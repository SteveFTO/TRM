<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>RiskDesk v10</title>
  <link rel="icon" type="image/png" href="icon.png" />
  <link rel="apple-touch-icon" href="icon.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://gumroad.com/js/gumroad.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <style>
	/* FORCE HIDE: Ensures views don't stack */
	.hidden { display: none !important; }
	/* SAFE AREA UTILITY: Pushes content below the Notch/Dynamic Island */
    .pt-safe {
        padding-top: env(safe-area-inset-top);
    }
    /* Custom Dark Theme Tweaks */
    body {
      background-color: #0f172a; /* Slate 900 */
      color: #e2e8f0;
      -webkit-tap-highlight-color: transparent;
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    /* Range Slider Styling */
    input[type=range] {
      -webkit-appearance: none; 
      background: transparent; 
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 24px;
      width: 24px;
      border-radius: 50%;
      background: #3b82f6;
      margin-top: -10px;
      box-shadow: 0 0 10px rgba(59,130,246,0.5);
    }
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%;
      height: 4px;
      background: #334155;
      border-radius: 2px;
    }

    /* Hide scrollbar for clean UI */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    
    /* Toggle Switch */
    .toggle-checkbox:checked {
      right: 0;
      border-color: #10b981;
    }
    .toggle-checkbox:checked + .toggle-label {
      background-color: #10b981;
    }
    
    /* Animation Utils */
    .slide-in {
        animation: slideIn 0.2s ease-out forwards;
    }
    @keyframes slideIn {
        from { opacity: 0; transform: translateX(20px); }
        to { opacity: 1; transform: translateX(0); }
    }

    /* Insight Card Animation */
    .insight-card {
        animation: fadeIn 0.5s ease-out forwards;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* --- PATCH: PASTE ZONE STYLES --- */
    .paste-zone {
        border: 2px dashed #475569;
        border-radius: 0.75rem;
        padding: 1rem;
        text-align: center;
        color: #64748b;
        transition: all 0.2s;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100px;
        margin-top: 1rem;
        background-color: rgba(15, 23, 42, 0.5);
    }
    .paste-zone:hover { border-color: #3b82f6; color: #60a5fa; }
    .paste-zone.has-image { border-color: #10b981; background-color: rgba(16, 185, 129, 0.1); color: #34d399; }
	/* --- PATCH: IMMERSIVE LANDSCAPE MODE --- */
    
    /* 1. Hide "App Chrome" on Phones in Landscape */
    @media (orientation: landscape) and (max-height: 600px) {
        header, nav, #view-logs > .flex.gap-2.mb-4 { /* Hides Header, Nav, and Search Bar */
            display: none !important;
        }
        #mainContainer {
            padding-bottom: 0 !important; /* Remove nav padding */
            padding-top: 10px !important; /* Small top spacing */
        }
        #view-logs {
            height: 100vh;
            padding: 0 !important;
        }
        #logsTableWrapper {
            border-radius: 0 !important; /* Full width look */
            border: none !important;
            height: 100vh !important;
        }
        
        /* Force Grid to 16 Columns on Landscape Mobile */
        .log-grid-layout {
            grid-template-columns: repeat(16, minmax(0, 1fr)) !important;
        }
        
        /* Reveal the Extra Data Columns */
        .landscape-data {
            display: block !important;
        }
        .portrait-only {
            display: none !important;
        }
    }

    /* 2. Desktop/Tablet Support (Width based) */
    @media (min-width: 768px) {
        .log-grid-layout {
            grid-template-columns: repeat(16, minmax(0, 1fr)) !important;
        }
        .landscape-data { display: block !important; }
        .portrait-only { display: none !important; }
    }
	.paste-zone.has-image { border-color: #10b981; background-color: rgba(16, 185, 129, 0.1); color: #34d399; }

    /* --- PASTE PATCH 2 HERE --- */
    /* Hide the top nav rotate hint on Desktop or Landscape */
    @media (min-width: 768px) {
        #topNavRotateHint { display: none !important; }
    }
    @media (orientation: landscape) {
        #topNavRotateHint { display: none !important; }
    }
	/* FIX: Enable Long Press Menu on Snapshots */
    #imgModal img {
        -webkit-touch-callout: default !important; /* Allow iOS Menu */
        -webkit-user-select: auto !important;      /* Allow Selection */
        user-select: auto !important;
        pointer-events: auto !important;           /* Ensure touches register */
    }
	/* Fix for iOS Input Focus Zoom/Scroll Lock */
    body {
        /* Prevents the whole page from bouncing */
        overscroll-behavior-y: none; 
        /* Forces height to respect Safe Areas */
        min-height: -webkit-fill-available;
    }
  </style>
</head>

<body class="bg-slate-900 text-slate-200 min-h-screen pb-safe overscroll-y-none selection:bg-blue-500 selection:text-white">

<!-- LICENSE GATE OVERLAY -->
  <div id="licenseGate" class="fixed inset-0 z-[100] bg-slate-900 flex flex-col items-center justify-center p-6 hidden">
      <div class="text-center max-w-sm w-full">
          <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-emerald-400 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-xl mx-auto mb-6">RD</div>
          <h1 class="text-3xl font-black text-white mb-2">Welcome to RiskDesk</h1>
          <p class="text-slate-400 mb-8 text-sm">Please enter your Gumroad License Key to activate the full version.</p>
          
          <input type="text" id="licenseKeyInput" placeholder="XXXXXXXX-XXXXXXXX-XXXXXXXX-XXXXXXXX" 
              class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-center text-white font-mono text-sm outline-none focus:border-blue-500 mb-4 transition-all uppercase">
          
          <button onclick="licenseService.verify()" id="activateBtn" class="w-full py-4 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg transition-all active:scale-95 flex justify-center items-center gap-2">
              Activate License
          </button>
          
          <div id="licenseError" class="text-red-400 text-xs mt-4 hidden">Invalid License Key. Please check your Gumroad receipt.</div>
          
          <p class="text-xs text-slate-600 mt-8">
              Don't have a key? <a href="https://riskdesk.io" target="_blank" class="text-blue-400 hover:underline">Get one here</a>
          </p>
      </div>
  </div>

  <div id="appHeader" class="sticky top-0 z-50 bg-slate-900/95 backdrop-blur border-b border-slate-800 transition-all duration-300 pt-safe">
    <div class="max-w-7xl mx-auto px-4 h-14 flex items-center justify-between relative">
        
        <div class="flex items-center shrink-0 -ml-2">
            <svg width="150" height="32" viewBox="0 0 150 32" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M16 2.5L5.5 6.875V13C5.5 19.125 9.875 24.375 16 26.125C22.125 24.375 26.5 19.125 26.5 13V6.875L16 2.5Z" 
                    stroke="#3b82f6" stroke-width="2" fill="rgba(59, 130, 246, 0.15)"/>
              <path d="M10 17L14 13L18 17L22 11" 
                    stroke="#34d399" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <text x="34" y="22" fill="url(#logo_grad)" font-family="ui-sans-serif, system-ui, sans-serif" font-weight="800" font-size="18" letter-spacing="-0.5">RISKDESK</text>
              <defs>
                <linearGradient id="logo_grad" x1="34" y1="0" x2="160" y2="0" gradientUnits="userSpaceOnUse">
                  <stop stop-color="#60a5fa" />
                  <stop offset="1" stop-color="#34d399" />
                </linearGradient>
              </defs>
            </svg>
        </div>

        <div id="riskBarContainer" class="flex-1 mx-2 md:mx-4 flex justify-center min-w-0">
            </div>

        <div class="flex items-center gap-2 shrink-0">
            
            <div id="headerRotateHint" class="hidden text-amber-400 animate-pulse mr-1" title="Rotate for better view">
                <i data-lucide="smartphone" class="w-5 h-5 rotate-90"></i>
            </div>

            <button onclick="app.switchView('settings')" class="text-slate-400 hover:text-white transition-colors p-1">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
            <button onclick="app.switchView('help')" class="text-slate-400 hover:text-white transition-colors p-1">
                <i data-lucide="circle-help" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <div id="riskDrawer" class="hidden border-b border-slate-800 bg-slate-900/95 backdrop-blur absolute w-full left-0 top-full shadow-2xl animate-in slide-in-from-top-2 z-40">
        <div id="riskDrawerContent" class="p-4 grid grid-cols-3 gap-2">
            </div>
    </div>
</div>

  <main class="w-full overflow-x-hidden pb-32 relative" id="mainContainer">
    
    <div id="view-calculator" class="p-4 space-y-6 max-w-lg mx-auto transition-opacity duration-300">
         

      <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
        <div class="flex justify-between items-center cursor-pointer" onclick="app.toggleAccountDisplay()">
          <div class="flex items-center gap-2">
              <h2 class="font-semibold text-slate-300">Active Accounts</h2>
              <span class="text-[10px] text-slate-500 uppercase tracking-wider">Base: <span id="dispBaseCcy" class="text-white font-bold">GBP</span></span>
          </div>
          <i data-lucide="chevron-down" id="accDisplayToggleIcon" class="w-5 h-5 transition-transform text-slate-500"></i>
        </div>
        
        <div id="accountsListDisplay" class="space-y-2 mt-4 transition-all duration-300 overflow-hidden">
          </div>
      </div>

      <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700 space-y-4">
        
        <div class="flex bg-slate-900 rounded-lg p-1 border border-slate-600 relative">
            <div class="w-1/2 text-center cursor-pointer py-2 rounded-md transition-all font-bold text-sm" 
                 id="btn-long" onclick="app.setDirection('LONG')">LONG</div>
            <div class="w-1/2 text-center cursor-pointer py-2 rounded-md transition-all font-bold text-sm text-slate-500" 
                 id="btn-short" onclick="app.setDirection('SHORT')">SHORT</div>
        </div>

        <div>
           <label class="text-xs text-slate-500 uppercase font-bold">Trade Currency</label>
           <select id="tradeCurrency" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm mt-1 focus:ring-2 focus:ring-blue-500 outline-none">
              </select>
        </div>

        <div class="flex gap-3">
          <div class="w-1/3">
            <label class="text-xs text-slate-500 uppercase font-bold">Ticker</label>
            <input type="text" id="ticker" placeholder="AAPL" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-lg font-mono uppercase mt-1 focus:border-blue-500 outline-none" />
          </div>
          <div class="w-2/3">
            <label class="text-xs text-slate-500 uppercase font-bold">Entry Price</label>
            <input type="number" id="purchasePrice" placeholder="0.00" step="any" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-lg font-mono mt-1 focus:border-blue-500 outline-none" />
          </div>
        </div>

        <div>
          <label class="text-xs text-slate-500 uppercase font-bold mb-2 block">Stop Loss Strategy</label>
          <div class="flex bg-slate-900 rounded-lg p-1 mb-3">
            <button class="flex-1 py-1 text-sm rounded transition-colors bg-slate-700 text-white shadow" id="btn-stop-single" onclick="app.setStopMode('single')">Single</button>
            <button class="flex-1 py-1 text-sm rounded transition-colors text-slate-400 hover:text-white" id="btn-stop-staggered" onclick="app.setStopMode('staggered')">Staggered</button>
          </div>

          <div id="stop-single-container">
            <input type="number" id="stopLoss" placeholder="Stop Price" step="any" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-lg font-mono focus:border-red-500 outline-none" />
          </div>

          <div id="stop-staggered-container" class="hidden space-y-2">
            </div>
        </div>
      </div>

      <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
         <div class="flex justify-between items-center mb-2">
            <label class="text-xs text-slate-500 uppercase font-bold">Risk Model</label>
            <div class="flex gap-2 text-sm">
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="radio" name="riskMode" value="equity" onchange="app.toggleRiskMode()" class="accent-blue-500">
                    <span class="text-[10px]">Eq %</span>
                </label>
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="radio" name="riskMode" value="position" onchange="app.toggleRiskMode()" class="accent-blue-500">
                    <span class="text-[10px]">Size %</span>
                </label>
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="radio" name="riskMode" value="cash" onchange="app.toggleRiskMode()" class="accent-emerald-500">
                    <span class="text-[10px]">Cash <span id="riskModeSym" class="text-emerald-400 font-bold">$</span></span>
                </label>
            </div>
         </div>

         <div id="cashRiskToggleContainer" class="hidden mb-3 bg-slate-900/50 p-2 rounded border border-slate-700/50 flex justify-between items-center animate-in slide-in-from-top-1">
             <span class="text-[9px] text-slate-400 leading-tight mr-2">Adjust risk across accounts?<br>(Maintain consistent EC%)</span>
             <div class="flex bg-slate-800 rounded p-0.5 border border-slate-600">
                 <button onclick="app.setCashAdjust(false)" id="btn-cash-fixed" class="px-2 py-1 text-[9px] font-bold rounded bg-slate-600 text-white transition-colors">NO</button>
                 <button onclick="app.setCashAdjust(true)" id="btn-cash-auto" class="px-2 py-1 text-[9px] font-bold rounded text-slate-400 hover:text-white transition-colors">YES</button>
             </div>
         </div>

         <div class="mt-2">
             <div class="flex justify-between items-center mb-2">
                 
                 <div class="flex items-center gap-2">
                     <span id="riskLabel" class="text-xs font-mono text-slate-300 font-bold">Risk 1.0%</span>
                     
                     <div id="riskInputContainer" class="hidden">
                        <input type="number" id="riskInputDisplay" class="bg-slate-900 border border-slate-700 rounded w-24 text-center text-sm font-bold text-white outline-none focus:border-blue-500 p-1" 
                            onchange="app.manualRiskInput(this.value)">
                     </div>
                 </div>

                 <span id="riskAmountDisplay" class="text-blue-400 text-xs font-mono"></span>
             </div>
             
             <div id="riskSliderContainer">
                <input type="range" id="riskSlider" min="0.1" max="2.0" step="0.05" value="0.25" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
             </div>
         </div>
      </div>

      <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
         <label class="text-xs text-slate-500 uppercase font-bold">Strategy & Context</label>
         <select id="strategy" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm mt-2 mb-2 focus:ring-2 focus:ring-blue-500 outline-none">
             <option value="">Select Strategy...</option>
             <option value="FB Breakout">FB Breakout</option>
             <option value="21d Pullback">21d Pullback</option>
             <option value="Gap & Go">Gap & Go</option>
             <option value="Reversal">Reversal</option>
             <option value="Other">Other</option>
         </select>
         <textarea id="notes" rows="2" placeholder="Trade context, mental state..." class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:border-blue-500 outline-none"></textarea>
      </div>

      <div class="space-y-3">
          <button id="mainActionBtn" onclick="app.calculateOrUpdate()" class="w-full py-4 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold text-lg shadow-lg shadow-blue-900/50 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
            Calculate
          </button>
          
          <button onclick="app.resetForm()" class="w-full py-3 rounded-xl border border-slate-700 hover:bg-slate-800 text-slate-400 font-bold text-sm transition-colors">
            Clear Inputs
          </button>
      </div>

      <div id="calculationResults" class="hidden mt-4 animate-in fade-in slide-in-from-bottom-4">
          </div>
      
      <div class="h-12"></div>
    </div>


    <div id="view-settings" class="hidden p-4 max-w-lg mx-auto slide-in pt-10">
        <div class="flex items-center gap-2 mb-6">
            <button onclick="app.switchView('calculator')" class="text-slate-400 hover:text-white">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h1 class="text-2xl font-bold text-white">Settings</h1>
        </div>
		<div class="bg-gradient-to-br from-indigo-900/40 to-purple-900/40 rounded-xl p-4 border border-indigo-500/30 mb-6 flex items-center justify-between shadow-lg shadow-indigo-900/20">
            <div>
                <h2 class="text-sm font-bold text-indigo-200 flex items-center gap-2">
                    <i data-lucide="coffee" class="w-4 h-4 text-amber-300"></i> Support Development
                </h2>
                <p class="text-[10px] text-slate-400 mt-1 max-w-xs leading-tight">
                    If it saves you money, consider a small tip to support ongoing development of RiskDesk!
                </p>
            </div>
            
            <a href="https://stephenhood.gumroad.com/l/jepcya" target="_blank" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-indigo-900/50 transition-all active:scale-95 text-xs uppercase tracking-wide">
                <i data-lucide="heart" class="w-4 h-4 text-pink-300 fill-pink-300/50"></i>
                Leave a Tip
            </a>
        </div>
        <div class="bg-slate-800 rounded-xl p-4 border border-slate-700 mb-6">
            <h2 class="text-sm font-bold text-emerald-400 mb-4 uppercase flex items-center gap-2">
                <i data-lucide="save" class="w-4 h-4"></i> Data Backup
            </h2>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="app.backupData()" class="bg-slate-900 border border-slate-600 hover:bg-slate-700 text-white py-3 rounded-lg text-sm font-semibold flex flex-col items-center gap-1">
                    <i data-lucide="download-cloud" class="w-5 h-5 text-blue-400"></i>
                    Backup Data
                </button>
                <div class="relative">
                    <input type="file" id="restoreFile" onchange="app.restoreData(this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".json">
                    <button class="w-full h-full bg-slate-900 border border-slate-600 hover:bg-slate-700 text-white py-3 rounded-lg text-sm font-semibold flex flex-col items-center gap-1 pointer-events-none">
                        <i data-lucide="upload-cloud" class="w-5 h-5 text-amber-400"></i>
                        Restore Data
                    </button>
                </div>
            </div>
            <p class="text-[10px] text-slate-500 mt-2 text-center">Save your trade history to a secure JSON file.</p>
        </div>

        <div class="bg-slate-800 rounded-xl p-4 border border-slate-700 mb-6">
            <h2 class="text-sm font-bold text-slate-300 mb-4 uppercase">Currency Settings</h2>
            
            <div class="mb-4">
                <label class="text-xs text-slate-500 uppercase font-bold block mb-1">Global Base Currency</label>
                <select id="settingsBaseCurrency" onchange="app.updateBaseCurrency(this.value)" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                  </select>
                <p class="text-[10px] text-slate-500 mt-1">All Account sizes are assumed to be in this currency.</p>
            </div>
            
            <div>
                <label class="text-xs text-slate-500 uppercase font-bold block mb-1">Default Trade Currency</label>
                <select id="settingsDefaultTradeCurrency" onchange="app.updateDefaultTradeCurrency(this.value)" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                   </select>
                <p class="text-[10px] text-slate-500 mt-1">Default currency selected when calculator opens.</p>
            </div>
        </div>

        <div class="bg-slate-800 rounded-xl p-4 border border-slate-700 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-sm font-bold text-slate-300 uppercase">Accounts Setup</h2>
                <button onclick="app.addAccount()" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-500">+ Add</button>
            </div>
            
            <div id="settingsAccountsList" class="space-y-3">
                </div>
            <p class="text-[10px] text-slate-500 mt-4">Select the radio button to nominate the <strong>Master Account</strong>. Logs will track this account's P&L.</p>
        </div>
		<div class="bg-slate-800 rounded-xl p-4 border border-slate-700 mt-6">
            <h2 class="text-sm font-bold text-slate-300 mb-4 uppercase flex items-center gap-2">
                <i data-lucide="list-checks" class="w-4 h-4 text-purple-400"></i> Strategy Manager
            </h2>
            <div id="settingsStrategiesList" class="space-y-2 mb-4">
                </div>
            <div class="flex gap-2">
                <input type="text" id="newStrategyInput" placeholder="New Strategy Name..." 
                    class="flex-1 bg-slate-900 border border-slate-600 rounded p-2 text-sm text-white focus:ring-2 focus:ring-blue-500 outline-none">
                <button onclick="app.addStrategy()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 rounded text-xs font-bold uppercase tracking-wider">
                    Add
                </button>
            </div>
        </div>
		
        <div class="bg-red-900/10 rounded-xl p-4 border border-red-900/50 mt-8">
            <h2 class="text-xs font-bold text-red-400 mb-3 uppercase">Danger Zone</h2>
            <button onclick="app.wipeAllData()" class="w-full mt-3 bg-red-900 hover:bg-red-800 text-white py-3 rounded-lg text-sm font-bold shadow-lg">
                Factory Reset App (Delete All Logs)
            </button>
        </div>
        <div class="h-24"></div>
    </div>

	<div id="view-help" class="hidden fixed inset-0 z-50 bg-slate-900 overflow-y-auto pb-20 animate-in fade-in slide-in-from-bottom-4 duration-300">
            
            <div class="sticky top-0 bg-slate-900/95 backdrop-blur z-20 border-b border-slate-800 p-4 flex items-center gap-3 shadow-lg">
                <button onclick="app.switchView('calculator')" class="bg-slate-800 hover:bg-slate-700 p-2 rounded-lg text-slate-400 hover:text-white transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </button>
                <h2 class="text-lg font-black text-white uppercase tracking-wider">User Guide</h2>
            </div>

            <div class="max-w-2xl mx-auto p-4 space-y-4">

                <details class="group bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                    <summary class="flex items-center justify-between p-4 cursor-pointer list-none bg-slate-800 hover:bg-slate-700/50 transition-colors">
                        <h3 class="text-amber-400 font-bold uppercase text-xs tracking-widest flex items-center gap-2">
                            <i data-lucide="settings" class="w-4 h-4"></i> Setup & Configuration
                        </h3>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 transition-transform group-open:rotate-180"></i>
                    </summary>
                    <div class="p-4 pt-0 text-sm text-slate-300 leading-relaxed border-t border-slate-700/50 mt-2 space-y-4">
                        
                        <div>
                            <strong class="text-white block mb-1">Accounts & Fund Manager</strong>
                            <p class="text-xs text-slate-400 mb-2">Define your trading accounts in Settings. You must select one as the <strong>Master Account</strong>.</p>
                            <p class="text-xs text-slate-400">
                                <span class="text-white font-bold">New:</span> Tap the <i data-lucide="wallet" class="w-3 h-3 inline text-emerald-400"></i> **Wallet Icon** on any account to open the **Fund Manager**. Here you can log Deposits/Withdrawals or configure a recurring **Monthly Auto-Contribution** (e.g., salary injection) to automate your growth tracking.
                            </p>
                        </div>

                        <div>
                            <strong class="text-white block mb-1">Currency & Live Prices</strong>
                            <p class="text-xs text-slate-400 mb-2">Set your Global Base Currency (e.g., GBP, USD). The app uses a live FX API to normalize risk across different trade currencies.</p>
                            <div class="bg-blue-900/20 p-2 rounded border border-blue-500/30">
                                <strong class="text-blue-300 text-[10px] uppercase block mb-1">Live Price Integration</strong>
                                <p class="text-[10px] text-slate-400">
                                    Get a free API Key from <a href="https://finnhub.io" target="_blank" class="text-blue-400 hover:underline">finnhub.io</a> and enter it in **Settings > App Preferences**. 
                                    This enables the <i data-lucide="refresh-cw" class="w-3 h-3 inline"></i> **Fetch Prices** button in the top Risk Bar, automatically updating your Open P&L and Heat.
                                </p>
                            </div>
                        </div>

                        <div>
                            <strong class="text-white block mb-1">Strategy Manager</strong>
                            <p class="text-xs text-slate-400">Create custom tags for your setups (e.g., "Gap & Go", "Reversal"). These tags are used to filter Logs and analyze performance.</p>
                        </div>

                        <div class="bg-slate-900/50 p-3 rounded border border-slate-600">
                            <strong class="text-white block mb-2 text-xs uppercase">Stats Configuration: Partials Impact</strong>
                            <p class="text-[10px] text-slate-400 mb-3">Found in Settings. This toggle controls how your statistics are calculated.</p>
                            
                            <div class="overflow-hidden rounded border border-slate-700">
                                <table class="w-full text-left text-[10px]">
                                    <thead class="bg-slate-700 text-slate-200 font-bold uppercase">
                                        <tr>
                                            <th class="p-2 border-r border-slate-600">Feature</th>
                                            <th class="p-2 border-r border-slate-600 text-emerald-400">OFF (Strict Mode)</th>
                                            <th class="p-2 text-blue-400">ON (Dynamic Mode)</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-700 bg-slate-800">
                                        <tr>
                                            <td class="p-2 font-bold text-slate-400 border-r border-slate-700">Math</td>
                                            <td class="p-2 border-r border-slate-700">Calculates averages using ONLY fully closed trades.</td>
                                            <td class="p-2">Includes Realized P&L from active trades (Partials).</td>
                                        </tr>
                                        <tr>
                                            <td class="p-2 font-bold text-slate-400 border-r border-slate-700">Use Case</td>
                                            <td class="p-2 border-r border-slate-700">Conservative. "What is my proven, banked edge?"</td>
                                            <td class="p-2">Cashflow. "How is my account growing right now?"</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div>
                            <strong class="text-white block mb-1">Data Management</strong>
                            <ul class="list-disc ml-4 text-xs text-slate-400 space-y-1">
                                <li><strong>Backup & Restore:</strong> Download your entire history as a JSON file. Do this regularly.</li>
                                <li><strong>Factory Reset:</strong> Located in Settings. <span class="text-red-400">Deletes all data permanently.</span></li>
                            </ul>
                        </div>
                    </div>
                </details>

                <details class="group bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                    <summary class="flex items-center justify-between p-4 cursor-pointer list-none bg-slate-800 hover:bg-slate-700/50 transition-colors">
                        <h3 class="text-blue-400 font-bold uppercase text-xs tracking-widest flex items-center gap-2">
                            <i data-lucide="calculator" class="w-4 h-4"></i> Using The Calculator
                        </h3>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 transition-transform group-open:rotate-180"></i>
                    </summary>
                    <div class="p-4 pt-0 text-sm text-slate-300 leading-relaxed border-t border-slate-700/50 mt-2 space-y-4">
                        
                        <div>
                            <strong class="text-white block mb-1">Defining Risk</strong>
                            <p class="text-xs text-slate-400 mb-2">RiskDesk calculates position size based on the distance between your Entry and Stop Loss.</p>
                            <ul class="list-disc ml-4 text-xs text-slate-400 space-y-1">
                                <li><strong>Equity Risk %:</strong> "I want to risk 1.0% of my account." The app adjusts share size so that if you hit your stop, you lose exactly that amount.</li>
                                <li><strong>Position Size %:</strong> "I want to invest 10% of my cash." The app fixes the share count, and your Risk % fluctuates based on the stop width.</li>
                                <li><strong>Trade Currency:</strong> Change your default Trade currency if necessary. The app handles FX conversion automatically.</li>
                            </ul>
                        </div>

                        <div>
                            <strong class="text-white block mb-1">Context & Logging</strong>
                            <p class="text-xs text-slate-400">Select a <strong>Strategy</strong> tag and add context notes (e.g., "Market choppy") before logging. This data feeds the Insights engine.</p>
                        </div>

                        <div>
                            <strong class="text-white block mb-1">Chart Capture</strong>
                            <p class="text-xs text-slate-400">Paste a chart image from your clipboard directly into the "Paste Zone" to save it with the trade.</p>
                        </div>
                    </div>
                </details>

                <details class="group bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                    <summary class="flex items-center justify-between p-4 cursor-pointer list-none bg-slate-800 hover:bg-slate-700/50 transition-colors">
                        <h3 class="text-emerald-400 font-bold uppercase text-xs tracking-widest flex items-center gap-2">
                            <i data-lucide="list" class="w-4 h-4"></i> Logs & Viewing Modes
                        </h3>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 transition-transform group-open:rotate-180"></i>
                    </summary>
                    <div class="p-4 pt-0 text-sm text-slate-300 leading-relaxed border-t border-slate-700/50 mt-2 space-y-4">
                        
                        <div>
                            <strong class="text-white block mb-1">Manual Log & Tools</strong>
                            <p class="text-xs text-slate-400 mb-2">Use the <i data-lucide="plus" class="w-3 h-3 inline"></i> button to manually record past trades. The header also contains Search, Filters, CSV Export, and Sharing tools.</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-slate-900 p-3 rounded border border-slate-600">
                                <strong class="text-white block mb-1 text-xs uppercase border-b border-slate-700 pb-1">Portrait Mode (Mobile)</strong>
                                <p class="text-[10px] text-slate-400 mb-2">Optimized for quick scanning.</p>
                                <ul class="text-[10px] text-slate-500 list-disc ml-3 space-y-0.5">
                                    <li>Date, Ticker & Direction</li>
                                    <li>Risk % & R-Multiple outcome</li>
                                    <li><strong>Current Price</strong> (Live/Manual)</li>
                                    <li>P&L Status Badge</li>
                                </ul>
                            </div>
                            <div class="bg-slate-900 p-3 rounded border border-slate-600">
                                <strong class="text-white block mb-1 text-xs uppercase border-b border-slate-700 pb-1">Landscape Mode (Pro View)</strong>
                                <p class="text-[10px] text-slate-400 mb-2">Rotate your phone to reveal the full data tape.</p>
                                <ul class="text-[10px] text-slate-500 list-disc ml-3 space-y-0.5">
                                    <li><strong class="text-slate-300">Position Size:</strong> Total value exposed.</li>
                                    <li><strong class="text-slate-300">Entry vs Current:</strong> Exact price levels.</li>
                                    <li><strong class="text-slate-300">Stop:</strong> Weighted avg active stop.</li>
                                    <li><strong class="text-slate-300">EC%:</strong> Equity Contribution % (Impact).</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </details>

                <details class="group bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                    <summary class="flex items-center justify-between p-4 cursor-pointer list-none bg-slate-800 hover:bg-slate-700/50 transition-colors">
                        <h3 class="text-purple-400 font-bold uppercase text-xs tracking-widest flex items-center gap-2">
                            <i data-lucide="layers" class="w-4 h-4"></i> Management & Exits
                        </h3>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 transition-transform group-open:rotate-180"></i>
                    </summary>
                    <div class="p-4 pt-0 text-sm text-slate-300 leading-relaxed border-t border-slate-700/50 mt-2 space-y-4">
                        <p class="text-xs text-slate-400">Tap any Log entry to open the Management View.</p>

                        <div>
                            <strong class="text-white block mb-1">Manual Price Override</strong>
                            <p class="text-xs text-slate-400">If the Live API price is incorrect (or for illiquid assets), you can manually type a price into the blue "Manual Live Price" box to instantly update your Position Value and P&L.</p>
                        </div>

                        <div>
                            <strong class="text-white block mb-1">Stop Adjustments</strong>
                            <p class="text-xs text-slate-400">Update your "Current Stop" as the trade moves in your favor. This automatically updates your "Open Heat" and "NER" metrics.</p>
                        </div>

                        <div>
                            <strong class="text-white block mb-1">Partial Exits</strong>
                            <p class="text-xs text-slate-400">Record partial sells by specifying Price and Quantity. The system calculates Realized P&L for that chunk and reduces your exposure. You can view the full history of exits at the bottom of the page.</p>
                        </div>
                    </div>
                </details>

                <details class="group bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                    <summary class="flex items-center justify-between p-4 cursor-pointer list-none bg-slate-800 hover:bg-slate-700/50 transition-colors">
                        <h3 class="text-cyan-400 font-bold uppercase text-xs tracking-widest flex items-center gap-2">
                            <i data-lucide="bar-chart-2" class="w-4 h-4"></i> Stats & Insights
                        </h3>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 transition-transform group-open:rotate-180"></i>
                    </summary>
                    <div class="p-4 pt-0 text-sm text-slate-300 leading-relaxed border-t border-slate-700/50 mt-2 space-y-4">
                        
                        <div class="bg-slate-900/50 p-3 rounded border border-slate-600">
                            <strong class="text-white block mb-2 text-xs uppercase text-blue-400">Live Risk Monitor (Top Bar)</strong>
                            <p class="text-[10px] text-slate-400 mb-2 italic">Based on the PrimeTrading "Progressive Exposure" Model.</p>
                            <ul class="list-disc ml-4 text-[10px] text-slate-400 space-y-3">
                                <li>
                                    <strong class="text-slate-200">NER (Net Exposure Risk):</strong> "Naked Risk."<br>
                                    The % of account at risk from <strong>unfinanced</strong> positions only.<br>
                                    <span class="font-mono text-xs text-slate-500">Formula: (Open Heat - Banked Profit)</span><br>
                                    <span class="text-slate-500 italic">*If Banked Profit > Open Heat, the trade is "Financed" and removed from NER.</span>
                                </li>
                                <li>
                                    <strong class="text-slate-200">NEP (New Exposure Profit):</strong> "Traction."<br>
                                    The <strong>Unrealized (Paper) Profit</strong> of your unfinanced positions.<br>
                                    <span class="text-slate-500">If Positive: Your new, trades are working immediately. Safer to add exposure.</span><br>
                                    <span class="text-slate-500">If Negative: Your new trades are not working. Reduce exposure.</span>
                                </li>
                                <li>
                                    <strong class="text-slate-200">Delta:</strong> "Net Traction."<br>
                                    The relationship between your Traction (NEP) and your Risk (NER).<br>
                                    <span class="font-mono text-xs text-slate-500">Formula: NEP - NER</span>
                                </li>
                            </ul>
                        </div>

                        <div>
                            <strong class="text-white block mb-1">Trading Insights</strong>
                            <p class="text-xs text-slate-400">An automated engine that highlights patterns (e.g., "Best Strategy", "Negative Skew") based on your data.</p>
                        </div>

                        <div class="grid grid-cols-2 gap-3 text-xs">
                            <div>
                                <strong class="text-white block">Financial Health</strong>
                                <span class="text-slate-500">Avg Win vs Avg Loss ($). Largest wins/losses.</span>
                            </div>
                            <div>
                                <strong class="text-white block">Edge & Efficiency</strong>
                                <span class="text-slate-500">Performance in R-Multiples. Risk/Reward Ratio.</span>
                            </div>
                        </div>

                        <div>
                            <strong class="text-white block mb-2 text-xs uppercase text-purple-400">Visual Analytics (Charts)</strong>
                            <div class="grid grid-cols-2 gap-2 text-[10px] text-slate-400">
                                <div class="bg-slate-900/50 p-2 rounded border border-slate-700">
                                    <strong class="text-slate-200 block">Account Growth</strong>
                                    Equity curve visualizing your total capital growth over time.
                                </div>
                                <div class="bg-slate-900/50 p-2 rounded border border-slate-700">
                                    <strong class="text-slate-200 block">Drawdown Depth</strong>
                                    Visualizes the cumulative pain/depth of losing streaks.
                                </div>
                                <div class="bg-slate-900/50 p-2 rounded border border-slate-700">
                                    <strong class="text-slate-200 block">Strategy Performance</strong>
                                    Compares Win Rate and P&L across your different setups.
                                </div>
                                <div class="bg-slate-900/50 p-2 rounded border border-slate-700">
                                    <strong class="text-slate-200 block">Time Analysis</strong>
                                    Breakdowns by Day of Week and Time of Day to find your "Zone".
                                </div>
                                <div class="bg-slate-900/50 p-2 rounded border border-slate-700 col-span-2">
                                    <strong class="text-slate-200 block">Consistency Heatmap</strong>
                                    A GitHub-style calendar view showing your daily trading frequency and results.
                                </div>
                            </div>
                        </div>

                        <div>
                            <strong class="text-white block mb-1">Smart Filters</strong>
                            <p class="text-xs text-slate-400">Slice your data by Strategy, Recency (e.g., Last 50 trades), or Timeframe (e.g., **This Month, YTD, or Custom Dates**). The stats update instantly.</p>
                        </div>
                    </div>
                </details>

                <details class="group bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                    <summary class="flex items-center justify-between p-4 cursor-pointer list-none bg-slate-800 hover:bg-slate-700/50 transition-colors">
                        <h3 class="text-pink-400 font-bold uppercase text-xs tracking-widest flex items-center gap-2">
                            <i data-lucide="book-open" class="w-4 h-4"></i> The Journal
                        </h3>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 transition-transform group-open:rotate-180"></i>
                    </summary>
                    <div class="p-4 pt-0 text-sm text-slate-300 leading-relaxed border-t border-slate-700/50 mt-2 space-y-4">
                        
                        <div>
                            <strong class="text-white block mb-1">Rules & Philosophy</strong>
                            <p class="text-xs text-slate-400">Define your "Golden Rules" in the Journal settings. These persist and serve as your daily checklist.</p>
                        </div>

                        <div>
                            <strong class="text-white block mb-1">Daily Log</strong>
                            <p class="text-xs text-slate-400">The Journal automatically pulls in every trade and P&L event for the selected date.</p>
                        </div>

                        <div class="bg-slate-900/50 p-3 rounded border border-slate-600">
                            <strong class="text-white block mb-2 text-xs uppercase">Discipline Tracking</strong>
                            <p class="text-xs text-slate-400">You must answer: <strong>"Did you follow your rules today?"</strong></p>
                            <ul class="list-disc ml-4 text-xs text-slate-400 mt-2 space-y-1">
                                <li><strong>YES:</strong> Marks the day Green on the heatmap.</li>
                                <li><strong>NO:</strong> Marks the day Red. A checklist appears to track exactly <em>which</em> rules were broken.</li>
                            </ul>
                        </div>
                    </div>
                </details>

                <details class="group bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                    <summary class="flex items-center justify-between p-4 cursor-pointer list-none bg-slate-800 hover:bg-slate-700/50 transition-colors">
                        <h3 class="text-slate-400 font-bold uppercase text-xs tracking-widest flex items-center gap-2">
                            <i data-lucide="shield" class="w-4 h-4"></i> Privacy & Sharing
                        </h3>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 transition-transform group-open:rotate-180"></i>
                    </summary>
                    <div class="p-4 pt-0 text-sm text-slate-300 leading-relaxed border-t border-slate-700/50 mt-2 space-y-3">
                         <div class="flex gap-3">
                            <i data-lucide="eye" class="w-5 h-5 text-slate-500 shrink-0"></i>
                            <div>
                                <strong class="text-white text-xs block">Privacy Mode</strong>
                                <span class="text-xs text-slate-400">Tap the Eye icon to blur all dollar/currency values. Ideal for working in public.</span>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <i data-lucide="share-2" class="w-5 h-5 text-slate-500 shrink-0"></i>
                            <div>
                                <strong class="text-white text-xs block">Social Sharing</strong>
                                <span class="text-xs text-slate-400">Tap the Camera icon to generate a clean, branded image of your trades or stats, formatted for X/Discord.</span>
                            </div>
                        </div>
                    </div>
                </details>

                <div class="p-4 text-[10px] text-slate-500 text-center leading-relaxed opacity-75 border-t border-slate-800 mt-4">
                    <p><strong>Local Data Only:</strong> RiskDesk is Offline-First. Data is stored in your browser. Clearing cache deletes your data. Back up regularly.</p>
                    <p class="mt-2">
                        <strong>Disclaimer:</strong> This tool is for educational and journaling purposes only and does not constitute financial advice. 
                        <strong>Market Data:</strong> Live prices are provided by third-party services, may be delayed, and should be used for estimation purposes only. 
                        The developers are not responsible for data accuracy. Always verify real-time prices with your broker before executing trades.
                    </p>
                </div>
                
                <div class="h-10"></div>

            </div>
        </div>


    <div id="view-logs" class="hidden p-4 max-w-4xl mx-auto h-full flex flex-col">
        <div class="flex gap-2 mb-4 items-center">
            <button onclick="app.openManualLogModal()" class="bg-blue-600 hover:bg-blue-500 text-white p-2 rounded-lg shadow-lg flex-shrink-0">
                <i data-lucide="plus" class="w-5 h-5"></i>
            </button>
            
            <div class="relative flex-1">
                <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-slate-500"></i>
                <input type="text" id="logSearch" placeholder="Search" onkeyup="app.renderLogs()" class="w-full bg-slate-800 border-none rounded-lg pl-10 py-2 text-sm focus:ring-2 focus:ring-blue-500 text-white">
            </div>

            <button onclick="app.exportLogs()" class="bg-slate-800 p-2 rounded-lg text-slate-400 hover:text-white border border-slate-700" title="Export CSV">
                <i data-lucide="download" class="w-5 h-5"></i>
            </button>
            
            <button onclick="app.captureAndShare('logsTableWrapper', 'sharePageBtn')" id="sharePageBtn" class="bg-slate-800 p-2 rounded-lg text-slate-400 hover:text-white border border-slate-700" title="Share List">
                <i data-lucide="camera" class="w-5 h-5"></i>
            </button>
            
            <button onclick="app.togglePrivacyMode()" id="privacyToggleBtn" class="bg-slate-800 p-2 rounded-lg text-slate-400 hover:text-white border border-slate-700" title="Toggle Privacy">
                <i data-lucide="eye" class="w-5 h-5"></i>
            </button>
        </div>

       <div id="logsTableWrapper" class="bg-slate-900 rounded-xl border border-slate-800 flex-1 overflow-hidden flex flex-col justify-start">
            
            <div class="shrink-0 log-grid-layout grid grid-cols-10 md:grid-cols-16 gap-2 p-3 bg-slate-800 text-xs font-bold text-slate-400 border-b border-slate-700">
                <div class="col-span-2">DATE</div>
                <div class="col-span-2">TICKER</div>
                
                <div class="landscape-data hidden col-span-2 text-center text-slate-500">QTY (Org/Cur)</div>
                <div class="landscape-data hidden col-span-1 text-center text-slate-500">STOP</div>
                <div class="landscape-data hidden col-span-1 text-center text-slate-500">RISK</div>
                <div class="landscape-data hidden col-span-2 text-center text-slate-500">PERF (EC/%)</div>
                
                <div class="portrait-only col-span-2 text-left">RISK / R</div>
                
                <div class="landscape-data hidden col-span-2 text-right">R / P&L</div>
                
                <div class="col-span-4 md:col-span-3 text-right md:text-center">
                    <span class="md:hidden">P&L / STATUS</span>
                    <span class="hidden md:inline">STATUS</span>
                </div>
                
                <div class="hidden md:block md:col-span-1 text-center"></div>
            </div>

            <div id="logsContainer" class="overflow-y-auto flex-1 p-2 space-y-1">
                </div>
        </div>
    </div>
    
    <div id="view-manage" class="hidden fixed inset-0 bg-slate-900 z-40 overflow-y-auto p-4 animate-in slide-in-from-right">
        <div class="max-w-lg mx-auto space-y-6 pt-10 pb-32">
            <div class="flex justify-between items-center mb-6">
                 <button onclick="app.closeManageView()" class="text-slate-400 hover:text-white flex items-center gap-1">
                     <i data-lucide="arrow-left" class="w-5 h-5"></i> Back
                 </button>
                 <h2 class="text-xl font-bold text-white">Manage Trade</h2>
                 <button onclick="app.openReplay(app.data.editingId)" class="text-blue-400 hover:text-white p-2 bg-blue-500/10 hover:bg-blue-600 rounded-lg border border-transparent transition-colors" title="Open Chart Replay">
                     <i data-lucide="line-chart" class="w-5 h-5"></i>
                 </button>
            </div>

            <div id="manageSummary" class="bg-slate-800 rounded-xl p-4 border border-slate-700"></div>

			<div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                <h3 class="text-sm font-bold text-slate-300 mb-3 uppercase flex justify-between items-center">
                    <span id="exitFormTitle">Add Exit / Partial</span>
                    <button id="cancelExitEditBtn" onclick="app.cancelExitEdit()" class="hidden text-[10px] text-red-400 hover:underline">Cancel Edit</button>
                </h3>
                
                <div class="mb-3">
                    <label class="text-[10px] uppercase text-slate-500 font-bold">Date & Time</label>
                    <input type="datetime-local" id="exitInputDate" class="w-full bg-slate-900 border border-slate-600 rounded p-2 font-mono text-white text-sm focus:border-blue-500 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-[10px] uppercase text-slate-500 font-bold">Exit Price</label>
                        <input type="number" id="exitInputPrice" step="any" class="w-full bg-slate-900 border border-slate-600 rounded p-2 font-mono text-white focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] uppercase text-slate-500 font-bold">Shares Sold</label>
                        <input type="number" id="exitInputQty" step="1" class="w-full bg-slate-900 border border-slate-600 rounded p-2 font-mono text-white focus:border-blue-500 outline-none">
                    </div>
                </div>
                <button id="exitActionBtn" onclick="app.addExit()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg transition-colors shadow-lg">Log Exit</button>
            </div>

            <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                 <h3 class="text-sm font-bold text-slate-300 mb-3 uppercase">Exit History</h3>
                 <div id="exitHistoryList" class="space-y-2"></div>
            </div>
            
            <button onclick="app.deleteLog(app.data.editingId); app.closeManageView()" class="w-full py-3 text-red-500 border border-red-900/50 bg-red-900/10 rounded-xl mt-8">
                Delete Entire Trade
            </button>
        </div>
    </div>

	<div id="view-stats" class="hidden p-4 max-w-lg mx-auto pb-24 animate-in slide-in-from-right">
        <div class="flex items-center justify-between mb-6">
			<h1 class="text-2xl font-bold text-white flex items-center gap-2">
				<i data-lucide="bar-chart-2" class="w-6 h-6 text-indigo-400"></i> Statistics
			</h1>
        <div class="flex gap-2">
            <button onclick="app.captureAndShare('view-stats', 'statsShareBtn')" id="statsShareBtn" class="bg-slate-800 p-2 rounded-lg text-slate-400 hover:text-white transition-colors border border-slate-700" title="Share Stats">
                <i data-lucide="camera" class="w-5 h-5"></i>
            </button>
            <button onclick="app.togglePrivacyMode()" id="statsPrivacyBtn" class="bg-slate-800 p-2 rounded-lg text-slate-400 hover:text-white transition-colors border border-slate-700" title="Toggle Privacy">
                <i data-lucide="eye" class="w-5 h-5"></i>
            </button>
        </div>
    </div>
        <div class="grid grid-cols-2 gap-3 mb-6">
            <div>
                 <label class="text-[10px] text-slate-500 uppercase font-bold">Filter Strategy</label>
                 <select id="statsFilter" onchange="app.renderStats()" class="w-full bg-slate-900 border border-slate-700 text-xs text-white rounded-lg p-2 mt-1 outline-none focus:border-blue-500">
                     <option value="ALL">All Strategies</option>
                 </select>
            </div>
           
        </div>

        <div class="grid grid-cols-4 gap-2 mb-6">
            <div class="bg-slate-800 p-2 rounded-lg text-center border border-slate-700 shadow-sm">
                <div class="text-[9px] text-slate-500 uppercase">Win Rate</div>
                <div class="text-lg font-bold text-emerald-400 leading-tight" id="statWinRate">0%</div>
                <div class="text-[8px] font-bold mt-0.5" id="statWinRateDiff"></div>
            </div>
            <div class="bg-slate-800 p-2 rounded-lg text-center border border-slate-700 shadow-sm">
                <div class="text-[9px] text-slate-500 uppercase">Profit Factor</div>
                <div class="text-lg font-bold text-blue-400 leading-tight" id="statPF">0.00</div>
                <div class="text-[8px] font-bold mt-0.5" id="statPFDiff"></div>
            </div>
            <div class="bg-slate-800 p-2 rounded-lg text-center border border-slate-700 shadow-sm">
                <div class="text-[9px] text-slate-500 uppercase">Expectancy</div>
                <div class="text-lg font-bold text-amber-400 leading-tight" id="statExpectancy">0R</div>
                <div class="text-[8px] font-bold mt-0.5" id="statExpectancyDiff"></div>
            </div>
            <div class="bg-slate-800 p-2 rounded-lg text-center border border-slate-700 shadow-sm">
                <div class="text-[9px] text-slate-500 uppercase">Trades</div>
                <div class="text-lg font-bold text-white leading-tight" id="statTotal">0</div>
            </div>
        </div>

        <div class="bg-indigo-900/10 border border-indigo-500/20 p-4 rounded-xl mb-10">
            <h3 class="font-bold text-indigo-300 mb-3 flex items-center gap-2 text-xs uppercase">
                <i data-lucide="sparkles" class="w-4 h-4"></i> Trading Insights
            </h3>
            <div id="smartInsightsList" class="space-y-2 text-xs text-slate-300">
                <div class="text-center italic opacity-50">Analysing performance...</div>
            </div>
        </div>

        <div class="mb-10">
            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 border-b border-slate-800 pb-2 flex items-center gap-2">
                <i data-lucide="wallet" class="w-4 h-4 text-emerald-500"></i> Financial Health
            </h3>

            <div id="financialStatsTarget" class="mb-6"></div>

            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 mb-6 shadow-md">
                <h3 class="text-sm font-semibold mb-2 text-slate-300 flex items-center gap-2">
                    <i data-lucide="trending-up" class="w-4 h-4 text-emerald-400"></i> Account Growth
                </h3>
                <canvas id="chartGrowth"></canvas>
            </div>

            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 mb-6">
                <h3 class="text-sm font-semibold mb-2 text-slate-300">Monthly Returns</h3>
                <div class="h-64 relative"><canvas id="chartMonthly"></canvas></div>
            </div>
            
            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 mb-6">
                <h3 class="text-sm font-semibold mb-2 text-slate-300">Recent Contributions</h3>
                <div class="h-64 relative"><canvas id="chartContributions"></canvas></div>
            </div>
        </div>

        <div class="mb-10">
            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 border-b border-slate-800 pb-2 flex items-center gap-2">
                <i data-lucide="crosshair" class="w-4 h-4 text-blue-500"></i> Strategy Edge
            </h3>

            <div id="directionStats" class="grid grid-cols-2 gap-3 mb-6"></div>

            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 mb-6">
                <h3 class="text-sm font-semibold mb-2 text-slate-300 flex items-center gap-2">
                    <i data-lucide="bar-chart-2" class="w-4 h-4 text-indigo-400"></i> R-Distribution (Edge Curve)
                </h3>
                <div class="h-64 relative">
                    <canvas id="chartDistribution"></canvas>
                </div>
            </div>

            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 mb-6">
                <h3 class="text-sm font-semibold mb-2 text-slate-300">Strategy Performance (R)</h3>
                <div class="h-56 relative"><canvas id="chartStrategy"></canvas></div>
            </div>

            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 mb-6">
                <h3 class="text-sm font-semibold mb-2 text-slate-300">Outcome Mix</h3>
                <div class="h-48 relative flex justify-center"><canvas id="chartWinLoss"></canvas></div>
            </div>
        </div>

        <div class="mb-8">
            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 border-b border-slate-800 pb-2 flex items-center gap-2">
                <i data-lucide="brain-circuit" class="w-4 h-4 text-purple-500"></i> Risk & Behavior
            </h3>

            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 mb-6">
                <h3 class="text-sm font-semibold mb-3 text-slate-300 flex items-center gap-2">
                    <i data-lucide="calendar-check" class="w-4 h-4 text-emerald-400"></i> Consistency Heatmap
                </h3>
                
                <div id="consistencyGrid" class="flex flex-wrap gap-1 justify-center mb-2"></div>
                
                <div id="heatmapInfo" class="text-center text-xs font-mono text-blue-300 h-4 mb-2">
                    <span class="opacity-50 italic">Tap a square to see details</span>
                </div>
                <div class="flex justify-between text-[9px] text-slate-500 px-4 opacity-50">
                    <span>90 Days Ago</span>
                    <div class="flex gap-1 items-center">
                        <div class="w-2 h-2 rounded-sm bg-red-500/50"></div>
                        <div class="w-2 h-2 rounded-sm bg-slate-700"></div>
                        <div class="w-2 h-2 rounded-sm bg-emerald-500/50"></div>
                    </div>
                    <span>Today</span>
                </div>
            </div>

            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 mb-6">
                <h3 class="text-sm font-semibold mb-2 text-slate-300 flex items-center gap-2">
                    <i data-lucide="activity" class="w-4 h-4 text-red-400"></i> Drawdown (Risk Depth)
                </h3>
                <div class="h-48 relative"><canvas id="chartDrawdown"></canvas></div>
            </div>

            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 mb-6">
                <h3 class="text-sm font-semibold mb-2 text-slate-300">Time vs Money (Duration)</h3>
                <div class="h-64 relative"><canvas id="chartDuration"></canvas></div>
            </div>
            
            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 mb-6">
                <h3 class="text-sm font-semibold mb-2 text-slate-300">Day of Week Performance</h3>
                <div class="h-64 relative"><canvas id="chartDayOfWeek"></canvas></div>
            </div>
        </div>
    </div>
	
	<div id="view-journal" class="hidden p-4 max-w-lg mx-auto pb-24 animate-in slide-in-from-right">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold text-white flex items-center gap-2">
                <i data-lucide="book" class="w-6 h-6 text-amber-400"></i> Journal
            </h1>
            <div class="flex gap-2">
                 <button onclick="app.shareActiveJournalTab()" id="journalShareBtn" class="bg-slate-800 p-2 rounded-lg text-slate-400 hover:text-white transition-colors border border-slate-700" title="Share Page">
                    <i data-lucide="camera" class="w-5 h-5"></i>
                </button>
                <button onclick="app.togglePrivacyMode()" id="journalPrivacyBtn" class="bg-slate-800 p-2 rounded-lg text-slate-400 hover:text-white transition-colors border border-slate-700" title="Toggle Privacy">
                    <i data-lucide="eye" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <div class="flex bg-slate-900 p-1 rounded-xl mb-6 border border-slate-700">
            <button onclick="app.switchJournalTab('log')" id="btn-jtab-log" class="flex-1 py-2 text-xs font-bold rounded-lg transition-colors bg-blue-600 text-white shadow">Daily Log</button>
            <button onclick="app.switchJournalTab('rules')" id="btn-jtab-rules" class="flex-1 py-2 text-xs font-bold rounded-lg transition-colors text-slate-500 hover:text-white">Rules & Philosophy</button>
        </div>

        <div id="jtab-rules" class="hidden space-y-6">
            <div id="journalRulesContainer" class="space-y-6">
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <h3 class="text-xs font-bold text-amber-400 uppercase mb-2">My Trading Philosophy</h3>
                    <textarea id="jPhilosophy" rows="4" placeholder="e.g. I am a risk manager first, trader second..." 
                        class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-sm text-slate-200 outline-none focus:border-amber-400"
                        onchange="app.saveJournal()"></textarea>
                </div>

                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xs font-bold text-blue-400 uppercase">My Trading Rules</h3>
                        <button onclick="app.addJournalRule()" class="text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded text-white">+ Add Rule</button>
                    </div>
                    <div id="jRulesList" class="space-y-2"></div>
                </div>
                
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <h3 class="text-xs font-bold text-purple-400 uppercase mb-3">Manage Emotions List</h3>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="newEmotionInput" placeholder="New Emotion..." class="flex-1 bg-slate-900 border border-slate-600 rounded p-2 text-sm text-white">
                        <button onclick="app.addEmotionTag()" class="bg-purple-600 text-white px-3 rounded font-bold text-xs">Add</button>
                    </div>
                    <div id="jEmotionsSettingsList" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
        </div>

        <div id="jtab-log" class="space-y-6">
            <div class="flex justify-between items-center bg-slate-800 p-3 rounded-xl border border-slate-700">
                <button onclick="app.shiftJournalDate(-1)" class="p-2 text-slate-400 hover:text-white"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                <input type="date" id="journalDate" class="bg-transparent text-white font-bold text-lg text-center outline-none" onchange="app.renderJournalEntry()">
                <button onclick="app.shiftJournalDate(1)" class="p-2 text-slate-400 hover:text-white"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
            </div>

            <div id="journalLogContainer" class="space-y-6">
                <div id="jActivityContainer" class="hidden space-y-3">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest pl-1">Market Activity</h3>
                    <div id="jActivityFeed" class="space-y-2"></div>
                </div>

				<div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
					<h3 class="text-[10px] font-bold text-slate-500 uppercase mb-3 text-center tracking-widest">Did you follow your rules?</h3>
					<div class="flex gap-3">
						<button onclick="app.setJournalDiscipline(true)" id="btn-disc-yes" class="flex-1 py-2 rounded-lg border border-emerald-900/50 bg-slate-900 text-slate-500 font-bold transition-all flex flex-col items-center gap-1 hover:border-emerald-500 text-xs">
							<i data-lucide="check-circle" class="w-5 h-5"></i> YES
						</button>
						<button onclick="app.setJournalDiscipline(false)" id="btn-disc-no" class="flex-1 py-2 rounded-lg border border-red-900/50 bg-slate-900 text-slate-500 font-bold transition-all flex flex-col items-center gap-1 hover:border-red-500 text-xs">
							<i data-lucide="x-circle" class="w-5 h-5"></i> NO
						</button>
					</div>
					<div id="brokenRulesArea"></div> 
				</div>

                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <div class="mb-4">
                        <label class="text-[10px] text-slate-500 uppercase font-bold mb-2 block">Emotions Felt</label>
                        <div id="jDailyEmotions" class="flex flex-wrap gap-2"></div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="text-[10px] text-slate-500 uppercase font-bold mb-2 block">Journal Notes</label>
                        <textarea id="jDailyNotes" rows="6" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-sm text-slate-200 outline-none focus:border-blue-500" placeholder="How was the session? What did you learn?" onchange="app.saveJournalEntry()"></textarea>
                    </div>

                    <div class="paste-zone min-h-[100px]" contenteditable="true" onpaste="app.handleJournalPaste(event)">
                        <i data-lucide="image-plus" class="w-6 h-6 mb-1"></i>
                        <span class="text-xs">Paste Charts Here (Ctrl+V)</span>
                    </div>
                    <div id="jDailyImages" class="grid grid-cols-2 gap-2 mt-4"></div>
                </div>
            </div>
        </div>
    </div>

  </main>
<div id="manualLogModal" class="hidden fixed inset-0 z-50 bg-slate-900/90 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-slate-800 rounded-2xl border border-slate-700 w-full max-w-sm overflow-hidden shadow-2xl animate-in fade-in zoom-in-95">
        
        <div class="bg-slate-900/50 p-4 border-b border-slate-700 flex justify-between items-center">
            <h3 class="font-bold text-white flex items-center gap-2">
                <i data-lucide="pen-tool" class="w-4 h-4 text-amber-400"></i> Manual Entry
            </h3>
            <button onclick="document.getElementById('manualLogModal').classList.add('hidden')" class="text-slate-500 hover:text-white">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="p-4 space-y-4">
            
            <div class="grid grid-cols-2 gap-x-3 gap-y-4">
                
                <div class="min-w-0">
                    <label class="text-[10px] text-slate-500 font-bold uppercase block mb-1">Ticker</label>
                    <input type="text" id="manTicker" placeholder="AAPL" class="w-full bg-slate-900 border border-slate-600 rounded p-2.5 text-sm font-bold uppercase text-white outline-none focus:border-blue-500 h-10 appearance-none min-w-0">
                </div>
                <div class="min-w-0">
                    <label class="text-[10px] text-slate-500 font-bold uppercase block mb-1">Trade Currency</label>
                    <select id="manTradeCurrency" class="w-full bg-slate-900 border border-slate-600 rounded p-2.5 text-sm font-bold text-slate-300 outline-none h-10 appearance-none min-w-0">
                        </select>
                </div>
                
                <div class="col-span-2 min-w-0">
                    <label class="text-[10px] text-slate-500 font-bold uppercase block mb-1">Direction</label>
                    <select id="manDirection" class="w-full bg-slate-900 border border-slate-600 rounded p-2.5 text-sm font-bold text-slate-300 outline-none h-10 appearance-none min-w-0">
                        <option value="LONG">LONG</option>
                        <option value="SHORT">SHORT</option>
                    </select>
                </div>

                <div class="min-w-0">
                    <label class="text-[10px] text-slate-500 font-bold uppercase block mb-1">Price</label>
                    <input type="number" id="manPrice" step="any" placeholder="0.00" class="w-full bg-slate-900 border border-slate-600 rounded p-2.5 text-white font-mono text-sm outline-none focus:border-blue-500 h-10 appearance-none min-w-0">
                </div>
                <div class="min-w-0">
                    <label class="text-[10px] text-amber-500 font-bold uppercase block mb-1">Qty</label>
                    <input type="number" id="manQty" step="any" placeholder="100" class="w-full bg-slate-900 border border-slate-600 rounded p-2.5 text-white font-mono text-sm outline-none focus:border-amber-500 h-10 appearance-none min-w-0">
                </div>

                <div class="min-w-0">
                    <label class="text-[10px] text-red-400 font-bold uppercase block mb-1">Stop Loss</label>
                    <input type="number" id="manStop" step="any" placeholder="0.00" class="w-full bg-slate-900 border border-red-900/50 rounded p-2.5 text-white font-mono text-sm outline-none focus:border-red-500 h-10 appearance-none min-w-0 focus:ring-1 focus:ring-red-500">
                </div>
                <div class="min-w-0">
                    <label class="text-[10px] text-slate-500 font-bold uppercase block mb-1">Time</label>
                    <input type="time" id="manTime" class="w-full bg-slate-900 border border-slate-600 rounded p-2.5 text-xs text-slate-300 outline-none h-10 appearance-none min-w-0">
                </div>

                <div class="col-span-2 min-w-0">
                    <label class="text-[10px] text-slate-500 font-bold uppercase block mb-1">Strategy</label>
                    <select id="manStrategy" class="w-full bg-slate-900 border border-slate-600 rounded p-2.5 text-sm font-bold text-slate-300 outline-none h-10 appearance-none min-w-0">
                        </select>
                </div>

                <div class="col-span-2 min-w-0">
                    <label class="text-[10px] text-slate-500 font-bold uppercase block mb-1">Date</label>
                    <input type="date" id="manDate" class="w-full bg-slate-900 border border-slate-600 rounded p-2.5 text-xs text-slate-300 outline-none h-10 appearance-none min-w-0">
                </div>

            </div>
            
            <button onclick="app.saveManualLog()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-all mt-2">
                Log Trade
            </button>
        </div>
    </div>
</div>
  <nav class="fixed bottom-0 w-full bg-slate-900/95 backdrop-blur border-t border-slate-800 flex justify-around items-center pb-safe z-50">
      <button onclick="app.switchView('calculator')" id="nav-calculator" class="flex flex-col items-center py-3 w-1/4 text-blue-500 transition-colors">
          <i data-lucide="calculator" class="w-6 h-6 mb-1"></i>
          <span class="text-[10px] font-bold">Calculator</span>
      </button>
      <button onclick="app.switchView('logs')" id="nav-logs" class="flex flex-col items-center py-3 w-1/4 text-slate-500 hover:text-slate-300 transition-colors">
          <i data-lucide="list" class="w-6 h-6 mb-1"></i>
          <span class="text-[10px] font-bold">Logs</span>
      </button>
      <button onclick="app.switchView('stats')" id="nav-stats" class="flex flex-col items-center py-3 w-1/4 text-slate-500 hover:text-slate-300 transition-colors">
          <i data-lucide="bar-chart-2" class="w-6 h-6 mb-1"></i>
          <span class="text-[10px] font-bold">Stats</span>
      </button>
      <button onclick="app.switchView('journal')" id="nav-journal" class="flex flex-col items-center py-3 w-1/4 text-slate-500 hover:text-slate-300 transition-colors">
          <i data-lucide="book" class="w-6 h-6 mb-1"></i>
          <span class="text-[10px] font-bold">Journal</span>
      </button>
  </nav>

<div id="imgModal" class="hidden fixed inset-0 z-[60] bg-black/95 flex flex-col items-center justify-center p-4 backdrop-blur-sm" onclick="if(event.target.id === 'imgModal') this.classList.add('hidden')">
    
    <button onclick="document.getElementById('imgModal').classList.add('hidden')" class="absolute top-6 right-6 text-slate-400 hover:text-white bg-slate-800/50 p-2 rounded-full">
        <i data-lucide="x" class="w-8 h-8"></i>
    </button>

    <img id="imgModalSrc" class="max-w-full max-h-[80vh] rounded-lg shadow-2xl border border-slate-700 object-contain" src="" />
    
    <p class="text-slate-500 text-xs mt-4 animate-pulse">
        Long-press image to Save/Share
    </p>
</div>
<div id="fundsModal" class="hidden fixed inset-0 z-[70] bg-slate-900/90 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-slate-800 rounded-2xl border border-slate-700 w-full max-w-sm overflow-hidden shadow-2xl animate-in fade-in zoom-in-95">
        
        <div class="bg-slate-900/50 p-4 border-b border-slate-700 flex justify-between items-center">
            <div>
                <h3 class="font-bold text-white flex items-center gap-2">
                    <i data-lucide="wallet" class="w-4 h-4 text-emerald-400"></i> Fund Manager
                </h3>
                <span id="fundsModalTitle" class="text-xs text-slate-500 font-bold uppercase">Main Account</span>
            </div>
            <button onclick="document.getElementById('fundsModal').classList.add('hidden')" class="text-slate-500 hover:text-white">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="p-4 space-y-6">
            
            <div>
                <label class="text-[10px] text-slate-500 font-bold uppercase block mb-2">One-Off Transaction</label>
                <div class="flex gap-2 mb-2">
                    <span class="bg-slate-700 text-slate-400 p-2 rounded-l-lg font-mono border border-r-0 border-slate-600 text-sm flex items-center justify-center min-w-[40px]" id="fundCcySym">$</span>
                    <input type="number" id="fundAmount" placeholder="0.00" class="flex-1 bg-slate-900 border border-slate-600 rounded-r-lg p-2 text-white font-mono focus:border-blue-500 outline-none text-right">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.processFundTransaction('deposit')" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2.5 rounded-lg text-xs shadow-lg transition-colors flex justify-center items-center gap-2">
                        <i data-lucide="arrow-down-to-line" class="w-4 h-4"></i> Deposit
                    </button>
                    <button onclick="app.processFundTransaction('withdraw')" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2.5 rounded-lg text-xs shadow-lg transition-colors flex justify-center items-center gap-2">
                        <i data-lucide="arrow-up-from-line" class="w-4 h-4"></i> Withdraw
                    </button>
                </div>
            </div>

            <div class="bg-slate-900/50 rounded-xl p-3 border border-slate-700">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs font-bold text-slate-300">Monthly Auto-Deposit</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="recurActive" class="sr-only peer" onchange="app.toggleRecurringUI()">
                        <div class="w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-emerald-500"></div>
                    </label>
                </div>
                
                <div id="recurSettings" class="grid grid-cols-2 gap-3 opacity-50 pointer-events-none transition-opacity">
                    <div>
                        <label class="text-[9px] text-slate-500 uppercase font-bold">Amount</label>
                        <input type="number" id="recurAmount" class="w-full bg-slate-800 border border-slate-600 rounded p-1.5 text-sm text-white focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-[9px] text-slate-500 uppercase font-bold">Day of Month</label>
                        <select id="recurDay" class="w-full bg-slate-800 border border-slate-600 rounded p-1.5 text-sm text-white focus:border-blue-500 outline-none">
                            </select>
                    </div>
                </div>
                <button onclick="app.saveRecurringSettings()" id="recurSaveBtn" class="hidden w-full mt-3 bg-slate-700 hover:bg-slate-600 text-slate-200 text-xs font-bold py-2 rounded transition-colors">
                    Save Schedule
                </button>
            </div>

            <div>
                <label class="text-[10px] text-slate-500 font-bold uppercase block mb-1">Transaction Log</label>
                <div id="fundHistoryList" class="space-y-1 max-h-32 overflow-y-auto pr-1 bg-slate-900/30 p-2 rounded-lg border border-slate-700/30"></div>
            </div>

        </div>
    </div>
</div>

<script>
// --- LICENSE SERVICE ---
const licenseService = {
    // 1. Initialization: Check if user is already activated
    async init() {
        const key = localStorage.getItem('rd_license');
        
        if (!key) {
            // No key found -> Show Gate
            document.getElementById('licenseGate').classList.remove('hidden');
        } else {
            // Key found -> Allow access (Gate remains hidden by default CSS)
            console.log('RiskDesk Activated');
            
            // Optional: You could silently re-verify in background here if you wanted, 
            // but for offline-first apps, trusting localStorage is better UX.
        }
    },

    // 2. Verification: Called when user clicks "Activate License" button
    async verify() {
        const input = document.getElementById('licenseKeyInput');
        const btn = document.getElementById('activateBtn');
        const err = document.getElementById('licenseError');
        const key = input.value.trim();

        if (!key) return;

        // UI Loading State
        btn.disabled = true;
        btn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Verifying...`;
        err.classList.add('hidden');
        lucide.createIcons();

        try {
            // Call Gumroad API using PRODUCT_ID
            const response = await fetch('https://api.gumroad.com/v2/licenses/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                // USE product_id HERE INSTEAD OF product_permalink
                body: `product_id=3iNSQXfyfIc0nRcFEZa7SQ==&license_key=${key}`
            });
            
            const data = await response.json();

            if (data.success && !data.purchase.refunded) {
                // Success! Save Key locally
                localStorage.setItem('rd_license', key);
                
                // Hide Gate
                document.getElementById('licenseGate').classList.add('fade-out'); // Add CSS transition class if you have one
                setTimeout(() => document.getElementById('licenseGate').classList.add('hidden'), 500);
            } else {
                throw new Error("Invalid Key");
            }
        } catch (e) {
            console.error(e);
            err.textContent = "Invalid or refunded license key.";
            err.classList.remove('hidden');
            btn.disabled = false;
            btn.innerHTML = "Activate License";
        }
    }
};
// --- PATCH 3: IMAGE DATABASE ENGINE ---
const imgDB = {
    db: null,
    async open() { return new Promise((resolve, reject) => {
        const req = indexedDB.open('RiskDeskImages', 1);
        req.onupgradeneeded = (e) => e.target.result.createObjectStore('images', { keyPath: 'id' });
        req.onsuccess = (e) => { this.db = e.target.result; resolve(); };
        req.onerror = (e) => reject(e);
    });},
    async save(blob) {
        if(!this.db) await this.open();
        const id = crypto.randomUUID();
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction('images', 'readwrite');
            tx.objectStore('images').put({ id, blob, date: new Date() });
            tx.oncomplete = () => resolve(id);
            tx.onerror = (e) => reject(e);
        });
    },
    async get(id) {
        if(!this.db) await this.open();
        return new Promise((resolve) => {
            const tx = this.db.transaction('images', 'readonly');
            const req = tx.objectStore('images').get(id);
            req.onsuccess = () => resolve(req.result ? URL.createObjectURL(req.result.blob) : null);
            req.onerror = () => resolve(null);
        });
    }
};

/**
 * Trade Risk Manager v8.1
 */

const app = {
    // --- STATE ---
    data: {
        logs: [],
        accounts: [],
        editingId: null, 
        isEditingParams: false,
		editingExitIdx: null,
		// --- PASTE THIS NEW BLOCK HERE ---
        journal: {
            philosophy: '',
            rules: [],
            emotionsList: ['Focused', 'Anxious', 'Confident', 'Revenge', 'FOMO', 'Patient'],
            entries: {} 
        },
        // ---------------------------------
        settings: {
            baseCurrency: 'GBP', 
            tradeCurrency: 'USD',
            defaultTradeCurrency: 'USD', // New Setting
            riskMode: 'equity',
            riskValue: 0.25,
            stopMode: 'single',
            direction: 'LONG'
        },
        staggeredStops: [
            { price: 0, pct: 50 },
            { price: 0, pct: 50 }
        ],
        tempCalculation: {}
    },
    
    charts: {},

	// --- INITIALIZATION ---
    async init() { 
        await licenseService.init(); 
        await imgDB.open();
        
        // 1. Load Logs & Journal
        const savedLogs = localStorage.getItem('tradeLogs');
        const savedJournal = localStorage.getItem('tradeJournal');
        
        if (savedJournal) {
            this.data.journal = { ...this.data.journal, ...JSON.parse(savedJournal) };
        }
        if (savedLogs) {
            this.data.logs = JSON.parse(savedLogs);
            this.data.logs.forEach(l => {
                if(!l.exits) l.exits = [];
                if(!l.direction) l.direction = 'LONG';
                if(!l.initialQty && l.outcome !== 'open') l.initialQty = 0; 
                if (typeof l.initialStop === 'undefined' || l.initialStop === null) {
                    l.initialStop = l.stop;
                }
            });
        }
        
        // 2. Load Settings
        const savedSettings = localStorage.getItem('appSettings');
        if (savedSettings) this.data.settings = {...this.data.settings, ...JSON.parse(savedSettings)};
		if (!this.data.settings.replayBarStyle) this.data.settings.replayBarStyle = 'candlestick';
        
        // --- FORCE RISK DEFAULTS (User Request) ---
        // Overwrite any saved risk preferences on every load
        this.data.settings.riskMode = 'equity';
        this.data.settings.riskValue = 0.25;
        // ------------------------------------------

        if (!this.data.settings.strategies) {
            this.data.settings.strategies = ['FB Breakout', '21d Pullback', 'Gap & Go', 'Reversal', 'Other'];
        }

        // 3. Load Accounts
        const savedAccs = localStorage.getItem('accounts');
        if (savedAccs) {
            this.data.accounts = JSON.parse(savedAccs);
            if (!this.data.accounts.find(a => a.isMaster)) {
                if(this.data.accounts.length > 0) this.data.accounts[0].isMaster = true;
            }
        } else {
            this.data.accounts = [{ id: 1, name: 'Main Account', size: 10000, isMaster: true }];
        }

        // 4. Setup DOM
        this.renderAccountsReadOnly();
        this.populateCurrencySelect();
        this.renderStaggeredInputs();
        this.updateStrategyFilter();
        this.setupListeners();
        
        // Fix: Call the new Risk Bar immediately
        if(this.updateRiskBar) this.updateRiskBar(); 
        
		// --- PATCH: iOS KEYBOARD FIX ---
        // Forces the window to snap back to the top when the keyboard closes
        const scrollReset = () => {
            window.scrollTo(0, 0);
            document.body.scrollTop = 0;
        };

        // Attach to all current and future inputs
        document.addEventListener('focusout', (e) => {
            if (['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
                // Small delay to allow the keyboard animation to start
                setTimeout(scrollReset, 100); 
            }
        });
        
        // Extra safety: Watch for visual viewport resizing (keyboard slide down)
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                // If the viewport is nearly full height (keyboard closed)
                if (window.visualViewport.height >= window.innerHeight - 50) {
                    scrollReset();
                }
            });
        }
		
        // 5. UI Init
        document.getElementById('settingsBaseCurrency').value = this.data.settings.baseCurrency;
        
        this.populateDefaultTradeCurrencySettings();
        document.getElementById('settingsDefaultTradeCurrency').value = this.data.settings.defaultTradeCurrency || 'USD';

        document.getElementById('dispBaseCcy').textContent = this.data.settings.baseCurrency;
        document.getElementById('tradeCurrency').value = this.data.settings.defaultTradeCurrency || 'USD';
        
        lucide.createIcons();
        this.restoreFormData();

        // --- SYNC UI TO DEFAULTS ---
        // Set Slider to 0.25
        const slider = document.getElementById('riskSlider');
        if(slider) slider.value = this.data.settings.riskValue;
        
        // Check "Equity" Radio
        const radio = document.querySelector(`input[name="riskMode"][value="equity"]`);
        if(radio) radio.checked = true;
        // ---------------------------

        this.toggleRiskMode();
        this.setDirection('LONG');
        this.populateStrategySelect();
        this.checkRecurringContributions();

        // 7. Fix Mobile Rotation (Updates Risk Bar on rotate)
        window.addEventListener('resize', () => {
            if(this.updateRiskBar) this.updateRiskBar();
        });
        
    },
    
    // --- PATCH 4B: IMAGE HELPERS ---
    async handlePaste(e, type, logId = null) {
        e.preventDefault();
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (const item of items) {
            if (item.type.indexOf("image") === 0) {
                const blob = item.getAsFile();
                const id = await imgDB.save(blob);
                
                const zone = e.target.closest('.paste-zone') || e.target;
                zone.innerHTML = `<i data-lucide="check-circle" class="w-6 h-6 text-emerald-400 mb-1"></i><span class="text-xs text-emerald-400 font-bold">Chart Attached!</span>`;
                zone.classList.add('has-image');
                lucide.createIcons();

                // 1. Calculator Entry
                if(type === 'entry') this.data.tempCalculation.entryImgId = id;
                
                // 2. Existing Trade: Exit Chart
                if(type === 'exit' && logId) {
                    const log = this.data.logs.find(l => l.id === logId);
                    if(log) { log.exitImg = id; localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs)); this.openManageView(logId); }
                }

                // 3. NEW: Existing Trade: Entry Chart
                if(type === 'entry-update' && logId) {
                    const log = this.data.logs.find(l => l.id === logId);
                    if(log) { log.entryImg = id; localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs)); this.openManageView(logId); }
                }
                return;
            }
        }
        alert("No image found in clipboard.");
    },
    
    showImg(src) {
        const m = document.getElementById('imgModal');
        document.getElementById('imgModalSrc').src = src;
        m.classList.remove('hidden');
    },

    setupListeners() {
        document.getElementById('riskSlider').addEventListener('input', (e) => {
            const val = e.target.value;
            this.data.settings.riskValue = parseFloat(val);
            
            // Only update label text if in Equity or Position mode
            if(this.data.settings.riskMode === 'equity') {
                document.getElementById('riskLabel').textContent = `Risk ${val}%`;
            } else if (this.data.settings.riskMode === 'position') {
                document.getElementById('riskLabel').textContent = `Size ${val}%`;
            }
            
            this.saveSettings();
            
        });
        document.getElementById('tradeCurrency').addEventListener('change', (e) => {
            this.data.settings.tradeCurrency = e.target.value;
            this.saveSettings();
        });
    },

    saveSettings() {
        localStorage.setItem('appSettings', JSON.stringify(this.data.settings));
        localStorage.setItem('accounts', JSON.stringify(this.data.accounts));
        document.getElementById('dispBaseCcy').textContent = this.data.settings.baseCurrency;
    },

    generateInsights(logs) {
        // --- 1. NEW: APPLY STATS DATE FILTER ---
        let reportingLogs = logs; // Default to using all logs

		// 2. UPDATE CHART (With the filtered logs)
        if (this.updateEquityChart) this.updateEquityChart(reportingLogs);

        const container = document.getElementById('smartInsightsList');
        if(!container) return; 

        // Safe checks for elements
        const filterEl = document.getElementById('statsFilter');
        const recencyEl = document.getElementById('statsRecency');
        const filter = filterEl ? filterEl.value : 'ALL';
        const recency = recencyEl ? recencyEl.value : 'ALL';

        // 3. CRITICAL CHANGE: Calculate Stats on 'reportingLogs' (not 'logs')
        const stats = this.calculateBatchStats(reportingLogs); 
        
        // Lowered Threshold: Need at least 2 trades
        if(!stats || stats.count < 2) {
            container.innerHTML = `<div class="text-center italic opacity-50 text-[10px]">Need at least 2 closed trades matching these filters to generate insights.</div>`;
            return;
        }

        const insights = [];

        // HELPER
        const createCard = (color, title, text) => {
            const colors = {
                emerald: 'border-emerald-500 text-emerald-400',
                amber: 'border-amber-500 text-amber-400',
                blue: 'border-blue-500 text-blue-400',
                purple: 'border-purple-500 text-purple-400'
            };
            return `<div class="insight-card border-l-2 pl-3 py-2 bg-slate-900/50 rounded-r mb-2 ${colors[color]}">
                <strong class="block text-[10px] uppercase opacity-80 mb-0.5">${title}</strong>
                <span class="block leading-snug">${text}</span>
            </div>`;
        };

        // 1. Profit Factor
        if (typeof stats.profitFactor === 'number' && isFinite(stats.profitFactor)) {
            if (stats.profitFactor >= 2.0) {
                insights.push(createCard('emerald', 'Robust System', `Profit Factor is a strong <strong>${stats.profitFactor.toFixed(2)}</strong>.`));
            } else if (stats.profitFactor < 1.0 && stats.profitFactor >= 0) {
                insights.push(createCard('amber', 'System Leak', `Profit Factor is below 1.0 (${stats.profitFactor.toFixed(2)}).`));
            }
        }

        // 2. Scratch Defense
        if (typeof stats.scratchCount === 'number') {
            const totalActivity = stats.count + stats.scratchCount;
            if (totalActivity > 0) {
                const scratchRate = (stats.scratchCount / totalActivity) * 100;
                if (scratchRate > 25) {
                    insights.push(createCard('blue', 'High Defense', `You are scratching often (<strong>${Math.round(scratchRate)}%</strong>).`));
                }
            }
        }

        // 3. Efficiency
        const winSize = stats.avgWinR || 0;
        const lossSize = stats.avgLossR || 0; 
        if (winSize > 0 && lossSize > 0) {
            if (winSize > lossSize * 2) {
                insights.push(createCard('emerald', 'High Efficiency', `Avg winner (${winSize.toFixed(2)}R) is <strong>>2x larger</strong> than avg loser.`));
            } else if (lossSize > winSize) {
                insights.push(createCard('amber', 'Negative Skew', `Warning: Avg loss (${lossSize.toFixed(2)}R) > Avg win (${winSize.toFixed(2)}R).`));
            }
        }

        // 4. Strategy Analysis
        if(filter === 'ALL') {
            const sMap = {};
            logs.forEach(l => {
                if(!l.strategy) return;
                const rObj = this.calculateBatchStats([l]); 
                if(!sMap[l.strategy]) sMap[l.strategy] = 0;
                sMap[l.strategy] += rObj.totalNetR;
            });
            let bestS = null, maxR = -Infinity;
            Object.keys(sMap).forEach(k => { if(sMap[k] > maxR) { maxR = sMap[k]; bestS = k; } });
            if(bestS && maxR > 0) insights.push(createCard('blue', 'MVP Strategy', `<strong>${bestS}</strong> is driving performance (+${maxR.toFixed(1)}R).`));
        } else {
            const globalStats = this.calculateBatchStats(this.data.logs);
            const diff = (stats.winRate || 0) - (globalStats.winRate || 0);
            if(diff > 5) insights.push(createCard('blue', 'Outperformer', `<strong>${filter}</strong> wins ${Math.round(diff)}% more often than global avg.`));
            else if (diff < -5) insights.push(createCard('blue', 'Underperformer', `<strong>${filter}</strong> win rate is ${Math.abs(Math.round(diff))}% below global avg.`));
        }

        // 5. Seasonality (Only if ALL time)
        if (recency === 'ALL') {
            const monthMap = {};
            logs.forEach(l => {
                 const d = new Date(l.date);
                 if (isNaN(d)) return;
                 const m = d.toLocaleString('default', {month:'long'});
                 const rObj = this.calculateBatchStats([l]); 
                 if(!monthMap[m]) monthMap[m] = 0;
                 monthMap[m] += rObj.totalNetR;
            });
            let bestM = null, maxM = -Infinity;
            Object.keys(monthMap).forEach(k => { if(monthMap[k] > maxM) { maxM = monthMap[k]; bestM = k; } });
            if(bestM && maxM > 1) insights.push(createCard('purple', 'Seasonality', `<strong>${bestM}</strong> is your strongest month (+${maxM.toFixed(1)}R).`));
        }

        if(insights.length === 0) container.innerHTML = `<div class="text-center text-slate-500 text-[10px]">No significant patterns found.</div>`;
        else container.innerHTML = insights.join('');
    },

    backupData() {
        const payload = {
            version: 'v9',
            timestamp: new Date().toISOString(),
            logs: this.data.logs,
            accounts: this.data.accounts,
            settings: this.data.settings,
            journal: this.data.journal
        };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(payload));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", `RiskDesk_Backup_${new Date().toISOString().split('T')[0]}.json`);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    },

    restoreData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                if (json.logs && json.accounts) {
                    const jCount = json.journal ? Object.keys(json.journal.entries).length : 0;
                    if(confirm(`Restore Data?\n ${json.logs.length} Trade Logs\n ${json.accounts.length} Accounts\n ${jCount} Journal Entries\n\nOverwrite current data?`)) {
                        localStorage.setItem('tradeLogs', JSON.stringify(json.logs));
                        localStorage.setItem('accounts', JSON.stringify(json.accounts));
                        if(json.settings) localStorage.setItem('appSettings', JSON.stringify(json.settings));
                        if(json.journal) localStorage.setItem('tradeJournal', JSON.stringify(json.journal));
                        alert("Restore Successful. App will reload.");
                        location.reload();
                    }
                } else { alert("Invalid Backup File."); }
            } catch (err) { alert("Error reading file: " + err); }
        };
        reader.readAsText(file);
    },

    wipeAllData() {
        if(confirm("CRITICAL WARNING: This will delete ALL trades, journal entries, and settings. No undo.")) {
            if(confirm("Are you absolutely sure? Have you taken a backup using the Backup Data function?")) {
                localStorage.removeItem('tradeJournal');
                localStorage.clear();
                location.reload();
            }
        }
    },

	// --- LIVE PRICE FETCHING (Via Finnhub API) ---
    async fetchCurrentPrices() {
        // 1. Validation
        const apiKey = this.data.settings.finnhubKey;
        if (!apiKey) {
            alert("Missing API Key.\n\n1. Go to finnhub.io and get a free API Key.\n2. Enter it in Settings > App Preferences.");
            return;
        }

        const openTrades = this.data.logs.filter(l => l.outcome === 'open');
        if (openTrades.length === 0) return alert("No open trades to update.");
        
        // 2. UI Feedback
        const btn = document.getElementById('btnFetchPrices');
        const originalIcon = btn ? btn.innerHTML : '';
        if (btn) btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin text-blue-400"></i>';
        lucide.createIcons();

        let updatedCount = 0;
        const delay = ms => new Promise(res => setTimeout(res, ms));

        // 3. Loop through Trades
        for (let log of openTrades) {
            let symbol = log.ticker.trim().toUpperCase();
            
            // --- TICKER TRANSLATION LOGIC ---
            // Finnhub uses "AAPL" for US, "VOD.L" for London, etc.
            // We map your ":SUFFIX" to Finnhub's ".SUFFIX"
            if (symbol.includes(':')) {
                const parts = symbol.split(':');
                const ticker = parts[0];
                const exch = parts[1]; 
                
                if (['LON', 'LSE', 'L'].includes(exch)) symbol = `${ticker}.L`;
                else if (['TO', 'TOR'].includes(exch)) symbol = `${ticker}.TO`; 
                else if (['PA', 'PAR'].includes(exch)) symbol = `${ticker}.PA`; 
                else if (['DE', 'GER'].includes(exch)) symbol = `${ticker}.DE`; 
                else symbol = ticker; // Default/US
            }
            // --------------------------------

            try {
                // Call Finnhub Quote Endpoint
                const response = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKey}`);
                
                if (response.status === 429) {
                    console.warn("Finnhub Rate Limit. Pausing...");
                    await delay(1000); 
                }

                if (response.ok) {
                    const data = await response.json();
                    // data.c is Current Price. If symbol is invalid, c is usually 0.
                    if (data.c && data.c > 0) {
                        log.currentPrice = parseFloat(data.c);
                        log.lastPriceDate = new Date().toISOString();
                        updatedCount++;
                    }
                }
            } catch (e) {
                console.error(`Fetch error for ${symbol}:`, e);
            }
            
            // Safety Delay (3 calls per second limit on free tier)
            await delay(350); 
        }

        // 4. Save & Render
        localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
        this.renderLogs();
       
        
        if(btn) btn.innerHTML = originalIcon;
        lucide.createIcons();
        
        if(updatedCount > 0) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-20 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full shadow-lg border border-slate-700 text-xs animate-bounce z-50';
            toast.innerHTML = `<span class="text-emerald-400 font-bold">${updatedCount}</span> Prices Updated`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        } else {
            alert("No prices updated. Check your API Key or Ticker formats.");
        }
    },
    // --- PATCH 2: HEAT CALCULATION (Corrected for Active Stop) ---

    calculateCurrentHeat() {
        const masterAcc = this.data.accounts.find(a => a.isMaster);
        if(!masterAcc || masterAcc.size <= 0) return { total: 0, ner: 0 };

        let totalHeatVal = 0;
        let totalNERVal = 0;

        this.data.logs.forEach(l => {
            if(l.outcome === 'open') {
                const initQty = typeof l.initialQty === 'number' ? l.initialQty : 0;
                
                // 1. Realized P&L Calculation
                let realizedPnL = 0;
                let totalSold = 0;
                if (l.exits && l.exits.length > 0) {
                    l.exits.forEach(ex => {
                        totalSold += ex.qty;
                        const pnl = l.direction === 'SHORT' 
                            ? (l.entry - ex.price) * ex.qty 
                            : (ex.price - l.entry) * ex.qty;
                        realizedPnL += pnl;
                    });
                }

                const remaining = initQty - totalSold;
                if(remaining <= 0) return;

                // --- 2. Calculate Potential Loss (UPDATED LOGIC) ---
                // We define 'activeStop' as the currentStop if it exists, otherwise fall back to initial stop.
                const activeStop = (typeof l.currentStop === 'number') ? l.currentStop : l.stop;

                let riskDist = 0;
                if(l.direction === 'LONG') {
                    // Uses 'activeStop' instead of 'l.stop'
                    // If activeStop is moved above entry, riskDist becomes 0 (Heat = 0)
                    riskDist = Math.max(0, l.entry - activeStop); 
                } else {
                    riskDist = Math.max(0, activeStop - l.entry);
                }
                
                const grossRiskVal = remaining * riskDist;
                
                // 3. NER Calculation
                let netExposureVal = grossRiskVal - realizedPnL;
                if (netExposureVal < 0) netExposureVal = 0;

                // 4. Convert to Base Currency
                const rate = l.exchangeRate || 1;
                totalHeatVal += (grossRiskVal / rate);
                totalNERVal += (netExposureVal / rate);
            }
        });

        return {
            total: (totalHeatVal / masterAcc.size) * 100,
            ner: (totalNERVal / masterAcc.size) * 100
        };
    },
	
	// --- NEW: ADVANCED RISK CALCULATOR ---
    calculatePortfolioRisk() {
        const openTrades = this.data.logs.filter(l => l.outcome === 'open');
        const masterAcc = this.data.accounts.find(a => a.isMaster);
        const accountSize = masterAcc ? masterAcc.size : 10000;

        let metrics = {
            ner: 0,           // Net Exposure Risk 
            nep: 0,           // New Exposure Profit (Traction)
            delta: 0,         // NEP - NER
            openProfit: 0,    // Total Portfolio P&L
            openHeat: 0,      // Total Portfolio Heat
            secured: 0        // Banked (Worst Case)
        };

        openTrades.forEach(log => {
            const rate = log.exchangeRate || 1;
            
            // 1. BANKED (Realized)
            let bankedPnl = 0;
            if(log.exits) {
                log.exits.forEach(ex => {
                     const pnl = (log.direction === 'SHORT' ? log.entry - ex.price : ex.price - log.entry) * ex.qty;
                     bankedPnl += pnl;
                });
            }
            const bankedBase = bankedPnl / rate;

            // 2. FLOATING (Unrealized)
            const totalSold = log.exits ? log.exits.reduce((a,b) => a + b.qty, 0) : 0;
            const currentQty = (log.initialQty || 0) - totalSold;
            let floatingPnl = 0;
            let currentPrice = log.currentPrice || log.entry;
            
            if(currentQty > 0) {
                const diff = (log.direction === 'SHORT' ? log.entry - currentPrice : currentPrice - log.entry);
                floatingPnl = diff * currentQty;
            }
            const floatingBase = floatingPnl / rate;

            // 3. GROSS RISK (The Fix)
            const activeStop = (typeof log.currentStop === 'number') ? log.currentStop : log.stop;
            
            // --- FIX START: Directional Risk Logic ---
            let riskPerShare = 0;
            if (log.direction === 'SHORT') {
                // For Short: Risk is (Stop - Entry). If Stop < Entry, Risk is 0.
                riskPerShare = Math.max(0, activeStop - log.entry);
            } else {
                // For Long: Risk is (Entry - Stop). If Stop > Entry, Risk is 0.
                riskPerShare = Math.max(0, log.entry - activeStop);
            }
            // --- FIX END ---

            const grossRiskBase = (riskPerShare * currentQty) / rate;


            // 4. PRIMETRADING LOGIC (Unfinanced Filter)
            const remainingRisk = grossRiskBase - bankedBase;

            if (remainingRisk > 0) {
                // Trade is UNFINANCED (Risky)
                metrics.ner += remainingRisk; 
                metrics.nep += floatingBase;   // Add Traction
            } else {
                // Trade is FINANCED (Free Roll)
                // We do NOT add to NEP/NER.
                // We add the "Overflow Safety" to Secured.
                // Secured = Banked - Risk. Since Risk is 0 (or covered), Secured = The Profit we keep.
                metrics.secured += Math.abs(remainingRisk); 
            }

            metrics.openProfit += (bankedBase + floatingBase);
            metrics.openHeat += grossRiskBase;
        });

        // Delta
        metrics.delta = metrics.nep - metrics.ner;

        return {
            nerPct: -(metrics.ner / accountSize) * 100,
            nepPct: (metrics.nep / accountSize) * 100,
            delta: (metrics.delta / accountSize) * 100,
            
            profitVal: metrics.openProfit,
            heatVal: metrics.openHeat,
            securedVal: metrics.secured
        };
    },
	
	// --- ROTATE ICON HELPER ---
    toggleRotateIcon(show) {
        const el = document.getElementById('headerRotateHint');
        if (!el) return;
        
        const isMobile = window.innerWidth < 768;
        if (show && isMobile) {
            el.classList.remove('hidden');
            el.classList.add('block');
        } else {
            el.classList.add('hidden');
            el.classList.remove('block');
        }
    },

    // --- RESPONSIVE RISK BAR ENGINE ---
	updateRiskBar() {
        const container = document.getElementById('riskBarContainer');
        const drawer = document.getElementById('riskDrawer');
        const drawerContent = document.getElementById('riskDrawerContent');
        if (!container) return;

        // 1. Calculate Metrics
        const data = this.calculatePortfolioRisk ? this.calculatePortfolioRisk() : {nerPct:0, nepPct:0, profitVal:0, heatVal:0, securedVal:0};
        
        const sym = this.getSymbol ? this.getSymbol(this.data.settings.baseCurrency) : "";
        const isMobile = window.innerWidth < 768;

        const color = (val, reverse = false) => {
             if(Math.abs(val) < 0.01) return 'text-slate-400';
             return (reverse ? val < 0 : val > 0) ? 'text-emerald-400' : 'text-red-400';
        };
        const fmtPct = (v) => `${v>0?'+':''}${v.toFixed(2)}%`;
        const fmtMoney = (v) => `${v<0?'-':''}${sym}${Math.abs(v).toFixed(0)}`;

        // 2. RENDER: DESKTOP (Full Bar)
        if (!isMobile) {
            if(drawer) drawer.classList.add('hidden');
            container.innerHTML = `
                <div class="flex items-center gap-3 text-xs font-mono bg-slate-800/50 px-4 py-1.5 rounded-full border border-slate-700/50">
                    <div class="flex flex-col items-center leading-none" title="Net Equity Risk">
                        <span class="text-[9px] text-slate-500 font-bold">NER</span>
                        <span class="${data.nerPct < -0.5 ? 'text-red-400' : 'text-slate-300'} font-bold">${data.nerPct.toFixed(2)}%</span>
                    </div>
                    <div class="w-px h-6 bg-slate-700"></div>
                    <div class="flex flex-col items-center leading-none" title="Net Equity Profit">
                        <span class="text-[9px] text-slate-500 font-bold">NEP</span>
                        <span class="${color(data.nepPct)} font-bold">${fmtPct(data.nepPct)}</span>
                    </div>
                    <div class="w-px h-6 bg-slate-700"></div>
                    <div class="flex flex-col items-center leading-none" title="Delta (NEP + NER)">
                        <span class="text-[9px] text-blue-400 font-bold">DELTA</span>
                        <span class="${(data.nepPct+data.nerPct)>0?'text-blue-400':'text-slate-400'} font-bold">${fmtPct(data.nepPct+data.nerPct)}</span>
                    </div>
                    <div class="w-px h-6 bg-slate-700"></div>
                    <div class="flex flex-col items-center leading-none" title="Open Profit">
                        <span class="text-[9px] text-slate-500 font-bold">OPEN P&L</span>
                        <span class="${color(data.profitVal)} font-bold">${fmtMoney(data.profitVal)}</span>
                    </div>
                    <div class="w-px h-6 bg-slate-700"></div>
                    <div class="flex flex-col items-center leading-none" title="Open Heat">
                        <span class="text-[9px] text-slate-500 font-bold">HEAT</span>
                        <span class="${data.heatVal > 0 ? 'text-red-400' : 'text-emerald-400'} font-bold">${fmtMoney(data.heatVal)}</span>
                    </div>
                    <div class="w-px h-6 bg-slate-700"></div>
                    <div class="flex flex-col items-center leading-none" title="Secured Profit">
                        <span class="text-[9px] text-slate-500 font-bold">SECURED</span>
                        <span class="${color(data.securedVal)} font-bold">${fmtMoney(data.securedVal)}</span>
                    </div>
                    <button onclick="app.fetchCurrentPrices()" class="ml-2 p-1.5 rounded-full bg-blue-600 hover:bg-blue-500 text-white shadow-lg transition-all hover:scale-105" title="Fetch Prices">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                    </button>
                </div>`;
        } 
        
        // 3. RENDER: MOBILE (Carousel Pill)
        else {
            const delta = data.nepPct + data.nerPct;
            const deltaColor = delta > 0 ? 'text-blue-400' : 'text-slate-400';
            
            // FIX: Added Heat and Secured to this list
            const slides = [
                { label: 'Delta', val: fmtPct(delta), col: deltaColor },
                { label: 'NER', val: data.nerPct.toFixed(2)+'%', col: data.nerPct < -0.5 ? 'text-red-400' : 'text-slate-300' },
                { label: 'NEP', val: fmtPct(data.nepPct), col: color(data.nepPct) },
                { label: 'Open P&L', val: fmtMoney(data.profitVal), col: color(data.profitVal) },
                { label: 'Heat', val: fmtMoney(data.heatVal), col: data.heatVal > 0 ? 'text-red-400' : 'text-emerald-400' },
                { label: 'Secured', val: fmtMoney(data.securedVal), col: color(data.securedVal) }
            ];

            // Generate Slide HTML
            const slidesHtml = slides.map(s => `
                <div class="w-full flex-shrink-0 snap-center flex flex-col items-start justify-center px-2">
                    <span class="text-[8px] text-slate-500 font-bold uppercase leading-none whitespace-nowrap">${s.label}</span>
                    <span class="text-xs font-bold font-mono ${s.col} leading-none whitespace-nowrap">${s.val}</span>
                </div>
            `).join('');
            
            container.innerHTML = `
                <div class="flex items-center gap-1 bg-slate-800 rounded-full border border-slate-700 shadow-sm pr-3 pl-1 py-1 max-w-[160px]">
                    <div onclick="document.getElementById('riskDrawer').classList.toggle('hidden')" class="p-1.5 bg-slate-700/50 rounded-full active:scale-95 transition-transform">
                        <i data-lucide="activity" class="w-3 h-3 ${deltaColor}"></i>
                    </div>

                    <div class="flex-1 overflow-x-auto flex snap-x snap-mandatory" style="scrollbar-width: none; -ms-overflow-style: none;">
                        ${slidesHtml}
                    </div>

                    <div onclick="document.getElementById('riskDrawer').classList.toggle('hidden')" class="active:scale-95 transition-transform pl-1 border-l border-slate-700/50">
                        <i data-lucide="chevron-down" class="w-3 h-3 text-slate-500"></i>
                    </div>
                </div>
            `;

            if (drawerContent) {
                drawerContent.innerHTML = `
                    <div class="bg-slate-800 p-2 rounded text-center border border-slate-700">
                        <div class="text-[9px] text-slate-500 font-bold uppercase">NER</div>
                        <div class="text-sm font-mono font-bold ${data.nerPct < -0.5 ? 'text-red-400' : 'text-slate-300'}">${data.nerPct.toFixed(2)}%</div>
                    </div>
                    <div class="bg-slate-800 p-2 rounded text-center border border-slate-700">
                        <div class="text-[9px] text-slate-500 font-bold uppercase">NEP</div>
                        <div class="text-sm font-mono font-bold ${color(data.nepPct)}">${fmtPct(data.nepPct)}</div>
                    </div>
                    <div class="bg-slate-800 p-2 rounded text-center border border-blue-900/50 bg-blue-900/10">
                        <div class="text-[9px] text-blue-400 font-bold uppercase">Delta</div>
                        <div class="text-sm font-mono font-bold ${deltaColor}">${fmtPct(delta)}</div>
                    </div>
                    <div class="bg-slate-800 p-2 rounded text-center border border-slate-700">
                        <div class="text-[9px] text-slate-500 font-bold uppercase">Open P&L</div>
                        <div class="text-xs font-mono font-bold ${color(data.profitVal)}">${fmtMoney(data.profitVal)}</div>
                    </div>
                    <div class="bg-slate-800 p-2 rounded text-center border border-slate-700">
                        <div class="text-[9px] text-slate-500 font-bold uppercase">Heat</div>
                        <div class="text-xs font-mono font-bold ${data.heatVal > 0 ? 'text-red-400' : 'text-emerald-400'}">${fmtMoney(data.heatVal)}</div>
                    </div>
                    <div class="bg-slate-800 p-2 rounded text-center border border-slate-700">
                        <div class="text-[9px] text-slate-500 font-bold uppercase">Secured</div>
                        <div class="text-xs font-mono font-bold ${color(data.securedVal)}">${fmtMoney(data.securedVal)}</div>
                    </div>
                    <div class="col-span-3 mt-1">
                        <button onclick="app.fetchCurrentPrices()" class="w-full bg-blue-600 hover:bg-blue-500 py-2 rounded flex items-center justify-center text-white shadow-lg shadow-blue-500/20 active:scale-95 transition-transform gap-2">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            <span class="text-xs font-bold">FETCH LIVE PRICES</span>
                        </button>
                    </div>
                `;
            }
        }
        lucide.createIcons();
    },
	

    // --- VIEW MANAGEMENT ---
	// --- VIEW MANAGEMENT ---
	switchView(viewName) {
        // 1. Hide all views & Nav Highlights
        ['calculator', 'logs', 'stats', 'journal', 'manage', 'settings', 'help'].forEach(v => {
            const el = document.getElementById(`view-${v}`);
            if(el) {
                el.classList.add('hidden'); // Force hide using our new !important CSS
                // Clean up animation classes so they replay nicely next time
                el.classList.remove('animate-in', 'fade-in', 'slide-in-from-bottom-4');
            }
            
            // Handle Nav State
            const nav = document.getElementById(`nav-${v}`);
            if(nav) {
                nav.classList.remove('text-blue-500');
                nav.classList.add('text-slate-500');
            }
        });

        // 2. Hide Overlays
        document.getElementById('mobileMenu')?.classList.add('hidden');
        document.getElementById('riskDrawer')?.classList.add('hidden');
        this.toggleRotateIcon(false);

        // 3. Show Target View
        const target = document.getElementById(`view-${viewName}`);
        if(target) {
            target.classList.remove('hidden');
            target.classList.add('animate-in', 'fade-in', 'slide-in-from-bottom-4');
            // CRITICAL: Scroll to top so the user doesn't feel lost
            window.scrollTo(0,0); 
        }

        // 4. Highlight Nav
        const activeNav = document.getElementById(`nav-${viewName}`);
        if(activeNav) {
            activeNav.classList.remove('text-slate-500');
            activeNav.classList.add('text-blue-500');
        }

        // 5. Trigger View-Specific Logic
        if(viewName === 'logs') this.renderLogs();
        if(viewName === 'stats') this.renderStats();
        if(viewName === 'journal') this.switchJournalTab('log');
        if(viewName === 'settings') this.renderSettings();
        if (viewName === 'calculator') {
            this.renderAccountsReadOnly();
            this.updateRiskBar();
        }
        lucide.createIcons();
    },
   
    closeManageView() {
        this.data.editingId = null;
        this.switchView('logs');
    },

    // --- SETTINGS LOGIC ---
    updateBaseCurrency(val) {
        this.data.settings.baseCurrency = val;
        this.populateCurrencySelect();
        this.saveSettings();
    },
    
    updateDefaultTradeCurrency(val) {
        this.data.settings.defaultTradeCurrency = val;
        this.saveSettings();
    },

    populateDefaultTradeCurrencySettings() {
         const options = ['USD', 'GBP', 'EUR', 'CAD', 'JPY','SEK'];
         const settingsSelect = document.getElementById('settingsDefaultTradeCurrency');
         if (settingsSelect) {
            settingsSelect.innerHTML = options.map(c => 
                `<option value="${c}" ${c === (this.data.settings.defaultTradeCurrency || 'USD') ? 'selected' : ''}>${c}</option>`
            ).join('');
         }
    },

    renderSettingsAccounts() {
        const list = document.getElementById('settingsAccountsList');
        // Ensure symbol logic exists
        const getSym = (this.getSymbol) ? ((c) => this.getSymbol(c)) : ((c) => c === 'USD' ? '$' : ''); 
        const sym = getSym(this.data.settings.baseCurrency);

        list.innerHTML = this.data.accounts.map((acc, idx) => `
            <div class="bg-slate-900 p-3 rounded border ${acc.isMaster ? 'border-amber-500/50' : 'border-slate-700'} flex items-center gap-3">
                <input type="radio" name="masterAcc" ${acc.isMaster ? 'checked' : ''} 
                    onchange="app.setMasterAccount(${idx})" class="accent-amber-500 w-4 h-4">
                
                <div class="flex-1 space-y-1">
                    <input type="text" value="${acc.name}" onchange="app.updateAccountData(${idx}, 'name', this.value)" 
                        class="w-full bg-transparent text-sm font-bold text-white outline-none border-b border-transparent focus:border-blue-500 placeholder-slate-600">
                    
                    <div class="text-xs font-mono text-slate-400 flex items-center gap-2">
                        <span>${sym}${acc.size.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                        ${acc.recurring && acc.recurring.active ? '<span class="text-[9px] text-emerald-500 bg-emerald-900/20 px-1 rounded">Auto</span>' : ''}
                    </div>
                </div>
                
                <button onclick="app.openFundsModal(${idx})" class="bg-slate-800 hover:bg-slate-700 text-emerald-400 p-2 rounded transition-colors" title="Manage Funds">
                    <i data-lucide="wallet" class="w-4 h-4"></i>
                </button>

                <button onclick="app.removeAccount(${idx})" class="text-slate-600 hover:text-red-500 p-2">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        `).join('');
        lucide.createIcons();
    },

    addAccount() {
        this.data.accounts.push({ 
            id: Date.now(), 
            name: `New Account`, 
            size: 0, 
            isMaster: this.data.accounts.length === 0 
        });
        this.saveSettings();
        this.renderSettingsAccounts();
    },

    removeAccount(idx) {
        if(this.data.accounts.length <= 1) return alert("Must have at least one account.");
        if(confirm("Delete this account?")) {
            const isMaster = this.data.accounts[idx].isMaster;
            this.data.accounts.splice(idx, 1);
            if(isMaster && this.data.accounts.length > 0) this.data.accounts[0].isMaster = true;
            this.saveSettings();
            this.renderSettingsAccounts();
        }
    },

    updateAccountData(idx, field, val) {
        this.data.accounts[idx][field] = field === 'size' ? parseFloat(val) : val;
        this.saveSettings();
    },

    setMasterAccount(idx) {
        this.data.accounts.forEach((a, i) => a.isMaster = (i === idx));
        this.saveSettings();
        this.renderSettingsAccounts();
    },

    // --- CALCULATOR VIEW LOGIC ---
    toggleAccountDisplay() {
        const list = document.getElementById('accountsListDisplay');
        const icon = document.getElementById('accDisplayToggleIcon');
        if(list.classList.contains('hidden')) {
            list.classList.remove('hidden');
            icon.style.transform = 'rotate(180deg)';
        } else {
            list.classList.add('hidden');
            icon.style.transform = 'rotate(0deg)';
        }
    },

    renderAccountsReadOnly() {
        const list = document.getElementById('accountsListDisplay');
        if(this.data.accounts.length === 0) {
            list.innerHTML = `<div class="text-xs text-center text-slate-500">No accounts configured. Go to Settings.</div>`;
            return;
        }
        list.innerHTML = this.data.accounts.map(acc => `
            <div class="flex justify-between items-center p-2 rounded bg-slate-900 border ${acc.isMaster ? 'border-amber-500/30' : 'border-slate-800'}">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-bold text-slate-300">${acc.name}</span>
                    ${acc.isMaster ? '<span class="text-[8px] bg-amber-500/20 text-amber-500 px-1 rounded border border-amber-500/20">MASTER</span>' : ''}
                </div>
                <div class="font-mono text-xs text-slate-400">${acc.size.toLocaleString()}</div>
            </div>
        `).join('');
    },

    // --- CALCULATOR LOGIC ---
    setDirection(dir) {
        this.data.settings.direction = dir;
        const btnLong = document.getElementById('btn-long');
        const btnShort = document.getElementById('btn-short');
        
        if(dir === 'LONG') {
            btnLong.classList.add('bg-emerald-600', 'text-white', 'shadow');
            btnLong.classList.remove('text-slate-500');
            btnShort.classList.remove('bg-red-600', 'text-white', 'shadow');
            btnShort.classList.add('text-slate-500');
        } else {
            btnShort.classList.add('bg-red-600', 'text-white', 'shadow');
            btnShort.classList.remove('text-slate-500');
            btnLong.classList.remove('bg-emerald-600', 'text-white', 'shadow');
            btnLong.classList.add('text-slate-500');
        }
    },

    populateCurrencySelect() {
        const tradeSel = document.getElementById('tradeCurrency');
        const options = ['USD', 'GBP', 'EUR', 'CAD', 'JPY','SEK'];
        const settingsSel = document.getElementById('settingsBaseCurrency');
        
        // Re-populate Calculator Trade Currency
        tradeSel.innerHTML = options.map(c => 
            `<option value="${c}" ${c === this.data.settings.tradeCurrency ? 'selected' : ''}>${c}</option>`
        ).join('');

        // Re-populate Settings Base Currency
        settingsSel.innerHTML = options.map(c =>
             `<option value="${c}" ${c === this.data.settings.baseCurrency ? 'selected' : ''}>${c}</option>`
        ).join('');
    },

	// --- STRATEGY MANAGEMENT ---
    populateStrategySelect() {
        const sel = document.getElementById('strategy');
        if(!sel) return;
        
        // Preserve current selection if reloading
        const currentVal = sel.value; 
        
        sel.innerHTML = '<option value="">Select Strategy...</option>' + 
            this.data.settings.strategies.map(s => `<option value="${s}">${s}</option>`).join('');
            
        if(currentVal && this.data.settings.strategies.includes(currentVal)) {
            sel.value = currentVal;
        }
    },

    renderSettingsStrategies() {
        const list = document.getElementById('settingsStrategiesList');
        if(!list) return;
        
        list.innerHTML = this.data.settings.strategies.map((strat, idx) => `
            <div class="flex justify-between items-center bg-slate-900 p-2 rounded border border-slate-700 group">
                <span class="text-sm text-slate-300 pl-2 border-l-2 border-purple-500/50">${strat}</span>
                <button onclick="app.removeStrategy(${idx})" class="text-slate-600 hover:text-red-400 p-1 opacity-50 group-hover:opacity-100 transition-opacity">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        `).join('');
        lucide.createIcons();
    },

    addStrategy() {
        const input = document.getElementById('newStrategyInput');
        const val = input.value.trim();
        if(!val) return;
        
        // Prevent duplicates
        if(this.data.settings.strategies.some(s => s.toLowerCase() === val.toLowerCase())) {
            return alert("Strategy already exists.");
        }
        
        this.data.settings.strategies.push(val);
        input.value = '';
        this.saveSettings();
        this.renderSettingsStrategies();
        this.populateStrategySelect();
    },

    removeStrategy(idx) {
        if(confirm("Remove this strategy? (It will remain on old logs but won't be selectable for new trades)")) {
            this.data.settings.strategies.splice(idx, 1);
            this.saveSettings();
            this.renderSettingsStrategies();
            this.populateStrategySelect();
        }
    },

    setStopMode(mode) {
        this.data.settings.stopMode = mode;
        const btnSingle = document.getElementById('btn-stop-single');
        const btnStag = document.getElementById('btn-stop-staggered');
        const divSingle = document.getElementById('stop-single-container');
        const divStag = document.getElementById('stop-staggered-container');

        if(mode === 'single') {
            btnSingle.classList.replace('text-slate-400', 'text-white');
            btnSingle.classList.add('bg-slate-700', 'shadow');
            btnStag.classList.remove('bg-slate-700', 'shadow', 'text-white');
            btnStag.classList.add('text-slate-400');
            divSingle.classList.remove('hidden');
            divStag.classList.add('hidden');
        } else {
            btnStag.classList.replace('text-slate-400', 'text-white');
            btnStag.classList.add('bg-slate-700', 'shadow');
            btnSingle.classList.remove('bg-slate-700', 'shadow', 'text-white');
            btnSingle.classList.add('text-slate-400');
            divSingle.classList.add('hidden');
            divStag.classList.remove('hidden');
        }
    },

    renderStaggeredInputs() {
        const container = document.getElementById('stop-staggered-container');
        container.innerHTML = this.data.staggeredStops.map((stop, idx) => `
            <div class="flex gap-2 items-center">
                <span class="text-xs text-slate-500 w-4">${idx+1}</span>
                <input type="number" placeholder="Price" value="${stop.price || ''}" 
                    onchange="app.updateStaggered(${idx}, 'price', this.value)"
                    class="flex-1 bg-slate-900 border border-slate-700 rounded p-2 text-sm font-mono">
                <div class="relative w-20">
                    <input type="number" value="${stop.pct}" 
                        onchange="app.updateStaggered(${idx}, 'pct', this.value)"
                        class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm text-right pr-6">
                    <span class="absolute right-2 top-2 text-slate-500 text-xs">%</span>
                </div>
            </div>
        `).join('') + `
            <button onclick="app.addStaggeredLevel()" class="text-xs text-blue-400 mt-1 hover:text-white">+ Add Level</button>
        `;
    },

    updateStaggered(idx, field, val) {
        this.data.staggeredStops[idx][field] = parseFloat(val);
    },

    addStaggeredLevel() {
        if(this.data.staggeredStops.length >= 4) return;
        this.data.staggeredStops.push({ price: 0, pct: 0 });
        this.renderStaggeredInputs();
    },

    toggleRiskMode() {
        const modes = document.getElementsByName('riskMode');
        let selected;
        modes.forEach(m => { if(m.checked) selected = m.value; });
        this.data.settings.riskMode = selected;
        
        const sliderContainer = document.getElementById('riskSliderContainer');
        const inputContainer = document.getElementById('riskInputContainer');
        const input = document.getElementById('riskInputDisplay');
        const slider = document.getElementById('riskSlider');
        const label = document.getElementById('riskLabel');
        const toggleContainer = document.getElementById('cashRiskToggleContainer');
        const sym = document.getElementById('riskModeSym');
        
        // Update Symbol
        const baseSym = this.getSymbol ? this.getSymbol(this.data.settings.baseCurrency) : '$';
        if(sym) sym.textContent = baseSym;

        // Reset
        this.data.tempCalculation.impliedRiskPct = null;
        
        if (selected === 'equity') {
            // MODE: EQUITY %
            sliderContainer.classList.remove('hidden'); // Show Slider
            inputContainer.classList.add('hidden');     // Hide Input Box
            toggleContainer.classList.add('hidden');    // Hide Cash Toggle
            
            slider.min = "0.1"; slider.max = "2.0"; slider.step = "0.05";
            if(slider.value > 2.0) slider.value = 0.5; 
            label.textContent = `Risk ${slider.value}%`; // Label shows value
            
            this.data.settings.riskValue = parseFloat(slider.value);
        } 
        else if (selected === 'position') {
            // MODE: SIZE %
            sliderContainer.classList.remove('hidden'); // Show Slider
            inputContainer.classList.add('hidden');     // Hide Input Box
            toggleContainer.classList.add('hidden');    // Hide Cash Toggle

            slider.min = "2"; slider.max = "50"; slider.step = "1";
            if(slider.value < 2 || slider.value > 50) slider.value = 10;
            label.textContent = `Size ${slider.value}%`; // Label shows value
            
            this.data.settings.riskValue = parseFloat(slider.value);
        } 
        else { 
            // MODE: CASH $
            sliderContainer.classList.add('hidden');    // Hide Slider
            inputContainer.classList.remove('hidden');  // Show Input Box
            
            // Show Multi-Account Toggle if > 1 account exists
            if(this.data.accounts.length > 1) toggleContainer.classList.remove('hidden');
            else toggleContainer.classList.add('hidden');
            
            // Set Default Cash if near zero (switch from %)
            if(this.data.settings.riskValue < 5) this.data.settings.riskValue = 100;
            
            label.textContent = `Risk ${baseSym}`;      // Label is just symbol
            input.value = this.data.settings.riskValue; // Value goes in box
        }
        
        
    },

	async calculateOrUpdate() {
        const ticker = document.getElementById('ticker').value.toUpperCase();
        const entry = parseFloat(document.getElementById('purchasePrice').value);
        const direction = this.data.settings.direction;
        
        if(!ticker || !entry) return alert("Please enter Ticker and Entry Price");

        let stopPrice = 0;
        if(this.data.settings.stopMode === 'single') {
            stopPrice = parseFloat(document.getElementById('stopLoss').value);
        } else {
            let totalW = 0;
            let wPrice = 0;
            this.data.staggeredStops.forEach(s => {
                if(s.price && s.pct) {
                    wPrice += s.price * (s.pct/100);
                    totalW += s.pct;
                }
            });
            if(Math.abs(totalW - 100) > 1) return alert("Staggered stops must equal 100%");
            stopPrice = wPrice;
        }

        if(!stopPrice) return alert("Invalid Stop Loss");
        if (direction === 'LONG' && stopPrice >= entry) return alert("For LONG, Stop must be < Entry");
        if (direction === 'SHORT' && stopPrice <= entry) return alert("For SHORT, Stop must be > Entry");

        // Rate Logic: Global Base -> Trade Ccy
        const baseCcy = this.data.settings.baseCurrency;
        const tradeCcy = document.getElementById('tradeCurrency').value;
        const baseSym = this.getSymbol(baseCcy);  // <--- NEW: Get Symbol (e.g. )
        const tradeSym = this.getSymbol(tradeCcy); // <--- NEW: Get Symbol (e.g. $)

        let rate = 1;
        
        if(baseCcy !== tradeCcy) {
            try {
                const btn = document.getElementById('mainActionBtn');
                const originalText = btn.textContent;
                btn.textContent = "Fetching Live Rate...";
                btn.disabled = true;
                const response = await fetch(`https://api.frankfurter.app/latest?from=${baseCcy}&to=${tradeCcy}`);
                const data = await response.json();
                rate = data.rates[tradeCcy];
                btn.textContent = originalText;
                btn.disabled = false;
            } catch (e) {
                alert("Could not fetch live rate. Using fallback (1.25). Check internet.");
                rate = 1.25; 
            }
        }

        const riskPerShare = Math.abs(entry - stopPrice);
        const stopPct = (riskPerShare / entry) * 100;
        
        let derisk13Price, derisk14Price;
        if(direction === 'LONG') {
             derisk13Price = entry + (entry - stopPrice); 
             derisk14Price = entry + (entry - stopPrice) * (4/3); 
        } else {
             derisk13Price = entry - (stopPrice - entry);
             derisk14Price = entry - (stopPrice - entry) * (4/3);
        }

        const resultsDiv = document.getElementById('calculationResults');
        let html = `<div class="bg-slate-900 border border-slate-700 rounded-xl p-4 mb-4">
            <div class="flex justify-between mb-2 border-b border-slate-700 pb-2">
                <span class="font-bold text-white">${ticker} <span class="text-[10px] ${direction==='LONG'?'text-emerald-400':'text-red-400'} px-1 border border-current rounded">${direction}</span></span>
                <span class="text-xs text-slate-400">${new Date().toLocaleDateString()}</span>
            </div>
            <div class="grid grid-cols-2 gap-4 text-sm mb-2">
                <div><span class="text-slate-500 block text-xs">Entry</span>${entry}</div>
                <div><span class="text-slate-500 block text-xs">Stop</span>${stopPrice.toFixed(2)} (${stopPct.toFixed(2)}%)</div>
            </div>
        </div>`;

        let impliedRiskPct = 0;

        html += `<div class="space-y-3">`;
        let validAccountFound = false;
        let masterShares = 0; 

        this.data.accounts.forEach(acc => {
            if(!acc.size || acc.size <= 0) return;
            validAccountFound = true;
            
            let shares, posSize, riskAmt, posSizePct, eqRiskPct;

            // --- A. EQUITY % MODE ---
            if(this.data.settings.riskMode === 'equity') {
                const riskPct = this.data.settings.riskValue / 100;
                riskAmt = acc.size * riskPct; 
                const riskAmtTradeCcy = riskAmt * rate; 
                shares = Math.floor(riskAmtTradeCcy / riskPerShare);
                
                const totalPosValueTradeCcy = shares * entry;
                const totalPosValueBaseCcy = totalPosValueTradeCcy / rate;
                posSizePct = (totalPosValueBaseCcy / acc.size) * 100;
                
                eqRiskPct = this.data.settings.riskValue; 
                impliedRiskPct = eqRiskPct; 
            } 
            
            // --- B. POSITION SIZE % MODE (Explicit Check Added) ---
            else if (this.data.settings.riskMode === 'position') {
                const posPct = this.data.settings.riskValue / 100;
                posSizePct = this.data.settings.riskValue;
                
                posSize = acc.size * posPct * rate; 
                shares = Math.floor(posSize / entry);
                
                const totalRiskInTradeCcy = shares * riskPerShare;
                const totalRiskInBaseCcy = totalRiskInTradeCcy / rate;
                
                riskAmt = totalRiskInBaseCcy;
                eqRiskPct = (totalRiskInBaseCcy / acc.size) * 100;
                if(impliedRiskPct === 0) impliedRiskPct = eqRiskPct; 
            } 
            
            // --- C. CASH RISK MODE (The Fix) ---
            else {
                let targetCashRisk = this.data.settings.riskValue; // e.g. 100

                // Logic: "Adjust across accounts?"
                if (this.data.settings.cashRiskAutoAdjust && !acc.isMaster) {
                    const master = this.data.accounts.find(a => a.isMaster) || this.data.accounts[0];
                    if (master && master.size > 0) {
                        // Scale risk relative to account size vs master
                        const masterRiskPct = targetCashRisk / master.size;
                        targetCashRisk = acc.size * masterRiskPct;
                    }
                }

                riskAmt = targetCashRisk; // e.g. 100
                
                // Convert Cash Risk to Trade Currency (e.g. 100 -> $130)
                const riskAmtTradeCcy = targetCashRisk * rate;
                // Calculate shares based on that risk amount
                shares = Math.floor(riskAmtTradeCcy / riskPerShare);
                
                // Calculate resulting stats for display
                const totalPosValueTradeCcy = shares * entry;
                const totalPosValueBaseCcy = totalPosValueTradeCcy / rate;
                posSizePct = (totalPosValueBaseCcy / acc.size) * 100;
                
                eqRiskPct = (targetCashRisk / acc.size) * 100;
                if (acc.isMaster) impliedRiskPct = eqRiskPct;
            }

            // --- Final Common Calculations ---
            if (!posSize) posSize = shares * entry;
            
            if (acc.isMaster) masterShares = shares;

            // ... (Rest of your rendering code follows here: const borderClass = ...)

            const borderClass = acc.isMaster 
                ? 'border-amber-500 shadow-[0_0_10px_rgba(245,158,11,0.2)]' 
                : (direction==='LONG'?'border-blue-500/50':'border-red-500/50');
            
            const badge = acc.isMaster ? '<span class="text-[8px] bg-amber-500 text-black px-1 rounded font-bold">MASTER</span>' : '';

            // --- UI UPDATE: Correct Symbols Used Below ---
            html += `
            <div class="bg-slate-800 p-3 rounded-lg border-l-4 ${borderClass}">
                <div class="flex justify-between items-center mb-1">
                    <div class="flex items-center gap-2">
                         <span class="font-bold text-slate-300">${acc.name}</span>
                         ${badge}
                    </div>
                    <span class="text-xs font-mono text-slate-500">Size: ${baseSym}${acc.size.toLocaleString()}</span>
                </div>
                <div class="grid grid-cols-4 gap-2 text-center mb-2">
                    <div class="bg-slate-900/50 rounded p-1">
                        <div class="text-[10px] text-slate-500 uppercase">Shares</div>
                        <div class="font-bold text-sm text-white">${shares}</div>
                    </div>
                    <div class="bg-slate-900/50 rounded p-1">
                        <div class="text-[10px] text-slate-500 uppercase">Pos Size</div>
                        <div class="font-mono text-xs text-white">${tradeSym}${posSize.toFixed(0)}</div>
                    </div>
                    <div class="bg-slate-900/50 rounded p-1">
                        <div class="text-[10px] text-slate-500 uppercase">Eq Risk</div>
                        <div class="font-mono text-xs text-amber-400 font-bold">${eqRiskPct.toFixed(2)}%</div>
                    </div>
                    <div class="bg-slate-900/50 rounded p-1">
                        <div class="text-[10px] text-slate-500 uppercase">Risk ${baseSym}</div> <div class="font-mono text-xs text-red-400">-${riskAmt.toFixed(2)}</div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-slate-400 border-t border-slate-700 pt-2">
                    <div class="flex justify-between col-span-2 border-b border-slate-700/50 pb-1 mb-1">
                        <span class="font-mono text-emerald-400">1 ${baseCcy} = ${rate.toFixed(4)} ${tradeCcy}</span>
                        <span class="font-mono text-slate-300">Size: ${posSizePct.toFixed(2)}%</span>
                    </div>
                </div>
            </div>`;
        });
        html += `</div>`;

        this.data.tempCalculation = { derisk13Price, derisk14Price, rate, impliedRiskPct };
         

        if(validAccountFound) {
            const btnText = this.data.isEditingParams ? "Update Trade Record" : `Add to Log (Master: ${masterShares} shares)`;
            const btnColor = this.data.isEditingParams ? "bg-amber-600 hover:bg-amber-500 shadow-amber-900/50" : "bg-emerald-600 hover:bg-emerald-500 shadow-emerald-900/50";
            
            html += `
            <div id="pasteArea" class="paste-zone mt-4 mb-2" contenteditable="true" onpaste="app.handlePaste(event, 'entry')">
                <i data-lucide="image-plus" class="w-6 h-6 mb-1"></i>
                <span class="text-xs">Paste Entry Chart Here</span>
            </div>`;

            html += `<button onclick="app.saveToLog(${entry}, ${stopPrice}, ${masterShares})" class="w-full mt-4 text-white font-bold py-3 rounded-xl shadow-lg transition-colors ${btnColor}">
                ${btnText}
            </button>`;
        } else {
             html += `<div class="text-center text-red-400 p-4">Please set an Account Size in Settings</div>`;
        }

        resultsDiv.innerHTML = html;
        resultsDiv.classList.remove('hidden');
        resultsDiv.scrollIntoView({ behavior: 'smooth' });
        lucide.createIcons();
    },

    saveToLog(entry, stop, shares) {
        if(shares <= 0) alert("Warning: Master Account share count is 0. Log will have no initial quantity.");

        const { derisk13Price, derisk14Price, rate, impliedRiskPct } = this.data.tempCalculation || {};
        
        let stopMeta = null;
        if (this.data.settings.stopMode === 'staggered') {
            const validLevels = this.data.staggeredStops.filter(s => s.price > 0 && s.pct > 0).map(s => ({...s}));
            stopMeta = { mode: 'staggered', levels: validLevels };
        } else {
            stopMeta = { mode: 'single', price: parseFloat(document.getElementById('stopLoss').value) };
        }

        // NORMALIZE RISK VALUE: Always save as Equity %
        // If we are in Position mode, use the calculated implied risk %
        let finalRiskVal = this.data.settings.riskValue;
        let finalRiskMode = this.data.settings.riskMode;
        
        if (this.data.settings.riskMode === 'position' && impliedRiskPct) {
            finalRiskVal = parseFloat(impliedRiskPct.toFixed(2));
            finalRiskMode = 'equity'; // Normalize log to equity mode
        }

        // Check if Updating
        if (this.data.isEditingParams && this.data.editingId) {
            const existingIndex = this.data.logs.findIndex(l => l.id === this.data.editingId);
            if (existingIndex !== -1) {
                const oldLog = this.data.logs[existingIndex];
                
                
                const updatedLog = {
                    ...oldLog,
                    ticker: document.getElementById('ticker').value.toUpperCase(),
                    direction: this.data.settings.direction,
                    entry: entry,
                    stop: stop,
                    initialStop: oldLog.initialStop || stop, 
                    stopMeta: stopMeta,
                    initialQty: shares, // Updated Share Count
                    riskMode: finalRiskMode, // Normalized
                    riskVal: finalRiskVal,   // Normalized
                    strategy: document.getElementById('strategy').value,
                    notes: document.getElementById('notes').value,
                    exchangeRate: rate,
                    derisk13: derisk13Price,
                    derisk14: derisk14Price,
                    // Preserves: id, date, exits, outcome (mostly)
                    entryImg: this.data.tempCalculation.entryImgId // PATCH 6
                };
                
                this.data.logs[existingIndex] = updatedLog;
                this.data.isEditingParams = false;
                this.data.editingId = null;
                alert("Trade Updated");
                
                document.getElementById('mainActionBtn').textContent = "Calculate";
                document.getElementById('mainActionBtn').classList.remove('bg-amber-600');
                document.getElementById('mainActionBtn').classList.add('bg-blue-600');
            }
        } else {
            // New Entry
            const logEntry = {
                id: Date.now(),
                date: new Date().toISOString(), 
                ticker: document.getElementById('ticker').value.toUpperCase(),
                direction: this.data.settings.direction,
                entry: entry,
                stop: stop,
                initialStop: stop,  
                stopMeta: stopMeta, 
                initialQty: shares, 
                riskMode: finalRiskMode, // Normalized
                riskVal: finalRiskVal,   // Normalized
                strategy: document.getElementById('strategy').value,
                notes: document.getElementById('notes').value,
                outcome: 'open',
                exits: [], 
                exchangeRate: rate,
                derisk13: derisk13Price,
                derisk14: derisk14Price,
                entryImg: this.data.tempCalculation.entryImgId // PATCH 6
            };
            this.data.logs.unshift(logEntry);
            
            // Toast
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-emerald-500 text-white px-4 py-2 rounded shadow-lg z-50 animate-bounce';
            toast.textContent = "Trade Logged to Master!";
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
        this.updateStrategyFilter(); 
        
        // Refresh smart insights if needed
        this.generateInsights(this.data.logs);
        
        document.getElementById('calculationResults').classList.add('hidden');
        // We no longer clear Ticker and Price here immediately if user wants to tweak, 
        // but usually "Logged" implies done. Let's clear to keep UI fresh.
        // The Clear Inputs button is now available if they want to clear without logging.
        // But standard flow is Log -> Clear. 
        // Let's clear fields for next trade.
        document.getElementById('ticker').value = '';
        document.getElementById('purchasePrice').value = '';
    },
    
    editTradeParams() {
        const log = this.data.logs.find(l => l.id === this.data.editingId);
        if(!log) return;
        
        // 1. Populate Calculator Inputs
        document.getElementById('ticker').value = log.ticker;
        document.getElementById('purchasePrice').value = log.entry;
        
        // Set Direction
        this.setDirection(log.direction || 'LONG');
        
        // Set Stop
        if (log.stopMeta && log.stopMeta.mode === 'staggered') {
            this.setStopMode('staggered');
            // Populate staggered inputs
            log.stopMeta.levels.forEach((lvl, i) => {
                if (i < 2) { // Assuming 2 default slots, could expand
                    this.data.staggeredStops[i].price = lvl.price;
                    this.data.staggeredStops[i].pct = lvl.pct;
                }
            });
            this.renderStaggeredInputs();
        } else {
            this.setStopMode('single');
            document.getElementById('stopLoss').value = log.stop;
        }
        
        // Set Strategy & Notes
        document.getElementById('strategy').value = log.strategy;
        document.getElementById('notes').value = log.notes;
        
        // Set Risk Params
        if (log.riskMode === 'equity') {
            document.querySelector(`input[name="riskMode"][value="equity"]`).checked = true;
        } else {
            document.querySelector(`input[name="riskMode"][value="position"]`).checked = true;
        }
        this.toggleRiskMode(); // Update slider ranges
        const slider = document.getElementById('riskSlider');
        slider.value = log.riskVal;
        slider.dispatchEvent(new Event('input')); // Update label
        
        // 2. Set State
        this.data.isEditingParams = true;
        
        // 3. UI Changes
        const btn = document.getElementById('mainActionBtn');
        btn.textContent = "Update Calculation";
        btn.classList.remove('bg-blue-600');
        btn.classList.add('bg-amber-600');
        
        // 4. Switch View
        this.switchView('calculator');
        window.scrollTo(0,0);
    },

    // --- LOGS & MANAGEMENT ---
    
		// --- PATCH 3: LOGS VIEW (With Duration) ---

	// --- PATCH 16: P&L HELPER ---
    
    getPnl(log, exitPrice, qty) {
        // 1. Calculate Raw P&L in Trade Currency
        const rawPnl = log.direction === 'SHORT' 
            ? (log.entry - exitPrice) * qty 
            : (exitPrice - log.entry) * qty;
            
        // 2. Convert to Base Currency
        const rate = log.exchangeRate || 1;
        const basePnl = rawPnl / rate;
        
        // 3. Format
        const sym = this.getSymbol ? this.getSymbol(this.data.settings.baseCurrency) : "";
        return {
            val: basePnl,
            formatted: `${basePnl >= 0 ? '+' : '-'}${sym}${Math.abs(basePnl).toFixed(2)}`
        };
    },


    // --- PATCH 26: DYNAMIC DE-RISKING ENGINE ---

	// --- 1. THE UPDATED FUNCTION ---
	// --- 1. P&L HELPER (Required dependency) ---
    getPnl(log, exitPrice, qty) {
        if (!log || !exitPrice || !qty) return { val: 0, formatted: '-' };
        
        // Calculate Raw P&L in Trade Currency
        const rawPnl = log.direction === 'SHORT' 
            ? (log.entry - exitPrice) * qty 
            : (exitPrice - log.entry) * qty;
            
        // Convert to Base Currency
        const rate = log.exchangeRate || 1;
        const basePnl = rawPnl / rate;
        
        // Format
        const sym = this.getSymbol ? this.getSymbol(this.data.settings.baseCurrency) : "";
        return {
            val: basePnl,
            formatted: `${basePnl >= 0 ? '+' : ''}${sym}${Math.abs(basePnl).toFixed(2)}`
        };
    },

    // --- 2. RENDER HISTORY (The logic you liked) ---
    renderExitHistory(log) {
        const list = document.getElementById('exitHistoryList');
        if (!list) return; // Safety check

        if(!log.exits || log.exits.length === 0) {
            list.innerHTML = `<div class="text-center text-xs text-slate-500 py-4">No exits recorded yet.</div>`;
            return;
        }

        // Sort for display (Oldest to Newest)
        const sortedExits = log.exits.map((ex, i) => ({...ex, originalIdx: i})); 
        sortedExits.sort((a,b) => new Date(a.date) - new Date(b.date));

        list.innerHTML = sortedExits.map((ex) => {
            const riskPerShare = Math.abs(log.entry - log.stop);
            const pnlPerShare = log.direction === 'SHORT' ? (log.entry - ex.price) : (ex.price - log.entry);
            
            // Calculate R-Multiple
            const rVal = (riskPerShare > 0) ? (pnlPerShare / riskPerShare).toFixed(2) : "0.00";
            
            // Calculate P&L Amount
            const pnlObj = this.getPnl(log, ex.price, ex.qty);
            const pnlClass = pnlObj.val >= 0 ? 'text-emerald-400' : 'text-red-400';
            
            // Format Date
            const d = new Date(ex.date);
            const dateStr = `${d.getDate()}/${d.getMonth()+1} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;

            return `
            <div class="flex justify-between items-center bg-slate-900 p-2 rounded border border-slate-700 text-sm mb-1">
                <div>
                    <div class="text-[10px] text-slate-500 mb-0.5">${dateStr}</div>
                    <span class="font-bold text-white">${ex.qty} shares @ ${ex.price}</span>
                </div>
                <div class="text-right">
                    <div class="${parseFloat(rVal) >= 0 ? 'text-emerald-400' : 'text-red-400'} font-bold">${parseFloat(rVal) > 0 ? '+' : ''}${rVal}R</div>
                    <div class="${pnlClass} text-xs font-mono">${pnlObj.formatted}</div>
                    
                    <div class="flex gap-3 justify-end mt-1">
                        <button onclick="app.editExit(${ex.originalIdx})" class="text-[10px] text-blue-400 hover:text-white hover:underline">Edit</button>
                        <button onclick="app.removeExit(${ex.originalIdx})" class="text-[10px] text-slate-600 hover:text-red-500 hover:underline">Delete</button>
                    </div>
                </div>
            </div>`;
        }).join('');
    },

    // --- 3. OPEN MANAGE VIEW (Updated Layout) ---
    async openManageView(id) {
        this.data.editingId = id;
        const log = this.data.logs.find(l => l.id === id);
        if(!log) return;
        if(typeof log.currentStop === 'undefined') log.currentStop = log.stop;

        // --- CALCS ---
        const totalSold = log.exits ? log.exits.reduce((a,b) => a+b.qty, 0) : 0;
        const remaining = log.initialQty - totalSold;
        
        let realizedPnL = 0;
        if (log.exits) {
            log.exits.forEach(ex => {
                realizedPnL += (log.direction === 'SHORT' ? (log.entry - ex.price) : (ex.price - log.entry)) * ex.qty;
            });
        }

        const activeStop = (typeof log.currentStop === 'number') ? log.currentStop : log.stop;
        let riskDist = log.direction === 'LONG' ? Math.max(0, log.entry - activeStop) : Math.max(0, activeStop - log.entry);
        const grossRisk = remaining * riskDist;
        const currentNER = Math.max(0, grossRisk - realizedPnL);
        
        // NER Badge
        let nerPctString = "";
        const masterAcc = this.data.accounts.find(a => a.isMaster);
        const mSize = masterAcc ? masterAcc.size : 10000;

        if (currentNER > 0 && masterAcc && masterAcc.size > 0) {
            const rate = log.exchangeRate || 1;
            const pct = ((currentNER / rate) / masterAcc.size) * 100;
            nerPctString = `<span class="bg-amber-900/30 text-amber-500 text-[10px] px-2 py-0.5 rounded border border-amber-500/30 ml-2 font-bold animate-pulse">Contributing ${pct.toFixed(2)}% NER</span>`;
        }

        const currentPrice = log.currentPrice || log.entry;
        const posValueTrade = currentPrice * remaining;
        const posValueBase = posValueTrade / (log.exchangeRate || 1);
        const posPct = (posValueBase / mSize) * 100;
        const sym = this.getSymbol ? this.getSymbol(this.data.settings.baseCurrency) : "";
        const posSizeDisplay = `${sym}${Math.round(posValueBase).toLocaleString()} (${posPct.toFixed(2)}%)`;

        // De-Risk HTML
        let deriskHtml = '';
        if (remaining > 0) {
            if (currentNER <= 0) {
                deriskHtml = `
                <div class="card bg-emerald-900/10 border border-emerald-500/50 p-3 mb-4 rounded-xl flex items-center justify-center gap-2">
                    <i data-lucide="shield-check" class="w-5 h-5 text-emerald-400"></i>
                    <span class="text-sm font-bold text-emerald-400 uppercase tracking-wide">Trade De-Risked</span>
                </div>`;
            } else {
                const dirMult = log.direction === 'LONG' ? 1 : -1;
                const calcTarget = (denom) => {
                    const q = Math.floor(remaining / denom);
                    if (q <= 0) return { q: 0, p: 0 };
                    const profitPerShareNeeded = (currentNER / q) - riskDist;
                    let target = log.entry + (profitPerShareNeeded * dirMult);
                    return { q, p: target.toFixed(2) };
                };
                const t3 = calcTarget(3);
                const t4 = calcTarget(4);
                const t5 = calcTarget(5);
                const stopLabel = activeStop !== log.stop ? `Adjusted Stop` : `Original Stop`;

                deriskHtml = `
                <div class="card bg-slate-800/50 mb-4 rounded-xl border border-slate-700">
                    <div class="flex justify-between items-center p-3 cursor-pointer" onclick="document.getElementById('targetList').classList.toggle('hidden')">
                        <div>
                            <h3 class="text-xs font-bold text-slate-300 uppercase flex items-center">
                                <i data-lucide="crosshair" class="w-3 h-3 mr-1 text-blue-400"></i> De-Risk Targets
                            </h3>
                            <div class="text-[9px] text-slate-500 mt-0.5">Based on ${stopLabel}</div>
                        </div>
                        <div class="flex items-center">
                            ${nerPctString}
                            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 ml-2"></i>
                        </div>
                    </div>
                    <div id="targetList" class="p-3 pt-0 text-xs border-t border-slate-700/50">
                        <div class="flex justify-between items-center py-2 border-b border-slate-700/30"><span class="text-slate-400">Sell 1/3 (${t3.q}) @</span><span class="font-mono text-emerald-400 font-bold">${t3.p}</span></div>
                        <div class="flex justify-between items-center py-2 border-b border-slate-700/30"><span class="text-slate-400">Sell 1/4 (${t4.q}) @</span><span class="font-mono text-emerald-400 font-bold">${t4.p}</span></div>
                        <div class="flex justify-between items-center py-2"><span class="text-slate-400">Sell 1/5 (${t5.q}) @</span><span class="font-mono text-emerald-400 font-bold">${t5.p}</span></div>
                    </div>
                </div>`;
            }
        }

        const entryImgUrl = log.entryImg ? await imgDB.get(log.entryImg) : null;
        const exitImgUrl = log.exitImg ? await imgDB.get(log.exitImg) : null;

        const stratOptions = this.data.settings.strategies.map(s => 
            `<option value="${s}" ${s === log.strategy ? 'selected' : ''}>${s}</option>`
        ).join('');

        let totalPnlVal = 0;
        if(this.getPnl && log.exits) log.exits.forEach(ex => totalPnlVal += this.getPnl(log, ex.price, ex.qty).val);
        const totalPnlStr = `${totalPnlVal>=0?'+':''}${sym}${Math.abs(totalPnlVal).toFixed(2)}`;
        const totalPnlClass = totalPnlVal >= 0 ? 'text-emerald-400' : 'text-red-400';

        const qtyHtml = totalSold === 0 
            ? `<div class="flex items-center gap-1"><input type="number" id="manageEditQty" value="${log.initialQty}" class="bg-slate-800 border border-slate-600 rounded w-16 text-center text-sm font-bold text-white p-1"><button onclick="app.updateTradeQty()" class="bg-blue-900/50 text-blue-400 p-1 rounded hover:bg-blue-600 hover:text-white"><i data-lucide="save" class="w-3 h-3"></i></button></div>`
            : `<div class="font-bold text-white text-lg">${log.initialQty}</div>`;

        // Duration Logic
        let durationStr = "Active";
        if (log.outcome === 'open') {
             durationStr = this.formatDuration ? this.formatDuration(log.date) + " (Open)" : "Active";
        } else if (log.exits && log.exits.length > 0) {
            const sortedExits = [...log.exits].sort((a,b) => new Date(a.date) - new Date(b.date));
            durationStr = this.formatDuration ? this.formatDuration(log.date, sortedExits[sortedExits.length-1].date) : "-";
        }

        // --- RENDER ---
        document.getElementById('manageSummary').innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <div>
                    <input type="text" 
                        value="${log.ticker}" 
                        onchange="app.updateLogTicker(${log.id}, this.value)"
                        class="bg-transparent text-2xl font-black text-white uppercase border-b border-dashed border-slate-700 hover:border-blue-500 focus:border-blue-500 outline-none w-32 transition-colors mb-1">
                    
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-xs text-slate-400 ${log.direction==='LONG'?'text-emerald-400':'text-red-400'} border border-current px-1 rounded block w-fit">${log.direction}</span>
                        <span class="text-[10px] text-slate-500 font-mono italic">Held: ${durationStr}</span>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-slate-500 mb-1">ENTRY</div>
                    <input type="number" step="0.01" value="${log.entry}" 
                        onchange="app.updateLogEntry(${log.id}, this.value)"
                        class="bg-transparent font-mono text-lg font-bold text-white border-b border-dashed border-slate-700 hover:border-blue-500 focus:border-blue-500 outline-none w-24 text-right transition-colors">
                </div>
            </div>
            
            <div class="bg-slate-900/50 p-2 rounded-lg mb-2 flex justify-between items-center border border-slate-700/50">
                 <label class="text-[10px] text-slate-500 font-bold uppercase">Entry Date</label>
                 <input type="datetime-local" value="${log.date.substring(0, 16)}" 
                    onchange="app.updateLogDate(${id}, this.value)"
                    class="bg-transparent text-white text-sm font-mono focus:outline-none text-right">
            </div>

            <div class="bg-slate-900/50 p-2 rounded-lg mb-3 flex justify-between items-center border border-slate-700/50">
                 <label class="text-[10px] text-slate-500 font-bold uppercase">Strategy</label>
                 <select onchange="app.updateLogStrategy(${id}, this.value)" class="bg-transparent text-white text-sm font-bold focus:outline-none text-right cursor-pointer hover:text-blue-400 transition-colors">
                    <option value="">(None Set)</option>
                    ${stratOptions}
                 </select>
            </div>

            <div class="grid grid-cols-4 gap-2 text-center bg-slate-900/50 p-2 rounded-lg mb-3 items-center">
                <div class="flex flex-col items-center col-span-1">
                    <div class="text-[10px] text-slate-500 mb-1">QTY</div>${qtyHtml}
                </div>
                <div class="col-span-1">
                    <div class="text-[10px] text-slate-500">SOLD</div><div class="font-bold text-amber-400">${totalSold}</div>
                </div>
                <div class="col-span-1 border-r border-slate-700 pr-1">
                    <div class="text-[10px] text-slate-500">LEFT</div><div class="font-bold text-blue-400">${remaining}</div>
                </div>
                <div class="col-span-1">
                    <div class="text-[10px] text-slate-500">Secured P&L</div><div class="font-bold ${totalPnlClass} text-xs">${totalPnlStr}</div>
                </div>
            </div>

            <div class="bg-blue-900/20 p-3 rounded-lg border border-blue-500/30 mb-4">
                <div class="flex justify-between items-center mb-2 pb-2 border-b border-blue-500/20">
                     <label class="text-[10px] text-blue-300 font-bold uppercase">Manual Live Price</label>
                     <input type="number" step="any" value="${currentPrice}" 
                        onchange="app.updateLogCurrentPrice(${log.id}, this.value)"
                        class="bg-slate-900/50 border border-blue-500/30 rounded p-1 text-right text-xs text-white font-mono outline-none focus:border-blue-400 w-24">
                </div>
                <div class="flex justify-between items-center">
                     <span class="text-[10px] text-blue-300 font-bold uppercase">Position Value</span>
                     <span class="text-xs font-mono font-bold text-white">${posSizeDisplay}</span>
                </div>
            </div>
            
            <div class="bg-slate-900/50 p-3 rounded-lg mb-4 border border-slate-700/50">
                <div class="flex justify-between items-start gap-4">
                    <div class="text-left">
                        <div class="text-[10px] text-slate-500 font-bold uppercase mb-1">Original Stop</div>
                        <div class="font-mono text-slate-400 text-sm">${log.initialStop || log.stop}</div>
                    </div>
                    <div class="flex-1 text-right">
                         <label class="text-[10px] text-blue-400 uppercase font-bold block mb-1">Active Stop (Adjusted)</label>
                         <div class="flex items-center justify-end gap-2">
                             <input type="number" step="any" value="${activeStop}" id="manageCurrentStopInput"
                                class="w-24 bg-slate-800 border border-slate-600 rounded p-1 text-sm text-white font-mono focus:border-blue-500 outline-none text-right">
                             <button onclick="app.updateCurrentStop()" class="px-2 py-1 bg-slate-700 hover:bg-blue-600 text-white text-xs rounded transition-colors">Update</button>
                         </div>
                         <div class="text-[9px] text-slate-500 mt-1 italic">Updates Open Heat/NER only.</div>
                    </div>
                </div>
                </div>

            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-slate-900 p-2 rounded-xl border border-slate-700 text-center relative">
                    <div class="text-[10px] text-slate-500 mb-2 font-bold uppercase">Entry Chart</div>
                    ${entryImgUrl ? `<img src="${entryImgUrl}" class="rounded h-24 w-full object-cover cursor-pointer border border-slate-600" onclick="app.showImg('${entryImgUrl}')">` : `<div class="paste-zone h-24 min-h-0 border-slate-600" contenteditable="true" onpaste="app.handlePaste(event, 'entry-update', ${log.id})"><span class="text-[10px]">Paste Entry<br>Chart</span></div>`}
                </div>
                <div class="bg-slate-900 p-2 rounded-xl border border-slate-700 text-center relative">
                    <div class="text-[10px] text-slate-500 mb-2 font-bold uppercase">Closure Chart</div>
                    ${exitImgUrl ? `<img src="${exitImgUrl}" class="rounded h-24 w-full object-cover cursor-pointer border border-slate-600" onclick="app.showImg('${exitImgUrl}')">` : `<div class="paste-zone h-24 min-h-0 border-slate-600" contenteditable="true" onpaste="app.handlePaste(event, 'exit', ${log.id})"><span class="text-[10px]">Paste Exit<br>Chart</span></div>`}
                </div>
            </div>

            <button onclick="app.openReplay(${log.id})" class="w-full py-3 mb-4 rounded-xl bg-gradient-to-r from-blue-900/50 to-purple-900/50 border border-blue-500/30 text-blue-200 font-bold text-sm shadow-lg hover:brightness-110 transition-all flex items-center justify-center gap-2">
                <i data-lucide="play-circle" class="w-5 h-5"></i> Trade Replay
            </button>
            
            ${deriskHtml} 
        `;

        // --- INIT STATIC ELEMENTS ---
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const dInput = document.getElementById('exitInputDate');
        if(dInput) dInput.value = now.toISOString().slice(0, 16);
        
        const qInput = document.getElementById('exitInputQty');
        if(qInput) qInput.value = remaining > 0 ? remaining : '';
        const pInput = document.getElementById('exitInputPrice');
        if(pInput) pInput.value = '';

        if(this.cancelExitEdit) this.cancelExitEdit();
        if(this.renderExitHistory) this.renderExitHistory(log);

        // --- ADDED: RESTORED CONTEXT BOX ---
        const exitHistory = document.querySelector('#exitHistoryList').parentNode;
        if(exitHistory && !document.getElementById('manageNotesContainer')) {
            const notesDiv = document.createElement('div');
            notesDiv.id = 'manageNotesContainer';
            notesDiv.className = 'bg-slate-800 rounded-xl p-4 border border-slate-700 mt-4';
            notesDiv.innerHTML = `
                <h3 class="text-sm font-bold text-slate-300 mb-2 uppercase">Trade Context & Mental State</h3>
                <textarea id="manageLogNotes" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-sm text-slate-200 outline-none focus:border-blue-500" rows="3" placeholder="What were you thinking?">${log.notes || ''}</textarea>
            `;
            // Insert after exit history
            exitHistory.parentNode.insertBefore(notesDiv, exitHistory.nextSibling);
            
            // Attach Listener
            document.getElementById('manageLogNotes').addEventListener('change', (e) => {
                const l = app.data.logs.find(i => i.id === app.data.editingId);
                if(l) { 
                    l.notes = e.target.value; 
                    localStorage.setItem('tradeLogs', JSON.stringify(app.data.logs)); 
                }
            });
        } else if (document.getElementById('manageLogNotes')) {
            // Update if already exists
            document.getElementById('manageLogNotes').value = log.notes || '';
        }

        this.switchView('manage');
        lucide.createIcons();
    },

    // --- 2. REQUIRED HELPER FUNCTIONS (Paste these into class App too) ---
    updateLogTicker(id, val) {
        const log = this.data.logs.find(l => l.id === id);
        if(log && val) {
            log.ticker = val.toUpperCase();
            this.saveAndRefresh(id);
        }
    },
    updateLogEntry(id, val) {
        const log = this.data.logs.find(l => l.id === id);
        if(log && val) {
            log.entry = parseFloat(val);
            this.saveAndRefresh(id);
        }
    },
	updateLogCurrentPrice(id, val) {
        const log = this.data.logs.find(l => l.id === id);
        if(log && val) {
            log.currentPrice = parseFloat(val);
            this.saveAndRefresh(id);
        }
    },
    saveAndRefresh(id) {
        localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
        this.renderLogs();
        if(this.updateRiskBar) this.updateRiskBar();
        // Since we are in Page View, we just re-open the page
        this.openManageView(id);
    },

    // --- PATCH 27: CLEAN DECIMAL FIX ---

    addExit() {
        const log = this.data.logs.find(l => l.id === this.data.editingId);
        if(!log) return;

        const price = parseFloat(document.getElementById('exitInputPrice').value);
        const qty = parseInt(document.getElementById('exitInputQty').value);

        if(!price || !qty) return alert("Enter Price and Quantity");

        const totalSold = log.exits.reduce((a,b) => a+b.qty, 0);
        if(totalSold + qty > log.initialQty) {
            return alert(`Cannot sell ${qty}. Only ${log.initialQty - totalSold} remaining.`);
        }

        // 1. Calculate P&L for this chunk
        const pnlTradeCcy = log.direction === 'SHORT' 
            ? (log.entry - price) * qty 
            : (price - log.entry) * qty;
            
        // 2. Convert to Base Currency (using original Entry Rate)
        const rate = log.exchangeRate || 1;
        const pnlBaseCcy = pnlTradeCcy / rate;

        // 3. Update Master Account (FIXED: Limit to 2 decimals)
        const masterIdx = this.data.accounts.findIndex(a => a.isMaster);
        if(masterIdx !== -1) {
            // Get current size, add PnL, fix to 2 decimals, then parse back to number
            const newSize = this.data.accounts[masterIdx].size + pnlBaseCcy;
            this.data.accounts[masterIdx].size = parseFloat(newSize.toFixed(2));
            this.saveSettings(); 
        }

        // 4. Update Log
        log.exits.push({ price, qty, date: new Date().toISOString() });

        const newTotalSold = totalSold + qty;
        if(newTotalSold >= log.initialQty) log.outcome = 'profit'; 

        localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
        this.openManageView(this.data.editingId); 
        this.renderLogs(); 
       
        
        // Notify User
        const currency = this.data.settings.baseCurrency;
        const sign = pnlBaseCcy >= 0 ? '+' : '';
        alert(`Exit Logged. Master Account Updated: ${sign}${pnlBaseCcy.toFixed(2)} ${currency}`);
    },

    removeExit(idx) {
        const log = this.data.logs.find(l => l.id === this.data.editingId);
        if(!log) return;
        
        const ex = log.exits[idx];
        
        // 1. Reverse the P&L (Refund the account or take back the loss)
        const pnlTradeCcy = log.direction === 'SHORT' 
            ? (log.entry - ex.price) * ex.qty 
            : (ex.price - log.entry) * ex.qty;
            
        const rate = log.exchangeRate || 1;
        const pnlBaseCcy = pnlTradeCcy / rate;

        const masterIdx = this.data.accounts.findIndex(a => a.isMaster);
        if(masterIdx !== -1) {
            this.data.accounts[masterIdx].size -= pnlBaseCcy; // Reverse operation
            this.saveSettings();
        }

        // 2. Remove Exit
        log.exits.splice(idx, 1);
        if(log.exits.reduce((a,b)=>a+b.qty,0) < log.initialQty) log.outcome = 'open';

        localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
        this.openManageView(this.data.editingId);
       
        this.renderLogs();
    },

    deleteLog(id) {
        if(!confirm("Delete this entire trade record? Any P&L banked will be reversed from the Master Account.")) return;
        
        const log = this.data.logs.find(l => l.id === id);
        if(log && log.exits && log.exits.length > 0) {
            // Calculate Total Realized P&L to Reverse
            let totalPnlBase = 0;
            const rate = log.exchangeRate || 1;
            
            log.exits.forEach(ex => {
                const pnl = log.direction === 'SHORT' ? (log.entry - ex.price)*ex.qty : (ex.price - log.entry)*ex.qty;
                totalPnlBase += (pnl / rate);
            });

            const masterIdx = this.data.accounts.findIndex(a => a.isMaster);
            if(masterIdx !== -1) {
                this.data.accounts[masterIdx].size -= totalPnlBase;
                this.saveSettings();
            }
        }

        this.data.logs = this.data.logs.filter(l => l.id !== id);
        localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
        this.renderLogs();
        
    },

    // --- STATS LOGIC ---
    updateStrategyFilter() {
        const strategies = new Set(this.data.logs.map(l => l.strategy).filter(s => s));
        const sel = document.getElementById('statsFilter');
        sel.innerHTML = '<option value="ALL">All Strategies</option>' + 
            Array.from(strategies).map(s => `<option value="${s}">${s}</option>`).join('');
    },

	// --- PATCH 1: MATH ENGINE & HELPERS ---

    // New Helper: Format milliseconds into "2d 5h"
    formatDuration(startStr, endStr) {
        if(!startStr) return "-";
        const start = new Date(startStr);
        const end = endStr ? new Date(endStr) : new Date(); // If no end, use now
        const diff = end - start;
        
        if (diff < 0) return "-";
        const totalMinutes = Math.floor(diff / (1000 * 60));
        const days = Math.floor(totalMinutes / (60 * 24));
        const hours = Math.floor((totalMinutes % (60 * 24)) / 60);
        
        if (days > 0) return `${days}d ${hours}h`;
        if (hours > 0) return `${hours}h ${totalMinutes % 60}m`;
        return `${totalMinutes}m`;
    },

	// --- HELPER: DATE RANGE CALCULATOR ---
    getDateRangeFromFilter(filterVal) {
        const now = new Date();
        // Reset time to end of day for 'end' and start of day for 'start' logic
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        
        let start = null;
        let end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59); // End of today

        if (filterVal === 'THIS_WEEK') {
            // Monday as start
            const day = today.getDay() || 7; // Get current day (1=Mon, 7=Sun)
            if (day !== 1) today.setHours(-24 * (day - 1));
            start = today;
        } 
        else if (filterVal === 'LAST_WEEK') {
            const day = today.getDay() || 7;
            today.setHours(-24 * (day - 1)); // Go to this Monday
            today.setHours(-24 * 7); // Go back 7 days to prev Monday
            start = new Date(today);
            end = new Date(start);
            end.setHours(24 * 6 + 23, 59, 59); // End of next Sunday
        }
        else if (filterVal === 'THIS_MONTH') {
            start = new Date(now.getFullYear(), now.getMonth(), 1);
        }
        else if (filterVal === 'LAST_MONTH') {
            start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            end = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
        }
        else if (filterVal === 'YTD') {
            start = new Date(now.getFullYear(), 0, 1);
        }
        else if (filterVal === 'CUSTOM') {
            const cStart = document.getElementById('statsDateStart')?.value;
            const cEnd = document.getElementById('statsDateEnd')?.value;
            if (cStart) start = new Date(cStart);
            if (cEnd) {
                end = new Date(cEnd);
                end.setHours(23, 59, 59);
            }
        }
        
        return { start, end };
    },
	
	// --- PATCH 22: FIXED MATH ENGINE (SCOPE CORRECTION) ---

    calculateBatchStats(logs) {
        // 1. Global Accumulators (Always All Realized P&L for Net R / Total $)
        let totalNetR = 0;
        let largestWin = 0;
        let largestLoss = 0;

        // 2. Scoped Accumulators (Respects Toggle for Averages)
        let winCount = 0, lossCount = 0, scratchCount = 0;
        let totalWinR = 0, totalLossR = 0; 
        
        // Financials for Profit Factor (All > 0 inside scope)
        let scopeGrossProfit = 0;
        let scopeGrossLoss = 0;
        
        // Financials for Averages (Only > Threshold inside scope)
        let scopeWinAmt = 0;
        let scopeLossAmt = 0;

        // 3. Filter Logic
        const includePartialsInAvg = this.data.settings.statsIncludePartials === true;

        // A. Realized Set (Any trade with money banked) -> Used for Totals
        const realizedLogs = logs.filter(l => {
            return (l.exits && l.exits.length > 0) || (typeof l.exitPrice !== 'undefined');
        });

        // B. Average Set (Subset based on toggle) -> Used for Win Rate / Averages
        const averageLogs = includePartialsInAvg ? realizedLogs : realizedLogs.filter(l => {
             const totalSold = l.exits ? l.exits.reduce((a,b)=>a+b.qty,0) : 0;
             return l.outcome !== 'open' || (l.initialQty > 0 && totalSold >= l.initialQty);
        });

        // 4. Calculation Loop (Iterate ALL realized to capture Total Net R)
        realizedLogs.forEach(l => {
            // USE INITIAL STOP IF AVAILABLE, FALLBACK TO STOP
            const refStop = (typeof l.initialStop !== 'undefined') ? l.initialStop : l.stop;
            const riskPerShare = Math.abs(l.entry - refStop);

            const rate = l.exchangeRate || 1;
            
            let rTrade = 0;
            let pnlBase = 0;

            if(l.exits && l.exits.length > 0) {
                 const totalRisk = l.initialQty * riskPerShare;
                 let pnlTrade = 0;
                 l.exits.forEach(ex => {
                     pnlTrade += (l.direction === 'SHORT' ? (l.entry - ex.price) : (ex.price - l.entry)) * ex.qty;
                 });
                 if(totalRisk > 0) rTrade = pnlTrade / totalRisk;
                 pnlBase = pnlTrade / rate;
            } else if (l.exitPrice) {
                 const diff = (l.direction==='SHORT' ? (l.entry - l.exitPrice) : (l.exitPrice - l.entry));
                 rTrade = diff / riskPerShare;
                 pnlBase = (diff * l.initialQty) / rate;
            }

            // --- GLOBAL STATS (Wealth) ---
            // These always track the account reality, ignoring the toggle
            totalNetR += rTrade;
            if(pnlBase > largestWin) largestWin = pnlBase;
            if(pnlBase < largestLoss) largestLoss = pnlBase;

            // --- SCOPED STATS (Performance) ---
            // Only count if this trade belongs in the User's selected view (Strict/Dynamic)
            if (averageLogs.includes(l)) {
                
                // A. For Profit Factor (Gross sums of all P&L in scope)
                if (rTrade > 0) scopeGrossProfit += pnlBase;
                else scopeGrossLoss += pnlBase;

                // B. For Win/Loss Counts & Averages (Threshold Logic)
                // THE FIX: We strictly align Avg Win $ with the trades counted as Wins
                if (rTrade > 0.1) {
                    winCount++;
                    totalWinR += rTrade;
                    scopeWinAmt += pnlBase; // Only sum if classified as Win in this scope
                } else if (rTrade < -0.1) {
                    lossCount++;
                    totalLossR += Math.abs(rTrade);
                    scopeLossAmt += pnlBase; // Only sum if classified as Loss in this scope
                } else {
                    scratchCount++;
                    // Scratches contribute to PF (Gross Profit/Loss) but NOT to Avg Win/Loss Averages
                }
            }
        });

        // 5. Final Metrics
        const count = averageLogs.length; 
        const winRate = count > 0 ? (winCount / count) * 100 : 0;
        
        const avgWinR = winCount > 0 ? totalWinR / winCount : 0;
        const avgLossR = lossCount > 0 ? totalLossR / lossCount : 0;
        const rrr = avgLossR === 0 ? 0 : (avgWinR / avgLossR); 
        
        // Corrected Financial Averages (Using Scoped Amounts)
        const avgWinAmt = winCount > 0 ? scopeWinAmt / winCount : 0;
        const avgLossAmt = lossCount > 0 ? scopeLossAmt / lossCount : 0;

        const profitFactor = Math.abs(scopeGrossLoss) === 0 ? (scopeGrossProfit > 0 ? 999 : 0) : (scopeGrossProfit / Math.abs(scopeGrossLoss));
        
        const expectancy = count > 0 ? (totalWinR - totalLossR) / count : 0;

        return { 
            winRate, profitFactor, expectancy, count, scratchCount, logs: realizedLogs,
            totalNetR, 
            avgWinAmt, avgLossAmt, largestWin, largestLoss,
            avgWinR, avgLossR, rrr
        };
    },

	renderStats() {
        // 1. DUPLICATE KILLER
        const oldFilters = document.querySelectorAll('#statsFilter, #statsRecency');
        oldFilters.forEach(el => {
            if (!el.closest('#statsControls')) {
                const parentGrid = el.closest('.grid'); 
                if (parentGrid) parentGrid.remove();
                else el.remove();
            }
        });

        // 2. SAFE CAPTURE
        const ctrlContainer = document.getElementById('statsControls');
        const strategyFilter = ctrlContainer ? (document.getElementById('statsFilter')?.value || 'ALL') : 'ALL';
        const recencyFilter = ctrlContainer ? (document.getElementById('statsRecency')?.value || 'ALL') : 'ALL';
        const timeFilter = ctrlContainer ? (document.getElementById('statsTimeFilter')?.value || 'ALL') : 'ALL';
        
        const view = document.getElementById('view-stats');
        if (!view) return;

        // 3. SETUP CONTROLS
        let controlsDiv = document.getElementById('statsControls');
        if (!controlsDiv) {
            controlsDiv = document.createElement('div');
            controlsDiv.id = 'statsControls';
            controlsDiv.className = 'mb-6 mt-2 animate-in slide-in-from-top-2';
            
            const titleText = view.querySelector('h1, h2');
            if(titleText) {
                let headerRow = titleText;
                while(headerRow.parentElement && headerRow.parentElement.id !== 'view-stats') {
                    headerRow = headerRow.parentElement;
                }
                if (headerRow.nextSibling) view.insertBefore(controlsDiv, headerRow.nextSibling);
                else view.appendChild(controlsDiv);
            } else {
                view.prepend(controlsDiv);
            }
        }

        // 4. RENDER CONTROLS
        if (document.activeElement.tagName !== 'INPUT') {
            controlsDiv.innerHTML = `
            <div class="flex flex-wrap gap-1 items-center bg-slate-900/50 p-2 rounded-xl border border-slate-800">
                <select id="statsFilter" onchange="app.renderStats()" class="bg-slate-800 border border-slate-700 rounded py-1.5 px-2 text-xs text-white outline-none focus:border-blue-500 transition-all cursor-pointer hover:bg-slate-700 max-w-[120px]">
                    <option value="ALL">All Strategies</option>
                    ${this.data.settings.strategies.map(s => `<option value="${s}" ${s === strategyFilter ? 'selected' : ''}>${s}</option>`).join('')}
                </select>

                <select id="statsRecency" onchange="app.handleStatFilterChange('RECENCY')" class="bg-slate-800 border border-slate-700 rounded py-1.5 px-2 text-xs text-white outline-none focus:border-blue-500 transition-all cursor-pointer hover:bg-slate-700 ${recencyFilter!=='ALL'?'text-blue-400 font-bold':''}">
                    <option value="ALL">All History</option>
                    <option value="10" ${recencyFilter === '10' ? 'selected' : ''}>Last 10</option>
                    <option value="20" ${recencyFilter === '20' ? 'selected' : ''}>Last 20</option>
                    <option value="50" ${recencyFilter === '50' ? 'selected' : ''}>Last 50</option>
                    <option value="100" ${recencyFilter === '100' ? 'selected' : ''}>Last 100</option>
                </select>

                <select id="statsTimeFilter" onchange="app.handleStatFilterChange('TIME')" class="bg-slate-800 border border-slate-700 rounded py-1.5 px-2 text-xs text-white outline-none focus:border-blue-500 transition-all cursor-pointer hover:bg-slate-700 ${timeFilter!=='ALL'?'text-amber-400 font-bold':''}">
                    <option value="ALL">All Dates</option>
                    <option value="THIS_WEEK" ${timeFilter === 'THIS_WEEK' ? 'selected' : ''}>This Week</option>
                    <option value="LAST_WEEK" ${timeFilter === 'LAST_WEEK' ? 'selected' : ''}>Last Week</option>
                    <option value="THIS_MONTH" ${timeFilter === 'THIS_MONTH' ? 'selected' : ''}>This Month</option>
                    <option value="LAST_MONTH" ${timeFilter === 'LAST_MONTH' ? 'selected' : ''}>Last Month</option>
                    <option value="YTD" ${timeFilter === 'YTD' ? 'selected' : ''}>YTD</option>
                    <option value="CUSTOM" ${timeFilter === 'CUSTOM' ? 'selected' : ''}>Custom</option>
                </select>

                <div id="statsCustomDates" class="${timeFilter === 'CUSTOM' ? 'flex' : 'hidden'} gap-1 items-center animate-in fade-in bg-slate-800 px-2 py-1 rounded border border-slate-700 ml-1">
                    <input type="date" id="statsDateStart" value="${this.tempStart||''}" onchange="app.renderStats()" class="bg-transparent text-[10px] text-white outline-none font-mono w-20">
                    <span class="text-slate-500">-</span>
                    <input type="date" id="statsDateEnd" value="${this.tempEnd||''}" onchange="app.renderStats()" class="bg-transparent text-[10px] text-white outline-none font-mono w-20">
                </div>
            </div>`;
        }

        // Capture Inputs
        if(timeFilter === 'CUSTOM') {
            const sEl = document.getElementById('statsDateStart');
            const eEl = document.getElementById('statsDateEnd');
            if(sEl) this.tempStart = sEl.value;
            if(eEl) this.tempEnd = eEl.value;
        }

        // 5. FILTERING
        let baseLogs = [...this.data.logs];

        if(strategyFilter !== 'ALL') {
            baseLogs = baseLogs.filter(l => l.strategy === strategyFilter);
        }

        if(timeFilter !== 'ALL') {
            const { start, end } = this.getDateRangeFromFilter(timeFilter);
            if (start) {
                baseLogs = baseLogs.filter(l => {
                    if (l.outcome === 'open') return true; 
                    const d = new Date(l.date);
                    if (end) return d >= start && d <= end;
                    return d >= start;
                });
            }
        }

        let closedLogs = baseLogs.filter(l => l.outcome !== 'open');
        closedLogs.sort((a,b) => new Date(b.date) - new Date(a.date));
        
        if (recencyFilter !== 'ALL' && timeFilter === 'ALL') {
            const limit = parseInt(recencyFilter);
            closedLogs = closedLogs.slice(0, limit);
        }

        const openLogs = baseLogs.filter(l => l.outcome === 'open');
        const reportingLogs = [...openLogs, ...closedLogs];
        reportingLogs.sort((a,b) => new Date(a.date) - new Date(b.date));

        // 6. STATS CALCS
        const baseline = this.calculateBatchStats(this.data.logs);
        const current = this.calculateBatchStats(reportingLogs);

        // --- BUG FIX: Removed faulty "Specific R-Multiple Calculations" block ---
        // We now rely purely on the robust calculateBatchStats result
        const avgWinR = current.avgWinR;
        const avgLossR = current.avgLossR;
        // ------------------------------------------------------------------------

        // 7. HEADER STATS
        const partialsOn = this.data.settings.statsIncludePartials;
        const isFiltered = (strategyFilter !== 'ALL' || recencyFilter !== 'ALL' || timeFilter !== 'ALL');
        
        const splitIcon = partialsOn ? `<i data-lucide="split" class="w-3 h-3 text-blue-400" title="Includes Partials"></i>` : '';
        const filterIcon = isFiltered ? `<i data-lucide="filter" class="w-3 h-3 text-amber-400" title="Filtered View"></i>` : '';

        const updateHeader = (elmId, text) => {
            const el = document.getElementById(elmId);
            if(el && el.previousElementSibling) {
                el.previousElementSibling.innerHTML = `
                    <div class="flex items-center gap-1.5">
                        <span>${text}</span>
                        ${filterIcon}
                        ${splitIcon}
                    </div>
                `;
            }
        };

        const renderDiff = (elId, curr, base, type) => {
            const el = document.getElementById(elId);
            if (!el) return;
            if (base.count === 0 || curr.count === 0) { el.innerHTML = ''; return; }
            const diff = curr - base;
            if(Math.abs(diff) < 0.01) { el.innerHTML = '<span class="text-slate-500">= No Change</span>'; return; }
            const isBetter = diff > 0;
            const color = isBetter ? 'text-emerald-400' : 'text-red-400';
            const iconChar = isBetter ? '' : '';
            let text = type === '%' ? `${Math.abs(diff).toFixed(1)}%` : type === 'R' ? `${Math.abs(diff).toFixed(2)}R` : `${Math.abs(diff).toFixed(2)}`;
            el.innerHTML = `<span class="${color} bg-slate-900/50 px-1 rounded">${iconChar} ${text} vs Avg</span>`;
        };

        document.getElementById('statWinRate').textContent = `${Math.round(current.winRate)}%`;
        updateHeader('statWinRate', 'Win Rate'); 
        renderDiff('statWinRateDiff', current.winRate, baseline.winRate, '%');

        document.getElementById('statPF').textContent = current.profitFactor >= 999 ? "" : current.profitFactor.toFixed(2);
        updateHeader('statPF', 'Profit Factor'); 
        renderDiff('statPFDiff', current.profitFactor, baseline.profitFactor, 'x');

        document.getElementById('statExpectancy').textContent = `${current.expectancy > 0 ? '+' : ''}${current.expectancy.toFixed(2)}R`;
        updateHeader('statExpectancy', 'Expectancy');
        renderDiff('statExpectancyDiff', current.expectancy, baseline.expectancy, 'R');

        const scratchText = current.scratchCount > 0 ? `<span class="text-slate-500 text-[9px]">(${current.scratchCount} Scratch)</span>` : '';
        document.getElementById('statTotal').innerHTML = `${current.count} <div class="text-[9px] text-slate-500 mt-1">Trades ${scratchText}</div>`;
        updateHeader('statTotal', 'Trades');


        // --- FINANCIAL PERFORMANCE & EDGE EFFICIENCY (Dashboard Layout) ---
        const baseSym = this.getSymbol ? this.getSymbol(this.data.settings.baseCurrency) : this.data.settings.baseCurrency;
        const financialTarget = document.getElementById('financialStatsTarget');
        const hidePnL = this.data.settings.hidePnL || false;
        
        const dirStats = document.getElementById('directionStats');
        if(dirStats) dirStats.innerHTML = ''; // Clear old slot

        const fmtMoney = (val) => {
            if (hidePnL) return '<span class="opacity-50 blur-[2px]">****</span>';
            return `${baseSym}${Math.abs(val).toFixed(0)}`;
        };
        const icon = partialsOn ? '<i data-lucide="split" class="w-3 h-3 inline text-slate-500"></i>' : '';

        if (financialTarget) {
            financialTarget.innerHTML = `
            <div class="grid grid-cols-2 gap-3 mb-6 animate-in slide-in-from-bottom-4 fade-in">
                
                <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 col-span-2">
                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2">
                        <i data-lucide="coins" class="w-4 h-4 text-amber-400"></i> Financial Performance
                    </h4>
                    <div class="grid grid-cols-4 gap-2 text-center">
                        <div class="bg-slate-900/30 rounded p-2">
                            <div class="text-[9px] text-slate-500 uppercase">Avg Win ${icon}</div>
                            <div class="text-sm font-mono text-emerald-400 font-bold">${fmtMoney(current.avgWinAmt)}</div>
                        </div>
                        <div class="bg-slate-900/30 rounded p-2">
                            <div class="text-[9px] text-slate-500 uppercase">Avg Loss ${icon}</div>
                            <div class="text-sm font-mono text-red-400 font-bold">${fmtMoney(current.avgLossAmt)}</div>
                        </div>
                        <div class="bg-slate-900/30 rounded p-2">
                            <div class="text-[9px] text-slate-500 uppercase">Max Win</div>
                            <div class="text-sm font-mono text-emerald-400 font-bold">${fmtMoney(current.largestWin)}</div>
                        </div>
                        <div class="bg-slate-900/30 rounded p-2">
                            <div class="text-[9px] text-slate-500 uppercase">Max Loss</div>
                            <div class="text-sm font-mono text-red-400 font-bold">${fmtMoney(current.largestLoss)}</div>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 col-span-2">
                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2">
                        <i data-lucide="swords" class="w-4 h-4 text-purple-400"></i> Edge & Efficiency
                    </h4>
                    <div class="grid grid-cols-4 gap-2 text-center">
                        <div class="bg-slate-900/50 rounded p-2">
                            <div class="text-[9px] text-slate-500 uppercase">Total Net R</div>
                            <div class="text-lg font-bold ${current.totalNetR >= 0 ? 'text-blue-400':'text-red-400'}">${current.totalNetR > 0 ? '+':''}${current.totalNetR.toFixed(1)}R</div>
                        </div>
                        <div class="bg-slate-900/50 rounded p-2">
                            <div class="text-[9px] text-slate-500 uppercase">RRR ${icon}</div>
                            <div class="text-lg font-bold text-white">1 : ${current.rrr.toFixed(2)}</div>
                        </div>
                        <div class="bg-slate-900/50 rounded p-2">
                            <div class="text-[9px] text-slate-500 uppercase">Avg Win R ${icon}</div>
                            <div class="text-lg font-bold text-emerald-400">+${avgWinR.toFixed(2)}R</div>
                        </div>
                        <div class="bg-slate-900/50 rounded p-2">
                            <div class="text-[9px] text-slate-500 uppercase">Avg Loss R ${icon}</div>
                            <div class="text-lg font-bold text-red-400">-${Math.abs(avgLossR).toFixed(2)}R</div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // 8. CHARTS & TOGGLES
        const ddChart = document.getElementById('chartDrawdown');
        const ddWrapper = ddChart?.parentElement;
        const ddHeader = ddWrapper?.previousElementSibling;

        if(ddHeader && ddHeader.tagName === 'H3' && !ddHeader.querySelector('.dd-toggles')) {
            const oldToggles = ddWrapper.querySelector('.dd-toggles');
            if(oldToggles) oldToggles.remove();

            const toggles = document.createElement('div');
            toggles.className = 'dd-toggles flex gap-1 ml-auto';
            toggles.innerHTML = `
                <button onclick="app.toggleDrawdownMode('pct')" id="btnDD_pct" class="text-[9px] px-2 py-1 rounded bg-blue-600 text-white font-bold border border-blue-500">%</button>
                <button onclick="app.toggleDrawdownMode('r')" id="btnDD_r" class="text-[9px] px-2 py-1 rounded bg-slate-800 text-slate-400 font-bold border border-slate-700">R</button>
                <button onclick="app.toggleDrawdownMode('amt')" id="btnDD_amt" class="text-[9px] px-2 py-1 rounded bg-slate-800 text-slate-400 font-bold border border-slate-700">$</button>
            `;
            ddHeader.appendChild(toggles);
        }

        this.drawGrowthChart(reportingLogs);
        this.drawWinLossChart(reportingLogs);
        
        if(!this.ddMode) this.ddMode = 'pct';
        this.drawDrawdownChart(reportingLogs);
        
        this.drawStrategyChart(reportingLogs);
        this.drawDayOfWeekChart(reportingLogs);
        this.drawMonthlyChart(reportingLogs); 
        this.drawDurationChart(reportingLogs);
        this.drawDistributionChart(reportingLogs);
        
        this.drawContributionChart(reportingLogs); 
        this.drawConsistencyHeatmap(reportingLogs); 
        
        this.generateInsights(reportingLogs);
        lucide.createIcons();
    },

    drawDurationChart(logs) {
        const ctx = document.getElementById('chartDuration');
        if(!ctx) return; // Prevents crash if HTML is missing
        if(this.charts.duration) this.charts.duration.destroy();

        const dataPoints = [];
        const pointColors = [];
        const labels = []; 

        logs.forEach(l => {
            // Must have exits to calculate duration
            if (!l.exits || l.exits.length === 0) return;
            
            // Calculate R
            let netR = 0;
            const riskPerShare = Math.abs(l.entry - l.stop);
            const totalRisk = l.initialQty * riskPerShare;
            let pnl = 0;
            
            // Find last exit time
            const sortedExits = [...l.exits].sort((a,b) => new Date(a.date) - new Date(b.date));
            const lastExit = sortedExits[sortedExits.length - 1];
            
            l.exits.forEach(ex => {
                 pnl += (l.direction === 'SHORT' ? (l.entry - ex.price) : (ex.price - l.entry)) * ex.qty;
            });
            
            if(totalRisk > 0) netR = pnl / totalRisk;
            
            // Calculate Duration
            const entryTime = new Date(l.date).getTime();
            if(!lastExit.date) return;
            const exitTime = new Date(lastExit.date).getTime();
            const durationMins = (exitTime - entryTime) / 1000 / 60; 

            if(durationMins > 0) {
                dataPoints.push({ x: durationMins, y: netR });
                pointColors.push(netR >= 0 ? 'rgba(52, 211, 153, 0.7)' : 'rgba(248, 113, 113, 0.7)');
                labels.push(`${l.ticker} (${l.strategy || 'N/A'})`);
            }
        });

        this.charts.duration = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Trade',
                    data: dataPoints,
                    backgroundColor: pointColors,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const idx = context.dataIndex;
                                const r = context.raw.y.toFixed(2);
                                const min = Math.round(context.raw.x);
                                return `${labels[idx]}: ${r}R in ${min}m`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        title: { display: true, text: 'Mins', color: '#64748b' },
                        grid: { color: '#334155' },
                        ticks: { color: '#94a3b8' }
                    },
                    y: {
                        title: { display: true, text: 'R', color: '#64748b' },
                        grid: { color: '#334155' },
                        ticks: { color: '#94a3b8' }
                    }
                }
            }
        });
    },
    
	drawDistributionChart(logs) {
        const ctx = document.getElementById('chartDistribution');
        if(!ctx) return;
        if(this.charts.distribution) this.charts.distribution.destroy();

        // 7 Bins: 
        // 0: Disaster (<-1.2)
        // 1: Full Stop (-1.2 to -0.8)
        // 2: Small Loss (-0.8 to -0.2) 
        // 3: Scratch/BE (-0.2 to 0.2)
        // 4: Base Hit (0.2 to 1.3)
        // 5: Target Hit (1.3 to 2.3)
        // 6: Home Run (> 2.3)
        const bins = [0, 0, 0, 0, 0, 0, 0];
        const labels = ['<-1R', '-1R', 'Small Loss', 'Scratch', '1R', '2R', '3R+'];
        
        logs.forEach(l => {
             // Calculate R
             let r = 0;
             const riskPerShare = Math.abs(l.entry - l.stop);
             
             if(l.exits && l.exits.length > 0) {
                 const totalRisk = l.initialQty * riskPerShare;
                 let pnl = 0;
                 l.exits.forEach(ex => pnl += (l.direction==='SHORT'?l.entry-ex.price : ex.price-l.entry)*ex.qty);
                 if(totalRisk > 0) r = pnl/totalRisk;
             } else if (l.exitPrice) {
                 r = (l.direction==='SHORT'?l.entry-l.exitPrice : l.exitPrice-l.entry)/riskPerShare;
             } else {
                 return; // Skip open trades
             }

             // Sort into Bins
             if (r < -1.2) bins[0]++;
             else if (r >= -1.2 && r < -0.8) bins[1]++;
             else if (r >= -0.8 && r < -0.2) bins[2]++;
             else if (r >= -0.2 && r <= 0.2) bins[3]++;
             else if (r > 0.2 && r < 1.3) bins[4]++;
             else if (r >= 1.3 && r < 2.3) bins[5]++;
             else if (r >= 2.3) bins[6]++;
        });

        // Color coding: Red for bad losses, Gray for scratch, Green for wins
        const colors = [
            '#7f1d1d', // Deep Red (Disaster)
            '#ef4444', // Red (Full Stop)
            '#fca5a5', // Pale Red (Small Loss)
            '#94a3b8', // Gray (BE)
            '#34d399', // Green (1R)
            '#10b981', // Emerald (2R)
            '#059669'  // Dark Green (3R+)
        ];

        this.charts.distribution = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Trades',
                    data: bins,
                    backgroundColor: colors,
                    borderRadius: 4,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.raw} Trades`
                        }
                    }
                },
                scales: { 
                    y: { 
                        grid: { color: '#334155' },
                        ticks: { stepSize: 1, color: '#94a3b8' },
                        title: { display: true, text: 'Count', color: '#64748b' }
                    }, 
                    x: { 
                        grid: { display: false },
                        ticks: { color: '#94a3b8', font: { size: 11, weight: 'bold' } } 
                    } 
                }
            }
        });
    },
	
	
    // --- PATCH 33: ROBUST INSIGHTS ENGINE ---
    generateInsights(logs) {
        const container = document.getElementById('smartInsightsList');
        if(!container) return; // Safety check

        const filter = document.getElementById('statsFilter').value;
        const recency = document.getElementById('statsRecency').value; 

        // 1. Calculate Stats
        const stats = this.calculateBatchStats(logs); 
        
        // Safety: Ensure we have enough data
        if(!stats || stats.count < 3) {
            container.innerHTML = `<div class="text-center italic opacity-50">Log at least 3 closed trades to unlock AI insights.</div>`;
            return;
        }

        const insights = [];

        // HELPER: HTML Generator
        const createCard = (color, title, text) => {
            const colors = {
                emerald: 'border-emerald-500 text-emerald-400',
                amber: 'border-amber-500 text-amber-400',
                blue: 'border-blue-500 text-blue-400',
                purple: 'border-purple-500 text-purple-400'
            };
            return `<div class="insight-card border-l-2 pl-3 py-2 bg-slate-900/50 rounded-r mb-2 ${colors[color]}">
                <strong class="block text-[10px] uppercase opacity-80 mb-0.5">${title}</strong>
                <span class="block leading-snug">${text}</span>
            </div>`;
        };

        // 1. Profit Factor Health (Check existence)
        if (typeof stats.profitFactor === 'number') {
            if (stats.profitFactor >= 2.0) {
                insights.push(createCard('emerald', 'Robust System', `Your Profit Factor is a strong <strong>${stats.profitFactor.toFixed(2)}</strong>. You are extracting $2+ for every $1 lost.`));
            } else if (stats.profitFactor < 1.0) {
                insights.push(createCard('amber', 'System Leak', `Profit Factor is below 1.0 (${stats.profitFactor.toFixed(2)}). Your losses are currently outpacing your winners.`));
            }
        }

        // 2. Scratch Defense (Check existence)
        if (typeof stats.scratchCount === 'number') {
            const scratchRate = (stats.scratchCount / (stats.count + stats.scratchCount)) * 100;
            if (scratchRate > 25) {
                insights.push(createCard('blue', 'High Defense', `You are scratching often (<strong>${Math.round(scratchRate)}%</strong> of trades). This shows discipline, but ensure you aren't choking winners too early.`));
            }
        }

        // 3. Efficiency (Avg Win vs Avg Loss R)
        const winSize = stats.avgWinR || 0;
        const lossSize = stats.avgLossR || 0; 
        
        if (winSize > 0 && lossSize > 0) {
            if (winSize > lossSize * 2) {
                insights.push(createCard('emerald', 'High Efficiency', `Your average winner (${winSize.toFixed(2)}R) is <strong>>2x larger</strong> than your average loser.`));
            } else if (lossSize > winSize) {
                insights.push(createCard('amber', 'Negative Skew', `Warning: Average loss (${lossSize.toFixed(2)}R) is bigger than average win (${winSize.toFixed(2)}R).`));
            }
        }

        // 4. Strategy Analysis
        if(filter === 'ALL') {
            const sMap = {};
            logs.forEach(l => {
                if(!l.strategy) return;
                const rObj = this.calculateBatchStats([l]); 
                if(!sMap[l.strategy]) sMap[l.strategy] = 0;
                sMap[l.strategy] += rObj.totalNetR;
            });
            
            let bestS = null, maxR = -Infinity;
            Object.keys(sMap).forEach(k => { if(sMap[k] > maxR) { maxR = sMap[k]; bestS = k; } });
            
            if(bestS && maxR > 0) {
                insights.push(createCard('blue', 'MVP Strategy', `<strong>${bestS}</strong> is driving your performance with <strong>+${maxR.toFixed(1)}R</strong> total return.`));
            }
        } else {
            const globalStats = this.calculateBatchStats(this.data.logs);
            const globalWinRate = globalStats.winRate || 0;
            const currentWinRate = stats.winRate || 0;
            const diff = currentWinRate - globalWinRate;

            if(diff > 5) {
                insights.push(createCard('blue', 'Outperformer', `<strong>${filter}</strong> wins ${Math.round(diff)}% more often than your global average.`));
            } else if (diff < -5) {
                insights.push(createCard('blue', 'Underperformer', `<strong>${filter}</strong> has a lower win rate (${Math.round(currentWinRate)}%) than your average (${Math.round(globalWinRate)}%).`));
            }
        }

        // 5. Seasonality
        if (recency === 'ALL') {
            const monthMap = {};
            logs.forEach(l => {
                 const d = new Date(l.date);
                 if (isNaN(d)) return;
                 const m = d.toLocaleString('default', {month:'long'});
                 const rObj = this.calculateBatchStats([l]); 
                 if(!monthMap[m]) monthMap[m] = 0;
                 monthMap[m] += rObj.totalNetR;
            });
            
            let bestM = null, maxM = -Infinity;
            Object.keys(monthMap).forEach(k => { if(monthMap[k] > maxM) { maxM = monthMap[k]; bestM = k; } });
            
            if(bestM && maxM > 2) {
                insights.push(createCard('purple', 'Seasonality', `<strong>${bestM}</strong> is historically your strongest month (+${maxM.toFixed(1)}R).`));
            }
        }

        // Render
        if(insights.length === 0) {
             container.innerHTML = `<div class="text-center text-slate-500 text-[10px]">No significant patterns found in this dataset.</div>`;
        } else {
             container.innerHTML = insights.join('');
        }
    },

    toggleDrawdownMode(mode) {
        this.ddMode = mode;
        
        // Update Buttons Styling
        ['pct','r','amt'].forEach(m => {
            const btn = document.getElementById(`btnDD_${m}`);
            if(btn) {
                if(m === mode) btn.className = 'text-[9px] px-2 py-1 rounded bg-blue-600 text-white font-bold border border-blue-500';
                else btn.className = 'text-[9px] px-2 py-1 rounded bg-slate-800 text-slate-400 font-bold border border-slate-700';
            }
        });

        // Re-render just the chart (forces a full re-render of stats to be safe and use current logs)
        this.renderStats(); 
    },
	
	// --- PATCH 7: DYNAMIC CURRENCY LABEL FIX ---

    drawGrowthChart(logs) {
        const ctx = document.getElementById('chartGrowth');
        if (this.charts.growth) this.charts.growth.destroy();

        // 1. WRAPPER ENGINE
        let wrapper = document.getElementById('chartGrowthWrapper');
        if (!wrapper) {
            wrapper = document.createElement('div');
            wrapper.id = 'chartGrowthWrapper';
            wrapper.style.position = 'relative';
            wrapper.style.width = '100%';
            wrapper.style.height = '250px'; 
            
            ctx.parentNode.insertBefore(wrapper, ctx);
            wrapper.appendChild(ctx);
        }

        // 2. TOGGLE BUTTONS
        const card = wrapper.parentElement;
        if (!document.getElementById('growthToggleContainer')) {
            const controls = document.createElement('div');
            controls.id = 'growthToggleContainer';
            controls.className = 'flex justify-end mb-2';
            controls.innerHTML = `
                <div class="flex bg-slate-900 rounded-lg p-1 border border-slate-700">
                    <button onclick="app.toggleGrowthMode('R')" id="btn-mode-R" class="px-3 py-1 text-[10px] font-bold rounded transition-colors text-slate-400 hover:text-white">R</button>
                    <button onclick="app.toggleGrowthMode('PCT')" id="btn-mode-PCT" class="px-3 py-1 text-[10px] font-bold rounded transition-colors text-slate-400 hover:text-white">%</button>
                    <button onclick="app.toggleGrowthMode('CCY')" id="btn-mode-CCY" class="px-3 py-1 text-[10px] font-bold rounded transition-colors text-slate-400 hover:text-white">${this.data.settings.baseCurrency}</button>
                </div>`;
            card.insertBefore(controls, wrapper);
        }

        // --- THE FIX: Force Update Button Text ---
        const ccyBtn = document.getElementById('btn-mode-CCY');
        if(ccyBtn) ccyBtn.textContent = this.data.settings.baseCurrency; 
        // ----------------------------------------

        // 3. UPDATE BUTTON STYLES
        ['R', 'PCT', 'CCY'].forEach(m => {
            const btn = document.getElementById(`btn-mode-${m}`);
            if (btn) {
                if (this.growthMode === m) {
                    btn.className = 'px-3 py-1 text-[10px] font-bold rounded bg-blue-600 text-white shadow';
                } else {
                    btn.className = 'px-3 py-1 text-[10px] font-bold rounded text-slate-500 hover:bg-slate-800 hover:text-white';
                }
            }
        });

        // 4. DATA PREPARATION
        const sorted = [...logs].sort((a, b) => new Date(a.date) - new Date(b.date));
        
        let accumulator = 0;
        const dataPoints = [];
        const labels = [];
        const baseSym = this.getSymbol ? this.getSymbol(this.data.settings.baseCurrency) : "";

        if(sorted.length > 0) {
            labels.push('');
            dataPoints.push(0);
        }

        sorted.forEach(l => {
            if (l.outcome === 'open' && (!l.exits || l.exits.length === 0)) return;

            let valToAdd = 0;
            const riskPerShare = Math.abs(l.entry - l.stop);
            const rate = l.exchangeRate || 1;

            let netR = 0;
            let pnlBase = 0;

            if (l.exits && l.exits.length > 0) {
                const totalRisk = l.initialQty * riskPerShare;
                let pnlTrade = 0;
                l.exits.forEach(ex => {
                    pnlTrade += (l.direction === 'SHORT' ? (l.entry - ex.price) : (ex.price - l.entry)) * ex.qty;
                });
                if (totalRisk > 0) netR = pnlTrade / totalRisk;
                pnlBase = pnlTrade / rate;
            } else if (l.exitPrice) {
                const diff = (l.direction === 'SHORT' ? (l.entry - l.exitPrice) : (l.exitPrice - l.entry));
                netR = diff / riskPerShare;
                pnlBase = (diff * l.initialQty) / rate;
            }

            if (this.growthMode === 'R') {
                valToAdd = netR;
            } else if (this.growthMode === 'PCT') {
                const riskFactor = l.riskMode === 'equity' ? l.riskVal : 1.0; 
                valToAdd = netR * riskFactor;
            } else {
                valToAdd = pnlBase;
            }

            if (valToAdd !== 0) {
                accumulator += valToAdd;
                labels.push(l.date.substring(5, 10));
                dataPoints.push(accumulator);
            }
        });

        // 5. CHART CONFIG
        let color = '#10b981';
        let label = 'Growth (R)';
        if (this.growthMode === 'PCT') { color = '#3b82f6'; label = 'Growth (%)'; } 
        if (this.growthMode === 'CCY') { color = '#f59e0b'; label = `P&L (${baseSym})`; }

        this.charts.growth = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: dataPoints,
                    borderColor: color,
                    backgroundColor: color + '20', 
                    tension: 0.3,
                    fill: true,
                    pointRadius: 2,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, 
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const val = context.raw;
                                if (this.growthMode === 'R') return `${val.toFixed(2)}R`;
                                if (this.growthMode === 'PCT') return `${val.toFixed(2)}%`;
                                return `${baseSym}${val.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
                            }
                        }
                    }
                },
                scales: {
                    x: { display: false },
                    y: {
                        grid: { color: '#334155' },
                        grace: '10%',
                        ticks: {
                            color: '#94a3b8',
                            maxTicksLimit: 6,
                            callback: (val) => {
                                if (this.growthMode === 'R') return val + 'R';
                                if (this.growthMode === 'PCT') return val + '%';
                                return baseSym + (Math.abs(val) >= 1000 ? (val/1000).toFixed(1)+'k' : val);
                            }
                        }
                    }
                }
            }
        });
    },

	drawDrawdownChart(logs) {
        const ctx = document.getElementById('chartDrawdown');
        if(!ctx) return;

        // 1. Sort Chronologically
        const sorted = [...logs].filter(l => l.outcome !== 'open').sort((a,b) => new Date(a.date) - new Date(b.date));
        
        let labels = [];
        let dataPoints = [];
        
        const mode = this.ddMode || 'pct'; // 'pct', 'amt', 'r'
        
        // --- BACKCASTING ENGINE ---
        // We start with Today's Balance and work backward to find the True Starting Balance
        // This ensures the Drawdown % is accurate to the account size *at the time of the trade*
        const masterAcc = this.data.accounts.find(a => a.isMaster);
        const currentBalance = masterAcc ? masterAcc.size : 10000;
        
        // Calculate Total PnL in this specific view (e.g. Last 50 trades)
        let totalViewPnL = 0;
        sorted.forEach(l => {
            let pnl = 0;
            if(l.exits && l.exits.length > 0) {
                l.exits.forEach(ex => pnl += (l.direction === 'SHORT' ? l.entry - ex.price : ex.price - l.entry) * ex.qty);
            } else if (l.exitPrice) {
                pnl = (l.direction === 'SHORT' ? l.entry - l.exitPrice : l.exitPrice - l.entry) * l.initialQty;
            }
            totalViewPnL += (pnl / (l.exchangeRate || 1));
        });

        // Set Baselines
        let runningEquity = currentBalance - totalViewPnL; 
        if (runningEquity <= 0) runningEquity = 1000; // Safety fallback for math
        
        let peakEquity = runningEquity; // High Water Mark ($)
        let runningCumR = 0;
        let peakCumR = 0; // High Water Mark (R)

        // --- SIMULATION LOOP ---
        sorted.forEach(l => {
            labels.push(l.ticker);
            
            // 1. Calculate Result for this trade
            let tradePnlBase = 0;
            let tradeR = 0;
            const rate = l.exchangeRate || 1;
            const refStop = (typeof l.initialStop !== 'undefined') ? l.initialStop : l.stop;
            const riskPerShare = Math.abs(l.entry - refStop);

            if(l.exits && l.exits.length > 0) {
                let realized = 0;
                l.exits.forEach(ex => realized += (l.direction === 'SHORT' ? l.entry - ex.price : ex.price - l.entry) * ex.qty);
                tradePnlBase = realized / rate;
                
                const totalRisk = l.initialQty * riskPerShare;
                if(totalRisk > 0) tradeR = realized / (totalRisk / rate);
            } 
            else if (l.exitPrice) {
                const diff = l.direction === 'SHORT' ? l.entry - l.exitPrice : l.exitPrice - l.entry;
                tradePnlBase = (diff * l.initialQty) / rate;
                if(riskPerShare > 0) tradeR = diff / riskPerShare;
            }

            // 2. Update Running Totals
            runningEquity += tradePnlBase;
            runningCumR += tradeR;

            // 3. Update High Water Marks (Peaks)
            if (runningEquity > peakEquity) peakEquity = runningEquity;
            if (runningCumR > peakCumR) peakCumR = runningCumR;

            // 4. Calculate Drawdown (Current - Peak)
            let ddVal = 0;
            if (mode === 'pct') {
                // Formula: (Current Equity - Peak Equity) / Peak Equity
                if (peakEquity > 0) ddVal = ((runningEquity - peakEquity) / peakEquity) * 100;
            } 
            else if (mode === 'amt') {
                ddVal = runningEquity - peakEquity;
            } 
            else { // mode === 'r'
                ddVal = runningCumR - peakCumR;
            }

            // Drawdown can never be positive (it's distance FROM peak)
            if (ddVal > 0) ddVal = 0; 

            dataPoints.push(ddVal);
        });

        if (this.charts.drawdown) this.charts.drawdown.destroy();

        const colorVal = mode === 'r' ? '#a855f7' : (mode === 'amt' ? '#10b981' : '#ef4444');
        const labelStr = mode === 'r' ? 'Drawdown (R)' : (mode === 'amt' ? 'Drawdown ($)' : 'Drawdown (%)');

        this.charts.drawdown = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: labelStr,
                    data: dataPoints,
                    borderColor: colorVal,
                    backgroundColor: colorVal + '20',
                    borderWidth: 2,
                    fill: true,
                    pointRadius: 1,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const val = ctx.raw;
                                const units = mode === 'r' ? 'R' : (mode === 'pct' ? '%' : '');
                                const pre = mode === 'amt' ? (this.getSymbol ? this.getSymbol(this.data.settings.baseCurrency) : '$') : '';
                                return `DD: ${pre}${val.toFixed(2)}${units}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        grid: { color: '#334155' },
                        ticks: { color: '#94a3b8' },
                        suggestedMax: 0 // Force 0 line at top
                    },
                    x: {
                        display: false 
                    }
                }
            }
        });
    },
   
    drawStrategyChart(logs) {
        const ctx = document.getElementById('chartStrategy');
        if(this.charts.strategy) this.charts.strategy.destroy();

        const stratMap = {};
        
        logs.forEach(l => {
            if(!l.strategy) return;
            let tradeR = 0;
            const riskPerShare = Math.abs(l.entry - l.stop);
            if(l.exits && l.exits.length > 0) {
                 const totalRisk = l.initialQty * riskPerShare;
                 let realizedPnL = 0;
                 l.exits.forEach(ex => realizedPnL += (l.direction === 'SHORT' ? (l.entry - ex.price) : (ex.price - l.entry)) * ex.qty);
                 if(totalRisk > 0) tradeR = realizedPnL / totalRisk;
            } else if (l.exitPrice) {
                 tradeR = (l.direction==='SHORT' ? (l.entry - l.exitPrice) : (l.exitPrice - l.entry)) / riskPerShare;
            }
            
            if(!stratMap[l.strategy]) stratMap[l.strategy] = 0;
            stratMap[l.strategy] += tradeR;
        });

        const labels = Object.keys(stratMap);
        const data = Object.values(stratMap);
        const colors = data.map(v => v >= 0 ? 'rgba(52, 211, 153, 0.6)' : 'rgba(248, 113, 113, 0.6)');

        this.charts.strategy = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total R',
                    data: data,
                    backgroundColor: colors,
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y', 
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { x: { grid: { color: '#334155' } }, y: { grid: { display: false } } }
            }
        });
    },

    drawDayOfWeekChart(logs) {
        const ctx = document.getElementById('chartDayOfWeek');
        if(this.charts.dayOfWeek) this.charts.dayOfWeek.destroy();

        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const dayMap = new Array(7).fill(0);
        
        logs.forEach(l => {
            const date = new Date(l.date);
            const dayIdx = date.getDay();
            
            let tradeR = 0;
            const riskPerShare = Math.abs(l.entry - l.stop);
            if(l.exits && l.exits.length > 0) {
                 const totalRisk = l.initialQty * riskPerShare;
                 let realizedPnL = 0;
                 l.exits.forEach(ex => realizedPnL += (l.direction === 'SHORT' ? (l.entry - ex.price) : (ex.price - l.entry)) * ex.qty);
                 if(totalRisk > 0) tradeR = realizedPnL / totalRisk;
            } else if (l.exitPrice) {
                 tradeR = (l.direction==='SHORT' ? (l.entry - l.exitPrice) : (l.exitPrice - l.entry)) / riskPerShare;
            }
            
            dayMap[dayIdx] += tradeR;
        });

        this.charts.dayOfWeek = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: days,
                datasets: [{
                    label: 'Total R',
                    data: dayMap,
                    backgroundColor: '#60a5fa',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { grid: { color: '#334155' } }, x: { grid: { display: false } } }
            }
        });
    },

    drawContributionChart(logs) {
        const ctx = document.getElementById('chartContributions');
        if(this.charts.contribution) this.charts.contribution.destroy();

        // Sort by Date
        const sorted = [...logs].sort((a,b) => new Date(a.date) - new Date(b.date));
        
        // Limit to last 5 trades
        const recent = sorted.slice(-5);

        const labels = [];
        const data = [];
        const colors = [];

        recent.forEach(l => {
            // Calculate Net R
            let netR = 0;
            const riskPerShare = Math.abs(l.entry - l.stop);
            if(l.exits && l.exits.length > 0) {
                 const totalRisk = l.initialQty * riskPerShare;
                 let pnl = 0;
                 l.exits.forEach(ex => {
                     pnl += (l.direction === 'SHORT' ? (l.entry - ex.price) : (ex.price - l.entry)) * ex.qty;
                 });
                 if(totalRisk > 0) netR = pnl / totalRisk;
            } else if (l.exitPrice) {
                 netR = ((l.direction==='SHORT'?l.entry-l.exitPrice:l.exitPrice-l.entry)/riskPerShare);
            }

            // Calculate Growth % contribution
            const riskFactor = l.riskMode === 'equity' ? l.riskVal : 1.0; 
            const contribution = netR * riskFactor;

            labels.push(l.ticker);
            data.push(contribution);
            colors.push(contribution >= 0 ? '#34d399' : '#f87171');
        });

        this.charts.contribution = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Contribution %',
                    data: data,
                    backgroundColor: colors,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { 
                        grid: { display: false },
                        ticks: { color: '#94a3b8', font: { size: 10 } }
                    },
                    y: {
                        grid: { color: '#334155' },
                        ticks: { callback: (val) => val.toFixed(2) + '%' }
                    }
                }
            }
        });
    },

    drawMonthlyChart(logs) {
        const ctx = document.getElementById('chartMonthly');
        if(this.charts.monthly) this.charts.monthly.destroy();

        const monthMap = {};
        
        logs.forEach(l => {
            const date = new Date(l.date);
            // Format Key: "2024-11" for sorting
            const key = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`;
            
            // Calculate Performance % (Contribution)
            let netR = 0;
            const riskPerShare = Math.abs(l.entry - l.stop);
            
            if(l.exits && l.exits.length > 0) {
                 const totalRisk = l.initialQty * riskPerShare;
                 let pnl = 0;
                 l.exits.forEach(ex => {
                     pnl += (l.direction === 'SHORT' ? (l.entry - ex.price) : (ex.price - l.entry)) * ex.qty;
                 });
                 if(totalRisk > 0) netR = pnl / totalRisk;
            } else if (l.exitPrice) {
                 netR = ((l.direction==='SHORT'?l.entry-l.exitPrice:l.exitPrice-l.entry)/riskPerShare);
            }
            
            const riskFactor = l.riskMode === 'equity' ? l.riskVal : 1.0; 
            const gainPct = netR * riskFactor;

            if(!monthMap[key]) monthMap[key] = 0;
            monthMap[key] += gainPct;
        });

        // Sort Keys
        const sortedKeys = Object.keys(monthMap).sort();
        const data = sortedKeys.map(k => monthMap[k]);
        
        // Format Labels: "2024-11" -> "Nov 24"
        const labels = sortedKeys.map(k => {
            const [y, m] = k.split('-');
            const d = new Date(y, m-1);
            return d.toLocaleString('default', { month: 'short', year: '2-digit' });
        });

        const colors = data.map(v => v >= 0 ? '#34d399' : '#f87171');

        this.charts.monthly = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Monthly Return %',
                    data: data,
                    backgroundColor: colors,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { 
                    x: { grid: { display: false } }, 
                    y: { 
                        grid: { color: '#334155' },
                        ticks: { callback: (val) => val.toFixed(2) + '%' }
                    } 
                }
            }
        });
    },

    drawWinLossChart(logs) {
        const ctx = document.getElementById('chartWinLoss');
        if(this.charts.winLoss) this.charts.winLoss.destroy();
        
        let wins=0, losses=0, open=0;
        
        logs.forEach(l => {
             const totalSold = l.exits ? l.exits.reduce((a,b)=>a+b.qty,0) : 0;
             const isClosed = l.outcome !== 'open' || (l.initialQty > 0 && totalSold >= l.initialQty);
             
             if(!isClosed) {
                 open++;
             } else {
                 let netR = 0;
                 const riskPerShare = Math.abs(l.entry - l.stop);
                 if(l.exits && l.exits.length > 0) {
                     const totalRisk = l.initialQty * riskPerShare;
                     let pnl = 0;
                     l.exits.forEach(ex => pnl += (l.direction==='SHORT'?l.entry-ex.price : ex.price-l.entry)*ex.qty);
                     netR = pnl/totalRisk;
                 } else if (l.exitPrice) {
                     netR = (l.direction==='SHORT'?l.entry-l.exitPrice : l.exitPrice-l.entry)/riskPerShare;
                 }
                 
                 if(netR > 0) wins++; else losses++;
             }
        });

        this.charts.winLoss = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Win', 'Loss', 'Open'],
                datasets: [{
                    data: [wins, losses, open],
                    backgroundColor: ['#34d399', '#f87171', '#60a5fa'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'right', labels: { color: '#94a3b8', boxWidth: 10 } } }
            }
        });
    },

    // --- UTILS ---
    saveFormData() {
        const formState = {
            ticker: document.getElementById('ticker').value,
            price: document.getElementById('purchasePrice').value,
            stop: document.getElementById('stopLoss').value,
            // riskMode/val are saved via settings now
        };
        localStorage.setItem('sessionForm', JSON.stringify(formState));
    },

    restoreFormData() {
        const saved = localStorage.getItem('sessionForm');
        if(saved) {
            const data = JSON.parse(saved);
            document.getElementById('ticker').value = data.ticker || '';
            document.getElementById('purchasePrice').value = data.price || '';
            document.getElementById('stopLoss').value = data.stop || '';
        }
    },
    
    resetForm() {
        if(confirm("Reset inputs and revert to default Risk (0.25% Equity)?")) {
            // 1. Clear Text Inputs
            document.getElementById('ticker').value = '';
            document.getElementById('purchasePrice').value = '';
            document.getElementById('stopLoss').value = '';
            
            // 2. Reset Direction
            this.setDirection('LONG');
            
            // 3. Reset Logic State
            this.data.editingId = null;
            this.data.isEditingParams = false;
            document.getElementById('calculationResults').classList.add('hidden');
            
            // 4. Reset Button
            const btn = document.getElementById('mainActionBtn');
            btn.textContent = "Calculate";
            btn.classList.add('bg-blue-600');
            btn.classList.remove('bg-amber-600');

            // 5. FORCE DEFAULT RISK (Equity 0.25%)
            this.data.settings.riskMode = 'equity';
            this.data.settings.riskValue = 0.25;

            // Sync UI: Check the Equity Radio Button
            const eqRadio = document.querySelector('input[name="riskMode"][value="equity"]');
            if(eqRadio) eqRadio.checked = true;

            // Sync UI: Reset Slider & Label
            const slider = document.getElementById('riskSlider');
            if(slider) {
                slider.value = 0.25;
                const label = document.getElementById('riskLabel');
                if(label) label.textContent = "Risk 0.25%";
            }

            // Run Toggle to ensure correct fields (slider vs input) are shown
            this.toggleRiskMode(); 
            this.saveSettings();
        }
    },
    
    exportLogs() {
        const csvContent = "data:text/csv;charset=utf-8," 
            + "Date,Ticker,Dir,Entry,Stop,InitialQty,Strategy,Status,NetR,ExitsSummary\n"
            + this.data.logs.map(e => {
                let netR = 0;
                let exitsSummary = '';
                const riskPerShare = Math.abs(e.entry - e.stop);
                
                if(e.exits && e.exits.length > 0) {
                     const totalRisk = e.initialQty * riskPerShare;
                     let pnl = 0;
                     e.exits.forEach(ex => {
                         pnl += (e.direction==='SHORT'?e.entry-ex.price:ex.price-e.entry)*ex.qty;
                         exitsSummary += `[${ex.qty}@${ex.price}] `;
                     });
                     if(totalRisk > 0) netR = (pnl/totalRisk).toFixed(2);
                } else if (e.exitPrice) {
                     netR = ((e.direction==='SHORT'?e.entry-e.exitPrice:e.exitPrice-e.entry)/riskPerShare).toFixed(2);
                }
                
                return `${e.date},${e.ticker},${e.direction},${e.entry},${e.stop},${e.initialQty || ''},${e.strategy},${e.outcome},${netR},${exitsSummary}`;
            }).join("\n");
            
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "trade_logs_v5.csv");
        document.body.appendChild(link);
        link.click();
    },
	
	// --- PATCH 4: HELPER FUNCTIONS (Update Actions) ---

    updateCurrentStop() {
        const id = this.data.editingId;
        const log = this.data.logs.find(l => l.id === id);
        if(!log) return;
        
        const val = parseFloat(document.getElementById('manageCurrentStopInput').value);
        if(isNaN(val)) return alert("Invalid Stop Price");
        
        // Save
        log.currentStop = val;
        localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
        
        // Refresh UI
        
        this.openManageView(id); // Reload view to recalc Derisk targets
        alert("Current Stop Updated");
    },

    updateTradeQty() {
        const id = this.data.editingId;
        const log = this.data.logs.find(l => l.id === id);
        if(!log) return;
        
        const val = parseInt(document.getElementById('manageEditQty').value);
        if(!val || val <= 0) return alert("Invalid Quantity");
        
        if(log.exits && log.exits.reduce((a,b)=>a+b.qty,0) > 0) {
            return alert("Cannot edit Quantity after exits have been logged.");
        }
        
        // Update Logic
        log.initialQty = val;
        
        // Recalculate implied risk % based on new qty
        const masterAcc = this.data.accounts.find(a => a.isMaster);
        if(masterAcc && masterAcc.size > 0) {
            const riskDist = Math.abs(log.entry - log.stop);
            const totalRiskBase = (val * riskDist) / (log.exchangeRate || 1);
            log.riskVal = parseFloat(((totalRiskBase / masterAcc.size) * 100).toFixed(2));
        }

        localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
        this.openManageView(id);
        this.renderLogs();
        
        alert("Quantity Updated");
    },

	// --- PATCH 5: DYNAMIC CURRENCY SYMBOLS & UI FIXES ---

    getSymbol(ccy) {
        const symbols = { 'USD': '$', 'GBP': '', 'EUR': '', 'JPY': '', 'CAD': 'C$', 'SEK': 'kr' };
        return symbols[ccy] || ccy;
    },

    // ======================================================

	// --- PATCH: GROWTH CHART TOGGLE ---
    
    // Store the preferred mode (Default to 'R')
    growthMode: 'R', 

    toggleGrowthMode(mode) {
        this.growthMode = mode;
        // Re-render only the stats to update the chart
        this.renderStats();
    },

	// --- PATCH 10: STATS PREFERENCES UI ---
    renderSettingsPreferences() {
        let container = document.getElementById('settingsPreferencesContainer');
        if(!container) {
            const accountsSection = document.getElementById('settingsAccountsList')?.parentElement;
            if(accountsSection) {
                container = document.createElement('div');
                container.id = 'settingsPreferencesContainer';
                container.className = 'bg-slate-800 rounded-xl p-4 border border-slate-700 mt-6 slide-in';
                accountsSection.parentNode.insertBefore(container, accountsSection.nextSibling);
            } else { return; }
        }

        const isChecked = this.data.settings.statsIncludePartials === true;
        
        container.innerHTML = `
            <h2 class="text-sm font-bold text-slate-300 mb-4 uppercase flex items-center gap-2">
                <i data-lucide="settings-2" class="w-4 h-4 text-indigo-400"></i> App Preferences
            </h2>
            
            <div class="space-y-4">
                <div class="bg-slate-900/50 p-3 rounded border border-slate-700">
                    <label class="text-[10px] text-blue-400 uppercase font-bold block mb-1">Finnhub API Key (Live Prices)</label>
                    <input type="text" value="${this.data.settings.finnhubKey || ''}" 
                        placeholder="Enter your free key from finnhub.io"
                        onchange="app.data.settings.finnhubKey = this.value.trim(); app.saveSettings()"
                        class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-xs text-white focus:border-blue-500 outline-none font-mono">
                    <p class="text-[9px] text-slate-500 mt-1">
                        Required for the "Fetch Prices" button. Get a free key at <a href="https://finnhub.io" target="_blank" class="underline hover:text-white">finnhub.io</a>.
                    </p>
                </div>

                <div class="flex justify-between items-center bg-slate-900 p-3 rounded border border-slate-700">
                    <div>
                        <div class="text-sm font-bold text-slate-300">Include Partials in Averages</div>
                        <div class="text-[10px] text-slate-500 max-w-xs mt-1">
                            <span class="${isChecked ? 'text-blue-400 font-bold' : 'text-slate-500'}">ON:</span> Dynamic Math.<br>
                            <span class="${!isChecked ? 'text-emerald-400 font-bold' : 'text-slate-500'}">OFF:</span> Strict Math.
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" onchange="app.toggleStatPreference(this.checked)" class="sr-only peer" ${isChecked ? 'checked' : ''}>
                        <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>
        `;
        lucide.createIcons();
    },

    toggleStatPreference(val) {
        this.data.settings.statsIncludePartials = val;
        this.saveSettings();
        this.renderSettingsPreferences(); // Visual update
    },
	
	renderSettings() {
        // 1. Render Sub-Sections
        this.renderSettingsAccounts();
        this.renderSettingsStrategies();
        this.renderSettingsPreferences();

    },
	
	
	// --- 1. P&L HELPER (Required dependency) ---
    getPnl(log, exitPrice, qty) {
        if (!log || !exitPrice || !qty) return { val: 0, formatted: '-' };
        
        // Calculate Raw P&L in Trade Currency
        const rawPnl = log.direction === 'SHORT' 
            ? (log.entry - exitPrice) * qty 
            : (exitPrice - log.entry) * qty;
            
        // Convert to Base Currency
        const rate = log.exchangeRate || 1;
        const basePnl = rawPnl / rate;
        
        // Format
        const sym = this.getSymbol ? this.getSymbol(this.data.settings.baseCurrency) : "";
        return {
            val: basePnl,
            formatted: `${basePnl >= 0 ? '+' : ''}${sym}${Math.abs(basePnl).toFixed(2)}`
        };
    },

	// --- 2. RENDER HISTORY (The logic you liked) ---
    renderExitHistory(log) {
        const list = document.getElementById('exitHistoryList');
        if (!list) return; // Safety check

        if(!log.exits || log.exits.length === 0) {
            list.innerHTML = `<div class="text-center text-xs text-slate-500 py-4">No exits recorded yet.</div>`;
            return;
        }

        // Sort for display (Oldest to Newest)
        const sortedExits = log.exits.map((ex, i) => ({...ex, originalIdx: i})); 
        sortedExits.sort((a,b) => new Date(a.date) - new Date(b.date));

        list.innerHTML = sortedExits.map((ex) => {
            const riskPerShare = Math.abs(log.entry - log.stop);
            const pnlPerShare = log.direction === 'SHORT' ? (log.entry - ex.price) : (ex.price - log.entry);
            
            // Calculate R-Multiple
            const rVal = (riskPerShare > 0) ? (pnlPerShare / riskPerShare).toFixed(2) : "0.00";
            
            // Calculate P&L Amount
            const pnlObj = this.getPnl(log, ex.price, ex.qty);
            const pnlClass = pnlObj.val >= 0 ? 'text-emerald-400' : 'text-red-400';
            
            // Format Date
            const d = new Date(ex.date);
            const dateStr = `${d.getDate()}/${d.getMonth()+1} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;

            return `
            <div class="flex justify-between items-center bg-slate-900 p-2 rounded border border-slate-700 text-sm mb-1">
                <div>
                    <div class="text-[10px] text-slate-500 mb-0.5">${dateStr}</div>
                    <span class="font-bold text-white">${ex.qty} shares @ ${ex.price}</span>
                </div>
                <div class="text-right">
                    <div class="${parseFloat(rVal) >= 0 ? 'text-emerald-400' : 'text-red-400'} font-bold">${parseFloat(rVal) > 0 ? '+' : ''}${rVal}R</div>
                    <div class="${pnlClass} text-xs font-mono">${pnlObj.formatted}</div>
                    
                    <div class="flex gap-3 justify-end mt-1">
                        <button onclick="app.editExit(${ex.originalIdx})" class="text-[10px] text-blue-400 hover:text-white hover:underline">Edit</button>
                        <button onclick="app.removeExit(${ex.originalIdx})" class="text-[10px] text-slate-600 hover:text-red-500 hover:underline">Delete</button>
                    </div>
                </div>
            </div>`;
        }).join('');
    },

	// --- PATCH 20: LOGS VIEW REPAIR KIT ---

    // 1. Ensure Helper Exists (Calculates P&L for display)
    getPnl(log, exitPrice, qty) {
        if (!log || !exitPrice || !qty) return { val: 0, formatted: '' };
        
        // Calculate Raw P&L in Trade Currency
        const rawPnl = log.direction === 'SHORT' 
            ? (log.entry - exitPrice) * qty 
            : (exitPrice - log.entry) * qty;
            
        // Convert to Base Currency
        const rate = log.exchangeRate || 1;
        const basePnl = rawPnl / rate;
        
        // Format
        const sym = this.getSymbol ? this.getSymbol(this.data.settings.baseCurrency) : "";
        return {
            val: basePnl,
            formatted: `${basePnl >= 0 ? '+' : '-'}${sym}${Math.abs(basePnl).toFixed(2)}`
        };
    },

	renderLogs(limit = 50) {
        // 1. UPDATE GLOBAL RISK BAR & ROTATE ICON
        this.updateRiskBar();
        this.toggleRotateIcon(true); // Turn on rotate icon for this view

        // 2. HEADER CONTROLS
        const header = document.querySelector('#view-logs .flex.gap-2.mb-4');
        if (header) {
            if (!document.getElementById('logStatusFilter')) {
                 const select = document.createElement('select');
                 select.id = 'logStatusFilter';
                 select.className = 'bg-slate-800 border-none rounded-lg py-2 px-3 text-xs font-bold focus:ring-2 focus:ring-blue-500 text-slate-300 outline-none cursor-pointer hover:text-white transition-colors';
                 select.innerHTML = `<option value="ALL">All Status</option><option value="OPEN">Open (Active)</option><option value="CLOSED">Closed Only</option><option value="WIN">Wins Only</option><option value="LOSS">Losses Only</option>`;
                 select.onchange = () => app.renderLogs();
                 header.insertBefore(select, header.firstChild);
            }
            // Note: Old fetch button logic removed
        }
        
        this.updatePrivacyIcons();

        // 3. DATA PREP
        const statusFilter = document.getElementById('logStatusFilter') ? document.getElementById('logStatusFilter').value : 'ALL';
        const searchVal = document.getElementById('logSearch') ? document.getElementById('logSearch').value.toUpperCase() : '';
        const container = document.getElementById('logsContainer');
        if (!container) return;

        const allMatches = this.data.logs.filter(l => {
            const matchSearch = l.ticker.includes(searchVal) || (l.strategy && l.strategy.toUpperCase().includes(searchVal));
            if(!matchSearch) return false;
            
            let totalSold = l.exits ? l.exits.reduce((a,b)=>a+b.qty,0) : 0;
            let isClosed = l.outcome !== 'open' || (l.initialQty > 0 && totalSold >= l.initialQty);

            if(statusFilter === 'ALL') return true;
            if(statusFilter === 'OPEN') return !isClosed;
            if(statusFilter === 'CLOSED') return isClosed;
            if(statusFilter === 'WIN' || statusFilter === 'LOSS') {
                const riskPerShare = Math.abs(l.entry - (l.initialStop || l.stop));
                let netR = 0;
                if(l.exits && l.exits.length > 0) {
                    let pnl = 0;
                    l.exits.forEach(ex => pnl += (l.direction === 'SHORT' ? l.entry - ex.price : ex.price - l.entry) * ex.qty);
                    if(l.initialQty*riskPerShare > 0) netR = pnl / (l.initialQty * riskPerShare);
                }
                return statusFilter === 'WIN' ? netR > 0.1 : netR < -0.1;
            }
            return true;
        });

        allMatches.sort((a,b) => new Date(b.date) - new Date(a.date));
        const visibleLogs = allMatches.slice(0, limit);
        const masterAcc = this.data.accounts.find(a => a.isMaster);
        const masterSize = masterAcc ? masterAcc.size : 10000;

        // 4. RENDER ROWS
        const htmlRows = visibleLogs.map(log => {
            // A. Base Data
            let totalSold = log.exits ? log.exits.reduce((acc, ex) => acc + ex.qty, 0) : 0;
            let currentQty = (log.initialQty || 0) - totalSold;
            let isOpen = log.outcome === 'open';
            
            // Pos Size
            const activePrice = log.currentPrice || log.entry;
            const posValueTrade = activePrice * currentQty;
            const posValueBase = posValueTrade / (log.exchangeRate || 1);
            const posPct = (posValueBase / masterSize) * 100;
            
            // P&L
            let realizedR = 0;
            let totalRealizedPnl = 0;
            let totalExitProceeds = 0;
            const refStop = (typeof log.initialStop !== 'undefined') ? log.initialStop : log.stop;
            const riskPerShare = Math.abs(log.entry - refStop);
            
            let dateDisplay = log.date.substring(5, 10);
            let timeDisplay = log.date.includes('T') ? new Date(log.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "";

            if (log.exits && log.exits.length > 0) {
                log.exits.forEach(ex => {
                    const pnlObj = this.getPnl(log, ex.price, ex.qty);
                    totalRealizedPnl += pnlObj.val;
                    totalExitProceeds += (ex.price * ex.qty);
                });
                const totalRiskAmount = log.initialQty * riskPerShare;
                if (totalRiskAmount > 0) realizedR = totalRealizedPnl / (totalRiskAmount / (log.exchangeRate||1)); 
            } else if (!log.initialQty && log.exitPrice) {
                const diff = log.direction === 'SHORT' ? (log.entry - log.exitPrice) : (log.exitPrice - log.entry);
                realizedR = diff / riskPerShare;
                isOpen = false;
            }

            let unrealizedPnl = 0;
            if (isOpen && log.currentPrice) {
                const diff = log.direction === 'SHORT' ? (log.entry - log.currentPrice) : (log.currentPrice - log.entry);
                unrealizedPnl = (diff * currentQty) / (log.exchangeRate || 1);
            }

            const ecPct = (totalRealizedPnl / masterSize) * 100;
            const ecClass = ecPct > 0 ? 'text-emerald-400' : (ecPct < 0 ? 'text-red-400' : 'text-slate-500');
            const ecDisplay = `<span class="${ecClass} font-bold">${ecPct > 0 ? '+':''}${ecPct.toFixed(2)}%</span>`;

            let gainPctDisplay = '<span class="text-slate-600">-</span>';
            if (totalSold > 0) {
                const avgExit = totalExitProceeds / totalSold;
                const gainPct = log.direction === 'LONG' 
                    ? ((avgExit - log.entry) / log.entry) * 100
                    : ((log.entry - avgExit) / log.entry) * 100;
                const gainClass = gainPct >= 0 ? 'text-emerald-400' : 'text-red-400';
                gainPctDisplay = `<span class="${gainClass}">${gainPct > 0 ? '+':''}${gainPct.toFixed(2)}%</span>`;
            }

            let activeStop = (typeof log.currentStop === 'number') ? log.currentStop : log.stop;

            let nerBadge = '';
            if (isOpen) {
                const dist = log.direction==='LONG' ? Math.max(0, log.entry-activeStop) : Math.max(0, activeStop-log.entry);
                if ((currentQty * dist) - (totalRealizedPnl*(log.exchangeRate||1)) > 0) nerBadge = `<span class="bg-amber-500 text-slate-900 text-[9px] px-1 rounded font-bold tracking-tighter mb-0.5" title="Net Equity Risk">NER</span>`;
            }
            let statusBadge = isOpen 
                ? (totalSold > 0 ? `<span class="text-blue-400 font-bold text-[10px]">OPEN(${Math.round((totalSold/log.initialQty)*100)}%)</span>` : `<span class="text-blue-400 font-bold text-[10px]">OPEN</span>`)
                : (realizedR > 0.1 ? `<span class="text-emerald-400 font-bold text-[10px]">WIN</span>` : (realizedR < -0.1 ? `<span class="text-red-400 font-bold text-[10px]">LOSS</span>` : `<span class="text-slate-400 font-bold text-[10px]">SCRATCH</span>`));

            const sym = this.getSymbol ? this.getSymbol(this.data.settings.baseCurrency) : "";
            const fmt = (val, isPaper = false) => {
                if (this.data.settings.hidePnL) return `<span class="opacity-50 select-none blur-[2px]">****</span>`;
                
                // 1. Determine Color based on Value (Positive/Negative)
                let colorBase = val >= 0 ? 'text-emerald-400' : 'text-red-400';
                
                // 2. Determine Style based on State (Paper vs Banked)
                // Paper: Italic + Slightly softer color (opacity-90)
                // Banked: Normal font (or bold)
                let styleClass = isPaper ? `italic ${colorBase} opacity-90` : `font-bold ${val >= 0 ? 'text-emerald-500' : 'text-red-500'}`;

                const prefix = isPaper ? '' : ''; // Optional prefix logic if you want 'est.'
                
                // 3. Render
                return `<div class="text-[10px] ${styleClass} leading-tight">${prefix}${val<0?'-':''}${sym}${Math.abs(val).toFixed(2)}</div>`;
            };

            let pnlStack = '';
            if (totalRealizedPnl !== 0) pnlStack += fmt(totalRealizedPnl);
            if (unrealizedPnl !== 0) pnlStack += fmt(unrealizedPnl, true);
            if (pnlStack === '') pnlStack = '<span class="text-slate-600 text-[10px]">-</span>';
            
            let rDisplay = (!isOpen || (log.exits && log.exits.length > 0)) ? `${realizedR>0?'+':''}${realizedR.toFixed(2)}R` : '-';
            let rClass = realizedR > 0 ? 'text-emerald-400 font-bold' : (realizedR < 0 ? 'text-red-400 font-bold' : 'text-slate-500');

            return `
            <div onclick="app.openManageView(${log.id})" class="log-row log-grid-layout grid grid-cols-10 md:grid-cols-16 gap-2 p-3 bg-slate-800/50 border-b border-slate-700 items-center hover:bg-slate-800 transition-colors cursor-pointer active:bg-slate-700">
                <div class="col-span-2">
                    <div class="text-xs text-slate-300 font-bold">${dateDisplay}</div>
                    <div class="text-[9px] text-slate-500 font-mono">${timeDisplay}</div>
                </div>
                <div class="col-span-2">
                    <div class="font-black text-white text-sm leading-tight">${log.ticker} <span class="text-[8px] text-slate-500 font-normal">${log.direction.substring(0,1)}</span></div>
                    <div class="text-[10px] text-slate-400 font-mono">@ ${log.entry}</div>
                </div>
                <div class="landscape-data hidden col-span-1 text-center">
                    <div class="text-xs font-mono text-white ${log.currentPrice ? '' : 'opacity-50'}">${log.currentPrice ? log.currentPrice : '-'}</div>
                </div>
                <div class="landscape-data hidden col-span-2 text-center">
                    <div class="text-xs font-mono text-white">${log.initialQty} <span class="text-slate-500"></span> ${currentQty}</div>
                    ${isOpen ? `<div class="text-[9px] text-blue-400 font-bold">${posPct.toFixed(1)}% Acc</div>` : ''}
                </div>
                <div class="landscape-data hidden col-span-1 text-center">
                    <div class="text-xs font-mono text-red-400">${activeStop.toFixed(2)}</div>
                </div>
                <div class="landscape-data hidden col-span-1 text-center">
                    <div class="text-xs text-slate-400">${log.riskVal}${log.riskMode === 'equity' ? '%' : 'sz'}</div>
                </div>
                <div class="landscape-data hidden col-span-2 text-center">
                    <div class="flex flex-col text-[10px] font-mono">
                        <div class="flex justify-between w-full px-1"><span>EC:</span> ${ecDisplay}</div>
                        <div class="flex justify-between w-full px-1"><span>Px:</span> ${gainPctDisplay}</div>
                    </div>
                </div>
                <div class="portrait-only col-span-2 text-left">
                    <div class="text-[9px] text-slate-500">${log.riskVal}${log.riskMode === 'equity' ? '%' : 'sz'}</div>
                    <div class="text-xs font-mono ${rClass}">${rDisplay}</div>
                </div>
                <div class="portrait-only col-span-4 flex justify-between items-center pl-1 flex-nowrap">
                    <div class="flex-1 flex flex-col items-end gap-0.5 mr-2 overflow-hidden">
                         ${pnlStack}
                         <div class="flex items-center gap-1 justify-end flex-wrap">${nerBadge}${statusBadge}</div>
                    </div>
                    <button onclick="event.stopPropagation(); app.shareLogImage(this)" class="text-slate-400 hover:text-white bg-slate-700/50 p-2 rounded-lg action-buttons flex-shrink-0"><i data-lucide="share-2" class="w-4 h-4"></i></button>
                </div>
                <div class="landscape-data hidden col-span-2 text-right">
                    <div class="text-xs font-mono ${rClass}">${rDisplay}</div>
                    <div class="flex flex-col items-end">${pnlStack}</div>
                </div>
                <div class="landscape-data hidden col-span-2 flex flex-col items-center justify-center gap-0.5">
                     ${nerBadge}${statusBadge}
                </div>
                <div class="landscape-data hidden col-span-1 text-center flex justify-center gap-1">
					<button onclick="event.stopPropagation(); app.openReplay(${log.id})" class="text-blue-400 hover:text-white bg-blue-500/10 hover:bg-blue-600 p-2 rounded-lg action-buttons" title="Chart Replay">
						<i data-lucide="line-chart" class="w-4 h-4"></i>
					</button>
     
					<button onclick="event.stopPropagation(); app.shareLogImage(this)" class="text-slate-400 hover:text-white bg-slate-700/50 p-2 rounded-lg action-buttons" title="Share Image">
						<i data-lucide="share-2" class="w-4 h-4"></i>
					</button>
				</div>
            </div>`;
        }).join('');

        const gridHeader = `
            <div class="shrink-0 log-grid-layout grid grid-cols-10 md:grid-cols-16 gap-2 p-3 bg-slate-800 text-xs font-bold text-slate-400 border-b border-slate-700">
                <div class="col-span-2">DATE</div>
                <div class="col-span-2">TICKER</div>
                <div class="landscape-data hidden col-span-1 text-center text-slate-500">LIVE</div>
                <div class="landscape-data hidden col-span-2 text-center text-slate-500">QTY / POS%</div> 
                <div class="landscape-data hidden col-span-1 text-center text-slate-500">STOP</div>
                <div class="landscape-data hidden col-span-1 text-center text-slate-500">RISK</div>
                <div class="landscape-data hidden col-span-2 text-center text-slate-500">PERF (EC/%)</div>
                <div class="portrait-only col-span-2 text-left">RISK / R</div>
                <div class="landscape-data hidden col-span-2 text-right">R / P&L</div>
                <div class="col-span-4 md:col-span-2 text-right md:text-center">
                    <span class="md:hidden">P&L / STATUS</span>
                    <span class="hidden md:inline">STATUS</span>
                </div>
                <div class="hidden md:block md:col-span-1 text-center"></div>
            </div>`;

        let loadMoreHtml = '';
        if (allMatches.length > limit) loadMoreHtml = `<div class="p-2 text-center"><button onclick="event.stopPropagation(); app.renderLogs(${limit + 50})" class="text-xs font-bold text-blue-400 hover:text-white border border-slate-700 bg-slate-800 rounded-full px-4 py-2 transition-all">Show Older Trades (${allMatches.length - limit} more)</button></div>`;
        else if (allMatches.length === 0) loadMoreHtml = `<div class="p-8 text-center text-slate-500 text-sm">No trades found matching filters.</div>`;

        const wrapper = document.getElementById('logsTableWrapper');
        wrapper.innerHTML = gridHeader + `<div id="logsContainer" class="overflow-y-auto flex-1 p-2 space-y-1">${htmlRows + loadMoreHtml}</div>`;
        
        lucide.createIcons();
    },
	
	// --- PATCH 37: INTERACTIVE HEATMAP (Mobile Friendly) ---

    viewDayDetails(el, date, count, pnl) {
        // 1. Visual Feedback (Highlight Selection)
        // Remove highlight from previous selection
        document.querySelectorAll('.heatmap-day').forEach(d => d.classList.remove('ring-2', 'ring-white', 'z-10'));
        
        // Add highlight to current
        if(el) el.classList.add('ring-2', 'ring-white', 'z-10');

        // 2. Update Info Bar
        const info = document.getElementById('heatmapInfo');
        if(!info) return;

        if (count === 0) {
            info.innerHTML = `<span class="text-slate-500">${date}: No Trades</span>`;
        } else {
            const pnlClass = pnl > 0 ? 'text-emerald-400' : (pnl < 0 ? 'text-red-400' : 'text-slate-300');
            const sign = pnl > 0 ? '+' : '';
            info.innerHTML = `<span class="text-white font-bold">${date}</span>  <span class="text-slate-400">${count} Trades</span>  <span class="${pnlClass} font-bold">${sign}${pnl.toFixed(2)}R</span>`;
        }
    },

    drawConsistencyHeatmap(logs) {
        const container = document.getElementById('consistencyGrid');
        if (!container) return;

        const dayMap = {};
        const daysToShow = 90; 
        const getIsoDate = (d) => d.toISOString().split('T')[0];

        for (let i = daysToShow - 1; i >= 0; i--) {
            const d = new Date();
            d.setUTCHours(12, 0, 0, 0); 
            d.setUTCDate(d.getUTCDate() - i);
            const key = getIsoDate(d); 
            dayMap[key] = { pnl: 0, count: 0, date: d };
        }

        logs.forEach(l => {
            const tDate = new Date(l.date);
            if (isNaN(tDate)) return; 
            const dateKey = getIsoDate(tDate);
            
            if (dayMap[dateKey]) {
                let netR = 0;
                const riskPerShare = Math.abs(l.entry - l.stop);
                if (l.exits && l.exits.length > 0) {
                    let pnl = 0;
                    l.exits.forEach(ex => pnl += (l.direction === 'SHORT' ? l.entry - ex.price : ex.price - l.entry) * ex.qty);
                    if (l.initialQty * riskPerShare > 0) netR = pnl / (l.initialQty * riskPerShare);
                } else if (l.exitPrice) {
                    netR = (l.direction === 'SHORT' ? l.entry - l.exitPrice : l.exitPrice - l.entry) / riskPerShare;
                }
                dayMap[dateKey].pnl += netR;
                dayMap[dateKey].count++;
            }
        });

        // Generate Squares with OnClick handlers
        const squares = Object.keys(dayMap).sort().map(key => {
            const data = dayMap[key];
            let colorClass = 'bg-slate-700/50'; 
            
            if (data.count > 0) {
                if (data.pnl > 0) {
                    if (data.pnl > 2) colorClass = 'bg-emerald-400 shadow-sm shadow-emerald-900'; 
                    else if (data.pnl > 1) colorClass = 'bg-emerald-500/80'; 
                    else colorClass = 'bg-emerald-600/50'; 
                } else if (data.pnl < 0) {
                    if (data.pnl < -2) colorClass = 'bg-red-500 shadow-sm shadow-red-900'; 
                    else if (data.pnl < -1) colorClass = 'bg-red-500/80'; 
                    else colorClass = 'bg-red-600/50'; 
                } else {
                    colorClass = 'bg-slate-500'; 
                }
            }

            // Added 'heatmap-day' class for selection logic
            // Added onclick event to trigger the detail view
            return `<div onclick="app.viewDayDetails(this, '${key}', ${data.count}, ${data.pnl.toFixed(2)})" 
                         class="heatmap-day w-3 h-3 rounded-sm ${colorClass} transition-all cursor-pointer relative hover:scale-125 hover:z-20"></div>`;
        }).join('');

        container.innerHTML = squares;
    },
	saveJournal() {
        // PATCH: Only update philosophy from DOM if the Rules tab is actually visible.
        // Prevents overwriting data with empty string when saving from Daily Log tab.
        const rulesTab = document.getElementById('jtab-rules');
        if (rulesTab && !rulesTab.classList.contains('hidden')) {
            this.data.journal.philosophy = document.getElementById('jPhilosophy').value;
        }
        
        localStorage.setItem('tradeJournal', JSON.stringify(this.data.journal));
    },

    switchJournalTab(tab) {
        document.getElementById('jtab-log').classList.add('hidden');
        document.getElementById('jtab-rules').classList.add('hidden');
        document.getElementById('btn-jtab-log').className = 'flex-1 py-2 text-xs font-bold rounded-lg transition-colors text-slate-500 hover:text-white';
        document.getElementById('btn-jtab-rules').className = 'flex-1 py-2 text-xs font-bold rounded-lg transition-colors text-slate-500 hover:text-white';

        document.getElementById(`jtab-${tab}`).classList.remove('hidden');
        document.getElementById(`btn-jtab-${tab}`).className = 'flex-1 py-2 text-xs font-bold rounded-lg transition-colors bg-blue-600 text-white shadow';
        
        if(tab === 'rules') this.renderJournalRules();
        if(tab === 'log') {
            if(!document.getElementById('journalDate').value) {
                document.getElementById('journalDate').value = new Date().toISOString().split('T')[0];
            }
            this.renderJournalEntry();
        }
    },

    renderJournalRules() {
        document.getElementById('jPhilosophy').value = this.data.journal.philosophy || '';
        
        const rulesDiv = document.getElementById('jRulesList');
        rulesDiv.innerHTML = this.data.journal.rules.map((r, i) => `
            <div class="flex gap-2 items-start bg-slate-900 p-2 rounded border border-slate-600">
                <div class="bg-blue-900/30 text-blue-400 font-bold px-2 py-1 rounded text-xs mt-0.5">#${i+1}</div>
                <textarea onchange="app.updateJournalRule(${i}, this.value)" 
                    class="flex-1 bg-transparent text-sm text-white outline-none resize-none leading-relaxed" 
                    rows="2" placeholder="Define your rule here...">${r}</textarea>
                <button onclick="app.deleteJournalRule(${i})" class="text-slate-600 hover:text-red-500 mt-0.5">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        `).join('');

        const emDiv = document.getElementById('jEmotionsSettingsList');
        emDiv.innerHTML = this.data.journal.emotionsList.map((e, i) => `
            <div class="bg-slate-900 border border-slate-600 rounded px-2 py-1 text-xs flex gap-2 items-center">
                <span>${e}</span>
                <button onclick="app.deleteEmotionTag(${i})" class="text-slate-500 hover:text-red-400"></button>
            </div>
        `).join('');
        lucide.createIcons();
    },

    addJournalRule() { this.data.journal.rules.push("New Rule..."); this.saveJournal(); this.renderJournalRules(); },
    updateJournalRule(idx, val) { this.data.journal.rules[idx] = val; this.saveJournal(); },
    deleteJournalRule(idx) { if(confirm("Delete rule?")) { this.data.journal.rules.splice(idx, 1); this.saveJournal(); this.renderJournalRules(); } },
    
    addEmotionTag() {
        const val = document.getElementById('newEmotionInput').value.trim();
        if(val && !this.data.journal.emotionsList.includes(val)) {
            this.data.journal.emotionsList.push(val);
            document.getElementById('newEmotionInput').value = '';
            this.saveJournal();
            this.renderJournalRules();
        }
    },
    deleteEmotionTag(idx) { this.data.journal.emotionsList.splice(idx, 1); this.saveJournal(); this.renderJournalRules(); },

    // --- JOURNAL: DAILY LOG ACTIONS ---
    shiftJournalDate(days) {
        const input = document.getElementById('journalDate');
        
        // Attempt to parse the current value
        let d = new Date(input.value);
        
        // SAFETY CHECK: If date is invalid or empty, default to Today
        if (isNaN(d.getTime())) {
            d = new Date();
        }
        
        // Perform the shift
        d.setDate(d.getDate() + days);
        
        // Update Input and Render
        input.value = d.toISOString().split('T')[0];
        this.renderJournalEntry();
    },
    
    setJournalDiscipline(status) {
        const date = document.getElementById('journalDate').value;
        if(!this.data.journal.entries[date]) this.data.journal.entries[date] = {};
        
        this.data.journal.entries[date].followedRules = status;
        
        // Reset broken rules if user switches to YES
        if(status === true) {
            this.data.journal.entries[date].brokenRules = [];
        }
        
        this.saveJournal();
        this.renderJournalEntry();
    },
    
    saveJournalEntry() {
        const date = document.getElementById('journalDate').value;
        if(!this.data.journal.entries[date]) this.data.journal.entries[date] = {};
        this.data.journal.entries[date].notes = document.getElementById('jDailyNotes').value;
        this.saveJournal();
    },
    
    toggleJournalEmotion(em) {
        const date = document.getElementById('journalDate').value;
        if(!this.data.journal.entries[date]) this.data.journal.entries[date] = { emotions: [] };
        if(!this.data.journal.entries[date].emotions) this.data.journal.entries[date].emotions = [];
        
        const list = this.data.journal.entries[date].emotions;
        if(list.includes(em)) list.splice(list.indexOf(em), 1);
        else list.push(em);
        this.saveJournal();
        this.renderJournalEntry();
    },
    
    async handleJournalPaste(e) {
        e.preventDefault();
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (const item of items) {
            if (item.type.indexOf("image") === 0) {
                const blob = item.getAsFile();
                const id = await imgDB.save(blob);
                const date = document.getElementById('journalDate').value;
                if(!this.data.journal.entries[date]) this.data.journal.entries[date] = { images: [] };
                if(!this.data.journal.entries[date].images) this.data.journal.entries[date].images = [];
                this.data.journal.entries[date].images.push(id);
                this.saveJournal();
                this.renderJournalEntry();
                return;
            }
        }
        alert("No image found in clipboard.");
    },
	
	getJournalActivity(dateStr) {
        const activity = [];
        // 1. Entries
        this.data.logs.forEach(log => {
            if (log.date.startsWith(dateStr)) {
                activity.push({ type: 'ENTRY', log: log, time: new Date(log.date), img: log.entryImg });
            }
        });
        // 2. Exits
        this.data.logs.forEach(log => {
            if (log.exits && log.exits.length > 0) {
                log.exits.forEach((ex, idx) => {
                    if (ex.date && ex.date.startsWith(dateStr)) {
                        const isLast = idx === log.exits.length - 1;
                        const hasExitImg = isLast && log.exitImg;
                        activity.push({
                            type: 'EXIT', log: log, exitDetails: ex, time: new Date(ex.date),
                            img: hasExitImg ? log.exitImg : null, isPartial: !isLast || log.outcome === 'open'
                        });
                    }
                });
            }
        });
        return activity.sort((a,b) => a.time - b.time);
    },

	async renderJournalEntry() {
        const date = document.getElementById('journalDate').value;
        const hidePnL = this.data.settings.hidePnL || false;
        
        // --- A. AUTOMATED MARKET ACTIVITY (Improved Layout) ---
        const activity = this.getJournalActivity(date);
        const feed = document.getElementById('jActivityFeed');
        document.getElementById('jActivityContainer').classList.toggle('hidden', activity.length === 0);
        
        if (activity.length > 0) {
            feed.innerHTML = (await Promise.all(activity.map(async (item) => {
                const timeStr = item.time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const ticker = item.log.ticker;
                const fmtQty = (q) => hidePnL ? '****' : q;
                const fmtPnl = (valStr) => hidePnL ? '<span class="opacity-50 blur-[2px]">****</span>' : `<span class="text-slate-300 font-mono">${valStr}</span>`;
                
                let imgHtml = '';
                if(item.img) {
                    const src = await imgDB.get(item.img);
                    if(src) imgHtml = `<img src="${src}" class="mt-2 rounded border border-slate-700 h-20 object-cover cursor-pointer" onclick="app.showImg('${src}')">`;
                }

                // REPLAY BUTTON: Larger, Underneath, Styled
                const replayBtn = `
                    <button onclick="app.openReplay(${item.log.id})" class="mt-1.5 bg-slate-700 hover:bg-blue-600 text-slate-300 hover:text-white p-1.5 rounded-lg transition-colors shadow-sm" title="Replay Trade">
                        <i data-lucide="line-chart" class="w-6 h-6"></i>
                    </button>
                `;

                if (item.type === 'ENTRY') {
                     let stopDisplay = '';
                     if (item.log.stopMeta && item.log.stopMeta.mode === 'staggered') {
                          const levels = item.log.stopMeta.levels.map(l => `${l.pct}% @ ${l.price}`).join(', ');
                          stopDisplay = `<div class="text-[10px] text-red-400 font-mono mt-0.5"><i data-lucide="shield" class="w-3 h-3 inline mr-0.5"></i>Staggered: ${levels}</div>`;
                     } else {
                          const price = (item.log.stopMeta && item.log.stopMeta.price) ? item.log.stopMeta.price : item.log.stop;
                          stopDisplay = `<div class="text-[10px] text-red-400 font-mono mt-0.5"><i data-lucide="shield" class="w-3 h-3 inline mr-0.5"></i>Stop: ${price}</div>`;
                     }

                    return `<div class="bg-slate-800/50 border-l-2 border-blue-500 p-3 rounded-r-lg border-y border-r border-slate-700/50">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="text-[10px] font-mono text-slate-500">${timeStr}</span>
                                <div class="font-bold text-slate-200 text-sm">Opened ${ticker}</div>
                                <div class="text-[10px] text-slate-400">Bot <span class="text-white font-bold">${fmtQty(item.log.initialQty)}</span> @ <span class="text-amber-400 font-mono">${item.log.entry}</span></div>
                                ${stopDisplay}
                            </div>
                            <div class="flex flex-col items-end">
                                <span class="bg-blue-900/30 text-blue-400 text-[9px] px-1.5 py-0.5 rounded uppercase font-bold">Entry</span>
                                ${replayBtn}
                            </div>
                        </div>
                        ${item.log.notes ? `<div class="text-xs text-slate-500 mt-1 italic border-t border-slate-700/50 pt-1">"${item.log.notes}"</div>` : ''} 
                        ${imgHtml}
                    </div>`;
                } 
                else {
                    const badge = item.isPartial ? 'PARTIAL' : 'CLOSED';
                    const badgeColor = item.isPartial ? 'text-amber-400 bg-amber-900/30' : 'text-emerald-400 bg-emerald-900/30';
                    const borderColor = item.isPartial ? 'border-amber-500' : 'border-emerald-500';
                    const pnlObj = this.getPnl(item.log, item.exitDetails.price, item.exitDetails.qty);
                    
                    let rInfo = '';
                    const riskPerShare = Math.abs(item.log.entry - item.log.stop);
                    const totalRisk = item.log.initialQty * riskPerShare;
                    if(totalRisk > 0) {
                        const chunkPnl = (item.log.direction==='SHORT'? item.log.entry - item.exitDetails.price : item.exitDetails.price - item.log.entry) * item.exitDetails.qty;
                        const chunkR = chunkPnl / totalRisk;
                        rInfo = `R: <span class="${chunkR>=0?'text-emerald-400':'text-red-400'} font-bold">${chunkR>=0?'+':''}${chunkR.toFixed(2)}</span>`;
                    }

                    return `<div class="bg-slate-800/50 border-l-2 ${borderColor} p-3 rounded-r-lg border-y border-r border-slate-700/50">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="text-[10px] font-mono text-slate-500">${timeStr}</span>
                                <div class="font-bold text-slate-200 text-sm">Sold <span class="text-white">${fmtQty(item.exitDetails.qty)}</span> ${ticker}</div>
                                <div class="text-[10px] text-slate-400">@ ${item.exitDetails.price}  ${rInfo}</div>
                                <div class="text-[10px] text-slate-500 mt-0.5">P&L: ${fmtPnl(pnlObj.formatted)}</div>
                            </div>
                            <div class="flex flex-col items-end">
                                <span class="${badgeColor} text-[9px] px-1.5 py-0.5 rounded uppercase font-bold">${badge}</span>
                                ${replayBtn}
                            </div>
                        </div>
                        ${imgHtml}
                    </div>`;
                }
            }))).join('');
        }

        // --- B. MANUAL JOURNAL & BROKEN RULES (Unchanged) ---
        const entry = this.data.journal.entries[date] || { notes: '', emotions: [], followedRules: null, images: [], brokenRules: [] };
        
        let brokenRulesHtml = '';
        if (entry.followedRules === false) {
            const brokenList = entry.brokenRules || [];
            const rulesList = this.data.journal.rules.map((rule, idx) => {
                const isBroken = brokenList.includes(rule);
                const icon = isBroken ? 'check-square' : 'square';
                const style = isBroken 
                    ? 'bg-red-900/40 text-red-300 border-red-500/50 font-bold' 
                    : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-slate-500 hover:text-slate-200';
                
                return `<button onclick="app.toggleBrokenRule(${idx})" class="w-full text-left p-2.5 rounded border text-xs flex items-center gap-3 transition-all ${style} mb-1.5">
                    <i data-lucide="${icon}" class="w-4 h-4 flex-shrink-0"></i>
                    <span class="leading-tight">${rule}</span>
                </button>`;
            }).join('');

            brokenRulesHtml = `
            <div class="mt-4 pt-4 border-t border-slate-700/50 animate-in fade-in slide-in-from-top-2">
                <h4 class="text-[10px] font-bold text-red-400 mb-2 uppercase flex items-center gap-2">
                    <i data-lucide="alert-circle" class="w-3 h-3"></i> Which rules did you break?
                </h4>
                <div>${rulesList}</div>
            </div>`;
        }

        // 2. Render Discipline Container
        const btnYes = document.getElementById('btn-disc-yes');
        const btnNo = document.getElementById('btn-disc-no');
        
        if (btnYes && btnNo) {
            btnYes.className = `flex-1 py-2 rounded-lg border font-bold text-xs transition-all flex flex-col items-center gap-1 ${entry.followedRules===true ? 'bg-emerald-600 text-white border-emerald-500 shadow-lg shadow-emerald-900/20' : 'bg-slate-900 border-emerald-900/30 text-slate-500 hover:border-emerald-500/50'}`;
            btnNo.className = `flex-1 py-2 rounded-lg border font-bold text-xs transition-all flex flex-col items-center gap-1 ${entry.followedRules===false ? 'bg-red-600 text-white border-red-500 shadow-lg shadow-red-900/20' : 'bg-slate-900 border-red-900/30 text-slate-500 hover:border-red-500/50'}`;
            
            let brokenTarget = document.getElementById('brokenRulesArea');
            if (!brokenTarget) {
                brokenTarget = document.createElement('div');
                brokenTarget.id = 'brokenRulesArea';
                btnYes.parentElement.parentElement.appendChild(brokenTarget);
            }
            brokenTarget.innerHTML = brokenRulesHtml;
        }

        // 3. Notes & Emotions
        document.getElementById('jDailyNotes').value = entry.notes || '';
        document.getElementById('jDailyEmotions').innerHTML = this.data.journal.emotionsList.map(em => {
            const active = entry.emotions && entry.emotions.includes(em);
            return `<button onclick="app.toggleJournalEmotion('${em}')" class="px-3 py-1 rounded-full text-xs border transition-colors ${active ? 'bg-indigo-600 text-white border-indigo-500 shadow-sm' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-slate-500'}">${em}</button>`;
        }).join('');
        
        const imgHtmls = entry.images ? await Promise.all(entry.images.map(async (id) => `<div class="relative group"><img src="${await imgDB.get(id)}" class="w-full h-24 object-cover rounded border border-slate-600 cursor-pointer" onclick="app.showImg('${await imgDB.get(id)}')"></div>`)) : [];
        document.getElementById('jDailyImages').innerHTML = imgHtmls.join('');
        
        this.updatePrivacyIcons();
        lucide.createIcons();
    },
	
	openManualLogModal() {
        ['manTicker','manPrice','manQty','manStop'].forEach(id => document.getElementById(id).value = '');
        
        // 1. Populate Strategies
        const stratSel = document.getElementById('manStrategy');
        stratSel.innerHTML = '<option value="">(Select Strategy...)</option>' + 
            this.data.settings.strategies.map(s => `<option value="${s}">${s}</option>`).join('');

        // 2. Populate Currencies (With Priority Logic)
        const ccySel = document.getElementById('manTradeCurrency');
        const options = ['USD', 'GBP', 'EUR', 'CAD', 'JPY', 'AUD', 'CHF'];
        
        // PRIORITY: 1. Your Existing Setting, 2. Base Currency, 3. Fallback to USD
        const def = this.data.settings.defaultTradeCurrency || this.data.settings.baseCurrency || 'USD';
        
        ccySel.innerHTML = options.map(c => 
            `<option value="${c}" ${c === def ? 'selected' : ''}>${c}</option>`
        ).join('');

        // 3. Date Defaults
        const now = new Date();
        const localDate = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');
        const localTime = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
        
        document.getElementById('manDate').value = localDate;
        document.getElementById('manTime').value = localTime;

        document.getElementById('manualLogModal').classList.remove('hidden');
    },

    async saveManualLog() {
        // 1. Get Values
        const ticker = document.getElementById('manTicker').value.toUpperCase();
        const tradeCcy = document.getElementById('manTradeCurrency').value; // NEW
        const dir = document.getElementById('manDirection').value;
        const price = parseFloat(document.getElementById('manPrice').value);
        const qty = parseFloat(document.getElementById('manQty').value);
        const stop = parseFloat(document.getElementById('manStop').value);
        const strategy = document.getElementById('manStrategy').value;
        const dateStr = document.getElementById('manDate').value;
        const timeStr = document.getElementById('manTime').value;

        // 2. Validations
        if(!ticker || !price || !qty || isNaN(stop) || !dateStr || !timeStr) return alert("All fields required");
        if ((dir === 'LONG' && stop >= price) || (dir === 'SHORT' && stop <= price)) return alert("Invalid Stop placement");

        const combinedDate = new Date(`${dateStr}T${timeStr}`);
        if(isNaN(combinedDate.getTime())) return alert("Invalid Date/Time");
        const finalDate = combinedDate.toISOString();

        // 3. UI Feedback
        const btn = document.querySelector('#manualLogModal button');
        const originalText = btn.textContent;
        btn.textContent = "Fetching FX Rate...";
        btn.disabled = true;

        // 4. FX Calculation
        const baseCcy = this.data.settings.baseCurrency;
        let rate = 1;
        
        // Only fetch if they are different
        if(baseCcy !== tradeCcy) {
            try {
                // Fetch rate from Frankfurter API
                const response = await fetch(`https://api.frankfurter.app/latest?from=${baseCcy}&to=${tradeCcy}`);
                const data = await response.json();
                rate = data.rates[tradeCcy];
            } catch (e) {
                alert(`Could not fetch live FX rate for ${baseCcy}/${tradeCcy}. Defaulting to 1.0.`);
                rate = 1; 
            }
        }

        // 5. Calculate Risk % (Converted to Base Currency for accurate Account Risk)
        const masterAcc = this.data.accounts.find(a => a.isMaster);
        const riskDist = Math.abs(price - stop);
        const totalRiskTradeCcy = riskDist * qty;
        
        const totalRiskBaseCcy = totalRiskTradeCcy / rate;
        
        const riskVal = (masterAcc && masterAcc.size > 0) 
            ? parseFloat(((totalRiskBaseCcy / masterAcc.size) * 100).toFixed(2)) 
            : 0;

        // 6. Save Log
        this.data.logs.unshift({
            id: Date.now(), 
            date: finalDate, 
            ticker: ticker, 
            direction: dir, 
            entry: price, 
            stop: stop, 
            initialStop: stop,
            initialQty: qty,
            riskMode: 'equity', 
            riskVal: riskVal, 
            strategy: strategy || 'Manual Entry',
            notes: 'Manual Log', 
            outcome: 'open', 
            exits: [], 
            exchangeRate: rate, // Save the rate
            stopMeta: { mode: 'single', price: stop } 
        });
        
        localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
        document.getElementById('manualLogModal').classList.add('hidden');
        
        // Reset Button
        btn.textContent = originalText;
        btn.disabled = false;

        // Refresh Views
        this.renderLogs(); 
       
        if(this.drawConsistencyHeatmap) this.drawConsistencyHeatmap(this.data.logs);
        
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-emerald-500 text-white px-4 py-2 rounded shadow-lg z-50 animate-bounce';
        toast.innerHTML = `Trade Logged!<br><span class="text-xs opacity-90">FX Rate: ${rate.toFixed(4)}</span>`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2500);
    },

    // --- SHARING & PRIVACY ENGINE ---

    togglePrivacyMode() {
        this.data.settings.hidePnL = !this.data.settings.hidePnL;
        this.saveSettings();
        
        // Refresh Views
        const logView = document.getElementById('view-logs');
        const jourView = document.getElementById('view-journal');
        const statsView = document.getElementById('view-stats');
        
        if (logView && !logView.classList.contains('hidden')) this.renderLogs();
        if (jourView && !jourView.classList.contains('hidden')) this.renderJournalEntry();
        if (statsView && !statsView.classList.contains('hidden')) this.renderStats();
        
        this.updatePrivacyIcons();
    },

    updatePrivacyIcons() {
        const isHidden = this.data.settings.hidePnL;
        const iconHtml = isHidden 
            ? `<i data-lucide="eye-off" class="w-5 h-5 text-amber-400"></i>` 
            : `<i data-lucide="eye" class="w-5 h-5"></i>`;

        ['journalPrivacyBtn', 'statsPrivacyBtn', 'privacyToggleBtn'].forEach(id => {
            const btn = document.getElementById(id);
            if(btn) { btn.innerHTML = iconHtml; lucide.createIcons(); }
        });
    },

	// MASTER SNAPSHOT (High-Res + Chart Fix + Text Fix)
    async captureAndShare(elementId, loadingBtnId = null) {
        const source = document.getElementById(elementId);
        if(!source) return;

        let originalIcon = '';
        const btn = loadingBtnId ? document.getElementById(loadingBtnId) : null;
        if(btn) {
            originalIcon = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin text-blue-400"></i>`;
            lucide.createIcons();
        }

        try {
            // A. CLONE
            const clone = source.cloneNode(true);
            
            // B. STYLE CLONE
            clone.style.position = 'absolute';
            clone.style.left = '-9999px';
            clone.style.top = '0';
            clone.style.width = '1200px'; 
            clone.style.height = 'auto';
            clone.style.background = '#0f172a';
            clone.style.padding = '30px';
            clone.style.borderRadius = '16px';
            
            if(elementId === 'logsTableWrapper') {
                const inner = clone.querySelector('#logsContainer');
                if(inner) { inner.style.overflow = 'visible'; inner.style.height = 'auto'; }
            }

            // --- 1. CANVAS REPAIR (Fix Charts) ---
            const origCanvases = source.querySelectorAll('canvas');
            const cloneCanvases = clone.querySelectorAll('canvas');
            origCanvases.forEach((orig, i) => {
                const dest = cloneCanvases[i];
                if (dest) {
                    dest.width = orig.width;
                    dest.height = orig.height;
                    dest.style.width = orig.style.width;
                    dest.style.height = orig.style.height;
                    dest.getContext('2d').drawImage(orig, 0, 0);
                }
            });

            // --- 2. FORM REPAIR (Fix Textareas/Inputs for Readability) ---
            const origForms = source.querySelectorAll('input[type="text"], textarea');
            const cloneForms = clone.querySelectorAll('input[type="text"], textarea');
            
            origForms.forEach((orig, i) => {
                const target = cloneForms[i];
                if(target) {
                    // Create a clean text div to replace the input box
                    const textDiv = document.createElement('div');
                    textDiv.innerText = orig.value; // Grab the true text value
                    textDiv.className = 'text-sm text-slate-200 whitespace-pre-wrap leading-relaxed';
                    
                    // Maintain container style if it was a philosophy box
                    if(orig.tagName === 'TEXTAREA' && orig.classList.contains('bg-slate-900')) {
                         textDiv.className += ' p-3 bg-slate-900 border border-slate-600 rounded';
                    }
                    
                    target.parentNode.replaceChild(textDiv, target);
                }
            });

            // C. WATERMARK
            const footer = document.createElement('div');
            footer.className = 'flex justify-between items-center mt-8 pt-6 border-t border-slate-800';
            footer.innerHTML = `<div class="flex items-center gap-3"><div class="w-6 h-6 rounded bg-gradient-to-br from-blue-500 to-emerald-400 shadow-lg shadow-blue-500/20"></div><span class="text-sm font-bold text-slate-200 tracking-wide">RiskDesk</span></div><div class="text-xs font-mono text-slate-500">www.riskdesk.io</div>`;
            clone.appendChild(footer);

            document.body.appendChild(clone);
            const canvas = await html2canvas(clone, { backgroundColor: '#0f172a', scale: 3, logging: false });
            document.body.removeChild(clone);

            canvas.toBlob(async (blob) => {
                try { await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]); alert("Snapshot copied!"); } 
                catch (err) { app.showImg(URL.createObjectURL(blob)); }
                if(btn) { btn.innerHTML = originalIcon; lucide.createIcons(); }
            });
        } catch (e) {
            console.error(e); alert("Snapshot failed.");
            if(btn) { btn.innerHTML = originalIcon; lucide.createIcons(); }
        }
    },

    shareActiveJournalTab() {
        const rules = document.getElementById('jtab-rules');
        if (!rules.classList.contains('hidden')) {
            this.captureAndShare('journalRulesContainer', 'journalShareBtn');
        } else {
            this.captureAndShare('journalLogContainer', 'journalShareBtn');
        }
    },

	
	async shareLogImage(btn) {
        const row = btn.closest('.log-row');
        if (!row) return;

        const originalIcon = btn.innerHTML;
        btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin text-blue-400"></i>`;
        lucide.createIcons();

        let container = null;

        try {
            const currentWidth = row.getBoundingClientRect().width;
            const isLandscape = window.innerWidth >= 768 || (window.orientation && Math.abs(window.orientation) === 90);
            const colCount = isLandscape ? 16 : 10;

            // --- UPDATED MAPS FOR NEW COLUMN STRUCTURE ---
            // Indices: 0:Date, 1:Ticker, 2:Price(New), 3:Qty, 4:Stop, 5:Risk, 6:Perf, 7:PortRisk, 8:PortStatus, 9:LandPnL, 10:LandStatus, 11:Share
            const mapLandscape = [true, true, true, true, true, true, true, false, false, true, true, false];
            const mapPortrait  = [true, true, false, false, false, false, false, true, true, false, false, false];
            const activeMap = isLandscape ? mapLandscape : mapPortrait;
            // ---------------------------------------------

            const enforceLayout = (element, isHeader) => {
                element.style.display = 'grid';
                element.style.gridTemplateColumns = `repeat(${colCount}, minmax(0, 1fr))`;
                element.style.gap = '0.5rem';
                element.style.alignItems = 'center';
                element.style.boxSizing = 'border-box';
                element.style.width = '100%'; 
                element.style.padding = '0.75rem';
                if(isHeader) element.style.textAlign = 'left'; 

                const children = Array.from(element.children);
                children.forEach((child, idx) => {
                    child.style.boxSizing = 'border-box';
                    if (idx < activeMap.length) {
                        if (!activeMap[idx]) {
                            child.style.display = 'none';
                            return;
                        }
                        child.classList.remove('hidden', 'md:hidden', 'md:block');
                        child.style.display = (child.classList.contains('flex') || child.classList.contains('flex-col')) ? 'flex' : 'block';
                        child.style.gridRow = '1 / 1';
                        
                        let span = 1;
                        if (child.classList.contains('col-span-2')) span = 2;
                        else if (child.classList.contains('col-span-3')) span = 3;
                        else if (child.classList.contains('col-span-4')) span = 4;
                        
                        child.style.gridColumn = `span ${span} / span ${span}`;
                    }
                });
            };

            container = document.createElement('div');
            container.style.position = 'absolute';
            container.style.left = '-9999px';
            container.style.width = `${currentWidth}px`;
            container.style.background = '#0f172a';
            container.style.borderRadius = '12px';
            container.style.overflow = 'hidden'; 
            container.style.fontFamily = 'ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, sans-serif';
            container.style.boxSizing = 'border-box';
            
            // Get Header logic (Updated to look inside wrapper properly)
            const wrapper = document.getElementById('logsTableWrapper');
            if (wrapper && wrapper.firstElementChild && wrapper.firstElementChild.classList.contains('log-grid-layout')) {
                const headerClone = wrapper.firstElementChild.cloneNode(true);
                headerClone.style.backgroundColor = '#1e293b'; 
                headerClone.style.borderBottom = '1px solid #334155';
                headerClone.style.color = '#94a3b8'; 
                headerClone.style.fontSize = '0.75rem';
                headerClone.style.fontWeight = 'bold';
                
                enforceLayout(headerClone, true);
                container.appendChild(headerClone);
            }

            const rowClone = row.cloneNode(true);
            rowClone.style.backgroundColor = '#0f172a'; 
            rowClone.style.color = '#e2e8f0';
            rowClone.classList.remove('hover:bg-slate-800'); 
            
            enforceLayout(rowClone, false);

            const buttons = rowClone.querySelectorAll('button, .action-buttons');
            buttons.forEach(b => b.style.visibility = 'hidden');

            container.appendChild(rowClone);

            const footer = document.createElement('div');
            footer.style.display = 'flex';
            footer.style.justifyContent = 'space-between';
            footer.style.alignItems = 'center';
            footer.style.padding = '0.75rem 1rem';
            footer.style.backgroundColor = '#020617'; 
            footer.style.borderTop = '1px solid #1e293b';
            footer.style.boxSizing = 'border-box';
            
            footer.innerHTML = `
                <div style="display:flex; align-items:center; gap:0.5rem;">
                    <div style="width:16px; height:16px; border-radius:4px; background: linear-gradient(to bottom right, #3b82f6, #34d399);"></div>
                    <span style="font-size:0.75rem; font-weight:700; color:#cbd5e1; letter-spacing:0.025em;">RiskDesk</span>
                </div>
                <div style="font-size:0.65rem; font-family:monospace; color:#475569;">www.riskdesk.io</div>
            `;
            container.appendChild(footer);

            document.body.appendChild(container);
            
            const scale = 3; 
            const canvas = await html2canvas(container, {
                backgroundColor: '#0f172a',
                scale: scale,
                logging: false,
                useCORS: true
            });

            canvas.toBlob(async (blob) => {
                const file = new File([blob], `Trade_${new Date().getTime()}.png`, { type: 'image/png' });
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({ files: [file], title: 'Trade Log' });
                        btn.innerHTML = originalIcon;
                        lucide.createIcons();
                        return;
                    } catch (err) { console.log(err); }
                }
                try {
                    await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                    alert("Snapshot copied to clipboard!");
                } catch (err) {
                    app.showImg(URL.createObjectURL(blob));
                }
                btn.innerHTML = originalIcon;
                lucide.createIcons();
            });

        } catch(e) {
            console.error("Snapshot Error:", e);
            alert("Error creating snapshot.");
            btn.innerHTML = originalIcon;
            lucide.createIcons();
        } finally {
            if (container && document.body.contains(container)) {
                document.body.removeChild(container);
            }
        }
    },

    // 2. Share Full Page (Mobile First)
    async shareLogView() {
        const source = document.getElementById('logsTableWrapper');
        if(!source) return;

        const btn = document.getElementById('sharePageBtn');
        const originalIcon = btn ? btn.innerHTML : '';
        if(btn) {
            btn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin text-blue-400"></i>`;
            lucide.createIcons();
        }

        try {
            const clone = source.cloneNode(true);
            clone.style.position = 'absolute';
            clone.style.left = '-9999px';
            clone.style.width = '800px'; 
            clone.style.height = 'auto'; 
            clone.style.overflow = 'visible'; 
            
            const cloneContainer = clone.querySelector('#logsContainer');
            if(cloneContainer) {
                cloneContainer.style.overflow = 'visible';
                cloneContainer.style.height = 'auto';
            }

            document.body.appendChild(clone);
            const canvas = await html2canvas(clone, { backgroundColor: '#0f172a', scale: 2 });
            document.body.removeChild(clone);

            canvas.toBlob(async (blob) => {
                const file = new File([blob], `RiskDesk_Log_${new Date().toISOString().split('T')[0]}.png`, { type: 'image/png' });

                // STRATEGY A: Native Mobile Share Sheet
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: 'RiskDesk Log'
                        });
                        if(btn) { btn.innerHTML = originalIcon; lucide.createIcons(); }
                        return; 
                    } catch (err) {
                        console.log("Share cancelled");
                    }
                }

                // STRATEGY B: Clipboard
                try {
                    await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                    alert("Log Copied to Clipboard!");
                } catch (err) {
                    // STRATEGY C: Fallback
                    app.showImg(URL.createObjectURL(blob));
                }
                if(btn) { btn.innerHTML = originalIcon; lucide.createIcons(); }
            });

        } catch (e) {
            console.error(e);
            alert("Error creating snapshot");
            if(btn) { btn.innerHTML = originalIcon; lucide.createIcons(); }
        }
    },
	
    // ROUTER for Journal Tabs
    shareActiveJournalTab() {
        const rules = document.getElementById('jtab-rules');
        if (!rules.classList.contains('hidden')) {
            this.captureAndShare('journalRulesContainer', 'journalShareBtn');
        } else {
            this.captureAndShare('journalLogContainer', 'journalShareBtn');
        }
    },

    // SINGLE ROW SHARER (With Headers + Watermark) - ROBUST VERSION
    async shareLogImage(btn) {
        const row = btn.closest('.log-row');
        if (!row) return;

        // Visual Feedback
        const originalIcon = btn.innerHTML;
        btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin text-blue-400"></i>`;
        lucide.createIcons();

        try {
            // 1. CREATE CANVAS CONTAINER (The Card)
            const container = document.createElement('div');
            container.style.position = 'absolute';
            container.style.left = '-9999px';
            container.style.width = '900px'; 
            container.style.background = '#0f172a'; // Slate 900
            container.style.borderRadius = '12px';
            container.style.overflow = 'hidden'; 
            container.style.fontFamily = 'ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, sans-serif'; // Enforce font

            // 2. FIND HEADER (SMART LOOKUP)
            // Strategy: Find the container holding the rows, then grab the sibling immediately before it (The Header)
            let headerOriginal = null;
            const logsContainer = document.getElementById('logsContainer');
            if (logsContainer && logsContainer.previousElementSibling) {
                headerOriginal = logsContainer.previousElementSibling;
            }

            // 3. CLONE & STYLE HEADER
            if (headerOriginal) {
                const headerClone = headerOriginal.cloneNode(true);
                // Force specific styles to ensure it looks right in the snapshot
                headerClone.className = ''; // Wipe classes to avoid conflicts
                headerClone.style.display = 'grid';
                headerClone.style.gridTemplateColumns = 'repeat(10, minmax(0, 1fr))'; // Match grid-cols-10
                headerClone.style.gap = '0.5rem';
                headerClone.style.padding = '1rem';
                headerClone.style.backgroundColor = '#1e293b'; // Slate 800
                headerClone.style.borderBottom = '1px solid #334155';
                headerClone.style.color = '#94a3b8'; // Slate 400
                headerClone.style.fontSize = '0.75rem'; // text-xs
                headerClone.style.fontWeight = '700';
                headerClone.style.textTransform = 'uppercase';
                
                container.appendChild(headerClone);
            }

            // 4. CLONE & STYLE ROW
            const rowClone = row.cloneNode(true);
            rowClone.className = ''; // Wipe classes
            rowClone.style.display = 'grid';
            rowClone.style.gridTemplateColumns = 'repeat(10, minmax(0, 1fr))';
            rowClone.style.gap = '0.5rem';
            rowClone.style.padding = '1rem';
            rowClone.style.backgroundColor = '#0f172a'; // Slate 900
            rowClone.style.alignItems = 'center';
            rowClone.style.color = '#e2e8f0';
            
            // Hide the buttons in the screenshot
            const actions = rowClone.querySelector('.action-buttons');
            if(actions) actions.style.visibility = 'hidden';
            
            container.appendChild(rowClone);

            // 5. ADD WATERMARK FOOTER
            const footer = document.createElement('div');
            footer.style.display = 'flex';
            footer.style.justifyContent = 'space-between';
            footer.style.alignItems = 'center';
            footer.style.padding = '0.75rem 1rem';
            footer.style.backgroundColor = '#020617'; // Slate 950
            footer.style.borderTop = '1px solid #1e293b';
            
            footer.innerHTML = `
                <div style="display:flex; align-items:center; gap:0.5rem;">
                    <div style="width:16px; height:16px; border-radius:4px; background: linear-gradient(to bottom right, #3b82f6, #34d399);"></div>
                    <span style="font-size:0.75rem; font-weight:700; color:#cbd5e1; letter-spacing:0.025em;">RiskDesk</span>
                </div>
                <div style="font-size:0.65rem; font-family:monospace; color:#475569;">www.riskdesk.io</div>
            `;
            container.appendChild(footer);

            // 6. RENDER & CAPTURE
            document.body.appendChild(container);
            
            const canvas = await html2canvas(container, {
                backgroundColor: '#0f172a',
                scale: 3 // High Res
            });

            document.body.removeChild(container);

            // 7. SHARE
            canvas.toBlob(async (blob) => {
                try {
                    await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                    alert("Trade Snapshot copied!");
                } catch (err) {
                    app.showImg(URL.createObjectURL(blob));
                }
                btn.innerHTML = originalIcon;
                lucide.createIcons();
            });
			
						
        } catch(e) {
            console.error(e);
            alert("Error creating snapshot");
            btn.innerHTML = originalIcon;
            lucide.createIcons();
        }
    },
	updateLogStrategy(id, val) {
        const log = this.data.logs.find(l => l.id === id);
        if(log) {
            log.strategy = val;
            localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
            // No need to re-render the whole view, just save it.
            // But we do need to re-render Logs list in background if filtering
            this.renderLogs();
        }
    },
	// 1. EDIT MODE TRIGGER
    editExit(idx) {
        const log = this.data.logs.find(l => l.id === this.data.editingId);
        if(!log || !log.exits[idx]) return;

        const ex = log.exits[idx];
        
        // Populate Form
        document.getElementById('exitInputPrice').value = ex.price;
        document.getElementById('exitInputQty').value = ex.qty;
        
        // Format Date for Input
        if(ex.date) {
            const d = new Date(ex.date);
            d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
            document.getElementById('exitInputDate').value = d.toISOString().slice(0, 16);
        }

        // Set UI State
        this.data.editingExitIdx = idx;
        document.getElementById('exitFormTitle').textContent = `Editing Exit #${idx + 1}`;
        document.getElementById('exitActionBtn').textContent = "Update Exit";
        document.getElementById('exitActionBtn').classList.replace('bg-blue-600', 'bg-amber-600');
        document.getElementById('cancelExitEditBtn').classList.remove('hidden');
    },

    // 2. CANCEL EDIT
    cancelExitEdit() {
        this.data.editingExitIdx = null;
        document.getElementById('exitFormTitle').textContent = "Add Exit / Partial";
        document.getElementById('exitActionBtn').textContent = "Log Exit";
        document.getElementById('exitActionBtn').classList.replace('bg-amber-600', 'bg-blue-600');
        document.getElementById('cancelExitEditBtn').classList.add('hidden');
        
        document.getElementById('exitInputPrice').value = '';
        document.getElementById('exitInputQty').value = '';
        
        // Reset Date
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('exitInputDate').value = now.toISOString().slice(0, 16);
    },

    // 3. MAIN ACTION (ADD OR UPDATE)
    addExit() {
        const log = this.data.logs.find(l => l.id === this.data.editingId);
        if(!log) return;

        const price = parseFloat(document.getElementById('exitInputPrice').value);
        const qty = parseInt(document.getElementById('exitInputQty').value);
        const dateVal = document.getElementById('exitInputDate').value;

        if(!price || !qty || !dateVal) return alert("Please enter Date, Price and Quantity");

        const exitDate = new Date(dateVal).toISOString();

        // Calculate available shares
        // If editing, we pretend the shares from the 'editing' exit are available again
        let totalSold = log.exits.reduce((a,b) => a+b.qty, 0);
        let available = log.initialQty - totalSold;
        
        if (this.data.editingExitIdx !== null) {
            available += log.exits[this.data.editingExitIdx].qty;
        }

        if(qty > available) {
            return alert(`Cannot sell ${qty}. Only ${available} shares remaining.`);
        }

        const masterIdx = this.data.accounts.findIndex(a => a.isMaster);
        const rate = log.exchangeRate || 1;

        // --- UPDATE LOGIC ---
        if (this.data.editingExitIdx !== null) {
            // A. Reverse Old P&L
            const oldEx = log.exits[this.data.editingExitIdx];
            const oldPnlTrade = log.direction === 'SHORT' ? (log.entry - oldEx.price)*oldEx.qty : (oldEx.price - log.entry)*oldEx.qty;
            if(masterIdx !== -1) this.data.accounts[masterIdx].size -= (oldPnlTrade / rate);

            // B. Update Exit Object
            log.exits[this.data.editingExitIdx] = { price, qty, date: exitDate };
            
            // C. Apply New P&L
            const newPnlTrade = log.direction === 'SHORT' ? (log.entry - price)*qty : (price - log.entry)*qty;
            if(masterIdx !== -1) this.data.accounts[masterIdx].size += (newPnlTrade / rate);
            
            alert("Exit Updated");
        } 
        // --- ADD LOGIC ---
        else {
            const newPnlTrade = log.direction === 'SHORT' ? (log.entry - price)*qty : (price - log.entry)*qty;
            if(masterIdx !== -1) this.data.accounts[masterIdx].size += (newPnlTrade / rate);
            
            log.exits.push({ price, qty, date: exitDate });
            
            const currency = this.data.settings.baseCurrency;
            const pnlBase = newPnlTrade / rate;
            const sign = pnlBase >= 0 ? '+' : '';
            // Optional: alert(`Exit Logged. Account: ${sign}${pnlBase.toFixed(2)} ${currency}`);
        }

        // Clean up formatting on master account
        if(masterIdx !== -1) this.data.accounts[masterIdx].size = parseFloat(this.data.accounts[masterIdx].size.toFixed(2));

        // Re-sort exits by date to keep timeline clean
        log.exits.sort((a,b) => new Date(a.date) - new Date(b.date));

        // Check if fully closed
        const finalSold = log.exits.reduce((a,b) => a+b.qty, 0);
        if(finalSold >= log.initialQty) log.outcome = 'profit'; // Simplified outcome logic
        else log.outcome = 'open';

        localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
        this.saveSettings(); // Save account size
        
        this.openManageView(this.data.editingId); 
        this.renderLogs(); 
        
    },
	// --- PATCH: BROKEN RULES LOGIC ---
    toggleBrokenRule(idx) {
        const date = document.getElementById('journalDate').value;
        if (!this.data.journal.entries[date]) this.data.journal.entries[date] = {};
        
        // Ensure array exists
        if (!this.data.journal.entries[date].brokenRules) {
            this.data.journal.entries[date].brokenRules = [];
        }

        const ruleText = this.data.journal.rules[idx];
        const list = this.data.journal.entries[date].brokenRules;

        // Toggle
        if (list.includes(ruleText)) {
            list.splice(list.indexOf(ruleText), 1);
        } else {
            list.push(ruleText);
        }

        this.saveJournal();
        this.renderJournalEntry(); // Re-render to show checkmark
    },
	// Helper: Handle typing in the Cash Input Box
    manualRiskInput(val) {
        const floatVal = parseFloat(val);
        if(isNaN(floatVal)) return;
        this.data.settings.riskValue = floatVal;
        this.calculateOrUpdate();
    },

    // Helper: Handle the Cash Adjust Yes/No Toggle
    setCashAdjust(isAuto) {
        this.data.settings.cashRiskAutoAdjust = isAuto;
        const btnFixed = document.getElementById('btn-cash-fixed');
        const btnAuto = document.getElementById('btn-cash-auto');
        
        if(isAuto) {
            btnAuto.className = 'px-2 py-1 text-[9px] font-bold rounded bg-emerald-600 text-white transition-colors shadow';
            btnFixed.className = 'px-2 py-1 text-[9px] font-bold rounded text-slate-400 hover:text-white transition-colors';
        } else {
            btnFixed.className = 'px-2 py-1 text-[9px] font-bold rounded bg-slate-600 text-white transition-colors shadow';
            btnAuto.className = 'px-2 py-1 text-[9px] font-bold rounded text-slate-400 hover:text-white transition-colors';
        }
        this.calculateOrUpdate(); 
    },
	// --- FUND MANAGER LOGIC ---

    openFundsModal(idx) {
        this.data.editingAccIdx = idx; 
        const acc = this.data.accounts[idx];
        
        // Init Structure
        if(!acc.contributions) acc.contributions = [];
        if(!acc.recurring) acc.recurring = { active: false, amount: 0, day: 1, lastCheck: new Date().toISOString() };

        // Populate UI
        document.getElementById('fundsModalTitle').textContent = acc.name;
        document.getElementById('fundAmount').value = '';
        
        // Set Symbol
        const sym = this.getSymbol ? this.getSymbol(this.data.settings.baseCurrency) : '$';
        document.getElementById('fundCcySym').textContent = sym;
        
        // Recurring UI
        document.getElementById('recurActive').checked = acc.recurring.active;
        document.getElementById('recurAmount').value = acc.recurring.amount || '';
        
        const daySel = document.getElementById('recurDay');
        daySel.innerHTML = Array.from({length: 28}, (_, i) => i + 1)
            .map(d => `<option value="${d}" ${d == acc.recurring.day ? 'selected' : ''}>${d}${getOrdinal(d)}</option>`).join('');
            
        // Helper for 1st, 2nd, 3rd
        function getOrdinal(n) {
            const s = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return s[(v - 20) % 10] || s[v] || s[0];
        }

        this.toggleRecurringUI();
        this.renderFundHistory(acc);
        document.getElementById('fundsModal').classList.remove('hidden');
    },

    toggleRecurringUI() {
        const isActive = document.getElementById('recurActive').checked;
        const panel = document.getElementById('recurSettings');
        const btn = document.getElementById('recurSaveBtn');
        
        if(isActive) {
            panel.classList.remove('opacity-50', 'pointer-events-none');
            btn.classList.remove('hidden');
        } else {
            panel.classList.add('opacity-50', 'pointer-events-none');
            btn.classList.add('hidden');
            if(this.data.editingAccIdx !== null) this.saveRecurringSettings(false); 
        }
    },

    saveRecurringSettings(forceActiveState = null) {
        const idx = this.data.editingAccIdx;
        if(idx === null) return;
        const acc = this.data.accounts[idx];
        
        const active = forceActiveState !== null ? forceActiveState : document.getElementById('recurActive').checked;
        const amt = parseFloat(document.getElementById('recurAmount').value);
        const day = parseInt(document.getElementById('recurDay').value);

        if(active && (!amt || amt <= 0)) return alert("Please enter a valid monthly amount.");

        acc.recurring.active = active;
        if(active) {
            acc.recurring.amount = amt;
            acc.recurring.day = day;
            if (!acc.recurring.lastCheck) acc.recurring.lastCheck = new Date().toISOString();
        }
        
        this.saveSettings();
        this.renderSettingsAccounts(); 
        if(forceActiveState === null) alert("Auto-Deposit Schedule Saved");
    },

    processFundTransaction(type) {
        const idx = this.data.editingAccIdx;
        if(idx === null) return;
        const acc = this.data.accounts[idx];
        
        let amt = parseFloat(document.getElementById('fundAmount').value);
        if(!amt || amt <= 0) return alert("Please enter a positive amount.");

        // Apply Direction (Negative for Withdraw)
        if (type === 'withdraw') amt = -amt;

        // 1. Update Account Size
        acc.size += amt;
        
        // 2. Log History
        acc.contributions.unshift({
            date: new Date().toISOString(),
            amount: amt,
            type: 'MANUAL'
        });

        this.saveSettings();
        this.renderSettingsAccounts();
        this.renderFundHistory(acc);
        document.getElementById('fundAmount').value = '';
        
        // Feedback
        const label = type === 'withdraw' ? "Withdrawal" : "Deposit";
        alert(`${label} Successful.\nNew Balance: ${acc.size.toFixed(2)}`);
    },

    renderFundHistory(acc) {
        const list = document.getElementById('fundHistoryList');
        if(!acc.contributions || acc.contributions.length === 0) {
            list.innerHTML = `<div class="text-[9px] text-slate-600 italic text-center py-2">No transaction history.</div>`;
            return;
        }
        
        // Show last 20
        list.innerHTML = acc.contributions.slice(0, 20).map(c => {
            const date = new Date(c.date).toLocaleDateString();
            const isDep = c.amount > 0;
            const color = isDep ? 'text-emerald-400' : 'text-red-400';
            const icon = isDep ? 'arrow-down-to-line' : 'arrow-up-from-line';
            const label = c.type === 'RECURRING' ? 'Auto-Dep' : (isDep ? 'Deposit' : 'Withdraw');
            
            return `
            <div class="flex justify-between items-center text-[10px] border-b border-slate-700/50 pb-1 last:border-0">
                <div class="flex items-center gap-2">
                    <i data-lucide="${icon}" class="w-3 h-3 ${color} opacity-70"></i>
                    <div>
                        <span class="text-slate-300 font-bold block">${label}</span>
                        <span class="text-slate-500 text-[9px]">${date}</span>
                    </div>
                </div>
                <span class="${color} font-mono font-bold">${isDep ? '+' : ''}${c.amount.toFixed(2)}</span>
            </div>`;
        }).join('');
        lucide.createIcons();
    },

    // --- AUTOMATED CHECKER (Run on Startup) ---
    checkRecurringContributions() {
        const now = new Date();
        let updated = false;

        this.data.accounts.forEach(acc => {
            if(!acc.contributions) acc.contributions = [];
            if(acc.recurring && acc.recurring.active && acc.recurring.amount > 0) {
                
                let lastCheck = new Date(acc.recurring.lastCheck || new Date().toISOString());
                // Check from day AFTER last check
                let pointer = new Date(lastCheck);
                pointer.setDate(pointer.getDate() + 1);
                
                while (pointer <= now) {
                    if (pointer.getDate() === parseInt(acc.recurring.day)) {
                        // PAYDAY
                        const amt = parseFloat(acc.recurring.amount);
                        acc.size += amt;
                        acc.contributions.unshift({
                            date: pointer.toISOString(),
                            amount: amt,
                            type: 'RECURRING'
                        });
                        updated = true;
                    }
                    pointer.setDate(pointer.getDate() + 1);
                }
                acc.recurring.lastCheck = now.toISOString();
            }
        });

        if(updated) this.saveSettings();
    },
		
	// --- HELPER: HANDLE FILTER EXCLUSIVITY ---
    handleStatFilterChange(type) {
        const recencyEl = document.getElementById('statsRecency');
        const timeEl = document.getElementById('statsTimeFilter');
        
        // If changing Recency to a specific value, reset Time
        if (type === 'RECENCY' && recencyEl.value !== 'ALL') {
            timeEl.value = 'ALL';
            document.getElementById('statsCustomDates').classList.add('hidden');
            document.getElementById('statsCustomDates').classList.remove('flex');
        }
        
        // If changing Time to a specific value, reset Recency
        if (type === 'TIME' && timeEl.value !== 'ALL') {
            recencyEl.value = 'ALL';
        }

        // Re-render
        this.renderStats();
    },
	
	// --- MANAGE EDIT HELPERS ---
    updateLogTicker(id, val) {
        const log = this.data.logs.find(l => l.id === id);
        if(log && val) {
            log.ticker = val.toUpperCase();
            this.saveAndRefresh(id);
        }
    },

    updateLogEntry(id, val) {
        const log = this.data.logs.find(l => l.id === id);
        if(log && val) {
            log.entry = parseFloat(val);
            this.saveAndRefresh(id);
        }
    },

	updateLogDate(id, val) {
        const log = this.data.logs.find(l => l.id === id);
        if(log && val) {
            // Format: "2023-10-25T14:30" -> ISO
            const dateObj = new Date(val);
            if (!isNaN(dateObj.getTime())) {
                log.date = dateObj.toISOString();
                this.saveAndRefresh(id);
            }
        }
    },

    saveAndRefresh(id) {
        localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
        this.renderLogs();     // Update Grid
        this.updateRiskBar();  // Update Header
        this.openManageView(id); // Refresh Modal to show new calculations
    },
	// --- TRADINGVIEW REPLAY ENGINE ---
    
    tvChart: null, // Stores the chart instance
	// --- REPLAY SETUP (Fixes Partial Label & Open Status) ---
    async openReplay(id) {
        const log = this.data.logs.find(l => l.id === id);
        if(!log) return;

        // UI Reset
        const modal = document.getElementById('tvModal');
        modal.classList.remove('hidden');
        requestAnimationFrame(() => modal.classList.remove('opacity-0'));
        
        // Header Updates
        document.getElementById('tvTitle').innerText = log.ticker;
        document.getElementById('tvSubtitle').innerText = "Loading...";
        document.getElementById('tvContainer').innerHTML = '<div class="absolute inset-0 flex items-center justify-center"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div></div>';
        
        // Reset Controls
        document.getElementById('btnPlay').classList.remove('hidden');
        document.getElementById('btnPause').classList.add('hidden');
        document.getElementById('btnSpeed').innerText = '1x';
		const styleBtn = document.getElementById('btnTvStyle');
		if(styleBtn) styleBtn.innerText = (this.data.settings.replayBarStyle === 'bar') ? 'Bars' : 'Candles';

        try {
            // A. FETCH DATA
            let symbol = log.ticker.toUpperCase().trim();
            if(symbol.includes('/')) symbol = symbol.replace('/', '') + '=X';
            if(['BTC','ETH','SOL'].includes(symbol)) symbol = symbol + '-USD';

            const entryDate = new Date(log.date);
            let lastExitDate = entryDate;
            if (log.exits && log.exits.length > 0) {
                log.exits.forEach(e => { 
                    if(e.date && new Date(e.date) > lastExitDate) lastExitDate = new Date(e.date); 
                });
            }

            // --- CRITICAL FIX: ROBUST OPEN CHECK ---
            // We check outcome OR if shares remaining > 0
            const totalSold = log.exits ? log.exits.reduce((a,b)=>a+b.qty, 0) : 0;
            const isOpen = log.outcome === 'open' || (log.initialQty > totalSold);
            
            // If open, we analyze up to TODAY, not the last partial exit
            const analysisEndDate = isOpen ? new Date() : lastExitDate;

            const ONE_DAY = 86400 * 1000;
            const fromTime = entryDate.getTime() - (75 * ONE_DAY);
            let toTime = analysisEndDate.getTime() + (60 * ONE_DAY);
            if(toTime > Date.now()) toTime = Date.now();

            const from = Math.floor(fromTime / 1000);
            const to = Math.floor(toTime / 1000);

            const url = `https://corsproxy.io/?` + encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?symbol=${symbol}&period1=${from}&period2=${to}&interval=1d`);
            const res = await fetch(url);
            if(!res.ok) throw new Error("Data fetch failed");
            const json = await res.json();
            const result = json.chart.result?.[0];
            if(!result) throw new Error("No data found");

            // B. PROCESS CANDLES
            const quotes = result.indicators.quote[0];
            const times = result.timestamp;
            const candles = [];
            for(let i=0; i<times.length; i++) {
                if(quotes.open[i]!==null) candles.push({ time: times[i], open: quotes.open[i], high: quotes.high[i], low: quotes.low[i], close: quotes.close[i] });
            }

            // --- C. METRICS (Result % in Header) ---
            const entryTs = Math.floor(entryDate.getTime() / 1000);
            const endTs = Math.floor(analysisEndDate.getTime() / 1000);
            
            // Hold Window: Candles from Entry to (Last Exit OR Today)
            const holdWindow = candles.filter(c => c.time >= entryTs && c.time <= endTs);
            
            let mfeStr = "0.00%", maeStr = "0.00%", posStr = "0.00%";
            let posColor = "text-slate-400";
            const entryPrice = parseFloat(log.entry);

            if(holdWindow.length > 0 && !isNaN(entryPrice)) {
                const maxPrice = Math.max(...holdWindow.map(c => c.high));
                const minPrice = Math.min(...holdWindow.map(c => c.low));
                const finalPrice = holdWindow[holdWindow.length - 1].close;
                
                let mfe, mae, posPct;
                if(log.direction === 'LONG') {
                    mfe = ((maxPrice - entryPrice) / entryPrice) * 100;
                    mae = ((minPrice - entryPrice) / entryPrice) * 100; 
                    posPct = ((finalPrice - entryPrice) / entryPrice) * 100;
                } else {
                    mfe = ((entryPrice - minPrice) / entryPrice) * 100;
                    mae = ((entryPrice - maxPrice) / entryPrice) * 100; 
                    posPct = ((entryPrice - finalPrice) / entryPrice) * 100;
                }

                mfeStr = (mfe > 0 ? "+" : "") + mfe.toFixed(2) + "%";
                maeStr = (mae > 0 ? "+" : "") + mae.toFixed(2) + "%";
                posStr = (posPct > 0 ? "+" : "") + posPct.toFixed(2) + "%";
                posColor = posPct >= 0 ? "text-emerald-400" : "text-red-400";
            }

            // INJECT RESULT INTO HEADER
            const headerRes = document.getElementById('tvHeaderResult');
            if(headerRes) {
                headerRes.innerHTML = `Result: <span class="${posColor}">${posStr}</span>`;
            }

            // INJECT MFE/MAE INTO FOOTER
            const footerStats = document.getElementById('tvFooterStats');
            if(footerStats) {
                footerStats.innerHTML = `
                    <span class="mr-3" title="Max Favorable Excursion">MFE: <span class="text-emerald-400 font-bold">${mfeStr}</span></span>
                    <span title="Max Adverse Excursion">MAE: <span class="text-red-400 font-bold">${maeStr}</span></span>
                `;
            }

            // D. EMA
            const emaData = [];
            const p = 21;
            if(candles.length >= p) {
                let sum=0; 
                for(let i=0; i<p; i++) sum+=candles[i].close;
                let val = sum/p;
                emaData.push({ time: candles[p-1].time, value: val });
                const k = 2/(p+1);
                for(let i=p; i<candles.length; i++) {
                    val = (candles[i].close - val)*k + val;
                    emaData.push({ time: candles[i].time, value: val });
                }
            }

            // E. MARKERS (Fixed Logic)
            let markers = [];
            const findClosest = (dStr) => {
                if(!dStr) return null;
                const t = Math.floor(new Date(dStr).getTime()/1000);
                let closest = null, minDiff = Infinity;
                candles.forEach(c => {
                    const diff = Math.abs(c.time - t);
                    if(diff < minDiff) { minDiff = diff; closest = c; }
                });
                return closest;
            };

            const ent = findClosest(log.date);
            if(ent) markers.push({ time: ent.time, position: log.direction==='LONG'?'belowBar':'aboveBar', color: '#fbbf24', shape: log.direction==='LONG'?'arrowUp':'arrowDown', text: `ENTRY @ ${log.entry}`, size: 2 });
            
            if(log.exits && log.exits.length > 0) {
                const sortedExits = [...log.exits].sort((a,b) => new Date(a.date) - new Date(b.date));
                sortedExits.forEach((ex, index) => {
                    const x = findClosest(ex.date);
                    if(x) {
                        const isLast = index === sortedExits.length - 1;
                        // FIX: Only label CLOSE if it's last AND trade is NOT open
                        const label = (isLast && !isOpen) ? "CLOSE" : "PARTIAL";
                        markers.push({ 
                            time: x.time, 
                            position: log.direction==='LONG'?'aboveBar':'belowBar', 
                            color: '#f472b6', 
                            shape: log.direction==='LONG'?'arrowDown':'arrowUp', 
                            text: `${label} @ ${ex.price}`, 
                            size: 2 
                        });
                    }
                });
            }
            markers.sort((a,b) => a.time - b.time);

            // F. PLAYER STATE
            let startIndex = 0;
            if (ent) {
                const idx = candles.findIndex(c => c.time === ent.time);
                startIndex = Math.max(0, idx - 15);
            } else {
                startIndex = Math.max(0, candles.length - 30);
            }

            this.player = { 
                isPlaying: false, 
                speed: 500, 
                timer: null, 
                startIndex: startIndex,
                currentIndex: candles.length - 1, 
                data: { candles, emaData, markers } 
            };

            document.getElementById('tvSubtitle').innerText = "Ready";
            this.renderTvChart(candles, emaData, markers);

        } catch(e) {
            console.error(e);
            document.getElementById('tvContainer').innerHTML = `<div class="text-slate-500 text-center flex h-full items-center justify-center flex-col"><p>${e.message}</p><button onclick="app.closeTvModal()" class="mt-4 px-4 py-2 bg-slate-800 rounded text-white">Close</button></div>`;
        }
    },

    // --- 2. RENDERER ---
    renderTvChart(candles, emaData, markers) {
        const container = document.getElementById('tvContainer');
        container.innerHTML = ''; 

        this.tvChart = LightweightCharts.createChart(container, {
            layout: { background: { color: '#020617' }, textColor: '#94a3b8' },
            grid: { vertLines: { color: '#1e293b' }, horzLines: { color: '#1e293b' } },
            timeScale: { timeVisible: true, secondsVisible: false },
        });
        
        // PATCH: Select Series Type
        const style = this.data.settings.replayBarStyle || 'candlestick';
        
        if (style === 'bar') {
            this.mainSeries = this.tvChart.addBarSeries({ 
                upColor: '#10b981', 
                downColor: '#ef4444', 
                thinBars: true // CHANGED: Set to true for thinner bars
            });
        } else {
            this.mainSeries = this.tvChart.addCandlestickSeries({ 
                upColor: '#10b981', 
                downColor: '#ef4444', 
                borderVisible: false, 
                wickUpColor: '#10b981', 
                wickDownColor: '#ef4444' 
            });
        }

        this.mainSeries.setData(candles);
        if(markers && markers.length > 0) this.mainSeries.setMarkers(markers);

        this.emaSeries = this.tvChart.addLineSeries({ color: '#d946ef', lineWidth: 2, crosshairMarkerVisible: false, priceLineVisible: false });
        this.emaSeries.setData(emaData);

        new ResizeObserver(e => { if(e.length) this.tvChart.applyOptions({ width: e[0].contentRect.width, height: e[0].contentRect.height }); }).observe(container);
        this.tvChart.timeScale().fitContent();
    },

    // --- 3. ANIMATION CONTROLS (Updated Logic) ---
    playReplay() {
        const p = this.player;
        if(!p || p.isPlaying) return;

        p.isPlaying = true;
        document.getElementById('btnPlay').classList.add('hidden');
        document.getElementById('btnPause').classList.remove('hidden');
        document.getElementById('tvSubtitle').innerText = "Replaying...";

        // RESET TO START
        p.currentIndex = p.startIndex;
        
        const initialCandles = p.data.candles.slice(0, p.currentIndex + 1);
        const initialEma = p.data.emaData.filter(d => d.time <= initialCandles[initialCandles.length-1].time);
        const initialMarkers = p.data.markers.filter(m => m.time <= initialCandles[initialCandles.length-1].time);

        this.mainSeries.setData(initialCandles);
        this.emaSeries.setData(initialEma);
        this.mainSeries.setMarkers(initialMarkers);
        
        this.tvChart.timeScale().fitContent();

        // Start Recursive Loop
        this.stepReplay();
    },

    pauseReplay() {
        if(!this.player) return;
        this.player.isPlaying = false;
        if(this.player.timer) clearTimeout(this.player.timer);
        document.getElementById('btnPlay').classList.remove('hidden');
        document.getElementById('btnPause').classList.add('hidden');
    },

    stepReplay() {
        const p = this.player;
        if(!p || !p.isPlaying) return;

        p.currentIndex++;

        if(p.currentIndex >= p.data.candles.length) {
            this.pauseReplay();
            document.getElementById('tvSubtitle').innerText = "Replay Finished";
            return;
        }

        // Update Data
        const candle = p.data.candles[p.currentIndex];
        this.mainSeries.update(candle);

        const emaPoint = p.data.emaData.find(d => d.time === candle.time);
        if(emaPoint) this.emaSeries.update(emaPoint);

        const visibleMarkers = p.data.markers.filter(m => m.time <= candle.time);
        this.mainSeries.setMarkers(visibleMarkers);

        // Schedule Next Step (Recursive Timeout allows changing speed)
        p.timer = setTimeout(() => this.stepReplay(), p.speed);
    },

    toggleSpeed() {
        const p = this.player;
        const btn = document.getElementById('btnSpeed');
        
        // SPEED SETTINGS:
        // 500ms = 1x (Slow/Standard)
        // 250ms = 2x (Medium)
        // 50ms  = 5x (Fast)
        
        if (p.speed === 500) { p.speed = 250; btn.innerText = '2x'; }
        else if (p.speed === 250) { p.speed = 50; btn.innerText = '5x'; }
        else { p.speed = 500; btn.innerText = '1x'; }
        
        // If running, restart the timer with new speed immediately
        if (p.isPlaying) {
            if(p.timer) clearTimeout(p.timer);
            this.stepReplay();
        }
    },
	
	toggleTvStyle() {
        const current = this.data.settings.replayBarStyle;
        const next = current === 'bar' ? 'candlestick' : 'bar';
        this.data.settings.replayBarStyle = next;
        this.saveSettings();
        
        const btn = document.getElementById('btnTvStyle');
        if(btn) btn.innerText = next === 'bar' ? 'Bars' : 'Candles';
        
        if(this.player && this.player.data) {
             const p = this.player;
             this.renderTvChart(p.data.candles, p.data.emaData, p.data.markers);
        }
    },

    closeTvModal() {
        if(this.player && this.player.timer) clearTimeout(this.player.timer);
        this.player = null; 
        
        const modal = document.getElementById('tvModal');
        modal.classList.add('opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
            if(this.tvChart) { this.tvChart.remove(); this.tvChart = null; }
            document.getElementById('tvContainer').innerHTML = '';
        }, 300);
    },
}; // <--- This is the end of the app object
	

document.addEventListener('DOMContentLoaded', () => {
    app.init();
});

// --- PATCH 38: HEATMAP TOGGLE (FIXED) ---

// 1. New Toggle Helper
app.toggleHeatmapMode = function(mode) {
    app.heatmapMode = mode;
    console.log("Switched Heatmap Mode to:", mode);
    app.renderStats(); 
};

// Add support for DISC mode
app.toggleHeatmapMode = function(mode) {
    app.heatmapMode = mode;
    app.drawConsistencyHeatmap(app.data.logs);
};

// Update details view to show discipline status
app.viewDayDetails = function(el, date, count, pnl) {
    document.querySelectorAll('.heatmap-day').forEach(d => d.classList.remove('ring-2', 'ring-white', 'z-10'));
    if(el) el.classList.add('ring-2', 'ring-white', 'z-10');

    const info = document.getElementById('heatmapInfo');
    if(!info) return;

    // Check Journal
    const entry = app.data.journal.entries[date];
    let discText = "";
    if (entry && entry.followedRules === true) discText = `  <span class="text-emerald-400 font-bold">Rules Followed</span>`;
    if (entry && entry.followedRules === false) discText = `  <span class="text-red-400 font-bold">Rules Broken</span>`;

    if (count === 0 && !discText) {
        info.innerHTML = `<span class="text-slate-500">${date}: No Trades</span>`;
    } else {
        const pnlClass = pnl > 0 ? 'text-emerald-400' : (pnl < 0 ? 'text-red-400' : 'text-slate-300');
        const sign = pnl > 0 ? '+' : '';
        const tradeText = count > 0 ? `<span class="text-slate-400">${count} Trades</span>  <span class="${pnlClass} font-bold">${sign}${pnl.toFixed(2)}R</span>` : '<span class="text-slate-500">No Trades</span>';
        info.innerHTML = `<span class="text-white font-bold">${date}</span>  ${tradeText}${discText}`;
    }
};

// Updated Heatmap Function
app.drawConsistencyHeatmap = function(logs) {
    const container = document.getElementById('consistencyGrid');
    if (!container) return;

    if (!app.heatmapMode) app.heatmapMode = 'ENTRY';

    let controls = document.getElementById('heatmapControls');
    if (!controls) {
        controls = document.createElement('div');
        controls.id = 'heatmapControls';
        controls.className = 'flex justify-center gap-2 mb-4 animate-in fade-in';
        container.parentNode.insertBefore(controls, container);
    }
    
    const isEntry = app.heatmapMode === 'ENTRY';
    const isExit = app.heatmapMode === 'EXIT';
    const isDisc = app.heatmapMode === 'DISC';

    const btnClass = (active, col) => `text-[10px] px-3 py-1 rounded border transition-all font-bold ${active ? `bg-${col}-600 text-white border-${col}-600 shadow-lg scale-105` : 'border-slate-600 text-slate-500 hover:text-white'}`;

    controls.innerHTML = `
        <button onclick="app.toggleHeatmapMode('ENTRY')" class="${btnClass(isEntry, 'blue')}">By Entry</button>
        <button onclick="app.toggleHeatmapMode('EXIT')" class="${btnClass(isExit, 'emerald')}">By Exit</button>
        <button onclick="app.toggleHeatmapMode('DISC')" class="${btnClass(isDisc, 'purple')}">By Discipline</button>
    `;

    const dayMap = {};
    const getIsoDate = (d) => d.toISOString().split('T')[0];
    for (let i = 89; i >= 0; i--) {
        const d = new Date(); d.setUTCHours(12, 0, 0, 0); d.setUTCDate(d.getUTCDate() - i);
        dayMap[getIsoDate(d)] = { pnl: 0, count: 0 };
    }

    logs.forEach(l => {
        const riskPerShare = Math.abs(l.entry - l.stop);
        const totalInitialRisk = (l.initialQty || 0) * riskPerShare;
        if (!totalInitialRisk || totalInitialRisk <= 0) return;

        if (app.heatmapMode === 'EXIT') {
            if (l.exits) l.exits.forEach(ex => {
                if (ex.date && dayMap[getIsoDate(new Date(ex.date))]) {
                    const chunkR = ((l.direction === 'SHORT' ? l.entry - ex.price : ex.price - l.entry) * ex.qty) / totalInitialRisk;
                    dayMap[getIsoDate(new Date(ex.date))].pnl += chunkR;
                    dayMap[getIsoDate(new Date(ex.date))].count++;
                }
            });
        } else {
            const dKey = getIsoDate(new Date(l.date));
            if (dayMap[dKey]) {
                let netR = 0;
                let active = false;
                if (l.exits && l.exits.length > 0) {
                    let pnl = 0; l.exits.forEach(ex => pnl += (l.direction==='SHORT'?l.entry-ex.price:ex.price-l.entry)*ex.qty);
                    netR = pnl/totalInitialRisk; active = true;
                } else if (l.exitPrice) {
                    netR = (l.direction==='SHORT'?l.entry-l.exitPrice:l.exitPrice-l.entry)/riskPerShare; active = true;
                }
                if(active) { dayMap[dKey].pnl += netR; dayMap[dKey].count++; }
            }
        }
    });

    const squares = Object.keys(dayMap).sort().map(key => {
        const data = dayMap[key];
        let colorClass = 'bg-slate-800 border border-slate-700/50';

        if (app.heatmapMode === 'DISC') {
            const entry = app.data.journal.entries[key];
            if (entry) {
                if (entry.followedRules === true) colorClass = 'bg-emerald-500 shadow-[0_0_8px_rgba(52,211,153,0.5)] z-10';
                else if (entry.followedRules === false) colorClass = 'bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.5)] z-10';
                else if (entry.notes || (entry.images && entry.images.length)) colorClass = 'bg-blue-600/50';
            }
        } else if (data.count > 0) {
            if (data.pnl > 0) colorClass = data.pnl > 2 ? 'bg-emerald-400 shadow-sm z-10' : (data.pnl > 1 ? 'bg-emerald-500' : 'bg-emerald-600/80');
            else if (data.pnl < 0) colorClass = data.pnl < -2 ? 'bg-red-500 shadow-sm z-10' : (data.pnl < -1 ? 'bg-red-500/90' : 'bg-red-600/80');
            else colorClass = 'bg-slate-500';
        }

        return `<div onclick="app.viewDayDetails(this, '${key}', ${data.count}, ${data.pnl.toFixed(2)})" 
             class="heatmap-day w-3 h-3 rounded-sm ${colorClass} transition-all cursor-pointer relative hover:scale-125 hover:z-20 hover:brightness-110"></div>`;
    }).join('');

    container.innerHTML = squares;
    const infoLabel = document.getElementById('heatmapInfo');
    if(infoLabel) {
        const labels = { 'EXIT': 'Realized P&L', 'ENTRY': 'Decision Result', 'DISC': 'Rule Adherence' };
        infoLabel.innerHTML = `<span class="opacity-30 italic">Showing ${labels[app.heatmapMode]}</span>`;
    }
};

</script>
<div id="manageLogModal" class="hidden fixed inset-0 z-[100] bg-slate-900/90 backdrop-blur flex items-center justify-center p-4">
    <div class="bg-slate-900 border border-slate-700 w-full max-w-lg h-[90vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-in zoom-in-95 duration-200">
        <div id="manageLogContent" class="flex-1 overflow-hidden p-6 relative">
            </div>
    </div>
</div>
<div id="tvModal" class="fixed inset-0 z-[100] bg-slate-950/90 hidden flex flex-col opacity-0 transition-opacity duration-300">
    <div class="h-14 border-b border-slate-800 bg-slate-900 flex items-center justify-between px-4 shrink-0 relative z-50">
        
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-2 bg-slate-800 rounded p-1 border border-slate-700">
                <span id="tvTitle" class="text-xs font-black text-white px-2 border-r border-slate-700"></span>
                
                <button onclick="app.playReplay()" id="btnPlay" class="p-1 rounded hover:bg-blue-600 hover:text-white text-blue-400 transition-colors" title="Play">
                    <i data-lucide="play" class="w-4 h-4 fill-current"></i>
                </button>
                <button onclick="app.pauseReplay()" id="btnPause" class="hidden p-1 rounded hover:bg-slate-700 text-slate-400 transition-colors" title="Pause">
                    <i data-lucide="pause" class="w-4 h-4 fill-current"></i>
                </button>
                
                <button onclick="app.toggleSpeed()" id="btnSpeed" class="text-[9px] font-mono font-bold px-1.5 py-0.5 rounded bg-slate-900 text-slate-400 hover:text-white min-w-[2rem]">1x</button>
				<button onclick="app.toggleTvStyle()" id="btnTvStyle" class="text-[9px] font-mono font-bold px-1.5 py-0.5 rounded bg-slate-900 text-slate-400 hover:text-white min-w-[3rem] ml-1">Candles</button>
            </div>
            
            <span id="tvSubtitle" class="hidden sm:inline-block text-[10px] text-slate-500 font-mono"></span>
        </div>

        <div class="flex items-center gap-3">
            <div id="tvHeaderResult" class="text-sm font-bold font-mono"></div>

            <button onclick="app.closeTvModal()" class="p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-white transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>
    
    <div class="flex-1 relative w-full h-full bg-slate-950" id="tvContainer">
        <div id="tvLoading" class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
        </div>
    </div>
    
    <div class="h-10 border-t border-slate-800 bg-slate-900 flex items-center justify-between px-4 shrink-0 text-[10px]">
        <div class="flex gap-4 font-bold uppercase tracking-wider">
            <div class="flex items-center gap-1 text-[#fbbf24]"><div class="w-2 h-2 rounded-full bg-[#fbbf24]"></div> Entry</div>
            <div class="flex items-center gap-1 text-[#f472b6]"><div class="w-2 h-2 rounded-full bg-[#f472b6]"></div> Partial</div>
            <div class="flex items-center gap-1 text-[#f472b6]"><div class="w-2 h-2 rounded-full bg-[#f472b6]"></div> Close</div>
        </div>
        
        <div id="tvFooterStats" class="text-slate-500 font-mono"></div>
    </div>
</div>
</div>
</body>
</html>








