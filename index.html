<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Trade Risk Manager" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />
  <title>Trade Risk Manager</title>
  <style>
    body {
      background: linear-gradient(135deg, #1e3c72, #2a5298, #4b3f72);
      color: #eee;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 15px;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      touch-action: manipulation;
    }
    h1 {
      text-align: center;
      margin-bottom: 15px;
      font-size: 1.6rem;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .help-icon {
      background: #34c759;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s ease;
    }
    .help-icon:hover {
      background: #28a745;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.3s;
    }
    .modal-content {
      background-color: #121212;
      margin: 10% auto;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 480px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      color: #eee;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      position: absolute;
      right: 15px;
      top: 10px;
    }
    .close:hover {
      color: #fff;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .app-container {
      max-width: 480px;
      width: 100%;
      padding: 12px;
      background: #121212;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .accounts-section {
      margin-bottom: 8px;
    }
    .accounts-toggle {
      width: 100%;
      padding: 8px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
      transition: background 0.3s ease;
      background: #2a2a2a;
      color: #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .accounts-toggle:hover {
      background: #3a3a3a;
    }
    .accounts-toggle::after {
      content: '▼';
      font-size: 0.8rem;
      transition: transform 0.3s ease;
    }
    .accounts-toggle.expanded::after {
      transform: rotate(180deg);
    }
    .account-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      opacity: 0;
    }
    .account-grid.expanded {
      max-height: 600px;
      opacity: 1;
    }
    .input-group {
      flex: 1 1 45%;
      min-width: 140px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .currency-select-group {
      margin-top: 4px;
    }
    .stop-type-group {
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
    }
    .stop-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
    }
    .stop-row .input-group {
      flex: 1 1 100%;
    }
    .staggered-stops {
      display: none;
      flex-direction: column;
      gap: 10px;
    }
    .staggered-stops.show {
      display: flex;
    }
    .staggered-level {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
    }
    .staggered-level .input-group {
      flex: 1 1 45%;
      min-width: 140px;
    }
    .staggered-level .percent-group {
      flex: 1 1 45%;
      min-width: 80px;
    }
    .add-level-btn {
      align-self: flex-start;
      width: auto;
      padding: 6px 12px;
      font-size: 1rem;
      background: #34c759;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .add-level-btn:hover {
      background: #28a745;
    }
    label, [contenteditable="true"] {
      font-size: 1.1rem;
      margin-bottom: 4px;
      color: #ffffff;
      cursor: text;
      display: inline-block;
      padding: 2px 4px;
      border-radius: 5px;
    }
    [contenteditable="true"]:focus {
      outline: none;
      background: #3a3a3a;
      border: none;
    }
    input[type="number"], select {
      width: 100%;
      font-size: 1.1rem;
      padding: 8px;
      border-radius: 5px;
      border: none;
      background: #2a2a2a;
      color: #eee;
      box-sizing: border-box;
      appearance: none;
      transition: background 0.3s ease;
    }
    input[type="number"]:focus, select:focus {
      background: #3a3a3a;
      outline: none;
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      appearance: none;
    }
    input[type="range"] {
      width: 100%;
      height: 8px;
      background: #444;
      border-radius: 5px;
      outline: none;
      appearance: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      background: #34c759;
      border-radius: 50%;
      cursor: pointer;
    }
    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: #34c759;
      border-radius: 50%;
      cursor: pointer;
    }
    .range-value {
      font-size: 1rem;
      color: #eee;
      margin-top: 4px;
      text-align: center;
    }
    .mode-group {
      display: flex;
      flex-direction: row;
      gap: 15px;
      align-items: center;
      justify-content: center;
    }
    .mode-option {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .mode-option label {
      font-size: 1.1rem;
      color: #ffffff;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 1.2rem;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
      transition: transform 0.2s ease, background 0.3s ease;
    }
    button#calculateBtn {
      background: #34c759;
      color: #fff;
    }
    button#resetBtn {
      background: #f0f0f0;
      color: #1e3c72;
    }
    button:hover {
      transform: scale(1.02);
    }
    button:active {
      transform: scale(0.98);
    }
    .results {
      max-width: 480px;
      margin: 15px 0;
      background: #2a2a2a;
      border-radius: 8px;
      padding: 12px;
      display: none;
    }
    .tab-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 12px;
      overflow-x: auto;
    }
    .tab-btn {
      flex: 1;
      min-width: 80px;
      padding: 6px;
      font-size: 1rem;
      background: #3a3a3a;
      color: #eee;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .tab-btn.active {
      background: #34c759;
    }
    .tab-content {
      display: flex;
      flex-direction: column;
    }
    .tab-pane {
      display: none;
    }
    .tab-pane.active {
      display: block;
    }
    .result-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 1rem;
    }
    .bold {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Trade Risk Manager <button class="help-icon" onclick="openHelp()">?</button></h1>

  <div id="helpModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Help & Instructions</h2>
      <p>This tool helps manage trade risk across multiple accounts.</p>
      <p>Enter account sizes, purchase price, stop levels, and risk or position size to calculate position details.</p>
      <p>Use staggered stops for multiple stop levels with percentages.</p>
    </div>
  </div>

  <div class="app-container">
    <form id="riskForm">
      <div class="currency-select-group">
        <label for="accountCurrency">Account Currency</label>
        <select id="accountCurrency">
          <option value="GBP">GBP (£)</option>
          <option value="USD">USD ($)</option>
          <option value="EUR">EUR (€)</option>
        </select>
      </div>

      <button type="button" class="accounts-toggle">Accounts</button>
      <div class="account-grid">
        <div class="input-group">
          <span contenteditable="true" id="account1Label">Account 1</span>
          <input type="number" id="account1" min="0">
        </div>
        <div class="input-group">
          <span contenteditable="true" id="account2Label">Account 2</span>
          <input type="number" id="account2" min="0">
        </div>
        <div class="input-group">
          <span contenteditable="true" id="account3Label">Account 3</span>
          <input type="number" id="account3" min="0">
        </div>
        <div class="input-group">
          <span contenteditable="true" id="account4Label">Account 4</span>
          <input type="number" id="account4" min="0">
        </div>
        <div class="input-group">
          <span contenteditable="true" id="account5Label">Account 5</span>
          <input type="number" id="account5" min="0">
        </div>
        <div class="input-group">
          <span contenteditable="true" id="account6Label">Account 6</span>
          <input type="number" id="account6" min="0">
        </div>
      </div>

      <div class="input-row">
        <div class="input-group">
          <label for="tradeCurrency">Trade Currency</label>
          <select id="tradeCurrency">
            <!-- Options populated dynamically -->
          </select>
        </div>
        <div class="input-group">
          <label for="purchasePrice">Purchase Price</label>
          <input type="number" id="purchasePrice" step="0.01" min="0">
        </div>
      </div>

      <div class="stop-type-group">
        <div class="mode-option">
          <input type="radio" id="stopSingle" name="stopType" value="single" checked>
          <label for="stopSingle">Single Stop</label>
        </div>
        <div class="mode-option">
          <input type="radio" id="stopStaggered" name="stopType" value="staggered">
          <label for="stopStaggered">Staggered Stops</label>
        </div>
      </div>

      <div class="stop-row" id="stopRow">
        <div class="input-group">
          <label for="stopLoss">Stop Location</label>
          <input type="number" id="stopLoss" step="0.01" min="0">
        </div>
      </div>

      <div class="staggered-stops" id="staggeredStops">
        <div class="staggered-level" id="level1">
          <div class="input-group">
            <label>Stop Level 1</label>
            <input type="number" class="stopLevel" data-level="1" step="0.01" min="0">
          </div>
          <div class="percent-group">
            <label>%</label>
            <input type="number" class="stopPercent" data-level="1" min="0" max="100">
          </div>
        </div>
        <div class="staggered-level" id="level2">
          <div class="input-group">
            <label>Stop Level 2</label>
            <input type="number" class="stopLevel" data-level="2" step="0.01" min="0">
          </div>
          <div class="percent-group">
            <label>%</label>
            <input type="number" class="stopPercent" data-level="2" min="0" max="100">
          </div>
        </div>
        <div class="staggered-level" id="level3" style="display: none;">
          <div class="input-group">
            <label>Stop Level 3</label>
            <input type="number" class="stopLevel" data-level="3" step="0.01" min="0">
          </div>
          <div class="percent-group">
            <label>%</label>
            <input type="number" class="stopPercent" data-level="3" min="0" max="100">
          </div>
        </div>
        <button type="button" class="add-level-btn" id="addLevelBtn">Add Level</button>
      </div>

      <div class="mode-group">
        <div class="mode-option">
          <input type="radio" id="modeEquityRisk" name="mode" value="equityRisk" checked>
          <label for="modeEquityRisk">Equity Risk %</label>
        </div>
        <div class="mode-option">
          <input type="radio" id="modePositionSize" name="mode" value="positionSize">
          <label for="modePositionSize">Position Size %</label>
        </div>
      </div>

      <div id="equityRiskGroup">
        <input type="range" id="equityRiskSlider" min="0.025" max="1.5" step="0.025" value="1">
        <span class="range-value" id="equityRiskVal">1%</span>
      </div>

      <div id="positionSizeGroup" style="display: none;">
        <input type="range" id="positionSizeSlider" min="3" max="50" step="0.5" value="10">
        <span class="range-value" id="positionSizeVal">10%</span>
      </div>

      <button type="button" id="calculateBtn">Calculate</button>
      <button type="button" id="resetBtn">Reset</button>
    </form>
  </div>

  <div class="results" id="resultsDiv"></div>

  <script>
    (() => {
      const form = document.getElementById('riskForm');
      const accountsToggle = document.querySelector('.accounts-toggle');
      const accountGrid = document.querySelector('.account-grid');
      const stopSingle = document.getElementById('stopSingle');
      const stopStaggered = document.getElementById('stopStaggered');
      const stopRow = document.getElementById('stopRow');
      const staggeredStops = document.getElementById('staggeredStops');
      const addLevelBtn = document.getElementById('addLevelBtn');
      const level3 = document.getElementById('level3');
      const modeEquityRisk = document.getElementById('modeEquityRisk');
      const modePositionSize = document.getElementById('modePositionSize');
      const equityRiskGroup = document.getElementById('equityRiskGroup');
      const positionSizeGroup = document.getElementById('positionSizeGroup');
      const equityRiskSlider = document.getElementById('equityRiskSlider');
      const equityRiskVal = document.getElementById('equityRiskVal');
      const positionSizeSlider = document.getElementById('positionSizeSlider');
      const positionSizeVal = document.getElementById('positionSizeVal');
      const calculateBtn = document.getElementById('calculateBtn');
      const resetBtn = document.getElementById('resetBtn');
      const resultsDiv = document.getElementById('resultsDiv');

      const accountCurrencySelect = document.getElementById('accountCurrency');
      const tradeCurrencySelect = document.getElementById('tradeCurrency');

      let numStaggeredLevels = 2;

      const currencySymbols = {
        'GBP': '£',
        'USD': '$',
        'EUR': '€'
      };

      const currencies = ['GBP', 'USD', 'EUR'];

      const accInputs = [
        { id: 'account1', labelId: 'account1Label', defaultLabel: 'Account 1' },
        { id: 'account2', labelId: 'account2Label', defaultLabel: 'Account 2' },
        { id: 'account3', labelId: 'account3Label', defaultLabel: 'Account 3' },
        { id: 'account4', labelId: 'account4Label', defaultLabel: 'Account 4' },
        { id: 'account5', labelId: 'account5Label', defaultLabel: 'Account 5' },
        { id: 'account6', labelId: 'account6Label', defaultLabel: 'Account 6' }
      ];

      function formatNumber(num) {
        return num.toLocaleString('en-GB', { maximumFractionDigits: 2 });
      }

      function initTabs() {
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabPanes = document.querySelectorAll('.tab-pane');
        tabBtns.forEach((btn, index) => {
          btn.addEventListener('click', () => {
            tabBtns.forEach(b => b.classList.remove('active'));
            tabPanes.forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            tabPanes[index].classList.add('active');
          });
        });
        if (tabBtns.length > 0) tabBtns[0].classList.add('active');
        if (tabPanes.length > 0) tabPanes[0].classList.add('active');
      }

      accountsToggle.addEventListener('click', () => {
        accountGrid.classList.toggle('expanded');
        accountsToggle.classList.toggle('expanded');
      });

      stopSingle.addEventListener('change', () => {
        stopRow.style.display = 'flex';
        staggeredStops.classList.remove('show');
      });

      stopStaggered.addEventListener('change', () => {
        stopRow.style.display = 'none';
        staggeredStops.classList.add('show');
      });

      addLevelBtn.addEventListener('click', () => {
        if (numStaggeredLevels < 3) {
          numStaggeredLevels++;
          level3.style.display = 'flex';
          addLevelBtn.style.display = 'none';
        }
      });

      modeEquityRisk.addEventListener('change', () => {
        equityRiskGroup.style.display = 'block';
        positionSizeGroup.style.display = 'none';
      });

      modePositionSize.addEventListener('change', () => {
        equityRiskGroup.style.display = 'none';
        positionSizeGroup.style.display = 'block';
      });

      equityRiskSlider.addEventListener('input', () => {
        equityRiskVal.textContent = `${equityRiskSlider.value}%`;
      });

      positionSizeSlider.addEventListener('input', () => {
        positionSizeVal.textContent = `${positionSizeSlider.value}%`;
      });

      // Update trade currency options with rates
      async function updateTradeCurrencyOptions() {
        const accCurrency = accountCurrencySelect.value;
        let rates = {};
        try {
          const response = await fetch(`https://api.frankfurter.app/latest?from=${accCurrency}&to=${currencies.join(',')}`);
          const data = await response.json();
          rates = data.rates || {};
        } catch (e) {
          // Silent fail, use defaults
        }

        tradeCurrencySelect.innerHTML = '';
        currencies.forEach(c => {
          const rate = (c === accCurrency) ? 1 : (rates[c] || 1);
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = `${c} (${currencySymbols[c]}) (${rate.toFixed(4)})`;
          opt.dataset.rate = rate.toFixed(4);
          tradeCurrencySelect.appendChild(opt);
        });

        // Restore saved selection if valid
        const savedTradeCurrency = localStorage.getItem('defaultTradeCurrency') || accCurrency;
        if (currencies.includes(savedTradeCurrency)) {
          tradeCurrencySelect.value = savedTradeCurrency;
        }
      }

      // Initial load and listeners for currency changes
      accountCurrencySelect.addEventListener('change', async () => {
        await updateTradeCurrencyOptions();
        localStorage.setItem('accountCurrency', accountCurrencySelect.value);
      });
      tradeCurrencySelect.addEventListener('change', () => {
        localStorage.setItem('defaultTradeCurrency', tradeCurrencySelect.value);
      });

      calculateBtn.addEventListener('click', () => {
        resultsDiv.innerHTML = '';
        resultsDiv.style.display = 'none';

        const mode = document.querySelector('input[name="mode"]:checked').value;
        const purchasePrice = parseFloat(document.getElementById('purchasePrice').value);
        if (isNaN(purchasePrice) || purchasePrice <= 0) return;

        const stopType = document.querySelector('input[name="stopType"]:checked').value;
        let avgStopLoss = 0;
        let percentToStop = 0;

        if (stopType === 'single') {
          const stopLoss = parseFloat(document.getElementById('stopLoss').value);
          if (isNaN(stopLoss)) return;
          avgStopLoss = stopLoss;
        } else {
          let totalPct = 0;
          let weightedSum = 0;
          for (let i = 1; i <= numStaggeredLevels; i++) {
            const stop = parseFloat(document.querySelector(`.stopLevel[data-level="${i}"]`).value);
            const pct = parseFloat(document.querySelector(`.stopPercent[data-level="${i}"]`).value);
            if (isNaN(stop) || isNaN(pct) || pct <= 0) return;
            weightedSum += stop * pct;
            totalPct += pct;
          }
          avgStopLoss = weightedSum / totalPct;
        }

        const priceDiff = Math.abs(purchasePrice - avgStopLoss);
        percentToStop = (priceDiff / purchasePrice) * 100;

        const accCurrency = accountCurrencySelect.value;
        const tradeCurrency = tradeCurrencySelect.value;
        const selectedOption = tradeCurrencySelect.options[tradeCurrencySelect.selectedIndex];
        const exchangeRate = parseFloat(selectedOption.dataset.rate) || 1;
        const accSymbol = currencySymbols[accCurrency] || accCurrency;
        const tradeSymbol = currencySymbols[tradeCurrency] || tradeCurrency;

        const tabNav = document.createElement('div');
        tabNav.classList.add('tab-nav');
        const tabContent = document.createElement('div');
        tabContent.classList.add('tab-content');

        accInputs.forEach((acc, index) => {
          const accountSize = parseFloat(document.getElementById(acc.id).value) || 0;
          if (accountSize <= 0) return;

          let riskAmount, positionSizeValue, positionSizePercent, positionSize;

          if (mode === 'equityRisk') {
            const equityRisk = parseFloat(equityRiskSlider.value);
            riskAmount = accountSize * (equityRisk / 100);
            positionSizeValue = riskAmount / (percentToStop / 100);
            positionSizePercent = (positionSizeValue / accountSize) * 100;
            positionSize = Math.floor((riskAmount * exchangeRate) / priceDiff);
          } else {
            const positionPercent = parseFloat(positionSizeSlider.value);
            positionSizeValue = accountSize * (positionPercent / 100);
            positionSizePercent = positionPercent;
            positionSize = Math.floor(positionSizeValue * exchangeRate / purchasePrice);
            riskAmount = (positionSize * priceDiff) / exchangeRate;
          }

          const derisk12Price = purchasePrice + (purchasePrice - avgStopLoss);
          const derisk12Shares = Math.floor(positionSize / 2);
          const derisk13Price = purchasePrice + 1.5 * (purchasePrice - avgStopLoss);
          const derisk13Shares = Math.floor(positionSize / 3);
          const derisk14Price = purchasePrice + 2 * (purchasePrice - avgStopLoss);
          const derisk14Shares = Math.floor(positionSize / 4);

          const label = document.getElementById(acc.labelId).innerText;

          const stopLabel = stopType === 'single' ? 'Stop Loss' : 'Avg Stop Loss';

          const tabBtn = document.createElement('button');
          tabBtn.textContent = label;
          tabBtn.classList.add('tab-btn');
          tabBtn.dataset.tab = `account${index + 1}`;
          tabNav.appendChild(tabBtn);

          const tabPane = document.createElement('div');
          tabPane.id = `account${index + 1}`;
          tabPane.classList.add('tab-pane');
          tabPane.innerHTML = `
            <h3>${label}</h3>
            <div class="result-row"><span>Shares to Buy:</span> <span style="color: green; font-weight: bold;">${formatNumber(positionSize)}</span></div>
            <div class="result-row"><span style="font-weight: bold;">${stopLabel}:</span> <span style="color: red;">${tradeSymbol}${formatNumber(avgStopLoss.toFixed(2))}</span></div>
            <div class="result-row"><span>Account Size:</span> <span>${accSymbol}${formatNumber(accountSize)}</span></div>
            <div class="result-row"><span>Money at Risk:</span> <span>${accSymbol}${formatNumber(riskAmount)}</span></div>
            <div class="result-row"><span>Total Position Size:</span> <span>${accSymbol}${formatNumber(positionSizeValue)}</span></div>
            <div class="result-row"><span>Position Size %:</span> <span>${positionSizePercent.toFixed(2)}%</span></div>
            <div class="result-row"><span>% to Stop:</span> <span>${percentToStop.toFixed(2)}%</span></div>
            <div class="result-row"><span>Derisk 1/3 (breakeven) at:</span> <span>${tradeSymbol}${formatNumber(derisk13Price.toFixed(2))}</span></div>
            <div class="result-row"><span>Sell Shares (1/3):</span> <span>${formatNumber(derisk13Shares)}</span></div>
            <div class="result-row"><span>Derisk 1/4 (breakeven) at:</span> <span>${tradeSymbol}${formatNumber(derisk14Price.toFixed(2))}</span></div>
            <div class="result-row"><span>Sell Shares (1/4):</span> <span>${formatNumber(derisk14Shares)}</span></div>
          `;
          tabContent.appendChild(tabPane);
        });

        resultsDiv.appendChild(tabNav);
        resultsDiv.appendChild(tabContent);
        initTabs();
        resultsDiv.style.display = 'block';
      });

      resetBtn.addEventListener('click', () => {
        form.reset();
        equityRiskVal.textContent = '1%';
        positionSizeVal.textContent = '10%';
        equityRiskGroup.style.display = 'block';
        positionSizeGroup.style.display = 'none';
        stopRow.style.display = 'flex';
        staggeredStops.classList.remove('show');
        level3.style.display = 'none';
        addLevelBtn.style.display = 'block';
        numStaggeredLevels = 2;
        accountGrid.classList.remove('expanded');
        accountsToggle.classList.remove('expanded');
        resultsDiv.style.display = 'none';
        accInputs.forEach(acc => {
          document.getElementById(acc.labelId).innerText = acc.defaultLabel;
        });
        localStorage.clear();
        updateTradeCurrencyOptions(); // Reset trade options
      });

      function loadSavedData() {
        const savedAccCurrency = localStorage.getItem('accountCurrency') || 'GBP';
        accountCurrencySelect.value = savedAccCurrency;

        const savedStopType = localStorage.getItem('stopType') || 'single';
        document.querySelector(`input[name="stopType"][value="${savedStopType}"]`).checked = true;
        stopRow.style.display = savedStopType === 'single' ? 'flex' : 'none';
        staggeredStops.classList.toggle('show', savedStopType === 'staggered');

        if (savedStopType === 'staggered') {
          numStaggeredLevels = parseInt(localStorage.getItem('numStaggeredLevels') || 2);
          if (numStaggeredLevels === 3) {
            level3.style.display = 'flex';
            addLevelBtn.style.display = 'none';
          }
          for (let i = 1; i <= numStaggeredLevels; i++) {
            const savedStop = localStorage.getItem(`staggeredStop${i}`);
            const savedPct = localStorage.getItem(`staggeredPct${i}`);
            if (savedStop) document.querySelector(`.stopLevel[data-level="${i}"]`).value = savedStop;
            if (savedPct) document.querySelector(`.stopPercent[data-level="${i}"]`).value = savedPct;
          }
        } else {
          const savedStopLoss = localStorage.getItem('stopLoss');
          if (savedStopLoss) document.getElementById('stopLoss').value = savedStopLoss;
        }

        accInputs.forEach(acc => {
          const savedSize = localStorage.getItem(acc.id);
          if (savedSize) document.getElementById(acc.id).value = savedSize;
          const savedLabel = localStorage.getItem(acc.labelId);
          if (savedLabel) document.getElementById(acc.labelId).innerText = savedLabel || acc.defaultLabel;
        });

        const savedPurchase = localStorage.getItem('purchasePrice');
        if (savedPurchase) document.getElementById('purchasePrice').value = savedPurchase;

        const savedRisk = localStorage.getItem('equityRisk');
        if (savedRisk) {
          equityRiskSlider.value = savedRisk;
          equityRiskVal.textContent = `${savedRisk}%`;
        }

        const savedPosition = localStorage.getItem('positionSize');
        if (savedPosition) {
          positionSizeSlider.value = savedPosition;
          positionSizeVal.textContent = `${savedPosition}%`;
        }

        const savedMode = localStorage.getItem('mode') || 'equityRisk';
        document.querySelector(`input[name="mode"][value="${savedMode}"]`).checked = true;
        equityRiskGroup.style.display = savedMode === 'equityRisk' ? 'block' : 'none';
        positionSizeGroup.style.display = savedMode === 'positionSize' ? 'block' : 'none';

        const accountsExpanded = localStorage.getItem('accountsExpanded') === 'true';
        if (accountsExpanded) {
          accountGrid.classList.add('expanded');
          accountsToggle.classList.add('expanded');
        }

        // Update trade options after loading
        updateTradeCurrencyOptions();
      }
      loadSavedData();

      form.addEventListener('input', () => {
        localStorage.setItem('accountCurrency', accountCurrencySelect.value);
        localStorage.setItem('stopType', document.querySelector('input[name="stopType"]:checked').value);
        if (document.querySelector('input[name="stopType"]:checked').value === 'staggered') {
          localStorage.setItem('numStaggeredLevels', numStaggeredLevels);
          for (let i = 1; i <= numStaggeredLevels; i++) {
            localStorage.setItem(`staggeredStop${i}`, document.querySelector(`.stopLevel[data-level="${i}"]`).value);
            localStorage.setItem(`staggeredPct${i}`, document.querySelector(`.stopPercent[data-level="${i}"]`).value);
          }
        } else {
          localStorage.setItem('stopLoss', document.getElementById('stopLoss').value);
        }
        accInputs.forEach(acc => {
          localStorage.setItem(acc.id, document.getElementById(acc.id).value);
          localStorage.setItem(acc.labelId, document.getElementById(acc.labelId).innerText.trim());
        });
        localStorage.setItem('purchasePrice', document.getElementById('purchasePrice').value);
        localStorage.setItem('equityRisk', equityRiskSlider.value);
        localStorage.setItem('positionSize', positionSizeSlider.value);
        localStorage.setItem('mode', document.querySelector('input[name="mode"]:checked').value);
      });

      accountsToggle.addEventListener('click', () => {
        const isExpanded = accountGrid.classList.contains('expanded');
        localStorage.setItem('accountsExpanded', isExpanded);
      });

      window.openHelp = () => document.getElementById('helpModal').style.display = 'block';
      window.closeHelp = () => document.getElementById('helpModal').style.display = 'none';
      document.querySelector('.close').addEventListener('click', closeHelp);
      window.addEventListener('click', (e) => {
        if (e.target === document.getElementById('helpModal')) closeHelp();
      });
    })();
  </script>
</body>
</html>
