<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Trade Risk Manager" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />
  <title>Trade Risk Manager</title>
  <style>
    body {
      background: linear-gradient(135deg, #1e3c72, #2a5298, #4b3f72);
      color: #eee;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 15px;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      touch-action: manipulation;
    }
    h1 {
      text-align: center;
      margin-bottom: 15px;
      font-size: 1.6rem;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .help-icon {
      background: #34c759;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s ease;
    }
    .help-icon:hover {
      background: #28a745;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.3s;
    }
    .modal-content {
      background-color: #121212;
      margin: 10% auto;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 480px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      color: #eee;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      position: absolute;
      right: 15px;
      top: 10px;
    }
    .close:hover {
      color: #fff;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .app-container {
      max-width: 480px;
      width: 100%;
      padding: 12px;
      background: #121212;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .accounts-section {
      margin-bottom: 8px;
    }
    .accounts-toggle {
      width: 100%;
      padding: 8px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
      transition: background 0.3s ease;
      background: #2a2a2a;
      color: #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .accounts-toggle:hover {
      background: #3a3a3a;
    }
    .accounts-toggle::after {
      content: 'â–¼';
      font-size: 0.8rem;
      transition: transform 0.3s ease;
    }
    .accounts-toggle.expanded::after {
      transform: rotate(180deg);
    }
    .account-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      opacity: 0;
    }
    .account-grid.expanded {
      max-height: 600px;
      opacity: 1;
    }
    .input-group {
      flex: 1 1 45%;
      min-width: 140px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .currency-select-group {
      margin-top: 4px;
    }
    .stop-type-group {
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
    }
    .stop-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
    }
    .stop-row .input-group {
      flex: 1 1 100%;
    }
    .staggered-stops {
      display: none;
      flex-direction: column;
      gap: 10px;
    }
    .staggered-stops.show {
      display: flex;
    }
    .staggered-level {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
    }
    .staggered-level .input-group {
      flex: 1 1 45%;
      min-width: 140px;
    }
    .staggered-level .percent-group {
      flex: 1 1 45%;
      min-width: 80px;
    }
    .add-level-btn {
      align-self: flex-start;
      width: auto;
      padding: 6px 12px;
      font-size: 1rem;
    }
    .input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
    }
    .input-row .input-group {
      flex: 1 1 45%;
      min-width: 140px;
    }
    .input-row .currency-group {
      flex: 1 1 45%;
      min-width: 140px;
    }
    label, [contenteditable="true"] {
      font-size: 1.1rem;
      margin-bottom: 4px;
      color: #ffffff;
      cursor: text;
      display: inline-block;
      padding: 2px 4px;
      border-radius: 5px;
    }
    [contenteditable="true"]:focus {
      outline: none;
      background: #3a3a3a;
      border: none;
    }
    input[type="number"], select {
      width: 100%;
      font-size: 1.1rem;
      padding: 8px;
      border-radius: 5px;
      border: none;
      background: #2a2a2a;
      color: #eee;
      box-sizing: border-box;
      appearance: none;
      transition: background 0.3s ease;
    }
    input[type="number"]:focus, select:focus {
      background: #3a3a3a;
      outline: none;
    }
    input[type="number"].error, .stopPercent.error {
      border: 1px solid #ff4444;
      background: #3a1a1a;
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      appearance: none;
    }
    input[type="range"] {
      width: 100%;
      height: 8px;
      background: #444;
      border-radius: 5px;
      outline: none;
      appearance: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      background: #34c759;
      border-radius: 50%;
      cursor: pointer;
    }
    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: #34c759;
      border-radius: 50%;
      cursor: pointer;
    }
    .range-value {
      font-size: 1rem;
      color: #eee;
      margin-top: 4px;
      text-align: center;
    }
    .mode-group {
      display: flex;
      flex-direction: row;
      gap: 15px;
      align-items: center;
      justify-content: center;
    }
    .mode-option {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .mode-option label {
      font-size: 1.1rem;
      color: #ffffff;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 1.2rem;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
      transition: transform 0.2s ease, background 0.3s ease;
    }
    button#calculateBtn {
      background: #34c759;
      color: #fff;
    }
    button#resetBtn {
      background: #f0f0f0;
      color: #1e3c72;
    }
    button:hover {
      transform: scale(1.02);
    }
    button:active {
      transform: scale(0.98);
    }
    .add-level-btn {
      background: #34c759;
      color: #fff;
    }
    .results {
      max-width: 480px;
      margin: 15px 0;
      background: #2a2a2a;
      border-radius: 8px;
      padding: 12px;
    }
    .account-buttons {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-bottom: 10px;
    }
    .account-buttons button {
      padding: 8px 12px;
      background: #2a2a2a;
      color: #eee;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
      width: 100%;
    }
    .account-buttons button.active {
      background: #34c759;
      color: #fff;
    }
    .account-buttons button:hover {
      background: #3a3a3a;
    }
    .result-display .result-group {
      border-bottom: 1px solid #444;
      padding: 12px 0;
    }
    .result-display .result-group:last-child {
      border-bottom: none;
    }
    .result-display .result-group h3 {
      margin: 0 0 8px;
      font-size: 1.2rem;
      color: #34c759;
    }
    .result-display .result-row {
      display: flex;
      justify-content: space-between;
      font-size: 1rem;
      margin-bottom: 6px;
    }
    .bold {
      font-weight: 700;
    }
    .copyright {
      text-align: center;
      font-size: 1rem;
      color: #eee;
      margin-top: 15px;
      opacity: 0.8;
    }
    @media (max-width: 375px) {
      .app-container {
        padding: 10px;
      }
      h1 {
        font-size: 1.4rem;
      }
      input[type="number"], select {
        font-size: 1rem;
      }
      label, [contenteditable="true"] {
        font-size: 1rem;
      }
      button {
        font-size: 1.1rem;
        padding: 10px;
      }
      .result-row {
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <h1>Trade Risk Manager <button class="help-icon" onclick="openHelp()">?</button></h1>

  <div id="helpModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeHelp()">&times;</span>
      <h2>How to Use Trade Risk Manager</h2>
      <p><strong>Accounts Section:</strong> Enter your account sizes and select currencies. Edit labels by tapping on them. Toggle to expand/collapse.</p>
      <p><strong>Trade Currency:</strong> Select the currency of the asset you're trading (e.g., USD for US stocks).</p>
      <p><strong>Purchase Price:</strong> Enter the intended buy price per share.</p>
      <p><strong>Stop Type:</strong> Choose single or staggered stops.</p>
      <ul>
        <li><strong>Single:</strong> One stop loss level.</li>
        <li><strong>Staggered:</strong> Up to 3 levels with percentages (must sum to 100%).</li>
      </ul>
      <p><strong>Mode:</strong> Equity Risk % (risk-based) or Position Size % (fixed size).</p>
      <p><strong>Calculate:</strong> Generates position sizes, shares, and derisk points per account.</p>
      <p><strong>Reset:</strong> Clears all inputs and results.</p>
      <p>Data persists across sessions. For issues, contact support.</p>
    </div>
  </div>

  <div class="app-container">
    <form id="tradeForm">
      <div class="accounts-section">
        <button type="button" id="accountsToggle" class="accounts-toggle">Accounts</button>
        <div class="input-group">
          <label for="accountCurrency">Account Currency</label>
          <select id="accountCurrency">
            <option value="GBP">GBP (Â£)</option>
            <option value="USD">USD ($)</option>
            <option value="EUR">EUR (â‚¬)</option>
          </select>
        </div>
        <div id="accountGrid" class="account-grid">
          <div class="input-group">
            <span id="accountLabel1" contenteditable="true">Account 1</span>
            <input type="number" id="accountSize1" min="0" step="0.01" placeholder="Enter size" />
          </div>
          <div class="input-group">
            <span id="accountLabel2" contenteditable="true">Account 2</span>
            <input type="number" id="accountSize2" min="0" step="0.01" placeholder="Enter size" />
          </div>
          <div class="input-group">
            <span id="accountLabel3" contenteditable="true">Account 3</span>
            <input type="number" id="accountSize3" min="0" step="0.01" placeholder="Enter size" />
          </div>
          <div class="input-group">
            <span id="accountLabel4" contenteditable="true">Account 4</span>
            <input type="number" id="accountSize4" min="0" step="0.01" placeholder="Enter size" />
          </div>
          <div class="input-group">
            <span id="accountLabel5" contenteditable="true">Account 5</span>
            <input type="number" id="accountSize5" min="0" step="0.01" placeholder="Enter size" />
          </div>
          <div class="input-group">
            <span id="accountLabel6" contenteditable="true">Account 6</span>
            <input type="number" id="accountSize6" min="0" step="0.01" placeholder="Enter size" />
          </div>
        </div>
      </div>

      <div class="input-row">
        <div class="input-group currency-group">
          <label for="currencySelect">Trade Currency</label>
          <select id="currencySelect">
            <option value="GBP">GBP (Â£)</option>
            <option value="USD">USD ($)</option>
            <option value="EUR">EUR (â‚¬)</option>
          </select>
        </div>
        <div class="input-group">
          <label for="purchasePrice">Purchase Price</label>
          <input type="number" id="purchasePrice" min="0" step="0.0001" placeholder="Enter price" />
        </div>
      </div>

      <div class="stop-type-group">
        <div class="mode-option">
          <input type="radio" id="stopSingle" name="stopType" value="single" checked />
          <label for="stopSingle">Single Stop</label>
        </div>
        <div class="mode-option">
          <input type="radio" id="stopStaggered" name="stopType" value="staggered" />
          <label for="stopStaggered">Staggered Stops</label>
        </div>
      </div>

      <div id="stopRow" class="stop-row">
        <div class="input-group">
          <label for="stopLoss">Stop Location</label>
          <input type="number" id="stopLoss" min="0" step="0.0001" placeholder="Enter stop" />
        </div>
      </div>

      <div id="staggeredStops" class="staggered-stops">
        <div class="staggered-level" data-level="1">
          <div class="input-group">
            <label>Stop Level 1</label>
            <input type="number" class="stopLevel" data-level="1" min="0" step="0.0001" placeholder="Enter stop" />
          </div>
          <div class="percent-group">
            <label>%</label>
            <input type="number" class="stopPercent" data-level="1" min="0" max="100" step="1" placeholder="%" />
          </div>
        </div>
        <div class="staggered-level" data-level="2">
          <div class="input-group">
            <label>Stop Level 2</label>
            <input type="number" class="stopLevel" data-level="2" min="0" step="0.0001" placeholder="Enter stop" />
          </div>
          <div class="percent-group">
            <label>%</label>
            <input type="number" class="stopPercent" data-level="2" min="0" max="100" step="1" placeholder="%" />
          </div>
        </div>
        <div class="staggered-level" data-level="3" style="display: none;">
          <div class="input-group">
            <label>Stop Level 3</label>
            <input type="number" class="stopLevel" data-level="3" min="0" step="0.0001" placeholder="Enter stop" />
          </div>
          <div class="percent-group">
            <label>%</label>
            <input type="number" class="stopPercent" data-level="3" min="0" max="100" step="1" placeholder="%" />
          </div>
        </div>
        <button type="button" id="addLevelBtn" class="add-level-btn">Add Level</button>
      </div>

      <div class="mode-group">
        <div class="mode-option">
          <input type="radio" id="modeEquityRisk" name="mode" value="equityRisk" checked />
          <label for="modeEquityRisk">Equity Risk %</label>
        </div>
        <div class="mode-option">
          <input type="radio" id="modePositionSize" name="mode" value="positionSize" />
          <label for="modePositionSize">Position Size %</label>
        </div>
      </div>

      <div id="equityRiskGroup">
        <label for="equityRiskSlider">Equity Risk %</label>
        <input type="range" id="equityRiskSlider" min="0.05" max="2" step="0.025" value="0.05" />
        <div id="equityRiskVal" class="range-value">0.05%</div>
      </div>

      <div id="positionSizeGroup" style="display: none;">
        <label for="positionSizeSlider">Position Size %</label>
        <input type="range" id="positionSizeSlider" min="2.5" max="50" step="0.5" value="2.5" />
        <div id="positionSizeVal" class="range-value">2.5%</div>
      </div>

      <button type="button" id="calculateBtn">Calculate</button>
      <button type="button" id="resetBtn">Reset</button>
    </form>
  </div>

  <div id="results" class="results"></div>

  <div class="copyright">Â© 2025 Trade Risk Manager</div>

  <script>
    (() => {
      const form = document.getElementById('tradeForm');
      const accountsToggle = document.getElementById('accountsToggle');
      const accountGrid = document.getElementById('accountGrid');
      const currencySelect = document.getElementById('currencySelect');
      const accountCurrencySelect = document.getElementById('accountCurrency');
      const stopSingle = document.getElementById('stopSingle');
      const stopStaggered = document.getElementById('stopStaggered');
      const stopRow = document.getElementById('stopRow');
      const staggeredStops = document.getElementById('staggeredStops');
      const addLevelBtn = document.getElementById('addLevelBtn');
      const level3 = document.querySelector('.staggered-level[data-level="3"]');
      const modeEquityRisk = document.getElementById('modeEquityRisk');
      const modePositionSize = document.getElementById('modePositionSize');
      const equityRiskGroup = document.getElementById('equityRiskGroup');
      const positionSizeGroup = document.getElementById('positionSizeGroup');
      const equityRiskSlider = document.getElementById('equityRiskSlider');
      const equityRiskVal = document.getElementById('equityRiskVal');
      const positionSizeSlider = document.getElementById('positionSizeSlider');
      const positionSizeVal = document.getElementById('positionSizeVal');
      const resultsDiv = document.getElementById('results');

      let numStaggeredLevels = 2;

      const accInputs = [
        { id: 'accountSize1', labelId: 'accountLabel1', defaultLabel: 'Account 1' },
        { id: 'accountSize2', labelId: 'accountLabel2', defaultLabel: 'Account 2' },
        { id: 'accountSize3', labelId: 'accountLabel3', defaultLabel: 'Account 3' },
        { id: 'accountSize4', labelId: 'accountLabel4', defaultLabel: 'Account 4' },
        { id: 'accountSize5', labelId: 'accountLabel5', defaultLabel: 'Account 5' },
        { id: 'accountSize6', labelId: 'accountLabel6', defaultLabel: 'Account 6' },
      ];

      const exchangeRates = {
        GBP: { USD: 1.3415, EUR: 1.15 },
        USD: { GBP: 0.7453, EUR: 0.86 },
        EUR: { GBP: 0.8683, USD: 1.17 },
      };

      const currencySymbols = {
        GBP: 'Â£',
        USD: '$',
        EUR: 'â‚¬',
      };

      function formatNumber(num) {
        return num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
      }

      function getExchangeRate(from, to) {
        if (from === to) return 1;
        return exchangeRates[from]?.[to] || 1;
      }

      function updateTradeCurrencyOptions() {
        const accCur = accountCurrencySelect.value;
        const options = ['GBP', 'USD', 'EUR'];
        currencySelect.innerHTML = '';
        options.forEach(cur => {
          const rate = getExchangeRate(accCur, cur).toFixed(4);
          const opt = document.createElement('option');
          opt.value = cur;
          opt.textContent = `${cur} (${currencySymbols[cur]}) ${rate}`;
          currencySelect.appendChild(opt);
        });
        const savedTradeCur = localStorage.getItem('defaultTradeCurrency') || 'GBP';
        currencySelect.value = options.includes(savedTradeCur) ? savedTradeCur : 'GBP';
      }

      function validateStaggeredPercentages() {
        const percents = Array.from(document.querySelectorAll('.stopPercent')).slice(0, numStaggeredLevels);
        percents.forEach(el => el.classList.remove('error'));
        const total = percents.reduce((sum, el) => sum + (parseFloat(el.value) || 0), 0);
        if (total !== 100) {
          percents.forEach(el => el.classList.add('error'));
          return false;
        }
        return true;
      }

      function calculateDeriskPoints(purchasePrice, stopLoss) {
        const distanceToStop = purchasePrice - stopLoss;
        return {
          derisk13: purchasePrice + distanceToStop,
          derisk14: purchasePrice + (distanceToStop * 1.5),
        };
      }

      function toggleAccounts() {
        accountGrid.classList.toggle('expanded');
        accountsToggle.classList.toggle('expanded');
      }

      accountsToggle.addEventListener('click', toggleAccounts);

      document.querySelectorAll('input[name="stopType"]').forEach(radio => {
        radio.addEventListener('change', () => {
          if (stopSingle.checked) {
            stopRow.style.display = 'flex';
            staggeredStops.classList.remove('show');
          } else {
            stopRow.style.display = 'none';
            staggeredStops.classList.add('show');
          }
        });
      });

      addLevelBtn.addEventListener('click', () => {
        if (numStaggeredLevels < 3) {
          numStaggeredLevels++;
          level3.style.display = 'flex';
          addLevelBtn.style.display = 'none';
        }
      });

      document.querySelectorAll('input[name="mode"]').forEach(radio => {
        radio.addEventListener('change', () => {
          equityRiskGroup.style.display = modeEquityRisk.checked ? 'block' : 'none';
          positionSizeGroup.style.display = modePositionSize.checked ? 'block' : 'none';
        });
      });

      equityRiskSlider.addEventListener('input', () => {
        equityRiskVal.textContent = `${equityRiskSlider.value}%`;
      });

      positionSizeSlider.addEventListener('input', () => {
        positionSizeVal.textContent = `${positionSizeSlider.value}%`;
      });

      accountCurrencySelect.addEventListener('change', updateTradeCurrencyOptions);
      currencySelect.addEventListener('change', () => {
        localStorage.setItem('defaultTradeCurrency', currencySelect.value);
      });

      document.getElementById('calculateBtn').addEventListener('click', () => {
        const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
        const tradeCurrency = currencySelect.value;
        const accCurrency = accountCurrencySelect.value;
        const mode = document.querySelector('input[name="mode"]:checked').value;
        let equityRiskPercent = 0;
        let positionSizePercent = 0;

        if (mode === 'equityRisk') {
          equityRiskPercent = parseFloat(equityRiskSlider.value) / 100;
        } else {
          positionSizePercent = parseFloat(positionSizeSlider.value) / 100;
        }

        let stopLevels = [];
        let isStaggered = stopStaggered.checked;

        if (isStaggered) {
          if (!validateStaggeredPercentages()) {
            alert('Staggered percentages must sum to 100%');
            return;
          }
          for (let i = 1; i <= numStaggeredLevels; i++) {
            const stop = parseFloat(document.querySelector(`.stopLevel[data-level="${i}"]`).value) || 0;
            const pct = parseFloat(document.querySelector(`.stopPercent[data-level="${i}"]`).value) / 100 || 0;
            stopLevels.push({ stop, pct });
          }
        } else {
          const stopLoss = parseFloat(document.getElementById('stopLoss').value) || 0;
          stopLevels = [{ stop: stopLoss, pct: 1 }];
        }

        if (purchasePrice <= 0) {
          alert('Purchase price must be greater than 0');
          return;
        }

        if (stopLevels.some(level => level.stop >= purchasePrice || level.stop <= 0)) {
          alert('All stop levels must be below purchase price and greater than 0');
          return;
        }

        resultsDiv.innerHTML = '';

        let accountResults = [];

        accInputs.forEach(({ id, labelId }) => {
          const accSize = parseFloat(document.getElementById(id).value) || 0;
          if (accSize === 0) return;
          const accLabel = document.getElementById(labelId).innerText.trim();

          const exchangeRate = getExchangeRate(accCurrency, tradeCurrency);

          const accSizeInTradeCurrency = accSize * exchangeRate;

          let totalPositionSize = 0;
          let weightedStopDistance = 0;

          stopLevels.forEach(level => {
            const distance = purchasePrice - level.stop;
            const portionSize = (mode === 'equityRisk')
              ? (accSizeInTradeCurrency * equityRiskPercent) / (distance / purchasePrice)
              : accSizeInTradeCurrency * positionSizePercent * level.pct;
            totalPositionSize += portionSize;
            weightedStopDistance += distance * level.pct;
          });

          const avgStop = purchasePrice - weightedStopDistance;
          const totalShares = Math.floor(totalPositionSize / purchasePrice);
          const percentToStop = ((purchasePrice - avgStop) / purchasePrice * 100).toFixed(2);

          const deriskPoints = calculateDeriskPoints(purchasePrice, avgStop);
          const derisk13Shares = Math.floor(totalShares / 3);
          const derisk14Shares = Math.floor(totalShares / 4);

          const riskAmount = totalShares * (purchasePrice - avgStop) / exchangeRate;

          let groupHTML = `
            <div class="result-group">
              <h3>${accLabel}</h3>
              <div class="result-row"><span>Exchange Rate (${accCurrency} to ${tradeCurrency}):</span> <span>${exchangeRate.toFixed(4)}</span></div>
              <div class="result-row"><span>Money at Risk:</span> <span>${currencySymbols[accCurrency]}${formatNumber(riskAmount)}</span></div>
              <div class="result-row"><span>Total Position Size:</span> <span>${currencySymbols[tradeCurrency]}${formatNumber(totalPositionSize)}</span></div>
              <div class="result-row"><span>Position Size %:</span> <span>${((totalPositionSize / accSizeInTradeCurrency) * 100).toFixed(2)}%</span></div>
              <div class="result-row"><span>Shares to Buy:</span> <span class="bold">${formatNumber(totalShares)}</span></div>
              <div class="result-row"><span>Avg Stop Loss:</span> <span class="bold">${currencySymbols[tradeCurrency]}${formatNumber(avgStop)}</span></div>
              <div class="result-row"><span>% to Stop:</span> <span>${percentToStop}%</span></div>
              <div class="result-row"><span>Derisk 1/3 at:</span> <span>${currencySymbols[tradeCurrency]}${formatNumber(deriskPoints.derisk13)}</span></div>
              <div class="result-row"><span>Sell Shares (1/3):</span> <span>${formatNumber(derisk13Shares)}</span></div>
              <div class="result-row"><span>Derisk 1/4 at:</span> <span>${currencySymbols[tradeCurrency]}${formatNumber(deriskPoints.derisk14)}</span></div>
              <div class="result-row"><span>Sell Shares (1/4):</span> <span>${formatNumber(derisk14Shares)}</span></div>
            </div>
          `;
          if (isStaggered) {
            stopLevels.forEach((level, idx) => {
              const levelShares = Math.floor(totalShares * level.pct);
              groupHTML += `
                <div class="result-row"><span>Level ${idx + 1} Shares (${level.pct * 100}%):</span> <span>${formatNumber(levelShares)}</span></div>
                <div class="result-row"><span>Level ${idx + 1} Stop:</span> <span>${currencySymbols[tradeCurrency]}${formatNumber(level.stop)}</span></div>
              `;
            });
          }
          accountResults.push({ label: accLabel, html: groupHTML });
        });

        if (accountResults.length > 0) {
          const buttonContainer = document.createElement('div');
          buttonContainer.className = 'account-buttons';

          const displayDiv = document.createElement('div');
          displayDiv.className = 'result-display';

          accountResults.forEach((res, index) => {
            const btn = document.createElement('button');
            btn.textContent = res.label;
            btn.addEventListener('click', () => {
              buttonContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              displayDiv.innerHTML = res.html;
            });
            buttonContainer.appendChild(btn);
          });

          resultsDiv.appendChild(buttonContainer);
          resultsDiv.appendChild(displayDiv);

          // Select first button by default
          buttonContainer.firstChild.click();
        }
      });

      document.getElementById('resetBtn').addEventListener('click', () => {
        form.reset();
        equityRiskVal.textContent = `${equityRiskSlider.value}%`;
        positionSizeVal.textContent = `${positionSizeSlider.value}%`;
        equityRiskGroup.style.display = 'block';
        positionSizeGroup.style.display = 'none';
        modeEquityRisk.checked = true;
        currencySelect.value = 'GBP';
        accountCurrencySelect.value = 'GBP';
        updateTradeCurrencyOptions();
        stopRow.style.display = 'flex';
        staggeredStops.classList.remove('show');
        level3.style.display = 'none';
        addLevelBtn.style.display = 'block';
        numStaggeredLevels = 2;
        accInputs.forEach(({ labelId, defaultLabel }) => {
          document.getElementById(labelId).innerText = defaultLabel;
        });
        resultsDiv.innerHTML = '';
        localStorage.clear();
      });

      function loadSavedData() {
        const savedTradeCurrency = localStorage.getItem('defaultTradeCurrency') || 'GBP';
        const savedAccCurrency = localStorage.getItem('accountCurrency') || 'GBP';
        accountCurrencySelect.value = savedAccCurrency;
        updateTradeCurrencyOptions();
        currencySelect.value = savedTradeCurrency;

        const savedStopType = localStorage.getItem('stopType') || 'single';
        if (savedStopType === 'single') {
          stopSingle.checked = true;
          stopRow.style.display = 'flex';
          staggeredStops.classList.remove('show');
        } else {
          stopStaggered.checked = true;
          stopRow.style.display = 'none';
          staggeredStops.classList.add('show');
          numStaggeredLevels = parseInt(localStorage.getItem('numStaggeredLevels') || 2);
          if (numStaggeredLevels === 3) {
            level3.style.display = 'flex';
            addLevelBtn.style.display = 'none';
          }
          // Load staggered values
          for (let i = 1; i <= numStaggeredLevels; i++) {
            const savedStop = localStorage.getItem(`staggeredStop${i}`);
            const savedPct = localStorage.getItem(`staggeredPct${i}`);
            if (savedStop) document.querySelector(`.stopLevel[data-level="${i}"]`).value = savedStop;
            if (savedPct) document.querySelector(`.stopPercent[data-level="${i}"]`).value = savedPct;
          }
        }

        accInputs.forEach(({ id, labelId, defaultLabel }) => {
          const el = document.getElementById(id);
          if (el) {
            const savedSize = localStorage.getItem(id);
            if (savedSize) el.value = savedSize;
          }
          const labelEl = document.getElementById(labelId);
          if (labelEl) {
            const savedLabel = localStorage.getItem(labelId);
            labelEl.innerText = savedLabel || defaultLabel;
          }
        });
        const savedPurchase = localStorage.getItem('purchasePrice');
        if (savedPurchase) document.getElementById('purchasePrice').value = savedPurchase;
        const savedStopLoss = localStorage.getItem('stopLoss');
        if (savedStopLoss) document.getElementById('stopLoss').value = savedStopLoss;
        const savedRisk = localStorage.getItem('equityRisk');
        if (savedRisk) {
          equityRiskSlider.value = savedRisk;
          equityRiskVal.textContent = `${savedRisk}%`;
        }
        const savedPosition = localStorage.getItem('positionSize');
        if (savedPosition) {
          positionSizeSlider.value = savedPosition;
          positionSizeVal.textContent = `${savedPosition}%`;
        }
        const savedMode = localStorage.getItem('mode');
        if (savedMode) {
          document.querySelector(`input[name="mode"][value="${savedMode}"]`).checked = true;
          equityRiskGroup.style.display = savedMode === 'equityRisk' ? 'block' : 'none';
          positionSizeGroup.style.display = savedMode === 'positionSize' ? 'block' : 'none';
        }
        const accountsExpanded = localStorage.getItem('accountsExpanded') === 'true';
        if (accountsExpanded) {
          accountGrid.classList.add('expanded');
          accountsToggle.classList.add('expanded');
        }
      }
      loadSavedData();

      // Persist on input/change
      form.addEventListener('input', () => {
        localStorage.setItem('defaultTradeCurrency', currencySelect.value);
        localStorage.setItem('accountCurrency', accountCurrencySelect.value);
        localStorage.setItem('stopType', document.querySelector('input[name="stopType"]:checked').value);
        if (document.querySelector('input[name="stopType"]:checked').value === 'staggered') {
          localStorage.setItem('numStaggeredLevels', numStaggeredLevels);
          for (let i = 1; i <= numStaggeredLevels; i++) {
            localStorage.setItem(`staggeredStop${i}`, document.querySelector(`.stopLevel[data-level="${i}"]`).value);
            localStorage.setItem(`staggeredPct${i}`, document.querySelector(`.stopPercent[data-level="${i}"]`).value);
          }
        } else {
          localStorage.setItem('stopLoss', document.getElementById('stopLoss').value);
        }
        accInputs.forEach(({ id, labelId }) => {
          const el = document.getElementById(id);
          if (el) localStorage.setItem(id, el.value);
          const labelEl = document.getElementById(labelId);
          if (labelEl) localStorage.setItem(labelId, labelEl.innerText.trim());
        });
        localStorage.setItem('purchasePrice', document.getElementById('purchasePrice').value);
        localStorage.setItem('equityRisk', equityRiskSlider.value);
        localStorage.setItem('positionSize', positionSizeSlider.value);
        localStorage.setItem('mode', document.querySelector('input[name="mode"]:checked')?.value || 'equityRisk');
      });

      // Accounts toggle persist
      accountsToggle.addEventListener('click', () => {
        const isExpanded = accountGrid.classList.contains('expanded');
        localStorage.setItem('accountsExpanded', !isExpanded);
      });

      // Help modal functions
      window.openHelp = () => document.getElementById('helpModal').style.display = 'block';
      window.closeHelp = () => document.getElementById('helpModal').style.display = 'none';
      document.querySelector('.close').addEventListener('click', closeHelp);
      window.addEventListener('click', (e) => {
        if (e.target === document.getElementById('helpModal')) closeHelp();
      });
    })();
  </script>
</body>
</html>
