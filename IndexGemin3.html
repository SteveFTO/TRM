<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>RiskDesk v10</title>
  <link rel="icon" type="image/png" href="icon.png" />
  <link rel="apple-touch-icon" href="icon.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    /* Custom Dark Theme Tweaks */
    body {
      background-color: #0f172a; /* Slate 900 */
      color: #e2e8f0;
      -webkit-tap-highlight-color: transparent;
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    /* Range Slider Styling */
    input[type=range] {
      -webkit-appearance: none; 
      background: transparent; 
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 24px;
      width: 24px;
      border-radius: 50%;
      background: #3b82f6;
      margin-top: -10px;
      box-shadow: 0 0 10px rgba(59,130,246,0.5);
    }
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%;
      height: 4px;
      background: #334155;
      border-radius: 2px;
    }

    /* Hide scrollbar for clean UI */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    
    /* Toggle Switch */
    .toggle-checkbox:checked {
      right: 0;
      border-color: #10b981;
    }
    .toggle-checkbox:checked + .toggle-label {
      background-color: #10b981;
    }
    
    /* Animation Utils */
    .slide-in {
        animation: slideIn 0.2s ease-out forwards;
    }
    @keyframes slideIn {
        from { opacity: 0; transform: translateX(20px); }
        to { opacity: 1; transform: translateX(0); }
    }

    /* Insight Card Animation */
    .insight-card {
        animation: fadeIn 0.5s ease-out forwards;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* --- PATCH: PASTE ZONE STYLES --- */
    .paste-zone {
        border: 2px dashed #475569;
        border-radius: 0.75rem;
        padding: 1rem;
        text-align: center;
        color: #64748b;
        transition: all 0.2s;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100px;
        margin-top: 1rem;
        background-color: rgba(15, 23, 42, 0.5);
    }
    .paste-zone:hover { border-color: #3b82f6; color: #60a5fa; }
    .paste-zone.has-image { border-color: #10b981; background-color: rgba(16, 185, 129, 0.1); color: #34d399; }
  </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-slate-200">

  <header class="bg-slate-900/90 backdrop-blur border-b border-slate-800 p-4 pt-12 flex justify-between items-center z-20">
    <svg width="150" height="32" viewBox="0 0 150 32" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M16 2.5L5.5 6.875V13C5.5 19.125 9.875 24.375 16 26.125C22.125 24.375 26.5 19.125 26.5 13V6.875L16 2.5Z" 
            stroke="#3b82f6" stroke-width="2" fill="rgba(59, 130, 246, 0.15)"/>
      <path d="M10 17L14 13L18 17L22 11" 
            stroke="#34d399" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <text x="34" y="22" fill="url(#logo_grad)" font-family="ui-sans-serif, system-ui, sans-serif" font-weight="800" font-size="18" letter-spacing="-0.5">RISKDESK</text>
      <defs>
        <linearGradient id="logo_grad" x1="34" y1="0" x2="160" y2="0" gradientUnits="userSpaceOnUse">
          <stop stop-color="#60a5fa" />
          <stop offset="1" stop-color="#34d399" />
        </linearGradient>
      </defs>
    </svg>
    
    <div class="flex gap-1">
        <button onclick="app.switchView('help')" class="text-slate-400 hover:text-white p-2">
            <i data-lucide="circle-help" class="w-6 h-6"></i>
        </button>
        <button onclick="app.switchView('settings')" class="text-slate-400 hover:text-white p-2">
            <i data-lucide="settings" class="w-6 h-6"></i>
        </button>
    </div>
  </header>

  <main class="flex-1 overflow-y-auto overflow-x-hidden no-scrollbar pb-24 relative" id="mainContainer">
    
    <div id="view-calculator" class="p-4 space-y-6 max-w-lg mx-auto transition-opacity duration-300">
      
      <div class="bg-slate-900 border border-slate-800 rounded-xl p-3 flex justify-between items-center shadow-lg" id="heatWidget">
          <div>
              <div class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Open Heat (Exposure)</div>
              <div class="flex items-baseline gap-2">
                  <span class="text-lg font-mono font-bold text-slate-200" id="heatCurrent">0.00%</span>
                  <span class="text-xs text-slate-500 font-mono" id="heatMath"></span>
              </div>
          </div>
          <div class="text-right">
              <div class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Projected Total</div>
              <span class="text-lg font-mono font-bold text-blue-400" id="heatTotal">0.00%</span>
          </div>
      </div>

      <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
        <div class="flex justify-between items-center cursor-pointer" onclick="app.toggleAccountDisplay()">
          <div class="flex items-center gap-2">
              <h2 class="font-semibold text-slate-300">Active Accounts</h2>
              <span class="text-[10px] text-slate-500 uppercase tracking-wider">Base: <span id="dispBaseCcy" class="text-white font-bold">GBP</span></span>
          </div>
          <i data-lucide="chevron-down" id="accDisplayToggleIcon" class="w-5 h-5 transition-transform text-slate-500"></i>
        </div>
        
        <div id="accountsListDisplay" class="space-y-2 mt-4 transition-all duration-300 overflow-hidden">
          </div>
      </div>

      <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700 space-y-4">
        
        <div class="flex bg-slate-900 rounded-lg p-1 border border-slate-600 relative">
            <div class="w-1/2 text-center cursor-pointer py-2 rounded-md transition-all font-bold text-sm" 
                 id="btn-long" onclick="app.setDirection('LONG')">LONG</div>
            <div class="w-1/2 text-center cursor-pointer py-2 rounded-md transition-all font-bold text-sm text-slate-500" 
                 id="btn-short" onclick="app.setDirection('SHORT')">SHORT</div>
        </div>

        <div>
           <label class="text-xs text-slate-500 uppercase font-bold">Trade Currency</label>
           <select id="tradeCurrency" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm mt-1 focus:ring-2 focus:ring-blue-500 outline-none">
              </select>
        </div>

        <div class="flex gap-3">
          <div class="w-1/3">
            <label class="text-xs text-slate-500 uppercase font-bold">Ticker</label>
            <input type="text" id="ticker" placeholder="AAPL" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-lg font-mono uppercase mt-1 focus:border-blue-500 outline-none" />
          </div>
          <div class="w-2/3">
            <label class="text-xs text-slate-500 uppercase font-bold">Entry Price</label>
            <input type="number" id="purchasePrice" placeholder="0.00" step="any" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-lg font-mono mt-1 focus:border-blue-500 outline-none" />
          </div>
        </div>

        <div>
          <label class="text-xs text-slate-500 uppercase font-bold mb-2 block">Stop Loss Strategy</label>
          <div class="flex bg-slate-900 rounded-lg p-1 mb-3">
            <button class="flex-1 py-1 text-sm rounded transition-colors bg-slate-700 text-white shadow" id="btn-stop-single" onclick="app.setStopMode('single')">Single</button>
            <button class="flex-1 py-1 text-sm rounded transition-colors text-slate-400 hover:text-white" id="btn-stop-staggered" onclick="app.setStopMode('staggered')">Staggered</button>
          </div>

          <div id="stop-single-container">
            <input type="number" id="stopLoss" placeholder="Stop Price" step="any" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-lg font-mono focus:border-red-500 outline-none" />
          </div>

          <div id="stop-staggered-container" class="hidden space-y-2">
            </div>
        </div>
      </div>

      <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
         <div class="flex justify-between items-center mb-2">
            <label class="text-xs text-slate-500 uppercase font-bold">Risk Model</label>
            <div class="flex gap-4 text-sm">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="riskMode" value="equity" checked onchange="app.toggleRiskMode()" class="accent-blue-500">
                    <span>Equity %</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="riskMode" value="position" onchange="app.toggleRiskMode()" class="accent-blue-500">
                    <span>Size %</span>
                </label>
            </div>
         </div>

         <div class="mt-4">
             <div class="flex justify-between text-sm mb-2 font-mono">
                 <span id="riskLabel">Risk 0.25%</span>
                 <span id="riskAmountDisplay" class="text-blue-400"></span>
             </div>
             <input type="range" id="riskSlider" min="0.1" max="1.5" step="0.025" value="0.25" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
         </div>
      </div>

      <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
         <label class="text-xs text-slate-500 uppercase font-bold">Strategy & Context</label>
         <select id="strategy" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm mt-2 mb-2 focus:ring-2 focus:ring-blue-500 outline-none">
             <option value="">Select Strategy...</option>
             <option value="FB Breakout">FB Breakout</option>
             <option value="21d Pullback">21d Pullback</option>
             <option value="Gap & Go">Gap & Go</option>
             <option value="Reversal">Reversal</option>
             <option value="Other">Other</option>
         </select>
         <textarea id="notes" rows="2" placeholder="Trade context, mental state..." class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:border-blue-500 outline-none"></textarea>
      </div>

      <div class="space-y-3">
          <button id="mainActionBtn" onclick="app.calculateOrUpdate()" class="w-full py-4 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold text-lg shadow-lg shadow-blue-900/50 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
            Calculate
          </button>
          
          <button onclick="app.resetForm()" class="w-full py-3 rounded-xl border border-slate-700 hover:bg-slate-800 text-slate-400 font-bold text-sm transition-colors">
            Clear Inputs
          </button>
      </div>

      <div id="calculationResults" class="hidden mt-4 animate-in fade-in slide-in-from-bottom-4">
          </div>
      
      <div class="h-12"></div>
    </div>


    <div id="view-settings" class="hidden p-4 max-w-lg mx-auto slide-in pt-10">
        <div class="flex items-center gap-2 mb-6">
            <button onclick="app.switchView('calculator')" class="text-slate-400 hover:text-white">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h1 class="text-2xl font-bold text-white">Settings</h1>
        </div>

        <div class="bg-slate-800 rounded-xl p-4 border border-slate-700 mb-6">
            <h2 class="text-sm font-bold text-emerald-400 mb-4 uppercase flex items-center gap-2">
                <i data-lucide="save" class="w-4 h-4"></i> Data Backup
            </h2>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="app.backupData()" class="bg-slate-900 border border-slate-600 hover:bg-slate-700 text-white py-3 rounded-lg text-sm font-semibold flex flex-col items-center gap-1">
                    <i data-lucide="download-cloud" class="w-5 h-5 text-blue-400"></i>
                    Backup Data
                </button>
                <div class="relative">
                    <input type="file" id="restoreFile" onchange="app.restoreData(this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".json">
                    <button class="w-full h-full bg-slate-900 border border-slate-600 hover:bg-slate-700 text-white py-3 rounded-lg text-sm font-semibold flex flex-col items-center gap-1 pointer-events-none">
                        <i data-lucide="upload-cloud" class="w-5 h-5 text-amber-400"></i>
                        Restore Data
                    </button>
                </div>
            </div>
            <p class="text-[10px] text-slate-500 mt-2 text-center">Save your trade history to a secure JSON file.</p>
        </div>

        <div class="bg-slate-800 rounded-xl p-4 border border-slate-700 mb-6">
            <h2 class="text-sm font-bold text-slate-300 mb-4 uppercase">Currency Settings</h2>
            
            <div class="mb-4">
                <label class="text-xs text-slate-500 uppercase font-bold block mb-1">Global Base Currency</label>
                <select id="settingsBaseCurrency" onchange="app.updateBaseCurrency(this.value)" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                  </select>
                <p class="text-[10px] text-slate-500 mt-1">All Account sizes are assumed to be in this currency.</p>
            </div>
            
            <div>
                <label class="text-xs text-slate-500 uppercase font-bold block mb-1">Default Trade Currency</label>
                <select id="settingsDefaultTradeCurrency" onchange="app.updateDefaultTradeCurrency(this.value)" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                   </select>
                <p class="text-[10px] text-slate-500 mt-1">Default currency selected when calculator opens.</p>
            </div>
        </div>

        <div class="bg-slate-800 rounded-xl p-4 border border-slate-700 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-sm font-bold text-slate-300 uppercase">Accounts Setup</h2>
                <button onclick="app.addAccount()" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-500">+ Add</button>
            </div>
            
            <div id="settingsAccountsList" class="space-y-3">
                </div>
            <p class="text-[10px] text-slate-500 mt-4">Select the radio button to nominate the <strong>Master Account</strong>. Logs will track this account's P&L.</p>
        </div>
		<div class="bg-slate-800 rounded-xl p-4 border border-slate-700 mt-6">
            <h2 class="text-sm font-bold text-slate-300 mb-4 uppercase flex items-center gap-2">
                <i data-lucide="list-checks" class="w-4 h-4 text-purple-400"></i> Strategy Manager
            </h2>
            <div id="settingsStrategiesList" class="space-y-2 mb-4">
                </div>
            <div class="flex gap-2">
                <input type="text" id="newStrategyInput" placeholder="New Strategy Name..." 
                    class="flex-1 bg-slate-900 border border-slate-600 rounded p-2 text-sm text-white focus:ring-2 focus:ring-blue-500 outline-none">
                <button onclick="app.addStrategy()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 rounded text-xs font-bold uppercase tracking-wider">
                    Add
                </button>
            </div>
        </div>
        <div class="bg-red-900/10 rounded-xl p-4 border border-red-900/50 mt-8">
            <h2 class="text-xs font-bold text-red-400 mb-3 uppercase">Danger Zone</h2>
            <button onclick="app.wipeAllData()" class="w-full mt-3 bg-red-900 hover:bg-red-800 text-white py-3 rounded-lg text-sm font-bold shadow-lg">
                Factory Reset App (Delete All Logs)
            </button>
        </div>
        <div class="h-24"></div>
    </div>

    <div id="view-help" class="hidden p-4 max-w-lg mx-auto slide-in pt-10 pb-24">
        <div class="flex items-center gap-2 mb-6">
            <button onclick="app.switchView('calculator')" class="text-slate-400 hover:text-white">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h1 class="text-2xl font-bold text-white">RiskDesk Guide</h1>
        </div>

        <div class="space-y-3">
            
            <details class="group bg-slate-800 rounded-xl border border-slate-700 overflow-hidden open:ring-1 open:ring-blue-500/50">
                <summary class="flex justify-between items-center p-4 cursor-pointer select-none bg-slate-800 hover:bg-slate-750">
                    <h3 class="font-bold text-white flex items-center gap-2">
                        <i data-lucide="settings" class="w-4 h-4 text-blue-400"></i> Setup & Accounts
                    </h3>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 transition-transform group-open:rotate-180"></i>
                </summary>
                <div class="p-4 pt-0 text-sm text-slate-300 space-y-3 border-t border-slate-700/50 mt-2">
                    <p>Before trading, configure your environment in the <strong>Settings</strong> tab.</p>
                    
                    <div>
                        <strong class="text-white block text-xs uppercase mb-1">1. Accounts & The "Master"</strong>
                        <p class="text-xs text-slate-400">You can add multiple accounts (e.g., "Personal", "Prop Firm A"). However, you must nominate one <strong>Master Account</strong>. The app uses the Master Account to track your official performance, win rate, and equity curve. Other accounts are for position sizing reference only.</p>
                        <p class="text-[10px] text-slate-500 mt-1 italic">Tip: Manually update your Account Size in settings when you make deposits or withdrawals to keep sizing accurate.</p>
                    </div>

                    <div>
                        <strong class="text-white block text-xs uppercase mb-1">2. Currencies</strong>
                        <p class="text-xs text-slate-400">Set your <strong>Global Base Currency</strong> (e.g., GBP, USD, SEK). This is the currency your accounts are denominated in. When you calculate a trade in a different currency (e.g., trading US stocks in USD while your account is in GBP), the app automatically fetches live exchange rates to normalize risk.</p>
                    </div>
                </div>
            </details>

            <details class="group bg-slate-800 rounded-xl border border-slate-700 overflow-hidden open:ring-1 open:ring-blue-500/50">
                <summary class="flex justify-between items-center p-4 cursor-pointer select-none bg-slate-800 hover:bg-slate-750">
                    <h3 class="font-bold text-white flex items-center gap-2">
                        <i data-lucide="sliders" class="w-4 h-4 text-emerald-400"></i> Defining Risk
                    </h3>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 transition-transform group-open:rotate-180"></i>
                </summary>
                <div class="p-4 pt-0 text-sm text-slate-300 space-y-3 border-t border-slate-700/50 mt-2">
                    <p>RiskDesk offers two distinct mathematical models for sizing your trades:</p>
                    
                    <div class="bg-slate-900/50 p-2 rounded border-l-2 border-emerald-500">
                        <strong class="text-white text-xs block">Model A: Equity Risk % (Standard)</strong>
                        <p class="text-xs text-slate-400">"I want to lose exactly 1.0% of my account if I'm wrong."</p>
                        <p class="text-[10px] text-slate-500 mt-1">The calculator adjusts your share size based on your Stop Loss width. A tight stop = more shares. A wide stop = fewer shares.</p>
                    </div>

                    <div class="bg-slate-900/50 p-2 rounded border-l-2 border-blue-500">
                        <strong class="text-white text-xs block">Model B: Position Size %</strong>
                        <p class="text-xs text-slate-400">"I want to put 10% of my capital into this stock."</p>
                        <p class="text-[10px] text-slate-500 mt-1">Your share count is fixed based on allocation. Your Risk % will fluctuate depending on how wide your stop is.</p>
                    </div>
                </div>
            </details>

            <details class="group bg-slate-800 rounded-xl border border-slate-700 overflow-hidden open:ring-1 open:ring-blue-500/50">
                <summary class="flex justify-between items-center p-4 cursor-pointer select-none bg-slate-800 hover:bg-slate-750">
                    <h3 class="font-bold text-white flex items-center gap-2">
                        <i data-lucide="flame" class="w-4 h-4 text-red-400"></i> Heat vs. NER
                    </h3>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 transition-transform group-open:rotate-180"></i>
                </summary>
                <div class="p-4 pt-0 text-sm text-slate-300 space-y-3 border-t border-slate-700/50 mt-2">
                    <p>The Dashboard (top left) tracks two critical safety metrics:</p>

                    <div>
                        <strong class="text-slate-200 block text-xs">1. Open Heat (Gross Exposure)</strong>
                        <p class="text-xs text-slate-400">The "Worst Case Scenario." If every single open trade hit its stop loss simultaneously, this is the % of equity you would lose. Professionals typically cap this at 6%.</p>
                    </div>

                    <div>
                        <strong class="text-amber-400 block text-xs">2. NER (New Exposure Risk)</strong>
                        <p class="text-xs text-slate-400">This tracks "Unfinanced Risk." It is your Gross Exposure <em>minus</em> any profits you have already banked on those trades.</p>
                        <ul class="list-disc ml-4 mt-1 text-[10px] text-slate-500">
                            <li><strong>Example:</strong> A recent position was opened with a -0.25% EC risk based on entry and stop loss. If three positions are now unfinanced, NER totals -0.75% EC. </li>
                            <li><strong>Goal:</strong> Once you bank enough profit to cover the remaining risk, the trade becomes "Risk Free" or at least much reduced as stop slippage during significant events can still occur.  The <span class="text-amber-500 px-1 border border-amber-500/50 rounded text-[9px]">NER</span> badge disappears from the logs.</li>
                        </ul>
                    </div>
                </div>
            </details>

            <details class="group bg-slate-800 rounded-xl border border-slate-700 overflow-hidden open:ring-1 open:ring-blue-500/50">
                <summary class="flex justify-between items-center p-4 cursor-pointer select-none bg-slate-800 hover:bg-slate-750">
                    <h3 class="font-bold text-white flex items-center gap-2">
                        <i data-lucide="calculator" class="w-4 h-4 text-purple-400"></i> Calculating & Logging
                    </h3>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 transition-transform group-open:rotate-180"></i>
                </summary>
                <div class="p-4 pt-0 text-sm text-slate-300 space-y-3 border-t border-slate-700/50 mt-2">
                    <ol class="list-decimal ml-4 space-y-2 text-xs text-slate-400">
                        <li><strong>Input Data:</strong> Enter Ticker, Entry Price, and Stop Loss. You can use a "Single" stop or "Staggered" stops (system will calculate the weighted average).</li>
                        <li><strong>Review sizing:</strong> The app calculates share counts for <em>all</em> your accounts simultaneously, but only logs the "Master" account data.</li>
                        <li><strong>Strategy & Notes:</strong> Tag the trade with a strategy (e.g., "Gap & Go") to unlock detailed performance analytics later.</li>
                        <li><strong>Chart Capture:</strong> Before logging, paste a screenshot of your chart into the "Paste Zone" (Ctrl+V) to save it with the trade record. You can also do this post logging by editing the trade</li>
                        <li><strong>Log It:</strong> Tap "Add to Log" to commit the trade.</li>
                    </ol>
                </div>
            </details>

            <details class="group bg-slate-800 rounded-xl border border-slate-700 overflow-hidden open:ring-1 open:ring-blue-500/50">
                <summary class="flex justify-between items-center p-4 cursor-pointer select-none bg-slate-800 hover:bg-slate-750">
                    <h3 class="font-bold text-white flex items-center gap-2">
                        <i data-lucide="layers" class="w-4 h-4 text-blue-400"></i> Management & Exits
                    </h3>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 transition-transform group-open:rotate-180"></i>
                </summary>
                <div class="p-4 pt-0 text-sm text-slate-300 space-y-3 border-t border-slate-700/50 mt-2">
                    <p class="text-xs text-slate-400">Tap the <i data-lucide="pencil" class="w-3 h-3 inline"></i> Pencil icon on any log to open the Management Console.</p>
                    
                    <div>
                        <strong class="text-white block text-xs">Partial Exits</strong>
                        <p class="text-xs text-slate-400">Log partial sells here. The app tracks the "R-Multiple" of every specific chunk you sell. Selling reduces your Open Heat and lowers your NER.</p>
                    </div>

                    <div>
                        <strong class="text-white block text-xs">Edits & Updates</strong>
                        <p class="text-xs text-slate-400">Tap the <i data-lucide="settings-2" class="w-3 h-3 inline"></i> icon in the header to fix entry errors, update notes, or adjust stops.</p>
                    </div>

                    <div>
                        <strong class="text-white block text-xs">Chart Gallery</strong>
                        <p class="text-xs text-slate-400">You can attach an "Exit Chart" here to compare your entry vs. your exit. Tap any image to view it full screen.</p>
                    </div>
                </div>
            </details>

            <details class="group bg-slate-800 rounded-xl border border-slate-700 overflow-hidden open:ring-1 open:ring-blue-500/50">
                <summary class="flex justify-between items-center p-4 cursor-pointer select-none bg-slate-800 hover:bg-slate-750">
                    <h3 class="font-bold text-white flex items-center gap-2">
                        <i data-lucide="bar-chart-2" class="w-4 h-4 text-indigo-400"></i> Stats & Insights
                    </h3>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 transition-transform group-open:rotate-180"></i>
                </summary>
                <div class="p-4 pt-0 text-sm text-slate-300 space-y-3 border-t border-slate-700/50 mt-2">
                    
                    <div>
                        <strong class="text-indigo-300 block text-xs mb-1">Pattern Recognition</strong>
                        <p class="text-[10px] text-slate-400">The app automatically scans your history for patterns. It highlights strengths (e.g., "Best Strategy") and flags risks (e.g., "Negative Skew" - where losses are bigger than wins).</p>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <span class="text-white text-[10px] font-bold block">Growth</span>
                            <span class="text-[10px] text-slate-500">Your equity curve based on Risk Units (R).</span>
                        </div>
                        <div>
                            <span class="text-white text-[10px] font-bold block">Drawdown</span>
                            <span class="text-[10px] text-slate-500">Visualizes the depth of pain/loss from your equity peak.</span>
                        </div>
                        <div>
                            <span class="text-white text-[10px] font-bold block">Duration</span>
                            <span class="text-[10px] text-slate-500">Time vs. Money. Are you holding losers too long?</span>
                        </div>
                        <div>
                            <span class="text-white text-[10px] font-bold block">Distribution</span>
                            <span class="text-[10px] text-slate-500">A bell curve of your R-multiples. Ideally skewed right.</span>
                        </div>
                    </div>
                </div>
            </details>

            <details class="group bg-slate-800 rounded-xl border border-slate-700 overflow-hidden open:ring-1 open:ring-blue-500/50">
                <summary class="flex justify-between items-center p-4 cursor-pointer select-none bg-slate-800 hover:bg-slate-750">
                    <h3 class="font-bold text-white flex items-center gap-2">
                        <i data-lucide="database" class="w-4 h-4 text-slate-400"></i> Data & Backup
                    </h3>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 transition-transform group-open:rotate-180"></i>
                </summary>
                <div class="p-4 pt-0 text-sm text-slate-300 space-y-3 border-t border-slate-700/50 mt-2">
                    <p class="text-xs text-slate-400">Your data is stored locally in your browser/device.</p>
                    
                    <ul class="list-disc ml-4 space-y-1 text-xs text-slate-400">
                        <li><strong>Backup:</strong> Use the Backup button in Settings to download a JSON file. Do this weekly.</li>
                        <li><strong>Export:</strong> Use the Download icon on the Logs page to get a CSV spreadsheet for Excel/Sheets.</li>
                        <li><strong>Restore:</strong> You can load a previous JSON backup to restore your history (e.g., moving to a new phone).</li>
                    </ul>
                </div>
            </details>
			
			<details class="group bg-slate-900/50 rounded-xl border border-red-900/30 overflow-hidden open:ring-1 open:ring-red-500/50 mt-4">
                <summary class="flex justify-between items-center p-4 cursor-pointer select-none hover:bg-slate-800 transition-colors">
                    <h3 class="font-bold text-slate-400 flex items-center gap-2 text-xs uppercase tracking-wider">
                        <i data-lucide="alert-triangle" class="w-4 h-4 text-red-500"></i> Disclaimer
                    </h3>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 transition-transform group-open:rotate-180"></i>
                </summary>
                <div class="p-4 pt-0 text-[10px] text-slate-500 space-y-2 border-t border-slate-800 mt-2 leading-relaxed text-justify">
                    <p><strong>For Educational & Informational Purposes Only:</strong> RiskDesk is a software tool designed to assist with mathematical calculations and record-keeping. It does not constitute financial, investment, or trading advice.</p>
                    
                    <p><strong>High Risk Warning:</strong> Trading can carry a high level of risk and may not be suitable for all investors. Before deciding to trade, you should carefully consider your investment objectives, level of experience, and risk appetite.</p>
                    
                    <p><strong>No Liability:</strong> The calculations provided by this tool are based on user inputs. The developers and distributors of RiskDesk accept no liability for any loss or damage, including without limitation to, any loss of profit, which may arise directly or indirectly from use of or reliance on such information.</p>
                    
                    <p><strong>Software "As Is":</strong> This software is provided "as is" without warranty of any kind. You are responsible for verifying all position sizes and calculations before executing live trades with a broker.</p>
                </div>
            </details>
        </div>
        <div class="h-24"></div>
    </div>


    <div id="view-logs" class="hidden p-4 max-w-4xl mx-auto h-full flex flex-col">
        <div class="flex gap-2 mb-4">
            <div class="relative flex-1">
                <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-slate-500"></i>
                <input type="text" id="logSearch" placeholder="Search Ticker..." onkeyup="app.renderLogs()" class="w-full bg-slate-800 border-none rounded-lg pl-10 py-2 text-sm focus:ring-2 focus:ring-blue-500 text-white">
            </div>
            <button onclick="app.exportLogs()" class="bg-slate-800 p-2 rounded-lg text-slate-400 hover:text-white">
                <i data-lucide="download" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="bg-slate-900 rounded-xl border border-slate-800 flex-1 overflow-hidden flex flex-col">
            <div class="grid grid-cols-12 gap-2 p-3 bg-slate-800 text-xs font-bold text-slate-400 border-b border-slate-700">
                <div class="col-span-2">DATE</div>
                <div class="col-span-2">TICKER</div>
                <div class="col-span-2 text-right">RISK</div>
                <div class="col-span-2 text-right">R-MULT</div>
                <div class="col-span-4 text-center">STATUS</div>
            </div>
            <div id="logsContainer" class="overflow-y-auto flex-1 p-2 space-y-1">
                </div>
        </div>
    </div>
    
    <div id="view-manage" class="hidden fixed inset-0 bg-slate-900 z-40 overflow-y-auto p-4 animate-in slide-in-from-right">
        <div class="max-w-lg mx-auto space-y-6 pt-10 pb-32">
            <div class="flex justify-between items-center mb-6">
                 <button onclick="app.closeManageView()" class="text-slate-400 hover:text-white flex items-center gap-1">
                     <i data-lucide="arrow-left" class="w-5 h-5"></i> Back
                 </button>
                 <h2 class="text-xl font-bold text-white">Manage Trade</h2>
                 <button onclick="app.editTradeParams()" class="text-slate-400 hover:text-blue-400 p-2 bg-slate-800 rounded-lg border border-slate-700">
                     <i data-lucide="settings-2" class="w-5 h-5"></i>
                 </button>
            </div>

            <div id="manageSummary" class="bg-slate-800 rounded-xl p-4 border border-slate-700"></div>

            <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                <h3 class="text-sm font-bold text-slate-300 mb-3 uppercase">Add Exit / Partial</h3>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-[10px] uppercase text-slate-500">Exit Price</label>
                        <input type="number" id="exitInputPrice" step="any" class="w-full bg-slate-900 border border-slate-600 rounded p-2 font-mono text-white">
                    </div>
                    <div>
                        <label class="text-[10px] uppercase text-slate-500">Shares Sold</label>
                        <input type="number" id="exitInputQty" step="1" class="w-full bg-slate-900 border border-slate-600 rounded p-2 font-mono text-white">
                    </div>
                </div>
                <button onclick="app.addExit()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg">Log Exit</button>
            </div>

            <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                 <h3 class="text-sm font-bold text-slate-300 mb-3 uppercase">Exit History</h3>
                 <div id="exitHistoryList" class="space-y-2"></div>
            </div>
            
            <button onclick="app.deleteLog(app.data.editingId); app.closeManageView()" class="w-full py-3 text-red-500 border border-red-900/50 bg-red-900/10 rounded-xl mt-8">
                Delete Entire Trade
            </button>
        </div>
    </div>


    <div id="view-stats" class="hidden p-4 max-w-lg mx-auto pb-24">
        
        <div class="bg-indigo-900/20 border border-indigo-500/30 p-4 rounded-xl mb-6">
            <h3 class="font-bold text-indigo-300 mb-3 flex items-center gap-2 text-sm"><i data-lucide="brain-circuit" class="w-5 h-5"></i> AI Analyst Insights</h3>
            <div id="smartInsightsList" class="space-y-2 text-xs text-slate-300">
               </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-4">
            <div>
                 <label class="text-xs text-slate-500 uppercase font-bold">Strategy</label>
                 <select id="statsFilter" onchange="app.renderStats()" class="w-full bg-slate-800 border-none text-sm rounded-lg p-2 mt-1 outline-none focus:ring-1 focus:ring-blue-500">
                     <option value="ALL">All Strategies</option>
                 </select>
            </div>
            <div>
                 <label class="text-xs text-slate-500 uppercase font-bold">Recency</label>
                 <select id="statsRecency" onchange="app.renderStats()" class="w-full bg-slate-800 border-none text-sm rounded-lg p-2 mt-1 outline-none focus:ring-1 focus:ring-blue-500">
                     <option value="ALL">All Time</option>
                     <option value="10">Last 10 Trades</option>
                     <option value="20">Last 20 Trades</option>
                     <option value="50">Last 50 Trades</option>
                 </select>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="bg-slate-800 p-3 rounded-lg text-center border border-slate-700">
                <div class="text-xs text-slate-500">Win Rate</div>
                <div class="flex flex-col items-center justify-center h-full">
                     <div class="text-xl font-bold text-emerald-400" id="statWinRate">0%</div>
                     <div class="text-[9px] font-bold mt-1" id="statWinRateDiff"></div>
                </div>
            </div>
            <div class="bg-slate-800 p-3 rounded-lg text-center border border-slate-700">
                <div class="text-xs text-slate-500">Profit Factor</div>
                <div class="flex flex-col items-center justify-center h-full">
                     <div class="text-xl font-bold text-blue-400" id="statPF">0.00</div>
                     <div class="text-[9px] font-bold mt-1" id="statPFDiff"></div>
                </div>
            </div>
            <div class="bg-slate-800 p-3 rounded-lg text-center border border-slate-700">
                <div class="text-xs text-slate-500">Expectancy</div>
                <div class="flex flex-col items-center justify-center h-full">
                     <div class="text-xl font-bold text-amber-400" id="statExpectancy">0R</div>
                     <div class="text-[9px] font-bold mt-1" id="statExpectancyDiff"></div>
                </div>
            </div>
            <div class="bg-slate-800 p-3 rounded-lg text-center border border-slate-700">
                <div class="text-xs text-slate-500">Sample Size</div>
                <div class="flex flex-col items-center justify-center h-full">
                     <div class="text-xl font-bold text-white" id="statTotal">0</div>
                     <div class="text-[9px] text-slate-500 mt-1">Trades</div>
                </div>
            </div>
        </div>
		<div id="directionStats" class="grid grid-cols-2 gap-3 mb-6 animate-in fade-in slide-in-from-bottom-2">
            </div>
		

        <div class="space-y-6">
            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
                <h3 class="text-sm font-semibold mb-2 text-slate-300 flex items-center gap-2">
                    <i data-lucide="trending-up" class="w-4 h-4 text-emerald-400"></i> Account Growth
                </h3>
                <canvas id="chartGrowth"></canvas>
            </div>

            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
                <h3 class="text-sm font-semibold mb-2 text-slate-300 flex items-center gap-2">
                    <i data-lucide="bar-chart" class="w-4 h-4 text-amber-400"></i> Recent Contributions (Last 5)
                </h3>
                <canvas id="chartContributions"></canvas>
            </div>

            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
                <h3 class="text-sm font-semibold mb-2 text-slate-300 flex items-center gap-2">
                    <i data-lucide="activity" class="w-4 h-4 text-red-400"></i> Drawdown (Risk Depth)
                </h3>
                <canvas id="chartDrawdown"></canvas>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
                    <h3 class="text-sm font-semibold mb-2 text-slate-300">Strategy Performance (Total R)</h3>
                    <canvas id="chartStrategy"></canvas>
                </div>
                <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
                    <h3 class="text-sm font-semibold mb-2 text-slate-300">Outcomes</h3>
                    <div class="h-40 flex justify-center">
                        <canvas id="chartWinLoss"></canvas>
                    </div>
                </div>
            </div>
			
			

</div> 
	<div class="bg-slate-800 p-3 rounded-xl border border-slate-700 mt-6 mb-6">
    <h3 class="text-sm font-semibold mb-2 text-slate-300 flex items-center gap-2">
        <i data-lucide="hourglass" class="w-4 h-4 text-pink-400"></i> Time vs. Money (Duration)
    </h3>
    <div class="h-64">
        <canvas id="chartDuration"></canvas>
    </div>
    <p class="text-[10px] text-slate-500 mt-2 text-center italic">
        "Cut losers fast (Left Red), Let winners run (Right Green)"
    </p>
</div>

<div class="bg-slate-800 p-3 rounded-xl border border-slate-700 mt-6 mb-6">
    <h3 class="text-sm font-semibold mb-2 text-slate-300 flex items-center gap-2">
        <i data-lucide="bar-chart-2" class="w-4 h-4 text-indigo-400"></i> R-Distribution (The Edge Curve)
    </h3>
    <div class="h-64">
        <canvas id="chartDistribution"></canvas>
    </div>
    <p class="text-[10px] text-slate-500 mt-2 text-center italic">
        "Left = Discipline Errors. Right = Home Runs."
    </p>
</div>

            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 mt-6 mb-6">
                <h3 class="text-sm font-semibold mb-2 text-slate-300 flex items-center gap-2">
                    <i data-lucide="calendar-days" class="w-4 h-4 text-emerald-400"></i> Monthly Performance (%)
                </h3>
                <canvas id="chartMonthly"></canvas>
            </div>

            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
                <h3 class="text-sm font-semibold mb-2 text-slate-300 flex items-center gap-2">
                    <i data-lucide="calendar" class="w-4 h-4 text-blue-400"></i> Day of Week Performance
                </h3>
                <canvas id="chartDayOfWeek"></canvas>
            </div>
        </div>
    </div>

  </main>

  <nav class="fixed bottom-0 w-full bg-slate-900/95 backdrop-blur border-t border-slate-800 flex justify-around items-center pb-safe z-50">
      <button onclick="app.switchView('calculator')" id="nav-calculator" class="flex flex-col items-center py-3 w-1/3 text-blue-500 transition-colors">
          <i data-lucide="calculator" class="w-6 h-6 mb-1"></i>
          <span class="text-[10px] font-bold">Calculator</span>
      </button>
      <button onclick="app.switchView('logs')" id="nav-logs" class="flex flex-col items-center py-3 w-1/3 text-slate-500 hover:text-slate-300 transition-colors">
          <i data-lucide="list" class="w-6 h-6 mb-1"></i>
          <span class="text-[10px] font-bold">Logs</span>
      </button>
      <button onclick="app.switchView('stats')" id="nav-stats" class="flex flex-col items-center py-3 w-1/3 text-slate-500 hover:text-slate-300 transition-colors">
          <i data-lucide="bar-chart-2" class="w-6 h-6 mb-1"></i>
          <span class="text-[10px] font-bold">Stats</span>
      </button>
  </nav>

  <div id="imgModal" class="hidden fixed inset-0 z-[60] bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm" onclick="this.classList.add('hidden')">
    <img id="imgModalSrc" class="max-w-full max-h-full rounded-lg shadow-2xl border border-slate-700" src="" />
</div>

<script>
// --- PATCH 3: IMAGE DATABASE ENGINE ---
const imgDB = {
    db: null,
    async open() { return new Promise((resolve, reject) => {
        const req = indexedDB.open('RiskDeskImages', 1);
        req.onupgradeneeded = (e) => e.target.result.createObjectStore('images', { keyPath: 'id' });
        req.onsuccess = (e) => { this.db = e.target.result; resolve(); };
        req.onerror = (e) => reject(e);
    });},
    async save(blob) {
        if(!this.db) await this.open();
        const id = crypto.randomUUID();
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction('images', 'readwrite');
            tx.objectStore('images').put({ id, blob, date: new Date() });
            tx.oncomplete = () => resolve(id);
            tx.onerror = (e) => reject(e);
        });
    },
    async get(id) {
        if(!this.db) await this.open();
        return new Promise((resolve) => {
            const tx = this.db.transaction('images', 'readonly');
            const req = tx.objectStore('images').get(id);
            req.onsuccess = () => resolve(req.result ? URL.createObjectURL(req.result.blob) : null);
            req.onerror = () => resolve(null);
        });
    }
};

/**
 * Trade Risk Manager v8.1
 */

const app = {
    // --- STATE ---
    data: {
        logs: [],
        accounts: [],
        editingId: null, 
        isEditingParams: false, 
        settings: {
            baseCurrency: 'GBP', 
            tradeCurrency: 'USD',
            defaultTradeCurrency: 'USD', // New Setting
            riskMode: 'equity',
            riskValue: 0.25,
            stopMode: 'single',
            direction: 'LONG'
        },
        staggeredStops: [
            { price: 0, pct: 50 },
            { price: 0, pct: 50 }
        ],
        tempCalculation: {}
    },
    
    charts: {},

    // --- INITIALIZATION ---
    async init() { // PATCH 4A: Async Init
        await imgDB.open(); // Init Image DB
        // Load Logs
        const savedLogs = localStorage.getItem('tradeLogs');
        if (savedLogs) {
            this.data.logs = JSON.parse(savedLogs);
            this.data.logs.forEach(l => {
                if(!l.exits) l.exits = [];
                if(!l.direction) l.direction = 'LONG';
                if(!l.initialQty && l.outcome !== 'open') l.initialQty = 0; 
            });
        }
        
        // Load Settings & Accounts
        const savedSettings = localStorage.getItem('appSettings');
        if (savedSettings) this.data.settings = {...this.data.settings, ...JSON.parse(savedSettings)};
		if (!this.data.settings.strategies) {
            // Default set if none exist
            this.data.settings.strategies = ['FB Breakout', '21d Pullback', 'Gap & Go', 'Reversal', 'Other'];
        }
        const savedAccs = localStorage.getItem('accounts');
        if (savedAccs) {
            this.data.accounts = JSON.parse(savedAccs);
            if (!this.data.accounts.find(a => a.isMaster)) {
                if(this.data.accounts.length > 0) this.data.accounts[0].isMaster = true;
            }
        } else {
            this.data.accounts = [{ id: 1, name: 'Main Account', size: 10000, isMaster: true }];
        }

        // Setup DOM
        this.renderAccountsReadOnly();
        this.populateCurrencySelect();
        this.renderStaggeredInputs();
        this.updateStrategyFilter();
        this.setupListeners();
        this.updateHeatWidget(); 
        
        // UI Init
        document.getElementById('settingsBaseCurrency').value = this.data.settings.baseCurrency;
        
        // Init Default Trade Currency Dropdown in Settings
        this.populateDefaultTradeCurrencySettings();
        document.getElementById('settingsDefaultTradeCurrency').value = this.data.settings.defaultTradeCurrency || 'USD';

        document.getElementById('dispBaseCcy').textContent = this.data.settings.baseCurrency;
        
        // Set initial Trade Currency based on default setting
        document.getElementById('tradeCurrency').value = this.data.settings.defaultTradeCurrency || 'USD';
        
        lucide.createIcons();
        this.restoreFormData();
        this.toggleRiskMode();
        this.setDirection('LONG');
		this.populateStrategySelect();
    },
    
    // --- PATCH 4B: IMAGE HELPERS ---
    async handlePaste(e, type, logId = null) {
        e.preventDefault();
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (const item of items) {
            if (item.type.indexOf("image") === 0) {
                const blob = item.getAsFile();
                const id = await imgDB.save(blob);
                
                const zone = e.target.closest('.paste-zone') || e.target;
                zone.innerHTML = `<i data-lucide="check-circle" class="w-6 h-6 text-emerald-400 mb-1"></i><span class="text-xs text-emerald-400 font-bold">Chart Attached!</span>`;
                zone.classList.add('has-image');
                lucide.createIcons();

                if(type === 'entry') this.data.tempCalculation.entryImgId = id;
                if(type === 'exit' && logId) {
                    const log = this.data.logs.find(l => l.id === logId);
                    if(log) { log.exitImg = id; localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs)); this.openManageView(logId); }
                }
                return;
            }
        }
        alert("No image found in clipboard.");
    },
    
    showImg(src) {
        const m = document.getElementById('imgModal');
        document.getElementById('imgModalSrc').src = src;
        m.classList.remove('hidden');
    },

    setupListeners() {
        document.querySelectorAll('textarea, #ticker, #purchasePrice, #stopLoss').forEach(el => {
            el.addEventListener('change', () => this.saveFormData());
        });
        document.getElementById('riskSlider').addEventListener('input', (e) => {
            const val = e.target.value;
            document.getElementById('riskLabel').textContent = 
                this.data.settings.riskMode === 'equity' ? `Risk ${val}%` : `Pos Size ${val}%`;
            this.data.settings.riskValue = parseFloat(val);
            this.saveSettings();
            this.updateHeatWidget(); 
        });
        document.getElementById('tradeCurrency').addEventListener('change', (e) => {
            this.data.settings.tradeCurrency = e.target.value;
            this.saveSettings();
        });
    },

    saveSettings() {
        localStorage.setItem('appSettings', JSON.stringify(this.data.settings));
        localStorage.setItem('accounts', JSON.stringify(this.data.accounts));
        document.getElementById('dispBaseCcy').textContent = this.data.settings.baseCurrency;
    },

    // --- SMART INSIGHTS ENGINE V2 (PATCH) ---
    generateInsights(logs) {
        const insights = [];
        const filter = document.getElementById('statsFilter').value;
        
        // 1. Filter for Closed Trades Only
        const closed = logs.filter(l => {
             const totalSold = l.exits ? l.exits.reduce((a,b)=>a+b.qty,0) : 0;
             return l.outcome !== 'open' || (l.initialQty > 0 && totalSold >= l.initialQty);
        });
        
        // 2. Create Context Subset (Are we looking at ALL or just ONE strategy?)
        const subset = filter === 'ALL' ? closed : closed.filter(l => l.strategy === filter);

        if(closed.length < 3) {
            document.getElementById('smartInsightsList').innerHTML = `<div class="text-center italic opacity-50">Log at least 3 closed trades to unlock AI insights.</div>`;
            return;
        }

        // HELPER: HTML Generator
        const createCard = (color, title, text) => {
            const colors = {
                emerald: 'border-emerald-500 text-emerald-400',
                amber: 'border-amber-500 text-amber-400',
                blue: 'border-blue-500 text-blue-400',
                purple: 'border-purple-500 text-purple-400'
            };
            return `<div class="insight-card border-l-2 pl-3 py-2 bg-slate-900/50 rounded-r mb-2 ${colors[color]}">
                <strong class="block text-[10px] uppercase opacity-80 mb-0.5">${title}</strong>
                <span class="block leading-snug">${text}</span>
            </div>`;
        };

        // INSIGHT A: Efficiency (Avg Win vs Avg Loss)
        let wins = [], losses = [];
        subset.forEach(l => {
            const risk = Math.abs(l.entry - l.stop);
            let r = 0;
            if(l.exits && l.exits.length > 0) {
                let pnl = 0;
                l.exits.forEach(e => pnl += (l.direction==='SHORT'?l.entry-e.price : e.price-l.entry)*e.qty);
                r = pnl / (l.initialQty * risk);
            } else if (l.exitPrice) {
                r = (l.direction==='SHORT'?l.entry-l.exitPrice : l.exitPrice-l.entry)/risk;
            }
            if(r > 0) wins.push(r); else losses.push(Math.abs(r));
        });

        const avgWin = wins.length ? wins.reduce((a,b)=>a+b,0)/wins.length : 0;
        const avgLoss = losses.length ? losses.reduce((a,b)=>a+b,0)/losses.length : 0;

        if(wins.length > 0 && losses.length > 0) {
            if(avgWin > avgLoss * 2) {
                insights.push(createCard('emerald', 'High Efficiency', `Your average winner (${avgWin.toFixed(2)}R) is <strong>2x larger</strong> than your average loser.`));
            } else if(avgLoss > avgWin) {
                insights.push(createCard('amber', 'Negative Skew', `Warning: Your average loss (${avgLoss.toFixed(2)}R) is bigger than your average win (${avgWin.toFixed(2)}R).`));
            }
        }

        // INSIGHT B: Strategy Context
        if(filter === 'ALL') {
            // Rank Strategies
            const sMap = {};
            closed.forEach(l => {
                if(!l.strategy) return;
                // Quick R Calc
                const risk = Math.abs(l.entry - l.stop);
                let r = 0;
                if(l.exits && l.exits.length) { let p=0; l.exits.forEach(e=>p+=(l.direction==='SHORT'?l.entry-e.price:e.price-l.entry)*e.qty); r=p/(l.initialQty*risk); }
                else if(l.exitPrice) r=(l.direction==='SHORT'?l.entry-l.exitPrice:l.exitPrice-l.entry)/risk;
                
                if(!sMap[l.strategy]) sMap[l.strategy] = 0;
                sMap[l.strategy] += r;
            });
            
            // Find Best
            let bestS = null, maxR = -Infinity;
            Object.keys(sMap).forEach(k => { if(sMap[k] > maxR) { maxR = sMap[k]; bestS = k; } });
            
            if(bestS) {
                insights.push(createCard('blue', 'MVP Strategy', `<strong>${bestS}</strong> is your top performer with <strong>${maxR.toFixed(1)}R</strong> total return.`));
            }
        } else {
            // Deep Dive: Compare Strategy vs Global Average
            const globalWinRate = (closed.filter(l => {
                 // Quick check win
                 const risk = Math.abs(l.entry - l.stop);
                 let r = 0;
                 if(l.exits && l.exits.length) { let p=0; l.exits.forEach(e=>p+=(l.direction==='SHORT'?l.entry-e.price:e.price-l.entry)*e.qty); r=p/(l.initialQty*risk); }
                 else if(l.exitPrice) r=(l.direction==='SHORT'?l.entry-l.exitPrice:l.exitPrice-l.entry)/risk;
                 return r > 0;
            }).length / closed.length) * 100;
            
            const stratWinRate = (wins.length / subset.length) * 100;
            const diff = stratWinRate - globalWinRate;
            
            if(diff > 5) {
                insights.push(createCard('blue', 'Outperformer', `<strong>${filter}</strong> wins ${Math.round(diff)}% more often than your average trade.`));
            } else if (diff < -5) {
                insights.push(createCard('blue', 'Underperformer', `<strong>${filter}</strong> has a lower win rate (${Math.round(stratWinRate)}%) than your average.`));
            }
        }

        // INSIGHT C: Seasonality (Best Month)
        const monthMap = {};
        subset.forEach(l => {
             const m = new Date(l.date).toLocaleString('default', {month:'long'});
             // Quick R Calc
             const risk = Math.abs(l.entry - l.stop);
             let r = 0;
             if(l.exits && l.exits.length) { let p=0; l.exits.forEach(e=>p+=(l.direction==='SHORT'?l.entry-e.price:e.price-l.entry)*e.qty); r=p/(l.initialQty*risk); }
             else if(l.exitPrice) r=(l.direction==='SHORT'?l.entry-l.exitPrice:l.exitPrice-l.entry)/risk;
             
             if(!monthMap[m]) monthMap[m] = 0;
             monthMap[m] += r;
        });
        
        let bestM = null, maxM = -Infinity;
        Object.keys(monthMap).forEach(k => { if(monthMap[k] > maxM) { maxM = monthMap[k]; bestM = k; } });
        
        if(bestM && maxM > 2) {
            insights.push(createCard('purple', 'Seasonality', `<strong>${bestM}</strong> is your strongest month (+${maxM.toFixed(1)}R).`));
        }

        // Render to DOM
        const container = document.getElementById('smartInsightsList');
        if(insights.length === 0) {
             container.innerHTML = `<div class="text-center text-slate-500 text-[10px]">No significant patterns found yet. Keep trading!</div>`;
        } else {
             container.innerHTML = insights.join('');
        }
    },

    // --- DATA BACKUP & RESTORE ---
    backupData() {
        const payload = {
            version: 'v8',
            timestamp: new Date().toISOString(),
            logs: this.data.logs,
            accounts: this.data.accounts,
            settings: this.data.settings
        };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(payload));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", `trade_backup_${new Date().toISOString().split('T')[0]}.json`);
        document.body.appendChild(downloadAnchorNode); // required for firefox
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    },

    restoreData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                if (json.logs && json.accounts) {
                    if(confirm(`Restore ${json.logs.length} logs and ${json.accounts.length} accounts? Current data will be overwritten.`)) {
                        localStorage.setItem('tradeLogs', JSON.stringify(json.logs));
                        localStorage.setItem('accounts', JSON.stringify(json.accounts));
                        if(json.settings) localStorage.setItem('appSettings', JSON.stringify(json.settings));
                        alert("Restore Successful. App will reload.");
                        location.reload();
                    }
                } else {
                    alert("Invalid Backup File format.");
                }
            } catch (err) {
                alert("Error reading file: " + err);
            }
        };
        reader.readAsText(file);
    },

    wipeAllData() {
        if(confirm("CRITICAL WARNING: This will permanently delete ALL trade logs and settings. There is no undo.")) {
            if(confirm("Are you absolutely sure?")) {
                localStorage.clear();
                location.reload();
            }
        }
    },

    // --- HEAT CALCULATION ---
    calculateCurrentHeat() {
        const masterAcc = this.data.accounts.find(a => a.isMaster);
        if(!masterAcc || masterAcc.size <= 0) return { total: 0, ner: 0 }; // Return object now

        let totalHeatVal = 0; // Gross Exposure
        let totalNERVal = 0;  // Net Unfinanced Exposure

        this.data.logs.forEach(l => {
            if(l.outcome === 'open') {
                const initQty = typeof l.initialQty === 'number' ? l.initialQty : 0;
                
                // 1. Calculate Realized P&L (Banked Finance)
                let realizedPnL = 0;
                let totalSold = 0;
                
                if (l.exits && l.exits.length > 0) {
                    l.exits.forEach(ex => {
                        totalSold += ex.qty;
                        const pnl = l.direction === 'SHORT' 
                            ? (l.entry - ex.price) * ex.qty 
                            : (ex.price - l.entry) * ex.qty;
                        realizedPnL += pnl;
                    });
                }

                const remaining = initQty - totalSold;
                if(remaining <= 0) return;

                // 2. Calculate Potential Loss on Remaining (Gross Risk)
                let riskDist = 0;
                if(l.direction === 'LONG') {
                    // If stop is above entry (locked in profit), risk is 0 for heat purposes
                    riskDist = Math.max(0, l.entry - l.stop); 
                } else {
                    riskDist = Math.max(0, l.stop - l.entry);
                }
                
                const grossRiskVal = remaining * riskDist;
                
                // 3. NER Calculation: Gross Risk minus Banked Profit
                // If we have banked more than we can lose, NER is 0.
                let netExposureVal = grossRiskVal - realizedPnL;
                if (netExposureVal < 0) netExposureVal = 0;

                // 4. Convert to Base Currency
                const rate = l.exchangeRate || 1;
                totalHeatVal += (grossRiskVal / rate);
                totalNERVal += (netExposureVal / rate);
            }
        });

        return {
            total: (totalHeatVal / masterAcc.size) * 100,
            ner: (totalNERVal / masterAcc.size) * 100
        };
    },

    updateHeatWidget() {
        const { total, ner } = this.calculateCurrentHeat();
        const widget = document.getElementById('heatWidget');
        
        // Thresholds for warning colors
        const isHeatHigh = total > 6.0;
        const isNerHigh = ner > 3.0;

        // Apply Warning Styles to Container
        if (isHeatHigh || isNerHigh) {
            widget.classList.add('border-red-500', 'bg-red-900/20');
            widget.classList.remove('border-slate-800');
        } else {
            widget.classList.remove('border-red-500', 'bg-red-900/20');
            widget.classList.add('border-slate-800');
        }

        // Render Clean Layout
        widget.innerHTML = `
            <div>
                <div class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Open Heat (Gross)</div>
                <div class="text-lg font-mono font-bold ${isHeatHigh ? 'text-red-400' : 'text-slate-200'}">${total.toFixed(2)}%</div>
            </div>
            <div class="text-right">
                <div class="text-[10px] text-amber-500/70 uppercase font-bold tracking-wider">NER (Net Risk)</div>
                <div class="text-lg font-mono font-bold ${isNerHigh ? 'text-red-400' : 'text-amber-400'}">${ner.toFixed(2)}%</div>
            </div>
        `;
    },

    // --- VIEW MANAGEMENT ---
    switchView(viewName) {
        ['calculator', 'logs', 'stats', 'manage', 'settings', 'help'].forEach(v => {
            const el = document.getElementById(`view-${v}`);
            if(el) el.classList.add('hidden');
            const nav = document.getElementById(`nav-${v}`);
            if(nav) {
                nav.classList.remove('text-blue-500');
                nav.classList.add('text-slate-500');
            }
        });

        document.getElementById(`view-${viewName}`).classList.remove('hidden');
        const activeNav = document.getElementById(`nav-${viewName}`);
        if(activeNav) {
            activeNav.classList.add('text-blue-500');
            activeNav.classList.remove('text-slate-500');
        }

        if (viewName === 'logs') this.renderLogs();
        if (viewName === 'stats') this.renderStats();
        if (viewName === 'settings') this.renderSettingsAccounts(); this.renderSettingsStrategies();
        if (viewName === 'calculator') {
            this.renderAccountsReadOnly();
            this.updateHeatWidget();
        }
        
        lucide.createIcons();
    },

    closeManageView() {
        this.data.editingId = null;
        this.switchView('logs');
    },

    // --- SETTINGS LOGIC ---
    updateBaseCurrency(val) {
        this.data.settings.baseCurrency = val;
        this.populateCurrencySelect();
        this.saveSettings();
    },
    
    updateDefaultTradeCurrency(val) {
        this.data.settings.defaultTradeCurrency = val;
        this.saveSettings();
    },

    populateDefaultTradeCurrencySettings() {
         const options = ['USD', 'GBP', 'EUR', 'CAD', 'JPY','SEK'];
         const settingsSelect = document.getElementById('settingsDefaultTradeCurrency');
         if (settingsSelect) {
            settingsSelect.innerHTML = options.map(c => 
                `<option value="${c}" ${c === (this.data.settings.defaultTradeCurrency || 'USD') ? 'selected' : ''}>${c}</option>`
            ).join('');
         }
    },

    renderSettingsAccounts() {
        const list = document.getElementById('settingsAccountsList');
        list.innerHTML = this.data.accounts.map((acc, idx) => `
            <div class="bg-slate-900 p-3 rounded border ${acc.isMaster ? 'border-amber-500/50' : 'border-slate-700'} flex items-center gap-3">
                <input type="radio" name="masterAcc" ${acc.isMaster ? 'checked' : ''} 
                    onchange="app.setMasterAccount(${idx})" class="accent-amber-500 w-4 h-4">
                
                <div class="flex-1 space-y-1">
                    <input type="text" value="${acc.name}" onchange="app.updateAccountData(${idx}, 'name', this.value)" 
                        class="w-full bg-transparent text-sm font-bold text-white outline-none border-b border-transparent focus:border-blue-500 placeholder-slate-600" placeholder="Account Name">
                    <input type="number" value="${acc.size}" onchange="app.updateAccountData(${idx}, 'size', this.value)" 
                        class="w-full bg-transparent text-xs font-mono text-slate-400 outline-none border-b border-transparent focus:border-blue-500" placeholder="Current Equity" title="Manually update this when you deposit funds or realize P&L">
                </div>
                
                <button onclick="app.removeAccount(${idx})" class="text-slate-600 hover:text-red-500">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        `).join('');
        lucide.createIcons();
    },

    addAccount() {
        this.data.accounts.push({ 
            id: Date.now(), 
            name: `New Account`, 
            size: 0, 
            isMaster: this.data.accounts.length === 0 
        });
        this.saveSettings();
        this.renderSettingsAccounts();
    },

    removeAccount(idx) {
        if(this.data.accounts.length <= 1) return alert("Must have at least one account.");
        if(confirm("Delete this account?")) {
            const isMaster = this.data.accounts[idx].isMaster;
            this.data.accounts.splice(idx, 1);
            if(isMaster && this.data.accounts.length > 0) this.data.accounts[0].isMaster = true;
            this.saveSettings();
            this.renderSettingsAccounts();
        }
    },

    updateAccountData(idx, field, val) {
        this.data.accounts[idx][field] = field === 'size' ? parseFloat(val) : val;
        this.saveSettings();
    },

    setMasterAccount(idx) {
        this.data.accounts.forEach((a, i) => a.isMaster = (i === idx));
        this.saveSettings();
        this.renderSettingsAccounts();
    },

    // --- CALCULATOR VIEW LOGIC ---
    toggleAccountDisplay() {
        const list = document.getElementById('accountsListDisplay');
        const icon = document.getElementById('accDisplayToggleIcon');
        if(list.classList.contains('hidden')) {
            list.classList.remove('hidden');
            icon.style.transform = 'rotate(180deg)';
        } else {
            list.classList.add('hidden');
            icon.style.transform = 'rotate(0deg)';
        }
    },

    renderAccountsReadOnly() {
        const list = document.getElementById('accountsListDisplay');
        if(this.data.accounts.length === 0) {
            list.innerHTML = `<div class="text-xs text-center text-slate-500">No accounts configured. Go to Settings.</div>`;
            return;
        }
        list.innerHTML = this.data.accounts.map(acc => `
            <div class="flex justify-between items-center p-2 rounded bg-slate-900 border ${acc.isMaster ? 'border-amber-500/30' : 'border-slate-800'}">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-bold text-slate-300">${acc.name}</span>
                    ${acc.isMaster ? '<span class="text-[8px] bg-amber-500/20 text-amber-500 px-1 rounded border border-amber-500/20">MASTER</span>' : ''}
                </div>
                <div class="font-mono text-xs text-slate-400">${acc.size.toLocaleString()}</div>
            </div>
        `).join('');
    },

    // --- CALCULATOR LOGIC ---
    setDirection(dir) {
        this.data.settings.direction = dir;
        const btnLong = document.getElementById('btn-long');
        const btnShort = document.getElementById('btn-short');
        
        if(dir === 'LONG') {
            btnLong.classList.add('bg-emerald-600', 'text-white', 'shadow');
            btnLong.classList.remove('text-slate-500');
            btnShort.classList.remove('bg-red-600', 'text-white', 'shadow');
            btnShort.classList.add('text-slate-500');
        } else {
            btnShort.classList.add('bg-red-600', 'text-white', 'shadow');
            btnShort.classList.remove('text-slate-500');
            btnLong.classList.remove('bg-emerald-600', 'text-white', 'shadow');
            btnLong.classList.add('text-slate-500');
        }
    },

    populateCurrencySelect() {
        const tradeSel = document.getElementById('tradeCurrency');
        const options = ['USD', 'GBP', 'EUR', 'CAD', 'JPY','SEK'];
        const settingsSel = document.getElementById('settingsBaseCurrency');
        
        // Re-populate Calculator Trade Currency
        tradeSel.innerHTML = options.map(c => 
            `<option value="${c}" ${c === this.data.settings.tradeCurrency ? 'selected' : ''}>${c}</option>`
        ).join('');

        // Re-populate Settings Base Currency
        settingsSel.innerHTML = options.map(c =>
             `<option value="${c}" ${c === this.data.settings.baseCurrency ? 'selected' : ''}>${c}</option>`
        ).join('');
    },

	// --- STRATEGY MANAGEMENT ---
    populateStrategySelect() {
        const sel = document.getElementById('strategy');
        if(!sel) return;
        
        // Preserve current selection if reloading
        const currentVal = sel.value; 
        
        sel.innerHTML = '<option value="">Select Strategy...</option>' + 
            this.data.settings.strategies.map(s => `<option value="${s}">${s}</option>`).join('');
            
        if(currentVal && this.data.settings.strategies.includes(currentVal)) {
            sel.value = currentVal;
        }
    },

    renderSettingsStrategies() {
        const list = document.getElementById('settingsStrategiesList');
        if(!list) return;
        
        list.innerHTML = this.data.settings.strategies.map((strat, idx) => `
            <div class="flex justify-between items-center bg-slate-900 p-2 rounded border border-slate-700 group">
                <span class="text-sm text-slate-300 pl-2 border-l-2 border-purple-500/50">${strat}</span>
                <button onclick="app.removeStrategy(${idx})" class="text-slate-600 hover:text-red-400 p-1 opacity-50 group-hover:opacity-100 transition-opacity">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        `).join('');
        lucide.createIcons();
    },

    addStrategy() {
        const input = document.getElementById('newStrategyInput');
        const val = input.value.trim();
        if(!val) return;
        
        // Prevent duplicates
        if(this.data.settings.strategies.some(s => s.toLowerCase() === val.toLowerCase())) {
            return alert("Strategy already exists.");
        }
        
        this.data.settings.strategies.push(val);
        input.value = '';
        this.saveSettings();
        this.renderSettingsStrategies();
        this.populateStrategySelect();
    },

    removeStrategy(idx) {
        if(confirm("Remove this strategy? (It will remain on old logs but won't be selectable for new trades)")) {
            this.data.settings.strategies.splice(idx, 1);
            this.saveSettings();
            this.renderSettingsStrategies();
            this.populateStrategySelect();
        }
    },

    setStopMode(mode) {
        this.data.settings.stopMode = mode;
        const btnSingle = document.getElementById('btn-stop-single');
        const btnStag = document.getElementById('btn-stop-staggered');
        const divSingle = document.getElementById('stop-single-container');
        const divStag = document.getElementById('stop-staggered-container');

        if(mode === 'single') {
            btnSingle.classList.replace('text-slate-400', 'text-white');
            btnSingle.classList.add('bg-slate-700', 'shadow');
            btnStag.classList.remove('bg-slate-700', 'shadow', 'text-white');
            btnStag.classList.add('text-slate-400');
            divSingle.classList.remove('hidden');
            divStag.classList.add('hidden');
        } else {
            btnStag.classList.replace('text-slate-400', 'text-white');
            btnStag.classList.add('bg-slate-700', 'shadow');
            btnSingle.classList.remove('bg-slate-700', 'shadow', 'text-white');
            btnSingle.classList.add('text-slate-400');
            divSingle.classList.add('hidden');
            divStag.classList.remove('hidden');
        }
    },

    renderStaggeredInputs() {
        const container = document.getElementById('stop-staggered-container');
        container.innerHTML = this.data.staggeredStops.map((stop, idx) => `
            <div class="flex gap-2 items-center">
                <span class="text-xs text-slate-500 w-4">${idx+1}</span>
                <input type="number" placeholder="Price" value="${stop.price || ''}" 
                    onchange="app.updateStaggered(${idx}, 'price', this.value)"
                    class="flex-1 bg-slate-900 border border-slate-700 rounded p-2 text-sm font-mono">
                <div class="relative w-20">
                    <input type="number" value="${stop.pct}" 
                        onchange="app.updateStaggered(${idx}, 'pct', this.value)"
                        class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm text-right pr-6">
                    <span class="absolute right-2 top-2 text-slate-500 text-xs">%</span>
                </div>
            </div>
        `).join('') + `
            <button onclick="app.addStaggeredLevel()" class="text-xs text-blue-400 mt-1 hover:text-white">+ Add Level</button>
        `;
    },

    updateStaggered(idx, field, val) {
        this.data.staggeredStops[idx][field] = parseFloat(val);
    },

    addStaggeredLevel() {
        if(this.data.staggeredStops.length >= 4) return;
        this.data.staggeredStops.push({ price: 0, pct: 0 });
        this.renderStaggeredInputs();
    },

    toggleRiskMode() {
        const modes = document.getElementsByName('riskMode');
        let selected;
        modes.forEach(m => { if(m.checked) selected = m.value; });
        this.data.settings.riskMode = selected;
        
        const slider = document.getElementById('riskSlider');
        const label = document.getElementById('riskLabel');
        
        // Reset implied calculation
        this.data.tempCalculation.impliedRiskPct = null;
        
        if (selected === 'equity') {
            slider.min = "0.1"; slider.max = "1.5"; slider.step = "0.025";
            if(slider.value > 1.5) slider.value = 0.25; 
            label.textContent = `Risk ${slider.value}%`;
        } else {
            slider.min = "3"; slider.max = "40"; slider.step = "0.5";
            if(slider.value < 3 || slider.value > 40) slider.value = 10;
            label.textContent = `Pos Size ${slider.value}%`;
        }
        this.data.settings.riskValue = parseFloat(slider.value);
        this.updateHeatWidget();
    },

    async calculateOrUpdate() {
        const ticker = document.getElementById('ticker').value.toUpperCase();
        const entry = parseFloat(document.getElementById('purchasePrice').value);
        const direction = this.data.settings.direction;
        
        if(!ticker || !entry) return alert("Please enter Ticker and Entry Price");

        let stopPrice = 0;
        if(this.data.settings.stopMode === 'single') {
            stopPrice = parseFloat(document.getElementById('stopLoss').value);
        } else {
            let totalW = 0;
            let wPrice = 0;
            this.data.staggeredStops.forEach(s => {
                if(s.price && s.pct) {
                    wPrice += s.price * (s.pct/100);
                    totalW += s.pct;
                }
            });
            if(Math.abs(totalW - 100) > 1) return alert("Staggered stops must equal 100%");
            stopPrice = wPrice;
        }

        if(!stopPrice) return alert("Invalid Stop Loss");
        if (direction === 'LONG' && stopPrice >= entry) return alert("For LONG, Stop must be < Entry");
        if (direction === 'SHORT' && stopPrice <= entry) return alert("For SHORT, Stop must be > Entry");

        // Rate Logic: Global Base -> Trade Ccy
        const baseCcy = this.data.settings.baseCurrency;
        const tradeCcy = document.getElementById('tradeCurrency').value;
        let rate = 1;
        
        if(baseCcy !== tradeCcy) {
            try {
                const btn = document.getElementById('mainActionBtn');
                const originalText = btn.textContent;
                btn.textContent = "Fetching Live Rate...";
                btn.disabled = true;
                const response = await fetch(`https://api.frankfurter.app/latest?from=${baseCcy}&to=${tradeCcy}`);
                const data = await response.json();
                rate = data.rates[tradeCcy];
                btn.textContent = originalText;
                btn.disabled = false;
            } catch (e) {
                alert("Could not fetch live rate. Using fallback (1.25). Check internet.");
                rate = 1.25; 
            }
        }

        const riskPerShare = Math.abs(entry - stopPrice);
        const stopPct = (riskPerShare / entry) * 100;
        
        let derisk13Price, derisk14Price;
        if(direction === 'LONG') {
             derisk13Price = entry + (entry - stopPrice); 
             derisk14Price = entry + (entry - stopPrice) * (4/3); 
        } else {
             derisk13Price = entry - (stopPrice - entry);
             derisk14Price = entry - (stopPrice - entry) * (4/3);
        }

        const resultsDiv = document.getElementById('calculationResults');
        let html = `<div class="bg-slate-900 border border-slate-700 rounded-xl p-4 mb-4">
            <div class="flex justify-between mb-2 border-b border-slate-700 pb-2">
                <span class="font-bold text-white">${ticker} <span class="text-[10px] ${direction==='LONG'?'text-emerald-400':'text-red-400'} px-1 border border-current rounded">${direction}</span></span>
                <span class="text-xs text-slate-400">${new Date().toLocaleDateString()}</span>
            </div>
            <div class="grid grid-cols-2 gap-4 text-sm mb-2">
                <div><span class="text-slate-500 block text-xs">Entry</span>${entry}</div>
                <div><span class="text-slate-500 block text-xs">Stop</span>${stopPrice.toFixed(2)} (${stopPct.toFixed(2)}%)</div>
            </div>
        </div>`;

        // Capture implied risk for Heat widget
        let impliedRiskPct = 0;

        html += `<div class="space-y-3">`;
        let validAccountFound = false;
        let masterShares = 0; 

        this.data.accounts.forEach(acc => {
            if(!acc.size || acc.size <= 0) return;
            validAccountFound = true;
            
            let shares, posSize, riskAmt, posSizePct, eqRiskPct;

            if(this.data.settings.riskMode === 'equity') {
                const riskPct = this.data.settings.riskValue / 100;
                riskAmt = acc.size * riskPct; 
                const riskAmtTradeCcy = riskAmt * rate; 
                shares = Math.floor(riskAmtTradeCcy / riskPerShare);
                const totalPosValueTradeCcy = shares * entry;
                const totalPosValueBaseCcy = totalPosValueTradeCcy / rate;
                posSizePct = (totalPosValueBaseCcy / acc.size) * 100;
                eqRiskPct = this.data.settings.riskValue; // Known constant
                impliedRiskPct = eqRiskPct; 
            } else {
                // Position Size Mode
                const posPct = this.data.settings.riskValue / 100;
                posSizePct = this.data.settings.riskValue;
                posSize = acc.size * posPct * rate; // Trade Ccy target
                shares = Math.floor(posSize / entry);
                
                // Back-calculate true risk
                const totalRiskInTradeCcy = shares * riskPerShare;
                const totalRiskInBaseCcy = totalRiskInTradeCcy / rate;
                eqRiskPct = (totalRiskInBaseCcy / acc.size) * 100;
                riskAmt = totalRiskInBaseCcy;
                
                // Store implied risk (first valid account usually reps the strategy)
                if(impliedRiskPct === 0) impliedRiskPct = eqRiskPct; 
            }

            posSize = shares * entry;
            if (acc.isMaster) masterShares = shares;

            const borderClass = acc.isMaster 
                ? 'border-amber-500 shadow-[0_0_10px_rgba(245,158,11,0.2)]' 
                : (direction==='LONG'?'border-blue-500/50':'border-red-500/50');
            
            const badge = acc.isMaster ? '<span class="text-[8px] bg-amber-500 text-black px-1 rounded font-bold">MASTER</span>' : '';

            html += `
            <div class="bg-slate-800 p-3 rounded-lg border-l-4 ${borderClass}">
                <div class="flex justify-between items-center mb-1">
                    <div class="flex items-center gap-2">
                         <span class="font-bold text-slate-300">${acc.name}</span>
                         ${badge}
                    </div>
                    <span class="text-xs font-mono text-slate-500">Size: ${acc.size.toLocaleString()}</span>
                </div>
                <div class="grid grid-cols-4 gap-2 text-center mb-2">
                    <div class="bg-slate-900/50 rounded p-1">
                        <div class="text-[10px] text-slate-500 uppercase">Shares</div>
                        <div class="font-bold text-sm text-white">${shares}</div>
                    </div>
                    <div class="bg-slate-900/50 rounded p-1">
                        <div class="text-[10px] text-slate-500 uppercase">Pos Size</div>
                        <div class="font-mono text-xs text-white">${posSize.toFixed(0)} <span class="text-[8px]">${tradeCcy}</span></div>
                    </div>
                    <div class="bg-slate-900/50 rounded p-1">
                        <div class="text-[10px] text-slate-500 uppercase">Eq Risk</div>
                        <div class="font-mono text-xs text-amber-400 font-bold">${eqRiskPct.toFixed(2)}%</div>
                    </div>
                    <div class="bg-slate-900/50 rounded p-1">
                        <div class="text-[10px] text-slate-500 uppercase">Risk $</div>
                        <div class="font-mono text-xs text-red-400">-${riskAmt.toFixed(2)}</div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-slate-400 border-t border-slate-700 pt-2">
                    <div class="flex justify-between col-span-2 border-b border-slate-700/50 pb-1 mb-1">
                        <span class="font-mono text-emerald-400">1 ${baseCcy} = ${rate.toFixed(4)} ${tradeCcy}</span>
                        <span class="font-mono text-slate-300">Size: ${posSizePct.toFixed(2)}%</span>
                    </div>
                </div>
            </div>`;
        });
        html += `</div>`;

        this.data.tempCalculation = { derisk13Price, derisk14Price, rate, impliedRiskPct };
        this.updateHeatWidget(); // Force update with new implied risk

        if(validAccountFound) {
            const btnText = this.data.isEditingParams ? "Update Trade Record" : `Add to Log (Master: ${masterShares} shares)`;
            const btnColor = this.data.isEditingParams ? "bg-amber-600 hover:bg-amber-500 shadow-amber-900/50" : "bg-emerald-600 hover:bg-emerald-500 shadow-emerald-900/50";
            
            // --- PATCH 5: PASTE ZONE HTML ---
            html += `
            <div id="pasteArea" class="paste-zone mt-4 mb-2" contenteditable="true" onpaste="app.handlePaste(event, 'entry')">
                <i data-lucide="image-plus" class="w-6 h-6 mb-1"></i>
                <span class="text-xs">Paste Entry Chart Here</span>
            </div>`;

            html += `<button onclick="app.saveToLog(${entry}, ${stopPrice}, ${masterShares})" class="w-full mt-4 text-white font-bold py-3 rounded-xl shadow-lg transition-colors ${btnColor}">
                ${btnText}
            </button>`;
        } else {
             html += `<div class="text-center text-red-400 p-4">Please set an Account Size in Settings</div>`;
        }

        resultsDiv.innerHTML = html;
        resultsDiv.classList.remove('hidden');
        resultsDiv.scrollIntoView({ behavior: 'smooth' });
        lucide.createIcons();
    },

    saveToLog(entry, stop, shares) {
        if(shares <= 0) alert("Warning: Master Account share count is 0. Log will have no initial quantity.");

        const { derisk13Price, derisk14Price, rate, impliedRiskPct } = this.data.tempCalculation || {};
        
        let stopMeta = null;
        if (this.data.settings.stopMode === 'staggered') {
            const validLevels = this.data.staggeredStops.filter(s => s.price > 0 && s.pct > 0).map(s => ({...s}));
            stopMeta = { mode: 'staggered', levels: validLevels };
        } else {
            stopMeta = { mode: 'single', price: parseFloat(document.getElementById('stopLoss').value) };
        }

        // NORMALIZE RISK VALUE: Always save as Equity %
        // If we are in Position mode, use the calculated implied risk %
        let finalRiskVal = this.data.settings.riskValue;
        let finalRiskMode = this.data.settings.riskMode;
        
        if (this.data.settings.riskMode === 'position' && impliedRiskPct) {
            finalRiskVal = parseFloat(impliedRiskPct.toFixed(2));
            finalRiskMode = 'equity'; // Normalize log to equity mode
        }

        // Check if Updating
        if (this.data.isEditingParams && this.data.editingId) {
            const existingIndex = this.data.logs.findIndex(l => l.id === this.data.editingId);
            if (existingIndex !== -1) {
                const oldLog = this.data.logs[existingIndex];
                
                // Update fields but preserve critical history
                const updatedLog = {
                    ...oldLog,
                    ticker: document.getElementById('ticker').value.toUpperCase(),
                    direction: this.data.settings.direction,
                    entry: entry,
                    stop: stop,
                    stopMeta: stopMeta,
                    initialQty: shares, // Updated Share Count
                    riskMode: finalRiskMode, // Normalized
                    riskVal: finalRiskVal,   // Normalized
                    strategy: document.getElementById('strategy').value,
                    notes: document.getElementById('notes').value,
                    exchangeRate: rate,
                    derisk13: derisk13Price,
                    derisk14: derisk14Price,
                    // Preserves: id, date, exits, outcome (mostly)
                    entryImg: this.data.tempCalculation.entryImgId // PATCH 6
                };
                
                this.data.logs[existingIndex] = updatedLog;
                this.data.isEditingParams = false;
                this.data.editingId = null;
                alert("Trade Updated");
                
                document.getElementById('mainActionBtn').textContent = "Calculate";
                document.getElementById('mainActionBtn').classList.remove('bg-amber-600');
                document.getElementById('mainActionBtn').classList.add('bg-blue-600');
            }
        } else {
            // New Entry
            const logEntry = {
                id: Date.now(),
                date: new Date().toISOString(), 
                ticker: document.getElementById('ticker').value.toUpperCase(),
                direction: this.data.settings.direction,
                entry: entry,
                stop: stop,
                stopMeta: stopMeta, 
                initialQty: shares, 
                riskMode: finalRiskMode, // Normalized
                riskVal: finalRiskVal,   // Normalized
                strategy: document.getElementById('strategy').value,
                notes: document.getElementById('notes').value,
                outcome: 'open',
                exits: [], 
                exchangeRate: rate,
                derisk13: derisk13Price,
                derisk14: derisk14Price,
                entryImg: this.data.tempCalculation.entryImgId // PATCH 6
            };
            this.data.logs.unshift(logEntry);
            
            // Toast
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-emerald-500 text-white px-4 py-2 rounded shadow-lg z-50 animate-bounce';
            toast.textContent = "Trade Logged to Master!";
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
        this.updateStrategyFilter(); 
        this.updateHeatWidget(); // Update Heat
        // Refresh smart insights if needed
        this.generateInsights(this.data.logs);
        
        document.getElementById('calculationResults').classList.add('hidden');
        // We no longer clear Ticker and Price here immediately if user wants to tweak, 
        // but usually "Logged" implies done. Let's clear to keep UI fresh.
        // The Clear Inputs button is now available if they want to clear without logging.
        // But standard flow is Log -> Clear. 
        // Let's clear fields for next trade.
        document.getElementById('ticker').value = '';
        document.getElementById('purchasePrice').value = '';
    },
    
    editTradeParams() {
        const log = this.data.logs.find(l => l.id === this.data.editingId);
        if(!log) return;
        
        // 1. Populate Calculator Inputs
        document.getElementById('ticker').value = log.ticker;
        document.getElementById('purchasePrice').value = log.entry;
        
        // Set Direction
        this.setDirection(log.direction || 'LONG');
        
        // Set Stop
        if (log.stopMeta && log.stopMeta.mode === 'staggered') {
            this.setStopMode('staggered');
            // Populate staggered inputs
            log.stopMeta.levels.forEach((lvl, i) => {
                if (i < 2) { // Assuming 2 default slots, could expand
                    this.data.staggeredStops[i].price = lvl.price;
                    this.data.staggeredStops[i].pct = lvl.pct;
                }
            });
            this.renderStaggeredInputs();
        } else {
            this.setStopMode('single');
            document.getElementById('stopLoss').value = log.stop;
        }
        
        // Set Strategy & Notes
        document.getElementById('strategy').value = log.strategy;
        document.getElementById('notes').value = log.notes;
        
        // Set Risk Params
        if (log.riskMode === 'equity') {
            document.querySelector(`input[name="riskMode"][value="equity"]`).checked = true;
        } else {
            document.querySelector(`input[name="riskMode"][value="position"]`).checked = true;
        }
        this.toggleRiskMode(); // Update slider ranges
        const slider = document.getElementById('riskSlider');
        slider.value = log.riskVal;
        slider.dispatchEvent(new Event('input')); // Update label
        
        // 2. Set State
        this.data.isEditingParams = true;
        
        // 3. UI Changes
        const btn = document.getElementById('mainActionBtn');
        btn.textContent = "Update Calculation";
        btn.classList.remove('bg-blue-600');
        btn.classList.add('bg-amber-600');
        
        // 4. Switch View
        this.switchView('calculator');
        window.scrollTo(0,0);
    },

    // --- LOGS & MANAGEMENT ---
    
		renderLogs(limit = 50) {
        const container = document.getElementById('logsContainer');
        const searchVal = document.getElementById('logSearch').value.toUpperCase();
        
        // 1. Sort & Filter (Search scans EVERYTHING)
        // We sort by date descending so the "Top 50" are always the newest
        const allMatches = this.data.logs
            .sort((a,b) => new Date(b.date) - new Date(a.date)) 
            .filter(l => l.ticker.includes(searchVal) || (l.strategy && l.strategy.toUpperCase().includes(searchVal)));

        // 2. Apply the Limit (Slice the array)
        const visibleLogs = allMatches.slice(0, limit);
        
        // 3. Render the Visible Slice
        const htmlRows = visibleLogs.map(log => {
            let totalSold = log.exits ? log.exits.reduce((acc, ex) => acc + ex.qty, 0) : 0;
            let isOpen = log.outcome === 'open';
            let realizedR = 0;
            const riskPerShare = Math.abs(log.entry - log.stop);
            
            // Time Formatting
            let dateDisplay = log.date.substring(5, 10); 
            if (log.date.includes('T')) {
                const d = new Date(log.date);
                dateDisplay = `${d.getDate()}/${d.getMonth()+1} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
            }

            // --- NER LOGIC ---
            let realizedPnL = 0;
            if (log.exits && log.exits.length > 0) {
                let totalRVal = 0;
                log.exits.forEach(ex => {
                    let rChunk;
                    if(log.direction === 'SHORT') {
                        rChunk = (log.entry - ex.price) / riskPerShare;
                        realizedPnL += (log.entry - ex.price) * ex.qty;
                    } else {
                        rChunk = (ex.price - log.entry) / riskPerShare;
                        realizedPnL += (ex.price - log.entry) * ex.qty;
                    }
                    totalRVal += (rChunk * ex.qty);
                });
                const totalRiskAmount = log.initialQty * riskPerShare;
                if (totalRiskAmount > 0) realizedR = realizedPnL / totalRiskAmount;
            } else if (!log.initialQty && log.exitPrice) {
                 const diff = log.direction === 'SHORT' ? (log.entry - log.exitPrice) : (log.exitPrice - log.entry);
                 realizedR = diff / riskPerShare;
                 isOpen = false;
            }

            let nerBadge = '';
            if (isOpen) {
                const remaining = (log.initialQty || 0) - totalSold;
                if (remaining > 0) {
                    let currentRiskDist = 0;
                    if(log.direction === 'LONG') currentRiskDist = Math.max(0, log.entry - log.stop);
                    else currentRiskDist = Math.max(0, log.stop - log.entry);
                    const grossRisk = remaining * currentRiskDist;
                    const netExposure = grossRisk - realizedPnL;
                    if (netExposure > 0) {
                        nerBadge = `<span class="bg-amber-900/40 text-amber-400 border border-amber-500/30 text-[9px] px-1.5 py-0.5 rounded font-bold ml-1 tracking-wider" title="Unfinanced Risk">NER</span>`;
                    }
                }
            }

            let rDisplay = '-';
            let rClass = 'text-slate-500';
            let statusBadge = `<span class="bg-blue-900/50 text-blue-400 text-[10px] px-2 py-1 rounded">OPEN</span>`;
            
            if (!isOpen || (log.exits && log.exits.length > 0)) {
                const rVal = realizedR.toFixed(2);
                if(rVal > 0) { rDisplay = `+${rVal}R`; rClass = 'text-emerald-400 font-bold'; } 
                else { rDisplay = `${rVal}R`; rClass = 'text-red-400 font-bold'; }
            }
            
            if(!isOpen) {
                statusBadge = realizedR > 0 
                   ? `<span class="bg-emerald-900/50 text-emerald-400 text-[10px] px-2 py-1 rounded">WIN</span>`
                   : `<span class="bg-red-900/50 text-red-400 text-[10px] px-2 py-1 rounded">LOSS</span>`;
            } else if (totalSold > 0) {
                 const pctClosed = Math.round((totalSold/log.initialQty)*100);
                 statusBadge = `<span class="bg-amber-900/50 text-amber-400 text-[10px] px-2 py-1 rounded">${pctClosed}% SOLD</span>`;
            }

            return `
            <div class="grid grid-cols-12 gap-2 p-3 bg-slate-800/50 border-b border-slate-700 items-center hover:bg-slate-800 transition-colors">
                <div class="col-span-2 text-xs text-slate-400 font-mono leading-tight">${dateDisplay}</div>
                <div class="col-span-2 font-bold text-white relative">
                    ${log.ticker} 
                    <span class="text-[8px] text-slate-500 block">${log.direction}</span>
                </div>
                <div class="col-span-2 text-right text-xs font-mono">${log.riskVal}${log.riskMode === 'equity' ? '%' : 'sz'}</div>
                <div class="col-span-2 text-right text-sm font-mono ${rClass}">${rDisplay}</div>
                <div class="col-span-4 flex justify-end gap-2 items-center">
                    ${nerBadge}
                    ${statusBadge}
                    <button onclick="app.openManageView(${log.id})" class="text-slate-400 hover:text-blue-400 bg-slate-700/50 p-1.5 rounded-full"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                </div>
            </div>
            `;
        }).join('');

        // 4. Handle "Load More" Button
        let loadMoreHtml = '';
        if (allMatches.length > limit) {
            const remaining = allMatches.length - limit;
            loadMoreHtml = `
            <div class="p-2 text-center">
                <button onclick="app.renderLogs(${limit + 50})" class="text-xs font-bold text-blue-400 hover:text-white border border-slate-700 bg-slate-800 rounded-full px-4 py-2 transition-all">
                    Show Older Trades (${remaining} more)
                </button>
            </div>`;
        } else if (allMatches.length === 0) {
            loadMoreHtml = `<div class="p-8 text-center text-slate-500 text-sm">No trades found.</div>`;
        }

        container.innerHTML = htmlRows + loadMoreHtml;
        lucide.createIcons();
    },


    async openManageView(id) {
        this.data.editingId = id;
        const log = this.data.logs.find(l => l.id === id);
        if(!log) return;

        const totalSold = log.exits.reduce((a,b) => a+b.qty, 0);
        const remaining = log.initialQty - totalSold;
        
        document.getElementById('exitInputQty').value = remaining > 0 ? remaining : '';
        document.getElementById('exitInputPrice').value = '';

        // --- PATCH 7: FETCH & DISPLAY CHARTS ---
        const entryImgUrl = log.entryImg ? await imgDB.get(log.entryImg) : null;
        const exitImgUrl = log.exitImg ? await imgDB.get(log.exitImg) : null;

		// --- PATCH: DE-RISK CALCULATION LOGIC ---
        const riskPerShare = Math.abs(log.entry - log.stop);
        const dirMult = log.direction === 'LONG' ? 1 : -1;
        const totalShares = log.initialQty;

        // 1. Sell 1/3 to Breakeven on remaining 2/3
        // We sell 1 part, hold 2 parts. Profit on 1 must equal Loss on 2.
        // Target = Entry + (2 * Risk)
        const q3 = Math.floor(totalShares / 3); // Sell 1/3
        const p3 = (log.entry + (riskPerShare * 2.0 * dirMult)).toFixed(2); 

        // 2. Sell 1/4 to Breakeven on remaining 3/4
        // We sell 1 part, hold 3 parts. Profit on 1 must equal Loss on 3.
        // Target = Entry + (3 * Risk)
        const q4 = Math.floor(totalShares / 4); // Sell 1/4
        const p4 = (log.entry + (riskPerShare * 3.0 * dirMult)).toFixed(2);

        // 3. Sell 1/5 to Breakeven on remaining 4/5
        // We sell 1 part, hold 4 parts. Profit on 1 must equal Loss on 4.
        // Target = Entry + (4 * Risk)
        const q5 = Math.floor(totalShares / 5); // Sell 1/5
        const p5 = (log.entry + (riskPerShare * 4.0 * dirMult)).toFixed(2);

        const chartHtml = `
        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="bg-slate-900 p-2 rounded-xl border border-slate-700 text-center relative">
                <div class="text-[10px] text-slate-500 mb-2 font-bold uppercase">Entry Chart</div>
                ${entryImgUrl ? `<img src="${entryImgUrl}" class="rounded h-24 w-full object-cover cursor-pointer border border-slate-600" onclick="app.showImg('${entryImgUrl}')">` : `<div class="h-24 flex items-center justify-center text-xs italic text-slate-600 border border-dashed border-slate-700 rounded">No Image</div>`}
            </div>
            <div class="bg-slate-900 p-2 rounded-xl border border-slate-700 text-center relative">
                <div class="text-[10px] text-slate-500 mb-2 font-bold uppercase">Closure Chart</div>
                ${exitImgUrl ? `<img src="${exitImgUrl}" class="rounded h-24 w-full object-cover cursor-pointer border border-slate-600" onclick="app.showImg('${exitImgUrl}')">` : `<div class="paste-zone h-24 min-h-0 border-slate-600" contenteditable="true" onpaste="app.handlePaste(event, 'exit', ${log.id})"><span class="text-[10px]">Paste Exit<br>Chart</span></div>`}
            </div>
        </div>
        
                
        <div class="card bg-slate-800/50 mb-4">
            <div class="flex justify-between items-center cursor-pointer" onclick="document.getElementById('targetList').classList.toggle('hidden')">
                <h3 class="text-xs font-bold text-slate-400 uppercase">De-Risk Targets (Breakeven)</h3>
                <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500"></i>
            </div>
            <div id="targetList" class="mt-2 space-y-2 hidden text-xs pt-2 border-t border-slate-700">
                <div class="flex justify-between items-center">
                    <span class="text-slate-400">Sell 1/3 (${q3} shares) @</span>
                    <span class="font-mono text-emerald-400 font-bold">${p3} (2.0R)</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-slate-400">Sell 1/4 (${q4} shares) @</span>
                    <span class="font-mono text-emerald-400 font-bold">${p4} (3.0R)</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-slate-400">Sell 1/5 (${q5} shares) @</span>
                    <span class="font-mono text-emerald-400 font-bold">${p5} (4.0R)</span>
                </div>
                <div class="mt-2 text-[9px] text-slate-500 italic text-center">
                    *Selling these amounts at these levels makes the remaining position Risk Free.
                </div>
            </div>
        </div>`;

		


        // Stop Display
        let stopHtml = '';
        if (log.stopMeta && log.stopMeta.mode === 'staggered') {
             const rows = log.stopMeta.levels.map((lvl, i) => `
                <div class="flex justify-between text-xs border-b border-slate-700/50 py-1 last:border-0">
                    <span class="text-slate-400">Stop #${i+1} (${lvl.pct}%)</span>
                    <span class="text-white font-mono">${lvl.price}</span>
                </div>`).join('');
             stopHtml = `
                <div class="mt-3 bg-slate-900/50 p-2 rounded-lg">
                    <div class="text-[10px] text-slate-500 uppercase mb-1 font-bold">Staggered Stops</div>
                    ${rows}
                    <div class="flex justify-between text-xs pt-2 mt-1 border-t border-slate-700">
                        <span class="text-slate-400">Avg Stop</span>
                        <span class="text-white font-mono">${log.stop.toFixed(2)}</span>
                    </div>
                </div>`;
        } else {
             stopHtml = `
                <div class="mt-3 bg-slate-900/50 p-2 rounded-lg flex justify-between items-center">
                    <div class="text-[10px] text-slate-500 uppercase font-bold">Stop Loss</div>
                    <div class="text-white font-mono text-lg">${log.stop}</div>
                </div>`;
        }
        
        // Date Value for input (YYYY-MM-DDTHH:MM)
        const dateVal = log.date.substring(0, 16);

        document.getElementById('manageSummary').innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h1 class="text-2xl font-bold text-white">${log.ticker}</h1>
                    <span class="text-xs text-slate-400 ${log.direction==='LONG'?'text-emerald-400':'text-red-400'} border border-current px-1 rounded">${log.direction}</span>
                </div>
                <div class="text-right">
                    <div class="text-xs text-slate-500">ENTRY</div>
                    <div class="text-lg font-mono">${log.entry}</div>
                </div>
            </div>
            
            <div class="bg-slate-900/50 p-2 rounded-lg mb-3 flex justify-between items-center border border-slate-700/50">
                 <label class="text-[10px] text-slate-500 font-bold uppercase">Entry Date</label>
                 <input type="datetime-local" value="${dateVal}" 
                    onchange="app.updateLogDate(${id}, this.value)"
                    class="bg-transparent text-white text-sm font-mono focus:outline-none text-right">
            </div>

            <div class="grid grid-cols-3 gap-2 text-center bg-slate-900/50 p-2 rounded-lg mb-3">
                <div>
                    <div class="text-[10px] text-slate-500">MASTER QTY</div>
                    <div class="font-bold text-white">${log.initialQty || '-'}</div>
                </div>
                <div>
                    <div class="text-[10px] text-slate-500">SOLD</div>
                    <div class="font-bold text-amber-400">${totalSold}</div>
                </div>
                <div>
                    <div class="text-[10px] text-slate-500">REMAINING</div>
                    <div class="font-bold text-blue-400">${remaining}</div>
                </div>
            </div>
            ${chartHtml}
            ${stopHtml}
        `;

        this.renderExitHistory(log);
        document.getElementById('view-manage').classList.remove('hidden');
        lucide.createIcons();
    },

    updateLogDate(id, dateStr) {
        const log = this.data.logs.find(l => l.id === id);
        if(log) {
            log.date = new Date(dateStr).toISOString();
            localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
            this.renderLogs(); 
        }
    },

    renderExitHistory(log) {
        const list = document.getElementById('exitHistoryList');
        if(!log.exits || log.exits.length === 0) {
            list.innerHTML = `<div class="text-center text-xs text-slate-500 py-4">No exits recorded yet.</div>`;
            return;
        }

        list.innerHTML = log.exits.map((ex, idx) => {
            const riskPerShare = Math.abs(log.entry - log.stop);
            const pnlPerShare = log.direction === 'SHORT' ? (log.entry - ex.price) : (ex.price - log.entry);
            const rVal = (pnlPerShare / riskPerShare).toFixed(2);
            
            return `
            <div class="flex justify-between items-center bg-slate-900 p-2 rounded border border-slate-700 text-sm">
                <div>
                    <span class="text-slate-400 text-xs block">Exit #${idx+1}</span>
                    <span class="font-bold text-white">${ex.qty} shares @ ${ex.price}</span>
                </div>
                <div class="text-right">
                    <span class="${rVal > 0 ? 'text-emerald-400' : 'text-red-400'} font-bold">${rVal > 0 ? '+' : ''}${rVal}R</span>
                    <button onclick="app.removeExit(${idx})" class="text-xs text-red-500 underline ml-2">Undo</button>
                </div>
            </div>`;
        }).join('');
    },

    addExit() {
        const log = this.data.logs.find(l => l.id === this.data.editingId);
        if(!log) return;

        const price = parseFloat(document.getElementById('exitInputPrice').value);
        const qty = parseInt(document.getElementById('exitInputQty').value);

        if(!price || !qty) return alert("Enter Price and Quantity");

        const totalSold = log.exits.reduce((a,b) => a+b.qty, 0);
        if(totalSold + qty > log.initialQty) {
            return alert(`Cannot sell ${qty}. Only ${log.initialQty - totalSold} remaining.`);
        }

        log.exits.push({
            price, qty, date: new Date().toISOString()
        });

        const newTotalSold = totalSold + qty;
        if(newTotalSold >= log.initialQty) {
            log.outcome = 'profit'; 
        }

        localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
        this.openManageView(this.data.editingId); 
        this.renderLogs(); 
        this.updateHeatWidget();
    },

    removeExit(idx) {
        const log = this.data.logs.find(l => l.id === this.data.editingId);
        if(log) {
            log.exits.splice(idx, 1);
            if(log.exits.reduce((a,b)=>a+b.qty,0) < log.initialQty) {
                log.outcome = 'open';
            }
            localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
            this.openManageView(this.data.editingId);
            this.updateHeatWidget();
        }
    },

    deleteLog(id) {
        if(!confirm("Delete this entire trade record?")) return;
        this.data.logs = this.data.logs.filter(l => l.id !== id);
        localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
        this.renderLogs();
        this.updateHeatWidget();
    },

    // --- STATS LOGIC ---
    updateStrategyFilter() {
        const strategies = new Set(this.data.logs.map(l => l.strategy).filter(s => s));
        const sel = document.getElementById('statsFilter');
        sel.innerHTML = '<option value="ALL">All Strategies</option>' + 
            Array.from(strategies).map(s => `<option value="${s}">${s}</option>`).join('');
    },

	calculateBatchStats(logs) {
        let winCount = 0, lossCount = 0, totalWinR = 0, totalLossR = 0, totalR = 0;
        
        // Only consider CLOSED trades for stats
        const closed = logs.filter(l => {
            const totalSold = l.exits ? l.exits.reduce((a,b)=>a+b.qty,0) : 0;
            // A trade is "Statistically Closed" if it is outcome!=open OR fully sold
            return l.outcome !== 'open' || (l.initialQty > 0 && totalSold >= l.initialQty);
        });

        closed.forEach(l => {
            let rTrade = 0;
            const riskPerShare = Math.abs(l.entry - l.stop);
            
            // Calculate R
            if(l.exits && l.exits.length > 0) {
                 const totalRisk = l.initialQty * riskPerShare;
                 let realizedPnL = 0;
                 l.exits.forEach(ex => realizedPnL += (l.direction === 'SHORT' ? (l.entry - ex.price) : (ex.price - l.entry)) * ex.qty);
                 if(totalRisk > 0) rTrade = realizedPnL / totalRisk;
            } else if (l.exitPrice) {
                 rTrade = (l.direction==='SHORT' ? (l.entry - l.exitPrice) : (l.exitPrice - l.entry)) / riskPerShare;
            }
            
            totalR += rTrade;
            if(rTrade > 0) { winCount++; totalWinR += rTrade; } 
            else { lossCount++; totalLossR += Math.abs(rTrade); }
        });

        const count = closed.length;
        const winRate = count > 0 ? (winCount / count) * 100 : 0;
        const avgWin = winCount > 0 ? totalWinR / winCount : 0;
        const avgLoss = lossCount > 0 ? totalLossR / lossCount : 0;
        const profitFactor = totalLossR === 0 ? (totalWinR > 0 ? 999 : 0) : (totalWinR / totalLossR);
        const expectancy = (winRate/100 * avgWin) - ((1-(winRate/100)) * avgLoss);

        return { winRate, profitFactor, expectancy, count, logs: closed };
    },

    renderStats() {
        const strategyFilter = document.getElementById('statsFilter').value;
        const recencyFilter = document.getElementById('statsRecency').value;
        
        // 1. Get Base Logs (Strategy Filtered)
        let baseLogs = [...this.data.logs];
        if(strategyFilter !== 'ALL') {
            baseLogs = baseLogs.filter(l => l.strategy === strategyFilter);
        }

        // 2. Calculate BASELINE Stats (All Time for this strategy)
        const baseline = this.calculateBatchStats(baseLogs);

        // 3. Apply Recency Filter (Targeting CLOSED trades)
        // FIX: We must filter for closed trades BEFORE slicing to ensure we get a full sample.
        let closedLogs = baseLogs.filter(l => {
             const totalSold = l.exits ? l.exits.reduce((a,b)=>a+b.qty,0) : 0;
             return l.outcome !== 'open' || (l.initialQty > 0 && totalSold >= l.initialQty);
        });

        // Sort Newest First
        closedLogs.sort((a,b) => new Date(b.date) - new Date(a.date));
        
        let recentStatsLogs = closedLogs;
        if (recencyFilter !== 'ALL') {
            const limit = parseInt(recencyFilter);
            recentStatsLogs = closedLogs.slice(0, limit);
        }
        
        // 4. Calculate CURRENT Stats
        const current = this.calculateBatchStats(recentStatsLogs);

        // 5. Render Cards (Diff Logic)
        const setDiff = (elId, curr, base, type) => {
            const el = document.getElementById(elId);
            // Safety check: if no baseline count, or no current count, hide diff
            if(recencyFilter === 'ALL' || base.count === 0 || curr.count === 0) { el.innerHTML = ''; return; }
            
            const diff = curr - base;
            let color = '', icon = '', text = '';
            
            if(Math.abs(diff) < 0.01) { el.innerHTML = '<span class="text-slate-500">= No Change</span>'; return; }
            
            const isBetter = diff > 0;
            color = isBetter ? 'text-emerald-400' : 'text-red-400';
            icon = isBetter ? '' : '';
            
            if (type === '%') text = `${icon} ${Math.abs(diff).toFixed(1)}%`;
            else if (type === 'R') text = `${icon} ${Math.abs(diff).toFixed(2)}R`;
            else text = `${icon} ${Math.abs(diff).toFixed(2)}`;

            el.innerHTML = `<span class="${color} bg-slate-900/50 px-1 rounded">${text} vs Avg</span>`;
        };

        document.getElementById('statWinRate').textContent = `${Math.round(current.winRate)}%`;
        setDiff('statWinRateDiff', current.winRate, baseline.winRate, '%');

        document.getElementById('statPF').textContent = current.profitFactor >= 999 ? "" : current.profitFactor.toFixed(2);
        setDiff('statPFDiff', current.profitFactor, baseline.profitFactor, 'x');

        document.getElementById('statExpectancy').textContent = `${current.expectancy > 0 ? '+' : ''}${current.expectancy.toFixed(2)}R`;
        setDiff('statExpectancyDiff', current.expectancy, baseline.expectancy, 'R');

        document.getElementById('statTotal').textContent = current.count;

        // 6. Draw Charts
        // We pass the filtered "recentStatsLogs" to charts so they match the stat cards
		// --- PATCH START: DIRECTIONAL SPLIT ---
        // Filter the ALREADY filtered 'recentStatsLogs' (which respects recency & closed status)
        const longLogs = recentStatsLogs.filter(l => l.direction === 'LONG');
        const shortLogs = recentStatsLogs.filter(l => l.direction === 'SHORT');

        const longStats = this.calculateBatchStats(longLogs);
        const shortStats = this.calculateBatchStats(shortLogs);

        const renderDirCard = (title, stats, colorClass) => {
            // Handle empty data
            if (stats.count === 0) {
                return `
                <div class="bg-slate-800 p-3 rounded-lg border border-slate-700 opacity-50">
                    <div class="text-[10px] text-slate-500 font-bold uppercase mb-1">${title}</div>
                    <div class="text-xs text-slate-500 italic">No closed trades</div>
                </div>`;
            }

            return `
            <div class="bg-slate-800 p-3 rounded-lg border border-slate-700 flex flex-col justify-between">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-[10px] ${colorClass} font-bold uppercase px-1.5 py-0.5 bg-${colorClass.split('-')[1]}-900/30 rounded">${title}</span>
                    <span class="text-[10px] text-slate-500">${stats.count} Trades</span>
                </div>
                <div class="grid grid-cols-3 gap-1 text-center">
                    <div>
                        <div class="text-[9px] text-slate-500 uppercase">Win Rate</div>
                        <div class="text-sm font-bold text-slate-200">${Math.round(stats.winRate)}%</div>
                    </div>
                    <div>
                        <div class="text-[9px] text-slate-500 uppercase">PF</div>
                        <div class="text-sm font-bold ${stats.profitFactor >= 1.5 ? 'text-blue-400' : 'text-slate-400'}">${stats.profitFactor >= 999 ? '' : stats.profitFactor.toFixed(2)}</div>
                    </div>
                    <div>
                        <div class="text-[9px] text-slate-500 uppercase">Exp</div>
                        <div class="text-sm font-bold ${stats.expectancy > 0 ? 'text-emerald-400' : 'text-red-400'}">${stats.expectancy.toFixed(2)}R</div>
                    </div>
                </div>
            </div>`;
        };

        const dirContainer = document.getElementById('directionStats');
        if (dirContainer) {
            dirContainer.innerHTML = 
                renderDirCard('Longs', longStats, 'text-emerald-400') + 
                renderDirCard('Shorts', shortStats, 'text-red-400');
        }
        this.drawGrowthChart(recentStatsLogs);
        this.drawWinLossChart(recentStatsLogs);
        this.drawDrawdownChart(recentStatsLogs);
        this.drawStrategyChart(recentStatsLogs);
        this.drawDayOfWeekChart(recentStatsLogs);
        this.drawContributionChart(recentStatsLogs);
        this.drawMonthlyChart(recentStatsLogs); 
        this.drawDurationChart(recentStatsLogs);
        this.drawDistributionChart(recentStatsLogs);
        
        // Generate Insights
        this.generateInsights(recentStatsLogs);

        lucide.createIcons();
    },

    drawDurationChart(logs) {
        const ctx = document.getElementById('chartDuration');
        if(!ctx) return; // Prevents crash if HTML is missing
        if(this.charts.duration) this.charts.duration.destroy();

        const dataPoints = [];
        const pointColors = [];
        const labels = []; 

        logs.forEach(l => {
            // Must have exits to calculate duration
            if (!l.exits || l.exits.length === 0) return;
            
            // Calculate R
            let netR = 0;
            const riskPerShare = Math.abs(l.entry - l.stop);
            const totalRisk = l.initialQty * riskPerShare;
            let pnl = 0;
            
            // Find last exit time
            const sortedExits = [...l.exits].sort((a,b) => new Date(a.date) - new Date(b.date));
            const lastExit = sortedExits[sortedExits.length - 1];
            
            l.exits.forEach(ex => {
                 pnl += (l.direction === 'SHORT' ? (l.entry - ex.price) : (ex.price - l.entry)) * ex.qty;
            });
            
            if(totalRisk > 0) netR = pnl / totalRisk;
            
            // Calculate Duration
            const entryTime = new Date(l.date).getTime();
            if(!lastExit.date) return;
            const exitTime = new Date(lastExit.date).getTime();
            const durationMins = (exitTime - entryTime) / 1000 / 60; 

            if(durationMins > 0) {
                dataPoints.push({ x: durationMins, y: netR });
                pointColors.push(netR >= 0 ? 'rgba(52, 211, 153, 0.7)' : 'rgba(248, 113, 113, 0.7)');
                labels.push(`${l.ticker} (${l.strategy || 'N/A'})`);
            }
        });

        this.charts.duration = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Trade',
                    data: dataPoints,
                    backgroundColor: pointColors,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const idx = context.dataIndex;
                                const r = context.raw.y.toFixed(2);
                                const min = Math.round(context.raw.x);
                                return `${labels[idx]}: ${r}R in ${min}m`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        title: { display: true, text: 'Mins', color: '#64748b' },
                        grid: { color: '#334155' },
                        ticks: { color: '#94a3b8' }
                    },
                    y: {
                        title: { display: true, text: 'R', color: '#64748b' },
                        grid: { color: '#334155' },
                        ticks: { color: '#94a3b8' }
                    }
                }
            }
        });
    },
    
	drawDistributionChart(logs) {
        const ctx = document.getElementById('chartDistribution');
        if(!ctx) return;
        if(this.charts.distribution) this.charts.distribution.destroy();

        // 7 Bins: 
        // 0: Disaster (<-1.2)
        // 1: Full Stop (-1.2 to -0.8)
        // 2: Small Loss (-0.8 to -0.2) 
        // 3: Scratch/BE (-0.2 to 0.2)
        // 4: Base Hit (0.2 to 1.3)
        // 5: Target Hit (1.3 to 2.3)
        // 6: Home Run (> 2.3)
        const bins = [0, 0, 0, 0, 0, 0, 0];
        const labels = ['<-1R', '-1R', 'Small Loss', 'Scratch', '1R', '2R', '3R+'];
        
        logs.forEach(l => {
             // Calculate R
             let r = 0;
             const riskPerShare = Math.abs(l.entry - l.stop);
             
             if(l.exits && l.exits.length > 0) {
                 const totalRisk = l.initialQty * riskPerShare;
                 let pnl = 0;
                 l.exits.forEach(ex => pnl += (l.direction==='SHORT'?l.entry-ex.price : ex.price-l.entry)*ex.qty);
                 if(totalRisk > 0) r = pnl/totalRisk;
             } else if (l.exitPrice) {
                 r = (l.direction==='SHORT'?l.entry-l.exitPrice : l.exitPrice-l.entry)/riskPerShare;
             } else {
                 return; // Skip open trades
             }

             // Sort into Bins
             if (r < -1.2) bins[0]++;
             else if (r >= -1.2 && r < -0.8) bins[1]++;
             else if (r >= -0.8 && r < -0.2) bins[2]++;
             else if (r >= -0.2 && r <= 0.2) bins[3]++;
             else if (r > 0.2 && r < 1.3) bins[4]++;
             else if (r >= 1.3 && r < 2.3) bins[5]++;
             else if (r >= 2.3) bins[6]++;
        });

        // Color coding: Red for bad losses, Gray for scratch, Green for wins
        const colors = [
            '#7f1d1d', // Deep Red (Disaster)
            '#ef4444', // Red (Full Stop)
            '#fca5a5', // Pale Red (Small Loss)
            '#94a3b8', // Gray (BE)
            '#34d399', // Green (1R)
            '#10b981', // Emerald (2R)
            '#059669'  // Dark Green (3R+)
        ];

        this.charts.distribution = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Trades',
                    data: bins,
                    backgroundColor: colors,
                    borderRadius: 4,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.raw} Trades`
                        }
                    }
                },
                scales: { 
                    y: { 
                        grid: { color: '#334155' },
                        ticks: { stepSize: 1, color: '#94a3b8' },
                        title: { display: true, text: 'Count', color: '#64748b' }
                    }, 
                    x: { 
                        grid: { display: false },
                        ticks: { color: '#94a3b8', font: { size: 11, weight: 'bold' } } 
                    } 
                }
            }
        });
    },
	
	
    // --- SMART INSIGHTS ENGINE V2 (PATCH) ---
    generateInsights(logs) {
        const insights = [];
        const filter = document.getElementById('statsFilter').value;
        
        // 1. Filter for Closed Trades Only
        const closed = logs.filter(l => {
             const totalSold = l.exits ? l.exits.reduce((a,b)=>a+b.qty,0) : 0;
             return l.outcome !== 'open' || (l.initialQty > 0 && totalSold >= l.initialQty);
        });
        
        // 2. Create Context Subset (Are we looking at ALL or just ONE strategy?)
        const subset = filter === 'ALL' ? closed : closed.filter(l => l.strategy === filter);

        if(closed.length < 3) {
            document.getElementById('smartInsightsList').innerHTML = `<div class="text-center italic opacity-50">Log at least 3 closed trades to unlock AI insights.</div>`;
            return;
        }

        // HELPER: HTML Generator
        const createCard = (color, title, text) => {
            const colors = {
                emerald: 'border-emerald-500 text-emerald-400',
                amber: 'border-amber-500 text-amber-400',
                blue: 'border-blue-500 text-blue-400',
                purple: 'border-purple-500 text-purple-400'
            };
            return `<div class="insight-card border-l-2 pl-3 py-2 bg-slate-900/50 rounded-r mb-2 ${colors[color]}">
                <strong class="block text-[10px] uppercase opacity-80 mb-0.5">${title}</strong>
                <span class="block leading-snug">${text}</span>
            </div>`;
        };

        // INSIGHT A: Efficiency (Avg Win vs Avg Loss)
        let wins = [], losses = [];
        subset.forEach(l => {
            const risk = Math.abs(l.entry - l.stop);
            let r = 0;
            if(l.exits && l.exits.length > 0) {
                let pnl = 0;
                l.exits.forEach(e => pnl += (l.direction==='SHORT'?l.entry-e.price : e.price-l.entry)*e.qty);
                r = pnl / (l.initialQty * risk);
            } else if (l.exitPrice) {
                r = (l.direction==='SHORT'?l.entry-l.exitPrice : l.exitPrice-l.entry)/risk;
            }
            if(r > 0) wins.push(r); else losses.push(Math.abs(r));
        });

        const avgWin = wins.length ? wins.reduce((a,b)=>a+b,0)/wins.length : 0;
        const avgLoss = losses.length ? losses.reduce((a,b)=>a+b,0)/losses.length : 0;

        if(wins.length > 0 && losses.length > 0) {
            if(avgWin > avgLoss * 2) {
                insights.push(createCard('emerald', 'High Efficiency', `Your average winner (${avgWin.toFixed(2)}R) is <strong>2x larger</strong> than your average loser.`));
            } else if(avgLoss > avgWin) {
                insights.push(createCard('amber', 'Negative Skew', `Warning: Your average loss (${avgLoss.toFixed(2)}R) is bigger than your average win (${avgWin.toFixed(2)}R).`));
            }
        }

        // INSIGHT B: Strategy Context
        if(filter === 'ALL') {
            // Rank Strategies
            const sMap = {};
            closed.forEach(l => {
                if(!l.strategy) return;
                // Quick R Calc
                const risk = Math.abs(l.entry - l.stop);
                let r = 0;
                if(l.exits && l.exits.length) { let p=0; l.exits.forEach(e=>p+=(l.direction==='SHORT'?l.entry-e.price:e.price-l.entry)*e.qty); r=p/(l.initialQty*risk); }
                else if(l.exitPrice) r=(l.direction==='SHORT'?l.entry-l.exitPrice:l.exitPrice-l.entry)/risk;
                
                if(!sMap[l.strategy]) sMap[l.strategy] = 0;
                sMap[l.strategy] += r;
            });
            
            // Find Best
            let bestS = null, maxR = -Infinity;
            Object.keys(sMap).forEach(k => { if(sMap[k] > maxR) { maxR = sMap[k]; bestS = k; } });
            
            if(bestS) {
                insights.push(createCard('blue', 'MVP Strategy', `<strong>${bestS}</strong> is your top performer with <strong>${maxR.toFixed(1)}R</strong> total return.`));
            }
        } else {
            // Deep Dive: Compare Strategy vs Global Average
            const globalWinRate = (closed.filter(l => {
                 // Quick check win
                 const risk = Math.abs(l.entry - l.stop);
                 let r = 0;
                 if(l.exits && l.exits.length) { let p=0; l.exits.forEach(e=>p+=(l.direction==='SHORT'?l.entry-e.price:e.price-l.entry)*e.qty); r=p/(l.initialQty*risk); }
                 else if(l.exitPrice) r=(l.direction==='SHORT'?l.entry-l.exitPrice:l.exitPrice-l.entry)/risk;
                 return r > 0;
            }).length / closed.length) * 100;
            
            const stratWinRate = (wins.length / subset.length) * 100;
            const diff = stratWinRate - globalWinRate;
            
            if(diff > 5) {
                insights.push(createCard('blue', 'Outperformer', `<strong>${filter}</strong> wins ${Math.round(diff)}% more often than your average trade.`));
            } else if (diff < -5) {
                insights.push(createCard('blue', 'Underperformer', `<strong>${filter}</strong> has a lower win rate (${Math.round(stratWinRate)}%) than your average.`));
            }
        }

        // INSIGHT C: Seasonality (Best Month)
        const monthMap = {};
        subset.forEach(l => {
             const m = new Date(l.date).toLocaleString('default', {month:'long'});
             // Quick R Calc
             const risk = Math.abs(l.entry - l.stop);
             let r = 0;
             if(l.exits && l.exits.length) { let p=0; l.exits.forEach(e=>p+=(l.direction==='SHORT'?l.entry-e.price:e.price-l.entry)*e.qty); r=p/(l.initialQty*risk); }
             else if(l.exitPrice) r=(l.direction==='SHORT'?l.entry-l.exitPrice:l.exitPrice-l.entry)/risk;
             
             if(!monthMap[m]) monthMap[m] = 0;
             monthMap[m] += r;
        });
        
        let bestM = null, maxM = -Infinity;
        Object.keys(monthMap).forEach(k => { if(monthMap[k] > maxM) { maxM = monthMap[k]; bestM = k; } });
        
        if(bestM && maxM > 2) {
            insights.push(createCard('purple', 'Seasonality', `<strong>${bestM}</strong> is your strongest month (+${maxM.toFixed(1)}R).`));
        }

        // Render to DOM
        const container = document.getElementById('smartInsightsList');
        if(insights.length === 0) {
             container.innerHTML = `<div class="text-center text-slate-500 text-[10px]">No significant patterns found yet. Keep trading!</div>`;
        } else {
             container.innerHTML = insights.join('');
        }
    },

    drawGrowthChart(logs) {
        const ctx = document.getElementById('chartGrowth');
        if(this.charts.growth) this.charts.growth.destroy();

        const sorted = [...logs].sort((a,b) => new Date(a.date) - new Date(b.date));
        
        let accountGrowthPct = 0;
        const dataPoints = [];
        const labels = [];

        sorted.forEach(l => {
            let tradeR = 0;
            const riskPerShare = Math.abs(l.entry - l.stop);
            if(l.exits && l.exits.length > 0) {
                 const totalRisk = l.initialQty * riskPerShare;
                 let realizedPnL = 0;
                 l.exits.forEach(ex => realizedPnL += (l.direction === 'SHORT' ? (l.entry - ex.price) : (ex.price - l.entry)) * ex.qty);
                 if(totalRisk > 0) tradeR = realizedPnL / totalRisk;
            } else if (l.exitPrice) {
                 tradeR = (l.direction==='SHORT' ? (l.entry - l.exitPrice) : (l.exitPrice - l.entry)) / riskPerShare;
            }

            if(tradeR !== 0) {
                 const riskFactor = l.riskMode === 'equity' ? l.riskVal : 1.0; 
                 const pctGain = tradeR * riskFactor;
                 accountGrowthPct += pctGain;
                 labels.push(l.date.substring(5));
                 dataPoints.push(accountGrowthPct);
            }
        });

        this.charts.growth = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Growth %',
                    data: dataPoints,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.3,
                    fill: true,
                    pointRadius: 2
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { x: { display: false }, y: { grid: { color: '#334155' } } }
            }
        });
    },

    drawDrawdownChart(logs) {
        const ctx = document.getElementById('chartDrawdown');
        if(this.charts.drawdown) this.charts.drawdown.destroy();

        const sorted = [...logs].sort((a,b) => new Date(a.date) - new Date(b.date));
        
        let currentR = 0;
        let peakR = 0;
        const dataPoints = [];
        const labels = [];

        sorted.forEach(l => {
            let tradeR = 0;
            const riskPerShare = Math.abs(l.entry - l.stop);
            if(l.exits && l.exits.length > 0) {
                 const totalRisk = l.initialQty * riskPerShare;
                 let realizedPnL = 0;
                 l.exits.forEach(ex => realizedPnL += (l.direction === 'SHORT' ? (l.entry - ex.price) : (ex.price - l.entry)) * ex.qty);
                 if(totalRisk > 0) tradeR = realizedPnL / totalRisk;
            } else if (l.exitPrice) {
                 tradeR = (l.direction==='SHORT' ? (l.entry - l.exitPrice) : (l.exitPrice - l.entry)) / riskPerShare;
            }

            if(tradeR !== 0) {
                 currentR += tradeR;
                 if (currentR > peakR) peakR = currentR;
                 const drawdown = currentR - peakR; 
                 dataPoints.push(drawdown);
                 labels.push(l.date.substring(5));
            }
        });

        this.charts.drawdown = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Drawdown (R)',
                    data: dataPoints,
                    borderColor: '#f87171',
                    backgroundColor: 'rgba(248, 113, 113, 0.2)',
                    borderWidth: 1,
                    fill: true,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { x: { display: false }, y: { grid: { color: '#334155' } } }
            }
        });
    },

    drawStrategyChart(logs) {
        const ctx = document.getElementById('chartStrategy');
        if(this.charts.strategy) this.charts.strategy.destroy();

        const stratMap = {};
        
        logs.forEach(l => {
            if(!l.strategy) return;
            let tradeR = 0;
            const riskPerShare = Math.abs(l.entry - l.stop);
            if(l.exits && l.exits.length > 0) {
                 const totalRisk = l.initialQty * riskPerShare;
                 let realizedPnL = 0;
                 l.exits.forEach(ex => realizedPnL += (l.direction === 'SHORT' ? (l.entry - ex.price) : (ex.price - l.entry)) * ex.qty);
                 if(totalRisk > 0) tradeR = realizedPnL / totalRisk;
            } else if (l.exitPrice) {
                 tradeR = (l.direction==='SHORT' ? (l.entry - l.exitPrice) : (l.exitPrice - l.entry)) / riskPerShare;
            }
            
            if(!stratMap[l.strategy]) stratMap[l.strategy] = 0;
            stratMap[l.strategy] += tradeR;
        });

        const labels = Object.keys(stratMap);
        const data = Object.values(stratMap);
        const colors = data.map(v => v >= 0 ? 'rgba(52, 211, 153, 0.6)' : 'rgba(248, 113, 113, 0.6)');

        this.charts.strategy = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total R',
                    data: data,
                    backgroundColor: colors,
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y', 
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { x: { grid: { color: '#334155' } }, y: { grid: { display: false } } }
            }
        });
    },

    drawDayOfWeekChart(logs) {
        const ctx = document.getElementById('chartDayOfWeek');
        if(this.charts.dayOfWeek) this.charts.dayOfWeek.destroy();

        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const dayMap = new Array(7).fill(0);
        
        logs.forEach(l => {
            const date = new Date(l.date);
            const dayIdx = date.getDay();
            
            let tradeR = 0;
            const riskPerShare = Math.abs(l.entry - l.stop);
            if(l.exits && l.exits.length > 0) {
                 const totalRisk = l.initialQty * riskPerShare;
                 let realizedPnL = 0;
                 l.exits.forEach(ex => realizedPnL += (l.direction === 'SHORT' ? (l.entry - ex.price) : (ex.price - l.entry)) * ex.qty);
                 if(totalRisk > 0) tradeR = realizedPnL / totalRisk;
            } else if (l.exitPrice) {
                 tradeR = (l.direction==='SHORT' ? (l.entry - l.exitPrice) : (l.exitPrice - l.entry)) / riskPerShare;
            }
            
            dayMap[dayIdx] += tradeR;
        });

        this.charts.dayOfWeek = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: days,
                datasets: [{
                    label: 'Total R',
                    data: dayMap,
                    backgroundColor: '#60a5fa',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { grid: { color: '#334155' } }, x: { grid: { display: false } } }
            }
        });
    },

    drawContributionChart(logs) {
        const ctx = document.getElementById('chartContributions');
        if(this.charts.contribution) this.charts.contribution.destroy();

        // Sort by Date
        const sorted = [...logs].sort((a,b) => new Date(a.date) - new Date(b.date));
        
        // Limit to last 5 trades
        const recent = sorted.slice(-5);

        const labels = [];
        const data = [];
        const colors = [];

        recent.forEach(l => {
            // Calculate Net R
            let netR = 0;
            const riskPerShare = Math.abs(l.entry - l.stop);
            if(l.exits && l.exits.length > 0) {
                 const totalRisk = l.initialQty * riskPerShare;
                 let pnl = 0;
                 l.exits.forEach(ex => {
                     pnl += (l.direction === 'SHORT' ? (l.entry - ex.price) : (ex.price - l.entry)) * ex.qty;
                 });
                 if(totalRisk > 0) netR = pnl / totalRisk;
            } else if (l.exitPrice) {
                 netR = ((l.direction==='SHORT'?l.entry-l.exitPrice:l.exitPrice-l.entry)/riskPerShare);
            }

            // Calculate Growth % contribution
            const riskFactor = l.riskMode === 'equity' ? l.riskVal : 1.0; 
            const contribution = netR * riskFactor;

            labels.push(l.ticker);
            data.push(contribution);
            colors.push(contribution >= 0 ? '#34d399' : '#f87171');
        });

        this.charts.contribution = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Contribution %',
                    data: data,
                    backgroundColor: colors,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { 
                        grid: { display: false },
                        ticks: { color: '#94a3b8', font: { size: 10 } }
                    },
                    y: {
                        grid: { color: '#334155' },
                        ticks: { callback: (val) => val.toFixed(2) + '%' }
                    }
                }
            }
        });
    },

    drawMonthlyChart(logs) {
        const ctx = document.getElementById('chartMonthly');
        if(this.charts.monthly) this.charts.monthly.destroy();

        const monthMap = {};
        
        logs.forEach(l => {
            const date = new Date(l.date);
            // Format Key: "2024-11" for sorting
            const key = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`;
            
            // Calculate Performance % (Contribution)
            let netR = 0;
            const riskPerShare = Math.abs(l.entry - l.stop);
            
            if(l.exits && l.exits.length > 0) {
                 const totalRisk = l.initialQty * riskPerShare;
                 let pnl = 0;
                 l.exits.forEach(ex => {
                     pnl += (l.direction === 'SHORT' ? (l.entry - ex.price) : (ex.price - l.entry)) * ex.qty;
                 });
                 if(totalRisk > 0) netR = pnl / totalRisk;
            } else if (l.exitPrice) {
                 netR = ((l.direction==='SHORT'?l.entry-l.exitPrice:l.exitPrice-l.entry)/riskPerShare);
            }
            
            const riskFactor = l.riskMode === 'equity' ? l.riskVal : 1.0; 
            const gainPct = netR * riskFactor;

            if(!monthMap[key]) monthMap[key] = 0;
            monthMap[key] += gainPct;
        });

        // Sort Keys
        const sortedKeys = Object.keys(monthMap).sort();
        const data = sortedKeys.map(k => monthMap[k]);
        
        // Format Labels: "2024-11" -> "Nov 24"
        const labels = sortedKeys.map(k => {
            const [y, m] = k.split('-');
            const d = new Date(y, m-1);
            return d.toLocaleString('default', { month: 'short', year: '2-digit' });
        });

        const colors = data.map(v => v >= 0 ? '#34d399' : '#f87171');

        this.charts.monthly = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Monthly Return %',
                    data: data,
                    backgroundColor: colors,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { 
                    x: { grid: { display: false } }, 
                    y: { 
                        grid: { color: '#334155' },
                        ticks: { callback: (val) => val.toFixed(2) + '%' }
                    } 
                }
            }
        });
    },

    drawWinLossChart(logs) {
        const ctx = document.getElementById('chartWinLoss');
        if(this.charts.winLoss) this.charts.winLoss.destroy();
        
        let wins=0, losses=0, open=0;
        
        logs.forEach(l => {
             const totalSold = l.exits ? l.exits.reduce((a,b)=>a+b.qty,0) : 0;
             const isClosed = l.outcome !== 'open' || (l.initialQty > 0 && totalSold >= l.initialQty);
             
             if(!isClosed) {
                 open++;
             } else {
                 let netR = 0;
                 const riskPerShare = Math.abs(l.entry - l.stop);
                 if(l.exits && l.exits.length > 0) {
                     const totalRisk = l.initialQty * riskPerShare;
                     let pnl = 0;
                     l.exits.forEach(ex => pnl += (l.direction==='SHORT'?l.entry-ex.price : ex.price-l.entry)*ex.qty);
                     netR = pnl/totalRisk;
                 } else if (l.exitPrice) {
                     netR = (l.direction==='SHORT'?l.entry-l.exitPrice : l.exitPrice-l.entry)/riskPerShare;
                 }
                 
                 if(netR > 0) wins++; else losses++;
             }
        });

        this.charts.winLoss = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Win', 'Loss', 'Open'],
                datasets: [{
                    data: [wins, losses, open],
                    backgroundColor: ['#34d399', '#f87171', '#60a5fa'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'right', labels: { color: '#94a3b8', boxWidth: 10 } } }
            }
        });
    },

    // --- UTILS ---
    saveFormData() {
        const formState = {
            ticker: document.getElementById('ticker').value,
            price: document.getElementById('purchasePrice').value,
            stop: document.getElementById('stopLoss').value,
            // riskMode/val are saved via settings now
        };
        localStorage.setItem('sessionForm', JSON.stringify(formState));
    },

    restoreFormData() {
        const saved = localStorage.getItem('sessionForm');
        if(saved) {
            const data = JSON.parse(saved);
            document.getElementById('ticker').value = data.ticker || '';
            document.getElementById('purchasePrice').value = data.price || '';
            document.getElementById('stopLoss').value = data.stop || '';
        }
    },
    
    resetForm() {
        if(confirm("Reset all form inputs?")) {
            document.getElementById('ticker').value = '';
            document.getElementById('purchasePrice').value = '';
            document.getElementById('stopLoss').value = '';
            this.setDirection('LONG');
            this.data.editingId = null;
            this.data.isEditingParams = false; // Reset edit flag
            document.getElementById('calculationResults').classList.add('hidden');
            
            // Reset Button
            const btn = document.getElementById('mainActionBtn');
            btn.textContent = "Calculate";
            btn.classList.add('bg-blue-600');
            btn.classList.remove('bg-amber-600');
        }
    },
    
    exportLogs() {
        const csvContent = "data:text/csv;charset=utf-8," 
            + "Date,Ticker,Dir,Entry,Stop,InitialQty,Strategy,Status,NetR,ExitsSummary\n"
            + this.data.logs.map(e => {
                let netR = 0;
                let exitsSummary = '';
                const riskPerShare = Math.abs(e.entry - e.stop);
                
                if(e.exits && e.exits.length > 0) {
                     const totalRisk = e.initialQty * riskPerShare;
                     let pnl = 0;
                     e.exits.forEach(ex => {
                         pnl += (e.direction==='SHORT'?e.entry-ex.price:ex.price-e.entry)*ex.qty;
                         exitsSummary += `[${ex.qty}@${ex.price}] `;
                     });
                     if(totalRisk > 0) netR = (pnl/totalRisk).toFixed(2);
                } else if (e.exitPrice) {
                     netR = ((e.direction==='SHORT'?e.entry-e.exitPrice:e.exitPrice-e.entry)/riskPerShare).toFixed(2);
                }
                
                return `${e.date},${e.ticker},${e.direction},${e.entry},${e.stop},${e.initialQty || ''},${e.strategy},${e.outcome},${netR},${exitsSummary}`;
            }).join("\n");
            
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "trade_logs_v5.csv");
        document.body.appendChild(link);
        link.click();
    }
};

document.addEventListener('DOMContentLoaded', () => {
    app.init();
});

</script>
</body>
</html>



