<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Trade Risk Manager</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Tailwind CSS for rapid, clean styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    /* Custom Dark Theme Tweaks */
    body {
      background-color: #0f172a; /* Slate 900 */
      color: #e2e8f0;
      -webkit-tap-highlight-color: transparent;
    }
    
    /* Range Slider Styling */
    input[type=range] {
      -webkit-appearance: none; 
      background: transparent; 
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 24px;
      width: 24px;
      border-radius: 50%;
      background: #3b82f6;
      margin-top: -10px;
      box-shadow: 0 0 10px rgba(59,130,246,0.5);
    }
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%;
      height: 4px;
      background: #334155;
      border-radius: 2px;
    }

    /* Hide scrollbar for clean UI */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* Safe Area for iPhone */
    .safe-bottom {
      padding-bottom: env(safe-area-inset-bottom);
    }
  </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-slate-200">

  <!-- TOP HEADER -->
  <header class="bg-slate-900/90 backdrop-blur border-b border-slate-800 p-4 pt-12 flex justify-between items-center z-20">
    <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent">
      Trade Risk Manager
    </h1>
    <button onclick="app.resetForm()" class="text-xs bg-slate-800 hover:bg-slate-700 px-3 py-1 rounded text-slate-400 border border-slate-700">
      Reset
    </button>
  </header>

  <!-- MAIN CONTENT AREA -->
  <main class="flex-1 overflow-y-auto overflow-x-hidden no-scrollbar pb-24 relative" id="mainContainer">
    
    <!-- VIEW: CALCULATOR -->
    <div id="view-calculator" class="p-4 space-y-6 max-w-lg mx-auto transition-opacity duration-300">
      
      <!-- Accounts Section -->
      <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
        <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="app.toggleAccounts()">
          <h2 class="font-semibold text-slate-300">Accounts & Currency</h2>
          <i data-lucide="chevron-down" id="accToggleIcon" class="w-5 h-5 transition-transform"></i>
        </div>
        
        <div id="accountsGrid" class="hidden grid-cols-2 gap-3 mb-4">
          <!-- Generated by JS -->
        </div>

        <div class="flex gap-3">
          <div class="flex-1">
            <label class="text-xs text-slate-500 uppercase font-bold">Base Ccy</label>
            <select id="accountCurrency" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm mt-1 focus:ring-2 focus:ring-blue-500 outline-none">
              <option value="GBP">GBP (£)</option>
              <option value="USD">USD ($)</option>
              <option value="EUR">EUR (€)</option>
            </select>
          </div>
          <div class="flex-1">
            <label class="text-xs text-slate-500 uppercase font-bold">Trade Ccy</label>
            <select id="tradeCurrency" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm mt-1 focus:ring-2 focus:ring-blue-500 outline-none">
              <!-- Populated by JS -->
            </select>
          </div>
        </div>
      </div>

      <!-- Trade Details -->
      <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700 space-y-4">
        <div class="flex gap-3">
          <div class="w-1/3">
            <label class="text-xs text-slate-500 uppercase font-bold">Ticker</label>
            <input type="text" id="ticker" placeholder="AAPL" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-lg font-mono uppercase mt-1 focus:border-blue-500 outline-none" />
          </div>
          <div class="w-2/3">
            <label class="text-xs text-slate-500 uppercase font-bold">Entry Price</label>
            <input type="number" id="purchasePrice" placeholder="0.00" step="any" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-lg font-mono mt-1 focus:border-blue-500 outline-none" />
          </div>
        </div>

        <div>
          <label class="text-xs text-slate-500 uppercase font-bold mb-2 block">Stop Loss Strategy</label>
          <div class="flex bg-slate-900 rounded-lg p-1 mb-3">
            <button class="flex-1 py-1 text-sm rounded transition-colors bg-slate-700 text-white shadow" id="btn-stop-single" onclick="app.setStopMode('single')">Single</button>
            <button class="flex-1 py-1 text-sm rounded transition-colors text-slate-400 hover:text-white" id="btn-stop-staggered" onclick="app.setStopMode('staggered')">Staggered</button>
          </div>

          <div id="stop-single-container">
            <input type="number" id="stopLoss" placeholder="Stop Price" step="any" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-lg font-mono focus:border-red-500 outline-none" />
          </div>

          <div id="stop-staggered-container" class="hidden space-y-2">
            <!-- Staggered Inputs generated by JS -->
          </div>
        </div>
      </div>

      <!-- Risk Management -->
      <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
         <div class="flex justify-between items-center mb-2">
            <label class="text-xs text-slate-500 uppercase font-bold">Risk Model</label>
            <div class="flex gap-4 text-sm">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="riskMode" value="equity" checked onchange="app.toggleRiskMode()" class="accent-blue-500">
                    <span>Equity %</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="riskMode" value="position" onchange="app.toggleRiskMode()" class="accent-blue-500">
                    <span>Size %</span>
                </label>
            </div>
         </div>

         <div class="mt-4">
             <div class="flex justify-between text-sm mb-2 font-mono">
                 <span id="riskLabel">Risk 1.0%</span>
                 <span id="riskAmountDisplay" class="text-blue-400"></span>
             </div>
             <!-- Initial range setup for Equity Risk: 0.1 to 2.0 -->
             <input type="range" id="riskSlider" min="0.1" max="2.0" step="0.025" value="1.0" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
         </div>
      </div>

      <!-- Strategy & Notes (Collapsible) -->
      <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
         <label class="text-xs text-slate-500 uppercase font-bold">Strategy & Context</label>
         <select id="strategy" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm mt-2 mb-2 focus:ring-2 focus:ring-blue-500 outline-none">
             <option value="">Select Strategy...</option>
             <option value="FB Breakout">FB Breakout</option>
             <option value="21d Pullback">21d Pullback</option>
             <option value="Gap & Go">Gap & Go</option>
             <option value="Reversal">Reversal</option>
             <option value="Other">Other</option>
         </select>
         <textarea id="notes" rows="2" placeholder="Trade context, mental state..." class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:border-blue-500 outline-none"></textarea>
      </div>

      <!-- Action Button -->
      <button id="mainActionBtn" onclick="app.calculateOrUpdate()" class="w-full py-4 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold text-lg shadow-lg shadow-blue-900/50 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
        Calculate
      </button>

      <!-- Results Modal (Hidden by default) -->
      <div id="calculationResults" class="hidden mt-4 animate-in fade-in slide-in-from-bottom-4">
          <!-- Injected by JS -->
      </div>
      
      <!-- Spacer for bottom nav -->
      <div class="h-12"></div>
    </div>


    <!-- VIEW: LOGS -->
    <div id="view-logs" class="hidden p-4 max-w-4xl mx-auto h-full flex flex-col">
        <div class="flex gap-2 mb-4">
            <div class="relative flex-1">
                <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-slate-500"></i>
                <input type="text" id="logSearch" placeholder="Search Ticker..." onkeyup="app.renderLogs()" class="w-full bg-slate-800 border-none rounded-lg pl-10 py-2 text-sm focus:ring-2 focus:ring-blue-500 text-white">
            </div>
            <button onclick="app.exportLogs()" class="bg-slate-800 p-2 rounded-lg text-slate-400 hover:text-white">
                <i data-lucide="download" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="bg-slate-900 rounded-xl border border-slate-800 flex-1 overflow-hidden flex flex-col">
            <div class="grid grid-cols-12 gap-2 p-3 bg-slate-800 text-xs font-bold text-slate-400 border-b border-slate-700">
                <div class="col-span-2">DATE</div>
                <div class="col-span-2">TICKER</div>
                <div class="col-span-2 text-right">RISK</div>
                <div class="col-span-2 text-right">R-MULT</div>
                <div class="col-span-4 text-center">STATUS</div>
            </div>
            <div id="logsContainer" class="overflow-y-auto flex-1 p-2 space-y-1">
                <!-- Logs injected here -->
            </div>
        </div>
    </div>


    <!-- VIEW: STATS -->
    <div id="view-stats" class="hidden p-4 max-w-lg mx-auto pb-24">
        <div class="grid grid-cols-3 gap-3 mb-6">
            <div class="bg-slate-800 p-3 rounded-lg text-center border border-slate-700">
                <div class="text-xs text-slate-500">Win Rate</div>
                <div class="text-xl font-bold text-emerald-400" id="statWinRate">0%</div>
            </div>
            <div class="bg-slate-800 p-3 rounded-lg text-center border border-slate-700">
                <div class="text-xs text-slate-500">Avg R</div>
                <div class="text-xl font-bold text-blue-400" id="statAvgR">0R</div>
            </div>
            <div class="bg-slate-800 p-3 rounded-lg text-center border border-slate-700">
                <div class="text-xs text-slate-500">Trades</div>
                <div class="text-xl font-bold text-white" id="statTotal">0</div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
                <h3 class="text-sm font-semibold mb-2 text-slate-300">Performance Curve (Cumulative R)</h3>
                <canvas id="chartEquity"></canvas>
            </div>
            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
                <h3 class="text-sm font-semibold mb-2 text-slate-300">Outcome Distribution</h3>
                <canvas id="chartWinLoss"></canvas>
            </div>
        </div>
    </div>

  </main>


  <!-- BOTTOM NAVIGATION TAB BAR -->
  <nav class="fixed bottom-0 w-full bg-slate-900/95 backdrop-blur border-t border-slate-800 flex justify-around items-center pb-safe z-50">
      <button onclick="app.switchView('calculator')" id="nav-calculator" class="flex flex-col items-center py-3 w-1/3 text-blue-500 transition-colors">
          <i data-lucide="calculator" class="w-6 h-6 mb-1"></i>
          <span class="text-[10px] font-bold">Calculator</span>
      </button>
      <button onclick="app.switchView('logs')" id="nav-logs" class="flex flex-col items-center py-3 w-1/3 text-slate-500 hover:text-slate-300 transition-colors">
          <i data-lucide="list" class="w-6 h-6 mb-1"></i>
          <span class="text-[10px] font-bold">Logs</span>
      </button>
      <button onclick="app.switchView('stats')" id="nav-stats" class="flex flex-col items-center py-3 w-1/3 text-slate-500 hover:text-slate-300 transition-colors">
          <i data-lucide="bar-chart-2" class="w-6 h-6 mb-1"></i>
          <span class="text-[10px] font-bold">Stats</span>
      </button>
  </nav>

<script>
/**
 * Trade Risk Manager - Consolidated SPA Logic
 */

const app = {
    // --- STATE ---
    data: {
        logs: [],
        accounts: [],
        editingId: null, // If not null, we are in update mode
        settings: {
            baseCurrency: 'GBP',
            tradeCurrency: 'USD',
            riskMode: 'equity', // 'equity' or 'position'
            riskValue: 1.0,
            stopMode: 'single'
        },
        staggeredStops: [
            { price: 0, pct: 50 },
            { price: 0, pct: 50 }
        ],
        // Temporary store for calculated values to persist
        tempCalculation: {}
    },
    
    charts: {},

    // --- INITIALIZATION ---
    init() {
        // Load data
        const savedLogs = localStorage.getItem('tradeLogs');
        if (savedLogs) this.data.logs = JSON.parse(savedLogs);
        
        // Initialize accounts if empty
        const savedAccs = localStorage.getItem('accounts');
        if (savedAccs) {
            this.data.accounts = JSON.parse(savedAccs);
        } else {
            // Default 6 accounts
            this.data.accounts = Array(6).fill().map((_, i) => ({ 
                id: i+1, name: `Acc ${i+1}`, size: 0 
            }));
        }

        // Setup DOM
        this.renderAccounts();
        this.populateCurrencySelect();
        this.renderStaggeredInputs();
        this.setupListeners();
        
        // Icons
        lucide.createIcons();
        
        // Initial Restore from "Session" (Local storage form data)
        this.restoreFormData();
        
        // Initialize slider attributes based on default risk mode (Equity)
        this.toggleRiskMode();
    },

    setupListeners() {
        // Inputs that save state automatically
        document.querySelectorAll('input, select, textarea').forEach(el => {
            el.addEventListener('change', () => this.saveFormData());
        });

        // Range slider live update
        document.getElementById('riskSlider').addEventListener('input', (e) => {
            const val = e.target.value;
            document.getElementById('riskLabel').textContent = 
                this.data.settings.riskMode === 'equity' ? `Risk ${val}%` : `Pos Size ${val}%`;
            this.data.settings.riskValue = parseFloat(val);
        });
    },

    // --- VIEW MANAGEMENT ---
    switchView(viewName) {
        // Hide all
        ['calculator', 'logs', 'stats'].forEach(v => {
            document.getElementById(`view-${v}`).classList.add('hidden');
            document.getElementById(`nav-${v}`).classList.remove('text-blue-500');
            document.getElementById(`nav-${v}`).classList.add('text-slate-500');
        });

        // Show active
        document.getElementById(`view-${viewName}`).classList.remove('hidden');
        document.getElementById(`nav-${viewName}`).classList.add('text-blue-500');
        document.getElementById(`nav-${viewName}`).classList.remove('text-slate-500');

        // View specific actions
        if (viewName === 'logs') this.renderLogs();
        if (viewName === 'stats') this.renderStats();
    },

    // --- CALCULATOR LOGIC ---
    
    toggleAccounts() {
        const grid = document.getElementById('accountsGrid');
        const icon = document.getElementById('accToggleIcon');
        grid.classList.toggle('hidden');
        grid.classList.toggle('grid');
        icon.style.transform = grid.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
    },

    renderAccounts() {
        const grid = document.getElementById('accountsGrid');
        grid.innerHTML = this.data.accounts.map((acc, idx) => `
            <div class="bg-slate-900 p-2 rounded border border-slate-700">
                <input type="text" value="${acc.name}" onchange="app.updateAccount(${idx}, 'name', this.value)" 
                    class="w-full bg-transparent text-xs text-slate-400 mb-1 outline-none border-b border-transparent focus:border-blue-500">
                <input type="number" value="${acc.size}" onchange="app.updateAccount(${idx}, 'size', this.value)" 
                    placeholder="0.00"
                    class="w-full bg-transparent text-white font-mono outline-none">
            </div>
        `).join('');
    },

    updateAccount(idx, field, value) {
        this.data.accounts[idx][field] = field === 'size' ? parseFloat(value) : value;
        localStorage.setItem('accounts', JSON.stringify(this.data.accounts));
    },

    populateCurrencySelect() {
        const base = document.getElementById('accountCurrency').value;
        const tradeSel = document.getElementById('tradeCurrency');
        const options = ['USD', 'GBP', 'EUR'];
        
        tradeSel.innerHTML = options.map(c => 
            `<option value="${c}" ${c === 'USD' ? 'selected' : ''}>${c}</option>`
        ).join('');
    },

    setStopMode(mode) {
        this.data.settings.stopMode = mode;
        const btnSingle = document.getElementById('btn-stop-single');
        const btnStag = document.getElementById('btn-stop-staggered');
        const divSingle = document.getElementById('stop-single-container');
        const divStag = document.getElementById('stop-staggered-container');

        if(mode === 'single') {
            btnSingle.classList.replace('text-slate-400', 'text-white');
            btnSingle.classList.add('bg-slate-700', 'shadow');
            btnStag.classList.remove('bg-slate-700', 'shadow', 'text-white');
            btnStag.classList.add('text-slate-400');
            divSingle.classList.remove('hidden');
            divStag.classList.add('hidden');
        } else {
            btnStag.classList.replace('text-slate-400', 'text-white');
            btnStag.classList.add('bg-slate-700', 'shadow');
            btnSingle.classList.remove('bg-slate-700', 'shadow', 'text-white');
            btnSingle.classList.add('text-slate-400');
            divSingle.classList.add('hidden');
            divStag.classList.remove('hidden');
        }
    },

    renderStaggeredInputs() {
        const container = document.getElementById('stop-staggered-container');
        container.innerHTML = this.data.staggeredStops.map((stop, idx) => `
            <div class="flex gap-2 items-center">
                <span class="text-xs text-slate-500 w-4">${idx+1}</span>
                <input type="number" placeholder="Price" value="${stop.price || ''}" 
                    onchange="app.updateStaggered(${idx}, 'price', this.value)"
                    class="flex-1 bg-slate-900 border border-slate-700 rounded p-2 text-sm font-mono">
                <div class="relative w-20">
                    <input type="number" value="${stop.pct}" 
                        onchange="app.updateStaggered(${idx}, 'pct', this.value)"
                        class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm text-right pr-6">
                    <span class="absolute right-2 top-2 text-slate-500 text-xs">%</span>
                </div>
            </div>
        `).join('') + `
            <button onclick="app.addStaggeredLevel()" class="text-xs text-blue-400 mt-1 hover:text-white">+ Add Level</button>
        `;
    },

    updateStaggered(idx, field, val) {
        this.data.staggeredStops[idx][field] = parseFloat(val);
    },

    addStaggeredLevel() {
        if(this.data.staggeredStops.length >= 4) return;
        this.data.staggeredStops.push({ price: 0, pct: 0 });
        this.renderStaggeredInputs();
    },

    toggleRiskMode() {
        const modes = document.getElementsByName('riskMode');
        let selected;
        modes.forEach(m => { if(m.checked) selected = m.value; });
        this.data.settings.riskMode = selected;
        
        const slider = document.getElementById('riskSlider');
        const label = document.getElementById('riskLabel');
        
        if (selected === 'equity') {
            // Equity Risk: 0.1% to 2.0% in 0.025% increments
            slider.min = "0.1"; slider.max = "2.0"; slider.step = "0.025";
            if(slider.value > 2.0) slider.value = 1.0; // Reset if out of bounds
            label.textContent = `Risk ${slider.value}%`;
        } else {
            // Position Size: 3% to 50% in 0.5% increments
            slider.min = "3"; slider.max = "50"; slider.step = "0.5";
            if(slider.value < 3) slider.value = 10; // Reset if out of bounds
            label.textContent = `Pos Size ${slider.value}%`;
        }
        this.data.settings.riskValue = parseFloat(slider.value);
    },

    async calculateOrUpdate() {
        // 1. Gather Inputs
        const ticker = document.getElementById('ticker').value.toUpperCase();
        const entry = parseFloat(document.getElementById('purchasePrice').value);
        if(!ticker || !entry) return alert("Please enter Ticker and Entry Price");

        let stopPrice = 0;
        if(this.data.settings.stopMode === 'single') {
            stopPrice = parseFloat(document.getElementById('stopLoss').value);
        } else {
            // Weighted average stop
            let totalW = 0;
            let wPrice = 0;
            this.data.staggeredStops.forEach(s => {
                if(s.price && s.pct) {
                    wPrice += s.price * (s.pct/100);
                    totalW += s.pct;
                }
            });
            if(Math.abs(totalW - 100) > 1) return alert("Staggered stops must equal 100%");
            stopPrice = wPrice;
        }

        if(!stopPrice) return alert("Invalid Stop Loss");

        // 2. Fetch Live Exchange Rate
        const baseCcy = document.getElementById('accountCurrency').value;
        const tradeCcy = document.getElementById('tradeCurrency').value;
        let rate = 1;
        
        if(baseCcy !== tradeCcy) {
            try {
                // UI Feedback
                const btn = document.getElementById('mainActionBtn');
                const originalText = btn.textContent;
                btn.textContent = "Fetching Live Rate...";
                btn.disabled = true;
                
                const response = await fetch(`https://api.frankfurter.app/latest?from=${baseCcy}&to=${tradeCcy}`);
                const data = await response.json();
                rate = data.rates[tradeCcy];
                
                // Restore UI
                btn.textContent = originalText;
                btn.disabled = false;
            } catch (e) {
                console.error("API Error", e);
                // Fallback Logic or Alert
                alert("Could not fetch live rate. Using fallback (1.25). Check internet.");
                rate = 1.25; 
                document.getElementById('mainActionBtn').textContent = "Calculate";
                document.getElementById('mainActionBtn').disabled = false;
            }
        }

        // 3. Determine Risk
        const riskPerShare = Math.abs(entry - stopPrice);
        const stopPct = (riskPerShare / entry) * 100;
        
        // Derisk Calculation (assuming direction based on entry vs stop)
        // Formula: entry + (entry - stop)
        const derisk13Price = entry + (entry - stopPrice);
        const derisk14Price = entry + (entry - stopPrice) * (4/3);

        // 4. Generate Result HTML per account
        const resultsDiv = document.getElementById('calculationResults');
        let html = `<div class="bg-slate-900 border border-slate-700 rounded-xl p-4 mb-4">
            <div class="flex justify-between mb-2 border-b border-slate-700 pb-2">
                <span class="font-bold text-white">${ticker}</span>
                <span class="text-xs text-slate-400">${new Date().toLocaleDateString()}</span>
            </div>
            <div class="grid grid-cols-2 gap-4 text-sm mb-2">
                <div><span class="text-slate-500 block text-xs">Entry</span>${entry}</div>
                <div><span class="text-slate-500 block text-xs">Avg Stop</span>${stopPrice.toFixed(2)} (${stopPct.toFixed(2)}%)</div>
            </div>
        </div>`;

        // Store temp data for logging
        this.data.tempCalculation = {
            derisk13Price,
            derisk14Price,
            rate
        };

        // Loop Accounts
        html += `<div class="space-y-3">`;
        
        let validAccountFound = false;

        this.data.accounts.forEach(acc => {
            if(!acc.size || acc.size <= 0) return;
            validAccountFound = true;
            
            let shares, posSize, riskAmt, posSizePct;

            if(this.data.settings.riskMode === 'equity') {
                const riskPct = this.data.settings.riskValue / 100;
                riskAmt = acc.size * riskPct; // In Base Ccy
                
                // Convert Risk Amount to Trade Ccy to find shares
                const riskAmtTradeCcy = riskAmt * rate; 
                shares = Math.floor(riskAmtTradeCcy / riskPerShare);
                
                // Calculate resulting Pos Size %
                const totalPosValueTradeCcy = shares * entry;
                const totalPosValueBaseCcy = totalPosValueTradeCcy / rate;
                posSizePct = (totalPosValueBaseCcy / acc.size) * 100;

            } else {
                const posPct = this.data.settings.riskValue / 100;
                posSizePct = this.data.settings.riskValue;
                posSize = acc.size * posPct * rate; // Trade Ccy
                shares = Math.floor(posSize / entry);
                riskAmt = (shares * riskPerShare) / rate; // Back to Base Ccy
            }

            posSize = shares * entry;
            const sell13 = Math.floor(shares/3);
            const sell14 = Math.floor(shares/4);
            
            html += `
            <div class="bg-slate-800 p-3 rounded-lg border-l-4 border-blue-500">
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-slate-300">${acc.name}</span>
                    <span class="text-xs font-mono text-slate-500">Size: ${acc.size}</span>
                </div>
                
                <!-- Main Stats -->
                <div class="grid grid-cols-3 gap-2 text-center mb-2">
                    <div class="bg-slate-900/50 rounded p-1">
                        <div class="text-[10px] text-slate-500 uppercase">Shares</div>
                        <div class="font-bold text-lg text-white">${shares}</div>
                    </div>
                    <div class="bg-slate-900/50 rounded p-1">
                        <div class="text-[10px] text-slate-500 uppercase">Pos Size</div>
                        <div class="font-mono text-sm">${(posSize/rate).toFixed(0)} <span class="text-[10px]">${baseCcy}</span></div>
                    </div>
                    <div class="bg-slate-900/50 rounded p-1">
                        <div class="text-[10px] text-slate-500 uppercase">Risk</div>
                        <div class="font-mono text-sm text-red-400">-${riskAmt.toFixed(2)}</div>
                    </div>
                </div>

                <!-- Detailed Stats (Exchange, %, Derisk) -->
                <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-slate-400 border-t border-slate-700 pt-2">
                    <div class="flex justify-between">
                        <span>Live Rate:</span>
                        <span class="font-mono text-emerald-400">${rate.toFixed(4)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Pos Size %:</span>
                        <span class="font-mono text-slate-200">${posSizePct.toFixed(2)}%</span>
                    </div>
                    <div class="flex justify-between col-span-2 mt-1">
                        <span>Derisk 1/3 @ ${derisk13Price.toFixed(2)}:</span>
                        <span class="font-mono text-emerald-400">Sell ${sell13}</span>
                    </div>
                    <div class="flex justify-between col-span-2">
                        <span>Derisk 1/4 @ ${derisk14Price.toFixed(2)}:</span>
                        <span class="font-mono text-emerald-400">Sell ${sell14}</span>
                    </div>
                </div>
            </div>`;
        });
        html += `</div>`;

        if(!validAccountFound) {
            html += `<div class="text-center text-red-400 p-4">Please set an Account Size above 0</div>`;
        } else {
            // Add "Save/Update Log" button
            const btnText = this.data.editingId ? "Update Log Entry" : "Add to Trade Log";
            html += `<button onclick="app.saveToLog(${entry}, ${stopPrice})" class="w-full mt-4 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-emerald-900/50">
                ${btnText}
            </button>`;
        }

        resultsDiv.innerHTML = html;
        resultsDiv.classList.remove('hidden');
        
        // Scroll to results
        resultsDiv.scrollIntoView({ behavior: 'smooth' });
    },

    saveToLog(entry, stop) {
        // Retrieve calculated temp data
        const { derisk13Price, derisk14Price, rate } = this.data.tempCalculation || {};

        const logEntry = {
            id: this.data.editingId || Date.now(),
            date: new Date().toISOString().split('T')[0],
            ticker: document.getElementById('ticker').value.toUpperCase(),
            entry: entry,
            stop: stop,
            riskMode: this.data.settings.riskMode,
            riskVal: this.data.settings.riskValue,
            strategy: document.getElementById('strategy').value,
            notes: document.getElementById('notes').value,
            outcome: 'open', // open, profit, loss
            exitPrice: null,
            rResult: null,
            // Persisted Extras
            exchangeRate: rate,
            derisk13: derisk13Price,
            derisk14: derisk14Price
        };

        if(this.data.editingId) {
            // Update existing
            const idx = this.data.logs.findIndex(l => l.id === this.data.editingId);
            if(idx !== -1) this.data.logs[idx] = logEntry;
            alert("Trade Updated");
            this.data.editingId = null; // Exit edit mode
            document.getElementById('mainActionBtn').textContent = "Calculate";
            document.getElementById('mainActionBtn').classList.remove('bg-amber-600');
            document.getElementById('mainActionBtn').classList.add('bg-blue-600');
        } else {
            // Add new
            this.data.logs.unshift(logEntry); // Add to top
            
            // Show toast
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-emerald-500 text-white px-4 py-2 rounded shadow-lg z-50 animate-bounce';
            toast.textContent = "Trade Logged!";
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
        document.getElementById('calculationResults').classList.add('hidden');
        
        // Clear critical inputs but keep context
        document.getElementById('ticker').value = '';
        document.getElementById('purchasePrice').value = '';
    },

    // --- LOGS LOGIC ---
    renderLogs() {
        const container = document.getElementById('logsContainer');
        const search = document.getElementById('logSearch').value.toUpperCase();
        
        const filtered = this.data.logs.filter(l => 
            l.ticker.includes(search) || (l.strategy && l.strategy.toUpperCase().includes(search))
        );

        container.innerHTML = filtered.map(log => {
            // Calculate R if exit exists
            let rDisplay = '-';
            let rClass = 'text-slate-500';
            let statusBadge = `<span class="bg-blue-900/50 text-blue-400 text-[10px] px-2 py-1 rounded">OPEN</span>`;

            if(log.outcome !== 'open' && log.exitPrice) {
                const risk = Math.abs(log.entry - log.stop);
                const reward = log.exitPrice - log.entry;
                // Adjust reward direction for shorts (implied logic: entry < stop = short? simplified here assuming long for calculation or need short flag)
                // Assuming Long only for simplicity unless entry < stop
                const r = (reward / risk).toFixed(2);
                
                if(r > 0) {
                    rDisplay = `+${r}R`;
                    rClass = 'text-emerald-400 font-bold';
                    statusBadge = `<span class="bg-emerald-900/50 text-emerald-400 text-[10px] px-2 py-1 rounded">WIN</span>`;
                } else {
                    rDisplay = `${r}R`;
                    rClass = 'text-red-400 font-bold';
                    statusBadge = `<span class="bg-red-900/50 text-red-400 text-[10px] px-2 py-1 rounded">LOSS</span>`;
                }
            }

            return `
            <div class="grid grid-cols-12 gap-2 p-3 bg-slate-800/50 border-b border-slate-700 items-center hover:bg-slate-800 transition-colors">
                <div class="col-span-2 text-xs text-slate-400">${log.date.substring(5)}</div>
                <div class="col-span-2 font-bold text-white">${log.ticker}</div>
                <div class="col-span-2 text-right text-xs font-mono">${log.riskVal}${log.riskMode === 'equity' ? '%' : 'sz'}</div>
                <div class="col-span-2 text-right text-sm font-mono ${rClass}">${rDisplay}</div>
                <div class="col-span-4 flex justify-end gap-2">
                    ${statusBadge}
                    <button onclick="app.editLog(${log.id})" class="text-slate-400 hover:text-blue-400"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                    <button onclick="app.deleteLog(${log.id})" class="text-slate-400 hover:text-red-400"><i data-lucide="trash" class="w-4 h-4"></i></button>
                </div>
                <!-- Expansion for Exit Input -->
                <div class="col-span-12 mt-2 pt-2 border-t border-slate-700/50 flex gap-2 items-center">
                    <select onchange="app.updateLogStatus(${log.id}, this.value)" class="bg-slate-900 text-[10px] rounded p-1 border border-slate-700 outline-none">
                        <option value="open" ${log.outcome === 'open' ? 'selected' : ''}>Open</option>
                        <option value="profit" ${log.outcome === 'profit' ? 'selected' : ''}>Profit</option>
                        <option value="loss" ${log.outcome === 'loss' ? 'selected' : ''}>Loss</option>
                    </select>
                    <input type="number" placeholder="Exit Price" value="${log.exitPrice || ''}" 
                        onchange="app.updateLogExit(${log.id}, this.value)"
                        class="bg-slate-900 text-[10px] rounded p-1 border border-slate-700 w-20 outline-none">
                </div>
            </div>
            `;
        }).join('');
        
        lucide.createIcons();
    },

    updateLogStatus(id, status) {
        const log = this.data.logs.find(l => l.id === id);
        if(log) {
            log.outcome = status;
            localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
            this.renderLogs();
        }
    },

    updateLogExit(id, price) {
        const log = this.data.logs.find(l => l.id === id);
        if(log) {
            log.exitPrice = parseFloat(price);
            localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
            this.renderLogs(); // Re-calc R
        }
    },

    editLog(id) {
        const log = this.data.logs.find(l => l.id === id);
        if(!log) return;

        // Populate Calculator
        document.getElementById('ticker').value = log.ticker;
        document.getElementById('purchasePrice').value = log.entry;
        document.getElementById('stopLoss').value = log.stop;
        document.getElementById('strategy').value = log.strategy;
        document.getElementById('notes').value = log.notes;
        
        // Set Risk Settings
        if(log.riskMode === 'equity') {
            document.querySelector('input[value="equity"]').click();
        } else {
            document.querySelector('input[value="position"]').click();
        }
        // Force toggle to update slider attributes
        this.toggleRiskMode();
        // Set value
        const slider = document.getElementById('riskSlider');
        slider.value = log.riskVal;
        // Trigger input event to update label
        slider.dispatchEvent(new Event('input'));
        
        // Enter Edit Mode
        this.data.editingId = id;
        this.switchView('calculator');
        
        const btn = document.getElementById('mainActionBtn');
        btn.textContent = "Update Trade Logic";
        btn.classList.remove('bg-blue-600');
        btn.classList.add('bg-amber-600');
        
        window.scrollTo(0,0);
    },

    deleteLog(id) {
        if(!confirm("Delete this trade log?")) return;
        this.data.logs = this.data.logs.filter(l => l.id !== id);
        localStorage.setItem('tradeLogs', JSON.stringify(this.data.logs));
        this.renderLogs();
    },

    // --- STATS LOGIC ---
    renderStats() {
        const closedTrades = this.data.logs.filter(l => l.outcome !== 'open' && l.exitPrice);
        
        // Summary
        const wins = closedTrades.filter(l => l.outcome === 'profit').length;
        const total = closedTrades.length;
        const winRate = total > 0 ? Math.round((wins/total)*100) : 0;
        
        let totalR = 0;
        closedTrades.forEach(l => {
            const risk = Math.abs(l.entry - l.stop);
            const reward = l.exitPrice - l.entry;
            totalR += (reward/risk);
        });
        const avgR = total > 0 ? (totalR / total).toFixed(2) : 0;

        document.getElementById('statWinRate').textContent = `${winRate}%`;
        document.getElementById('statAvgR').textContent = `${avgR}R`;
        document.getElementById('statTotal').textContent = this.data.logs.length; // All trades

        // Charts
        this.drawEquityChart(closedTrades);
        this.drawWinLossChart(this.data.logs);
    },

    drawEquityChart(trades) {
        const ctx = document.getElementById('chartEquity');
        if(this.charts.equity) this.charts.equity.destroy();

        // Sort by date
        const sorted = [...trades].sort((a,b) => new Date(a.date) - new Date(b.date));
        
        let cumR = 0;
        const dataPoints = sorted.map(l => {
            const risk = Math.abs(l.entry - l.stop);
            const reward = l.exitPrice - l.entry;
            const r = reward/risk;
            cumR += r;
            return cumR;
        });

        const labels = sorted.map(l => l.date.substring(5));

        this.charts.equity = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Cumulative R',
                    data: dataPoints,
                    borderColor: '#34d399',
                    backgroundColor: 'rgba(52, 211, 153, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { grid: { color: '#334155' } }
                }
            }
        });
    },

    drawWinLossChart(allLogs) {
        const ctx = document.getElementById('chartWinLoss');
        if(this.charts.winLoss) this.charts.winLoss.destroy();

        const wins = allLogs.filter(l => l.outcome === 'profit').length;
        const losses = allLogs.filter(l => l.outcome === 'loss').length;
        const open = allLogs.filter(l => l.outcome === 'open').length;

        this.charts.winLoss = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Win', 'Loss', 'Open'],
                datasets: [{
                    data: [wins, losses, open],
                    backgroundColor: ['#34d399', '#f87171', '#60a5fa'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } }
            }
        });
    },

    // --- UTILS ---
    saveFormData() {
        // Save form state to prevent loss on reload
        const formState = {
            ticker: document.getElementById('ticker').value,
            price: document.getElementById('purchasePrice').value,
            stop: document.getElementById('stopLoss').value,
            riskMode: this.data.settings.riskMode,
            riskVal: this.data.settings.riskValue
        };
        localStorage.setItem('sessionForm', JSON.stringify(formState));
    },

    restoreFormData() {
        const saved = localStorage.getItem('sessionForm');
        if(saved) {
            const data = JSON.parse(saved);
            document.getElementById('ticker').value = data.ticker || '';
            document.getElementById('purchasePrice').value = data.price || '';
            document.getElementById('stopLoss').value = data.stop || '';
            // Restore risk settings...
        }
    },
    
    resetForm() {
        if(confirm("Reset all form inputs?")) {
            document.getElementById('ticker').value = '';
            document.getElementById('purchasePrice').value = '';
            document.getElementById('stopLoss').value = '';
            this.data.editingId = null;
            document.getElementById('calculationResults').classList.add('hidden');
            document.getElementById('mainActionBtn').textContent = "Calculate";
            document.getElementById('mainActionBtn').classList.add('bg-blue-600');
            document.getElementById('mainActionBtn').classList.remove('bg-amber-600');
        }
    },
    
    exportLogs() {
        const csvContent = "data:text/csv;charset=utf-8," 
            + "Date,Ticker,Entry,Stop,Strategy,Outcome,R,Derisk1/3,Derisk1/4\n"
            + this.data.logs.map(e => {
                let r = '';
                if(e.exitPrice) r = ((e.exitPrice - e.entry) / Math.abs(e.entry - e.stop)).toFixed(2);
                return `${e.date},${e.ticker},${e.entry},${e.stop},${e.strategy},${e.outcome},${r},${e.derisk13 || ''},${e.derisk14 || ''}`;
            }).join("\n");
            
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "trade_logs.csv");
        document.body.appendChild(link);
        link.click();
    }
};

// Start App
document.addEventListener('DOMContentLoaded', () => {
    app.init();
});

</script>
</body>
</html>